<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تصحيح الاختبارات باستخدام الذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px dashed #10b981;
            width: 80%;
            height: 60%;
            pointer-events: none;
            border-radius: 8px;
        }
        .countdown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0,0,0,0.7);
            opacity: 0;
            animation: fadeInOut 1s infinite;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .app-section {
            display: none;
        }
        .app-section.active {
            display: block;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden" onclick="toggleSidebar()"></div>
    <div class="flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 min-h-screen fixed md:relative inset-y-0 right-0 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <h1 class="text-2xl font-bold text-center mb-8">المصحح الذكي</h1>
            <nav class="flex flex-col gap-2">
                <a href="#dashboard" class="nav-link active p-3 rounded-lg hover:bg-gray-700" onclick="showSection('dashboard')">🏠 لوحة التحكم</a>
                <a href="#students" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('students')">👥 الطلاب</a>
                <a href="#answer-key" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('answer-key')">🔑 نماذج الإجابة</a>
                <a href="#correction" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('correction')">📷 التصحيح</a>
                <a href="#history" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('history')">📚 السجلات</a>
                <a href="#reports" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('reports')">🖨️ التقارير</a>
                <a href="#stats" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('stats')">📈 الإحصائيات</a>
                <a href="#settings" class="nav-link p-3 rounded-lg hover:bg-gray-700" onclick="showSection('settings')">⚙️ الإعدادات</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8">
            <button id="menu-button" class="md:hidden fixed top-4 right-4 z-20 p-2 bg-gray-800 text-white rounded-md" onclick="toggleSidebar()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            
            <!-- Section: Dashboard -->
            <section id="dashboard" class="app-section active">
                <header class="mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3 text-center">أطلق العنان لقوة التصحيح الفوري</h1>
                    <p class="text-lg md:text-xl text-center max-w-3xl mx-auto text-gray-600">"المصحح الذكي" هو مساعدك الرقمي الذي يحول مهمة تصحيح الاختبارات المرهقة إلى عملية سريعة ودقيقة وممتعة باستخدام أحدث تقنيات الذكاء الاصطناعي.</p>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b pb-4">أبرز الميزات</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex items-start gap-4">
                            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full text-2xl">⚡️</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">تصحيح ذكي وسريع</h3>
                                <p class="text-gray-600">حوّل كاميرا هاتفك إلى ماسح ضوئي فائق السرعة. يلتقط التطبيق الإجابات تلقائياً ويحللها في ثوانٍ معدودة بدقة عالية.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-full text-2xl">👥</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">إدارة الطلاب والفصول</h3>
                                <p class="text-gray-600">استورد قوائم طلابك من ملفات Excel بسهولة، وتتبع أداءهم، وقم بتصحيح أوراقهم بشكل فردي أو جماعي.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full text-2xl">🔑</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">نماذج إجابة مرنة</h3>
                                <p class="text-gray-600">أنشئ نماذج إجابات متعددة واحفظها. أدخل الإجابات الصحيحة يدوياً أو قم بتصوير نموذج محلول ليوفر عليك عناء الإدخال.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-red-100 text-red-600 p-3 rounded-full text-2xl">📊</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">سجلات وتقارير مفصلة</h3>
                                <p class="text-gray-600">احفظ جميع النتائج تلقائياً في سجلات منظمة. قم بتصدير ملخصات النتائج أو تقارير الإجابات التفصيلية إلى ملفات Excel لتحليل أعمق.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- قسم الإرشادات -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <button onclick="toggleInstructions()" class="w-full text-right">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                📖 دليل البدء السريع
                            </h2>
                            <span id="instructions-arrow">▼</span>
                        </div>
                    </button>
                    <div id="instructions-content" class="collapsible-content mt-4 pt-4 border-t">
                        <ol class="list-decimal list-inside space-y-4 text-gray-700">
                            <li>اذهب إلى قسم <a href="#" onclick="showSection('students')" class="text-blue-600 font-bold">"الطلاب"</a> واستورد قائمة طلابك.</li>
                            <li>اذهب إلى قسم <a href="#" onclick="showSection('answer-key')" class="text-blue-600 font-bold">"نماذج الإجابة"</a> وجهّز نموذج الإجابة الصحيحة.</li>
                            <li>انتقل إلى قسم <a href="#" onclick="showSection('correction')" class="text-blue-600 font-bold">"التصحيح"</a> وابدأ العمل!</li>
                        </ol>
                    </div>
                </div>
            </section>

            <!-- Section: Students -->
            <section id="students" class="app-section">
                <!-- إدارة الطلاب -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        👥 إدارة الطلاب
                    </h2>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">📊 استيراد قائمة الطلاب</h3>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                        </div>
                    </div>

                    <!-- قائمة الطلاب -->
                    <div id="studentsListSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">📋 قائمة الطلاب</h3>
                            <div class="flex gap-2">
                                <button onclick="toggleMultipleCorrection()" id="multiCorrectionBtn"
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                    🔄 تصحيح متعدد
                                </button>
                                <button onclick="clearStudentsList()" 
                                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    🗑️ مسح القائمة
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                                <div class="text-xs text-blue-800">إجمالي الطلاب</div>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                                <div class="text-xs text-green-800">تم تصحيحها</div>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                                <div class="text-xs text-yellow-800">في الانتظار</div>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                                <div class="text-xs text-purple-800">عدد الفصول</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">البحث بالاسم:</label>
                                    <input type="text" id="searchStudentName" placeholder="جزء من اسم الطالب..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                           onkeyup="filterStudentsList()">
                                </div>
                                <div>
                                    <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالفصل:</label>
                                    <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                            onchange="filterStudentsList()">
                                        <option value="">جميع الفصول</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">حالة التصحيح:</label>
                                    <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                            onchange="filterStudentsList()">
                                        <option value="">الكل</option>
                                        <option value="corrected">تم التصحيح</option>
                                        <option value="pending">في الانتظار</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </section>
            
            <!-- Section: Answer Key -->
            <section id="answer-key" class="app-section">
                <!-- إعداد الإجابات الصحيحة -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🔑 إعداد نماذج الإجابة</h2>
                    
                    <div class="mb-4">
                        <label for="answerKeyModel" class="block text-sm font-medium text-gray-700 mb-2">اختر أو أنشئ نموذج إجابة:</label>
                        <div class="flex gap-2">
                            <select id="answerKeyModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                            <button onclick="manageModels('new')" title="نموذج جديد" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-lg">➕</button>
                            <button onclick="manageModels('rename')" title="إعادة تسمية" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg">✏️</button>
                            <button onclick="manageModels('delete')" title="حذف النموذج" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg">🗑️</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة:</label>
                            <input type="number" id="questionCount" min="1" max="100" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">عدد الخيارات:</label>
                            <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="4">4 (A, B, C, D)</option>
                                <option value="5">5 (A, B, C, D, E)</option>
                            </select>
                        </div>
                        <div>
                            <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">المادة:</label>
                            <input type="text" id="subjectName" placeholder="مثال: رياضيات" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" oninput="document.getElementById('examName').value = this.value">
                        </div>
                    </div>
                     <button onclick="showManualEntry()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">✏️ إعداد الإجابات يدوياً</button>
                     <button onclick="scanAnswerKey()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm ml-2">📷 تصوير نموذج محلول</button>
                     
                    <div id="answerSheet" class="hidden mt-6 pt-4 border-t">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📝 أدخل الإجابات الصحيحة يدوياً:</h3>
                        <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                        <button onclick="saveCorrectAnswers()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">حفظ الإجابات</button>
                    </div>
                </div>
            </section>
            
            <!-- Section: Correction -->
            <section id="correction" class="app-section">
                <!-- قسم الكاميرا وتحميل الصور -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📷 تصوير أو تحميل ورقة الإجابة</h2>

                    <div class="mb-4">
                        <label for="correctionStudentSelect" class="block text-sm font-medium text-gray-700 mb-2">👤 اختر طالباً للتصحيح الفردي:</label>
                        <select id="correctionStudentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- اختر من القائمة --</option>
                        </select>
                    </div>

                    <div id="uploadOptions" class="flex flex-col sm:flex-row gap-4 my-6">
                        <button onclick="showCameraSection()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">📹 استخدام الكاميرا</button>
                        <button onclick="showUploadSection()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">📁 تحميل صورة</button>
                    </div>
                    <div id="cameraSection" class="hidden">
                        <div class="camera-container mb-4">
                            <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <div class="overlay"></div>
                            <div id="countdown" class="countdown-text"></div>
                        </div>
                        <div class="text-center">
                            <button onclick="stopCamera()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏹️ إيقاف الكاميرا</button>
                        </div>
                    </div>
                    <div id="uploadSection" class="hidden">
                        <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                    </div>
                </div>

                 <!-- التصحيح المتعدد -->
                <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">🔄 التصحيح المتعدد</h2>
                    <div id="multiCorrectionSetup">
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <p class="text-sm text-purple-700">سيتم تصحيح أوراق جميع الطلاب في قائمة "في الانتظار" بالتتابع. صوّر الأوراق بالترتيب وسيتم الانتقال للطالب التالي تلقائياً بعد حفظ النتيجة.</p>
                        </div>
                        <div class="text-center">
                            <button onclick="startMultipleCorrection()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg">
                                🚀 بدء التصحيح المتعدد
                            </button>
                        </div>
                    </div>
                    <div id="multiCorrectionActive" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>التقدم</span>
                                <span id="progressText">0 من 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
                                    <div class="text-sm text-blue-600">الفصل: <span id="multiStudentClass">-</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-600">ورقة رقم</div>
                                    <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onclick="skipCurrentStudent()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏭️ تخطي هذا الطالب</button>
                            <button onclick="stopMultipleCorrection()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏹️ إنهاء التصحيح المتعدد</button>
                        </div>
                    </div>
                    <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">📊 تقرير التصحيح المتعدد</h3>
                        <div id="multiReportContent"></div>
                        <div class="mt-4 flex gap-4 justify-center">
                            <button onclick="exportMultiReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">📄 تصدير التقرير</button>
                            <button onclick="resetMultiCorrection()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">🔄 تصحيح جديد</button>
                        </div>
                    </div>
                </div>

                <!-- الصورة الملتقطة والمعالجة -->
                <div id="capturedSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">🖼️ الصورة الملتقطة:</h3>
                    <img id="capturedImage" class="w-full max-w-md mx-auto rounded-lg shadow-md mb-4">
                    <div class="text-center">
                        <button onclick="processAnswers()" id="processBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                            <span id="processBtnSpinner" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                            <span id="processBtnText">🔍 تحليل الإجابات</span>
                        </button>
                    </div>
                </div>

                <!-- بيانات الاختبار وقائمة التأكيد -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div id="examInfoSection" class="mb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ℹ️ بيانات الاختبار (اختياري)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">اسم الاختبار:</label>
                                <input type="text" id="examName" placeholder="مثال: رياضيات - الفصل الأول" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">تاريخ الاختبار:</label>
                                <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <div id="verificationSection" class="hidden pt-4 border-t">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">🔍 تأكيد الإجابات المقروءة</h3>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                            <p class="text-sm text-yellow-700">يرجى مراجعة الإجابات والتعديل يدوياً إذا لزم الأمر.</p>
                        </div>
                        <div id="verificationGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"></div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onclick="confirmAnswers()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">✅ تأكيد وحساب النتيجة</button>
                        </div>
                    </div>
                </div>


                <!-- نتائج التصحيح -->
                <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">📊 نتائج التصحيح</h3>
                    <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>الطالب:</strong> <span id="resultStudentName">-</span></div>
                            <div><strong>الفصل:</strong> <span id="resultStudentClass">-</span></div>
                            <div><strong>الاختبار:</strong> <span id="resultExamName">-</span></div>
                            <div><strong>التاريخ:</strong> <span id="resultExamDate">-</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600" id="correctCount">0</div>
                            <div class="text-sm">صحيحة</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600" id="wrongCount">0</div>
                            <div class="text-sm">خاطئة</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600" id="scorePercentage">0%</div>
                            <div class="text-sm">النسبة</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="letterGrade">-</div>
                            <div class="text-sm">التقدير</div>
                        </div>
                    </div>
                    <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="saveToHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">💾 حفظ وبدء ورقة جديدة</button>
                        <button onclick="exportResults()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">📄 تصدير النتيجة</button>
                    </div>
                </div>
            </section>
            
            <!-- Section: History -->
            <section id="history" class="app-section">
                 <!-- سجل النتائج -->
                <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">📚 سجل النتائج المحفوظة</h3>
                        <div class="flex gap-2">
                            <button onclick="exportAllResults()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">📊 تصدير ملخص النتائج</button>
                             <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">🗑️ مسح السجل</button>
                        </div>
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                </div>

                <!-- سجل إجابات الطلاب المفصل -->
                <div id="detailedHistorySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">📋 سجل إجابات الطلاب (مفصل)</h3>
                        <div class="flex gap-2">
                            <button onclick="exportDetailedAnswersLog()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-medium text-sm">📄 تصدير سجل الإجابات (Excel)</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">يحتوي هذا السجل على إجابة كل طالب لكل سؤال. استخدم زر التصدير لتحليل البيانات.</p>
                </div>
            </section>

            <!-- Section: Reports -->
            <section id="reports" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🖨️ التقارير والطباعة</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">تقرير أداء الفصل</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="reportClassFilter" class="block text-sm font-medium text-gray-700 mb-1">اختر الفصل:</label>
                                    <select id="reportClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <label for="reportExamFilter" class="block text-sm font-medium text-gray-700 mb-1">اختر الاختبار:</label>
                                    <select id="reportExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div class="self-end">
                                    <button onclick="generateClassReport()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">📊 إنشاء تقرير</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="report-container" class="mt-6"></div>
                </div>
            </section>
            
            <!-- Section: Stats -->
            <section id="stats" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 الإحصائيات العامة</h2>
                     <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- Stats will be populated here by JS -->
                     </div>
                </div>
            </section>

            <!-- Section: Settings -->
            <section id="settings" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">⚙️ الإعدادات</h2>
                    <div class="space-y-6">

                        <!-- Basic Info -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">البيانات الأساسية للتقارير</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="setting-admin" type="text" placeholder="إدارة التعليم" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-school" type="text" placeholder="المدرسة" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-teacher" type="text" placeholder="المعلم" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-director" type="text" placeholder="المدير" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-year" type="text" placeholder="العام الدراسي" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-semester" type="text" placeholder="الفصل الدراسي" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button onclick="saveSettings()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">حفظ البيانات الأساسية</button>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="font-semibold text-lg text-gray-800 mb-4">إدارة البيانات</h3>
                             <div class="flex flex-wrap gap-4">
                                <button onclick="backupData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">📥 نسخ احتياطي للبيانات</button>
                                <div>
                                    <label for="restoreFile" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm cursor-pointer">📤 استعادة نسخة احتياطية</label>
                                    <input type="file" id="restoreFile" class="hidden" accept=".json" onchange="restoreData(event)">
                                </div>
                             </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                             <h3 class="font-semibold text-lg text-red-800 mb-2">منطقة الخطر</h3>
                             <p class="text-sm text-red-700 mb-4">سيؤدي هذا الإجراء إلى حذف جميع البيانات المحفوظة في التطبيق بشكل نهائي، بما في ذلك الطلاب، النماذج، والسجلات.</p>
                             <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">🗑️ مسح جميع بيانات التطبيق</button>
                        </div>
                    </div>
                </div>
            </section>

        </main>
        
    </div>

    <script>
        // Global state variables
        let correctAnswers = [];
        let studentAnswers = [];
        let stream = null;
        let currentStudent = null;
        let autoCaptureTimer = null;
        let isScanningForKey = false;
        
        // Data loaded from localStorage
        let settings = {};
        let studentsList = [];
        let resultsHistory = [];
        let detailedAnswersLog = [];
        let answerKeyModels = {};
        
        // Multi-correction state
        let isMultipleCorrectionMode = false;
        let multiCorrectionQueue = [];
        let currentMultiIndex = 0;
        let multiCorrectionResults = [];

        // === Safe localStorage Parsing ===
        function getFromStorage(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem(key);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            } catch (e) {
                console.error(`Error parsing ${key} from localStorage:`, e);
                return defaultValue;
            }
        }

        // === Navigation & UI Initialization ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.app-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[href="#${sectionId}"]`).classList.add('active');
            
            if (sectionId === 'correction') populateCorrectionStudentSelect();
            if (sectionId === 'reports') populateReportFilters();
            if (sectionId === 'stats') updateGlobalStats();

            if (sectionId !== 'correction') document.getElementById('multipleCorrectionSection').classList.add('hidden');
            
            if (window.innerWidth < 768) { // md breakpoint
                toggleSidebar();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('examDate').valueAsDate = new Date();
            document.getElementById('studentsFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) parseStudentsFile(file);
            });
            document.getElementById('imageInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleImageFile(file);
            });
             document.getElementById('answerKeyModel').addEventListener('change', switchModel);
             document.getElementById('correctionStudentSelect').addEventListener('change', (e) => {
                if(e.target.value) {
                    selectStudent(parseInt(e.target.value));
                } else {
                    selectDifferentStudent();
                }
             });

            loadInitialUI();
        });

        function loadInitialUI() {
            settings = getFromStorage('appSettings', {});
            studentsList = getFromStorage('studentsList', []);
            resultsHistory = getFromStorage('examResults', []);
            detailedAnswersLog = getFromStorage('detailedAnswersLog', []);
            answerKeyModels = getFromStorage('answerKeyModels', {});
            
            loadSettings();

            if (Object.keys(answerKeyModels).length === 0) {
                answerKeyModels['نموذج أ'] = { name: "نموذج أ", subject: "", answers: [] };
            }
            updateModelsDropdown();
            if (studentsList.length > 0) displayStudentsList();
            if (resultsHistory.length > 0) updateHistoryDisplay();
            if (detailedAnswersLog.length > 0) document.getElementById('detailedHistorySection').classList.remove('hidden');
        }
        
        function toggleInstructions() {
            const content = document.getElementById('instructions-content');
            const arrow = document.getElementById('instructions-arrow');
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                arrow.textContent = '▼';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.textContent = '▲';
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg z-50 text-center ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { document.body.removeChild(notification); }, 3000);
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('capturedImage').src = e.target.result;
                document.getElementById('capturedSection').classList.remove('hidden');
                 processAnswers();
            };
            if (typeof file === 'string') {
                 reader.readAsDataURL(dataURItoBlob(file));
            } else {
                reader.readAsDataURL(file);
            }
        }
        
        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], {type: mimeString});
        }


        // === Student Management ===
        function downloadStudentsTemplate() {
            const wb = XLSX.utils.book_new();
            const data = [['اسم الطالب', 'الفصل'], ['فاطمة علي الزهراني', '1/أ'], ['محمد سالم القحطاني', '2/ب']];
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'قائمة الطلاب');
            XLSX.writeFile(wb, 'نموذج_قائمة_الطلاب.xlsx');
        }

        function parseStudentsFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (jsonData.length < 2) throw new Error("الملف فارغ");
                    const headers = jsonData[0].map(h => String(h).trim());
                    const nameIndex = headers.findIndex(h => h.includes('اسم'));
                    const classIndex = headers.findIndex(h => h.includes('فصل'));
                    if (nameIndex === -1 || classIndex === -1) throw new Error("لم يتم العثور على عمودي 'اسم الطالب' و 'الفصل'");
                    
                    const newStudents = jsonData.slice(1).map((row, i) => {
                        const name = String(row[nameIndex] || '').trim();
                        const className = String(row[classIndex] || '').trim();
                        if (name && className) {
                            return { id: Date.now() + i, name, class: className, corrected: false, result: null };
                        }
                        return null;
                    }).filter(s => s && !studentsList.some(os => os.name === s.name && os.class === s.class));
                    
                    let notificationMessage;
                    let notificationType = 'info';

                    if (newStudents.length > 0) {
                        studentsList.push(...newStudents);
                        localStorage.setItem('studentsList', JSON.stringify(studentsList));
                        notificationMessage = `تم إضافة ${newStudents.length} طالب جديد!`;
                        notificationType = 'success';
                    } else {
                        notificationMessage = 'لم يتم العثور على طلاب جدد (قد يكونون موجودين بالفعل في القائمة).';
                    }

                    displayStudentsList();
                    showNotification(notificationMessage, notificationType);

                } catch (error) {
                    showNotification(`خطأ في قراءة الملف: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayStudentsList() {
            document.getElementById('studentsListSection').classList.remove('hidden');
            updateStudentsStats();
            updateClassFilter();
            filterStudentsList();
            populateCorrectionStudentSelect();
        }

        function updateStudentsStats() {
            const total = studentsList.length;
            const corrected = studentsList.filter(s => s.corrected).length;
            document.getElementById('totalStudentsCount').textContent = total;
            document.getElementById('correctedCount').textContent = corrected;
            document.getElementById('pendingCount').textContent = total - corrected;
            document.getElementById('uniqueClassesCount').textContent = [...new Set(studentsList.map(s => s.class))].length;
        }

        function updateClassFilter() {
            const filterClass = document.getElementById('filterClass');
            const uniqueClasses = [...new Set(studentsList.map(s => s.class))].sort();
            filterClass.innerHTML = '<option value="">جميع الفصول</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterStudentsList() {
            const searchTerm = document.getElementById('searchStudentName').value.toLowerCase();
            const classFilter = document.getElementById('filterClass').value;
            const statusFilter = document.getElementById('filterStatus').value;
            const filtered = studentsList.filter(student => 
                (!searchTerm || student.name.toLowerCase().includes(searchTerm)) &&
                (!classFilter || student.class === classFilter) &&
                (!statusFilter || (statusFilter === 'corrected' ? student.corrected : !student.corrected))
            );
            const listDiv = document.getElementById('studentsList');
            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-gray-500 py-4">لا توجد نتائج.</div>';
                return;
            }
            listDiv.innerHTML = filtered.map(student => `
                <div class="flex items-center justify-between p-3 rounded-lg border ${student.corrected ? 'bg-green-50' : 'bg-gray-50'}">
                    <div>
                        <div class="font-semibold">${student.name}</div>
                        <div class="text-sm text-gray-600">الفصل: ${student.class}</div>
                        ${student.corrected ? `<div class="text-xs text-green-600">النتيجة: ${student.result.percentage} (${student.result.score})</div>` : `<div class="text-xs text-yellow-600">في الانتظار</div>`}
                    </div>
                    <div>
                        ${!student.corrected && !isMultipleCorrectionMode ? `<button onclick="selectStudent(${student.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">اختيار</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function selectStudent(studentId) {
            currentStudent = studentsList.find(s => s.id === parseInt(studentId));
            if (currentStudent) {
                document.getElementById('correctionStudentSelect').value = currentStudent.id;
                showNotification(`تم اختيار الطالب: ${currentStudent.name}. يمكنك الآن بدء التصحيح.`, 'success');
            }
        }

        function selectDifferentStudent() {
            currentStudent = null;
            document.getElementById('correctionStudentSelect').value = '';
        }
        
        function populateCorrectionStudentSelect() {
            const select = document.getElementById('correctionStudentSelect');
            select.innerHTML = '<option value="">-- اختر من القائمة --</option>';
            const pendingStudents = studentsList.filter(s => !s.corrected);
            pendingStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} - ${student.class}`;
                select.appendChild(option);
            });
        }

        function clearStudentsList() {
            if (confirm('هل أنت متأكد من حذف جميع الطلاب؟ سيتم حذف سجلات النتائج المرتبطة بهم أيضاً.')) {
                studentsList = [];
                resultsHistory = []; 
                detailedAnswersLog = [];
                localStorage.removeItem('studentsList');
                localStorage.removeItem('examResults');
                localStorage.removeItem('detailedAnswersLog');
                
                document.getElementById('studentsListSection').classList.add('hidden');
                updateStudentsStats(); 
                updateHistoryDisplay();
                document.getElementById('detailedHistorySection').classList.add('hidden');
                showNotification('تم مسح قائمة الطلاب وجميع السجلات.', 'success');
            }
        }

        // === Answer Key Models Management ===
        function updateModelsDropdown() {
            const select = document.getElementById('answerKeyModel');
            const currentModelName = select.value;
            select.innerHTML = '';
            Object.keys(answerKeyModels).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            select.value = currentModelName && answerKeyModels[currentModelName] ? currentModelName : Object.keys(answerKeyModels)[0];
            switchModel();
        }

        function switchModel() {
            const modelName = document.getElementById('answerKeyModel').value;
            if (!modelName) return;
            const modelData = answerKeyModels[modelName] || {};
            correctAnswers = modelData.answers || [];
            document.getElementById('questionCount').value = correctAnswers.length || 10;
            const subject = modelData.subject || '';
            document.getElementById('subjectName').value = subject;
            document.getElementById('examName').value = subject; // Link subject to exam name
            document.getElementById('answerSheet').classList.add('hidden');
            showNotification(`تم التحويل إلى "${modelName}"`, 'info');
        }

        function manageModels(action) {
            const select = document.getElementById('answerKeyModel');
            const currentName = select.value;
            let newName;

            switch(action) {
                case 'new':
                    newName = prompt("أدخل اسم النموذج الجديد (مثال: نموذج ب):");
                    if (newName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = { name: newName, subject: "", answers: [] };
                    } else if (newName) {
                        alert("هذا الاسم موجود بالفعل.");
                    }
                    break;
                case 'rename':
                    if (!currentName) return;
                    newName = prompt("أدخل الاسم الجديد للنموذج:", currentName);
                    if (newName && newName !== currentName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = answerKeyModels[currentName];
                        delete answerKeyModels[currentName];
                    } else if (newName) {
                        alert("لا يمكن التسمية باسم موجود بالفعل.");
                    }
                    break;
                case 'delete':
                    if (!currentName || Object.keys(answerKeyModels).length <= 1) {
                         alert("يجب أن يكون هناك نموذج واحد على الأقل.");
                        return;
                    }
                    if (confirm(`هل أنت متأكد من حذف نموذج "${currentName}"؟`)) {
                        delete answerKeyModels[currentName];
                    }
                    break;
            }
            localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));
            updateModelsDropdown();
        }

        // === Answer Sheet Setup ===
        function showManualEntry() {
            generateAnswerSheet();
        }

        function scanAnswerKey() {
            isScanningForKey = true;
            showNotification('الرجاء تصوير ورقة الإجابة الصحيحة.', 'info');
            showSection('correction');
            showCameraSection();
        }

        function generateAnswerSheet() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const optionsCount = parseInt(document.getElementById('optionsCount').value);
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            const modelName = document.getElementById('answerKeyModel').value;
            const modelData = answerKeyModels[modelName] || {};
            const currentAnswers = modelData.answers || [];

            for (let i = 1; i <= questionCount; i++) {
                answersGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">السؤال ${i}:</label>
                        <select id="answer${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            ${options.map(opt => `<option value="${opt}" ${opt === (currentAnswers[i-1] || 'A') ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            document.getElementById('answerSheet').classList.remove('hidden');
        }

        function saveCorrectAnswers() {
            const modelName = document.getElementById('answerKeyModel').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            correctAnswers = Array.from({ length: questionCount }, (_, i) => document.getElementById(`answer${i + 1}`).value);
            answerKeyModels[modelName] = {
                name: modelName,
                subject: document.getElementById('subjectName').value,
                answers: correctAnswers
            };
            localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));
            document.getElementById('examInfoSection').classList.remove('hidden');
            document.getElementById('answerSheet').classList.add('hidden');
            showNotification(`تم حفظ الإجابات لـ "${modelName}".`, 'success');
        }

        // === Camera and Image Processing ===
        async function showCameraSection() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera').srcObject = stream;
                document.getElementById('cameraSection').classList.remove('hidden');
                document.getElementById('uploadSection').classList.add('hidden');
                startAutoCapture();
            } catch (error) {
                showNotification('لا يمكن الوصول للكاميرا.', 'error');
            }
        }

        function startAutoCapture() {
            const countdownEl = document.getElementById('countdown');
            let count = 3;
            countdownEl.textContent = count;
            countdownEl.style.display = 'block';

            autoCaptureTimer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(autoCaptureTimer);
                    countdownEl.style.display = 'none';
                    captureAndProcess();
                }
            }, 1000);
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            if(autoCaptureTimer) clearInterval(autoCaptureTimer);
            document.getElementById('countdown').style.display = 'none';
            document.getElementById('cameraSection').classList.add('hidden');
            document.getElementById('capturedSection').classList.add('hidden');
        }

        function captureAndProcess() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            clearInterval(autoCaptureTimer);
            
            if (isScanningForKey) {
                 stopCamera();
            }

            handleImageFile(canvas.toDataURL('image/jpeg'));
        }

        function showUploadSection() {
            stopCamera();
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('cameraSection').classList.add('hidden');
        }
        
        async function processAnswers() {
            const modelName = document.getElementById('answerKeyModel').value;
            correctAnswers = answerKeyModels[modelName] ? answerKeyModels[modelName].answers : [];

            if (correctAnswers.length === 0 && !isScanningForKey) {
                showNotification('يرجى إعداد وحفظ الإجابات الصحيحة أولاً.', 'error'); return;
            }
            if (!currentStudent && !isMultipleCorrectionMode && !isScanningForKey) {
                showNotification('يرجى اختيار طالب أولاً.', 'error'); return;
            }

            const processBtn = document.getElementById('processBtn'), spinner = document.getElementById('processBtnSpinner'), btnText = document.getElementById('processBtnText');
            processBtn.disabled = true; spinner.classList.remove('hidden'); btnText.textContent = 'جاري التحليل...';
            
            try {
                const imageSrc = document.getElementById('capturedImage').src;
                const blob = dataURItoBlob(imageSrc);
                const formData = new FormData();
                formData.append('image', blob, 'answer_sheet.jpg');
                formData.append('num_questions', document.getElementById('questionCount').value);
                formData.append('options_per_q', document.getElementById('optionsCount').value);

                const response = await fetch('/api/correct', { method: 'POST', body: formData });
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'فشل في التحليل');
                
                if (isScanningForKey) {
                    isScanningForKey = false;
                    document.getElementById('capturedSection').classList.add('hidden');
                    const scannedAnswers = data.answers;
                    const questionCount = parseInt(document.getElementById('questionCount').value);
                    for (let i = 0; i < questionCount; i++) {
                        const select = document.getElementById(`answer${i + 1}`);
                        if (select && scannedAnswers[i]) {
                            select.value = scannedAnswers[i];
                        }
                    }
                    showNotification('تم مسح الإجابات بنجاح. يرجى مراجعتها ثم الحفظ.', 'success');
                    showManualEntry();
                    showSection('answer-key');

                } else {
                    studentAnswers = data.answers;
                    showAnswerVerification();
                    // Do not hide the captured section here
                }
            } catch (err) {
                showNotification(`فشل تحليل الصورة: ${err.message}`, 'error');
                resetForNewSheet();
            } finally {
                processBtn.disabled = false; spinner.classList.add('hidden'); btnText.textContent = '🔍 تحليل الإجابات';
            }
        }

        // === Verification and Results ===
        function showAnswerVerification() {
            const verificationGrid = document.getElementById('verificationGrid');
            const optionsCount = parseInt(document.getElementById('optionsCount').value);
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            verificationGrid.innerHTML = '';
            for (let i = 0; i < correctAnswers.length; i++) {
                const answer = studentAnswers[i] || 'فراغ';
                verificationGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">س ${i + 1}</label>
                        <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <option value="فراغ" ${answer === 'فراغ' ? 'selected' : ''}>فراغ</option>
                            ${options.map(opt => `<option value="${opt}" ${opt === answer ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>`;
            }
            document.getElementById('verificationSection').classList.remove('hidden');
        }

        function confirmAnswers() {
            studentAnswers = Array.from({ length: correctAnswers.length }, (_, i) => document.getElementById(`verify${i}`).value);
            document.getElementById('verificationSection').classList.add('hidden');
            document.getElementById('capturedSection').classList.add('hidden'); // Hide image after confirmation
            displayResults();
        }

        function displayResults() {
            let correctCount = 0;
            const detailedResults = document.getElementById('detailedResults');
            detailedResults.innerHTML = '';
            for (let i = 0; i < correctAnswers.length; i++) {
                const isCorrect = studentAnswers[i] === correctAnswers[i];
                if (isCorrect) correctCount++;
                detailedResults.innerHTML += `
                    <div class="p-3 rounded-lg text-white text-center font-medium ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                        <div class="text-sm">س ${i + 1}</div>
                        <div class="text-lg">${studentAnswers[i] || '∅'}</div>
                        <div class="text-xs">${isCorrect ? '✓' : `✗ (${correctAnswers[i]})`}</div>
                    </div>`;
            }
            const wrongCount = correctAnswers.length - correctCount;
            const percentage = Math.round((correctCount / correctAnswers.length) * 100);
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('letterGrade').textContent = getLetterGrade(percentage);
            const studentForDisplay = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
            document.getElementById('resultStudentName').textContent = studentForDisplay.name;
            document.getElementById('resultStudentClass').textContent = studentForDisplay.class;
            document.getElementById('resultExamName').textContent = document.getElementById('examName').value || 'غير محدد';
            document.getElementById('resultExamDate').textContent = document.getElementById('examDate').value;
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        function getLetterGrade(percentage) {
            if (percentage >= 90) return 'ممتاز';
            if (percentage >= 80) return 'جيد جداً';
            if (percentage >= 70) return 'جيد';
            if (percentage >= 60) return 'مقبول';
            return 'ضعيف';
        }

        function saveToHistory() {
            const studentForHistory = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
            const correctCount = parseInt(document.getElementById('correctCount').textContent);
            const totalQuestions = correctAnswers.length;
            const result = {
                id: Date.now(), studentName: studentForHistory.name, studentClass: studentForHistory.class,
                examName: document.getElementById('examName').value || 'غير محدد', examDate: document.getElementById('examDate').value,
                score: `${correctCount}/${totalQuestions}`, percentage: document.getElementById('scorePercentage').textContent, grade: document.getElementById('letterGrade').textContent,
            };
            const detailedResult = { ...result, answers: studentAnswers };
            resultsHistory.unshift(result); detailedAnswersLog.unshift(detailedResult);
            localStorage.setItem('examResults', JSON.stringify(resultsHistory));
            localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
            updateHistoryDisplay();
            document.getElementById('detailedHistorySection').classList.remove('hidden');
            const studentIndex = studentsList.findIndex(s => s.id === studentForHistory.id);
            if (studentIndex !== -1) {
                studentsList[studentIndex].corrected = true;
                studentsList[studentIndex].result = { percentage: result.percentage, score: result.score };
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                displayStudentsList();
            }
            if (isMultipleCorrectionMode) {
                handleMultiCorrectionNext(result);
            } else {
                resetForNewSheet();
            }
        }

        function resetForNewSheet() {
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('verificationSection').classList.add('hidden');
            document.getElementById('capturedSection').classList.add('hidden');
            selectDifferentStudent();
            showNotification('تم الحفظ! يمكنك الآن تصحيح ورقة جديدة.', 'success');
            
            if (stream) {
                startAutoCapture(); 
            } else {
                document.getElementById('uploadOptions').classList.remove('hidden');
            }
        }

        // === History Management ===
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            document.getElementById('historySection').classList.toggle('hidden', resultsHistory.length === 0);
            if (resultsHistory.length === 0) {
                historyList.innerHTML = '';
                return;
            }
            historyList.innerHTML = resultsHistory.map(r => `
                <div class="bg-gray-50 rounded-lg p-3 border-r-4 border-blue-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${r.studentName}</h4>
                            <p class="text-sm text-gray-600">${r.examName} - ${r.examDate}</p>
                        </div>
                        <div class="text-left">
                            <div class="text-lg font-bold text-blue-600">${r.percentage}</div>
                            <div class="text-sm font-semibold text-gray-700">(${r.score})</div>
                            <div class="text-xs text-gray-600">${r.grade}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function exportResults() {
             const studentName = document.getElementById('resultStudentName').textContent;
             const percentage = document.getElementById('scorePercentage').textContent;
             const report = `نتيجة الطالب: ${studentName}\nالنسبة: ${percentage}`;
             const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url; a.download = `نتيجة_${studentName}.txt`; a.click(); URL.revokeObjectURL(url);
        }

        function exportAllResults() {
            if (resultsHistory.length === 0) return;
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(resultsHistory);
            XLSX.utils.book_append_sheet(wb, ws, 'سجل النتائج');
            XLSX.writeFile(wb, 'سجل_النتائج_الكامل.xlsx');
        }

        function exportDetailedAnswersLog() {
            if (detailedAnswersLog.length === 0) { showNotification("لا يوجد سجل مفصل لتصديره.", "info"); return; }
            const maxQuestions = Math.max(...detailedAnswersLog.map(log => log.answers.length));
            const headers = ['اسم الطالب', 'الفصل', 'اسم الاختبار', 'التاريخ', 'الدرجة'];
            for(let i=1; i<= maxQuestions; i++) { headers.push(`س${i}`); }
            const data = detailedAnswersLog.map(log => {
                const row = {'اسم الطالب': log.studentName, 'الفصل': log.studentClass, 'اسم الاختبار': log.examName, 'التاريخ': log.examDate, 'الدرجة': log.score };
                log.answers.forEach((ans, i) => { row[`س${i+1}`] = ans; });
                return row;
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data, {header: headers});
            XLSX.utils.book_append_sheet(wb, ws, 'سجل إجابات الطلاب');
            XLSX.writeFile(wb, 'سجل_إجابات_الطلاب_المفصل.xlsx');
        }

        function clearHistory() {
             if (confirm('هل أنت متأكد من مسح السجل؟ لا يمكن التراجع عن هذا الإجراء.')) {
                resultsHistory = []; detailedAnswersLog = [];
                localStorage.removeItem('examResults');
                localStorage.removeItem('detailedAnswersLog');
                updateHistoryDisplay();
                document.getElementById('detailedHistorySection').classList.add('hidden');
             }
        }
        
        // === Multiple Correction Logic ===
        function toggleMultipleCorrection() {
             const uncorrected = studentsList.filter(s => !s.corrected);
             if (uncorrected.length === 0) { showNotification('جميع الطلاب تم تصحيح أوراقهم!', 'info'); return; }
             document.getElementById('multipleCorrectionSection').classList.toggle('hidden');
             selectDifferentStudent(); // Clear single selection
             showSection('correction');
        }

        function startMultipleCorrection() {
            multiCorrectionQueue = studentsList.filter(s => !s.corrected);
            if (multiCorrectionQueue.length === 0) { showNotification('لا توجد أوراق في انتظار التصحيح!', 'error'); return; }
            const modelName = document.getElementById('answerKeyModel').value;
            if (!answerKeyModels[modelName] || answerKeyModels[modelName].answers.length === 0) { showNotification('يرجى إعداد وحفظ الإجابات الصحيحة للنموذج الحالي أولاً!', 'error'); return; }
            isMultipleCorrectionMode = true; currentMultiIndex = 0; multiCorrectionResults = [];
            document.getElementById('multiCorrectionSetup').classList.add('hidden');
            document.getElementById('multiCorrectionActive').classList.remove('hidden');
            showCurrentMultiStudent();
            showNotification(`بدء التصحيح المتعدد لـ ${multiCorrectionQueue.length} طالب.`, 'success');
        }

        function showCurrentMultiStudent() {
            const student = multiCorrectionQueue[currentMultiIndex];
            document.getElementById('multiStudentName').textContent = student.name;
            document.getElementById('multiStudentClass').textContent = student.class;
            document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
            updateMultiCorrectionProgress();
        }

        function updateMultiCorrectionProgress() {
            const progress = ((currentMultiIndex) / multiCorrectionQueue.length) * 100;
            document.getElementById('progressText').textContent = `${currentMultiIndex} من ${multiCorrectionQueue.length}`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function handleMultiCorrectionNext(result) {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'completed', result });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent();
                resetForNewSheet();
                showNotification(`تم حفظ النتيجة. انتقل للطالب التالي: ${multiCorrectionQueue[currentMultiIndex].name}`, 'info');
            } else {
                completeMultipleCorrection();
            }
        }

        function skipCurrentStudent() {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'skipped', result: null });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent();
            } else {
                completeMultipleCorrection();
            }
        }

        function stopMultipleCorrection() {
             if (confirm('هل أنت متأكد من إنهاء التصحيح المتعدد؟')) {
                completeMultipleCorrection();
             }
        }

        function completeMultipleCorrection() {
            isMultipleCorrectionMode = false;
            document.getElementById('multiCorrectionActive').classList.add('hidden');
            if (multiCorrectionResults.length > 0) {
                generateMultiCorrectionReport();
            } else {
                resetMultiCorrection();
            }
             showNotification('تم إنهاء التصحيح المتعدد.', 'success');
        }

        function generateMultiCorrectionReport() {
            const corrected = multiCorrectionResults.filter(r => r.status === 'completed').length;
            const skipped = multiCorrectionResults.filter(r => r.status === 'skipped').length;
            const avgScore = corrected > 0 ? Math.round(multiCorrectionResults.filter(r=>r.result).reduce((sum, r) => sum + parseInt(r.result.percentage), 0) / corrected) : 0;
            document.getElementById('multiReportContent').innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-green-100 p-2 rounded-lg"><div class="font-bold text-lg">${corrected}</div><div class="text-xs">تم تصحيحها</div></div>
                    <div class="bg-yellow-100 p-2 rounded-lg"><div class="font-bold text-lg">${skipped}</div><div class="text-xs">تم تخطيها</div></div>
                    <div class="bg-blue-100 p-2 rounded-lg"><div class="font-bold text-lg">${avgScore}%</div><div class="text-xs">متوسط الدرجات</div></div>
                </div>
            `;
            document.getElementById('multiCorrectionReport').classList.remove('hidden');
        }

        function exportMultiReport() {
            const reportData = multiCorrectionResults.map(r => ({
                'اسم الطالب': r.student.name, 
                'الفصل': r.student.class, 
                'الحالة': r.status === 'completed' ? 'تم التصحيح' : 'تم التخطي', 
                'الدرجة': r.result ? r.result.score : '-',
                'النسبة': r.result ? r.result.percentage : '-',
            }));
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(reportData);
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير التصحيح');
            XLSX.writeFile(wb, 'تقرير_التصحيح_المتعدد.xlsx');
        }

        function resetMultiCorrection() {
            document.getElementById('multipleCorrectionSection').classList.add('hidden');
            document.getElementById('multiCorrectionSetup').classList.remove('hidden');
            document.getElementById('multiCorrectionReport').classList.add('hidden');
        }
        
        // === Reports Section ===
        function populateReportFilters() {
            const classFilter = document.getElementById('reportClassFilter');
            const examFilter = document.getElementById('reportExamFilter');

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

            classFilter.innerHTML = '<option value="">جميع الفصول</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">جميع الاختبارات</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }
        
        function generateClassReport() {
            const classFilter = document.getElementById('reportClassFilter').value;
            const examFilter = document.getElementById('reportExamFilter').value;
            const container = document.getElementById('report-container');

            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.studentClass === classFilter) &&
                (!examFilter || log.examName === examFilter)
            );

            if (filteredLogs.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">لا توجد بيانات تطابق هذه الفلاتر لإنشاء تقرير.</p>`;
                return;
            }
            
            const firstLog = filteredLogs[0];
            const modelName = Object.keys(answerKeyModels).find(key => 
                (answerKeyModels[key].subject === firstLog.examName || key === firstLog.examName) && 
                 answerKeyModels[key].answers.length === firstLog.answers.length
            );
            const reportCorrectAnswers = modelName ? answerKeyModels[modelName].answers : [];

            const scores = filteredLogs.map(log => parseInt(log.percentage));
            const avgScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            const maxScore = Math.max(...scores);
            const minScore = Math.min(...scores);
            
            const questionErrors = {};
            if (reportCorrectAnswers.length > 0) {
                for (let i = 0; i < reportCorrectAnswers.length; i++) {
                    questionErrors[i + 1] = { errors: 0, choices: {} };
                }
                filteredLogs.forEach(log => {
                    log.answers.forEach((studentAnswer, i) => {
                        if (studentAnswer !== reportCorrectAnswers[i]) {
                            questionErrors[i + 1].errors++;
                            if(studentAnswer !== 'فراغ'){
                                questionErrors[i + 1].choices[studentAnswer] = (questionErrors[i + 1].choices[studentAnswer] || 0) + 1;
                            }
                        }
                    });
                });
            }
            
            const sortedErrors = Object.entries(questionErrors).sort(([,a],[,b]) => b.errors - a.errors);
            const hardestQuestions = sortedErrors.slice(0, 3).map(([q]) => q);
            const easiestQuestions = sortedErrors.slice(-3).reverse().map(([q]) => q);

            const studentListHTML = filteredLogs.map(log => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span>${log.studentName}</span>
                    <span class="font-bold ${parseInt(log.percentage) >= 60 ? 'text-green-600' : 'text-red-600'}">${log.percentage} (${log.score})</span>
                </li>
            `).join('');

            let reportHTML = `
                <div id="printable-report" class="bg-white p-6 rounded-lg shadow-md">
                    <div class="text-center border-b pb-4 mb-4">
                        <h3 class="text-2xl font-bold">تقرير أداء الفصل</h3>
                        <p class="text-gray-600">${classFilter ? `للفصل: ${classFilter}`: 'لجميع الفصول'} - ${examFilter ? `اختبار: ${examFilter}` : 'لجميع الاختبارات'}</p>
                    </div>
                    
                    <h4 class="text-lg font-bold mb-2">ملخص الأداء</h4>
                    <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                        <div class="bg-blue-100 p-3 rounded-lg"><div class="font-bold text-xl">${avgScore}%</div><div class="text-xs">متوسط الدرجات</div></div>
                        <div class="bg-green-100 p-3 rounded-lg"><div class="font-bold text-xl">${maxScore}%</div><div class="text-xs">أعلى درجة</div></div>
                        <div class="bg-red-100 p-3 rounded-lg"><div class="font-bold text-xl">${minScore}%</div><div class="text-xs">أقل درجة</div></div>
                    </div>

                    <h4 class="text-lg font-bold mb-2">تحليل أولي للأسئلة</h4>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-red-50 p-3 rounded-lg">
                            <h5 class="font-semibold mb-1">الأصعب (الأكثر خطأً)</h5>
                            <p class="text-sm">${hardestQuestions.length > 0 ? 'الأسئلة رقم: ' + hardestQuestions.join(', ') : 'لا توجد بيانات كافية'}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <h5 class="font-semibold mb-1">الأسهل (الأقل خطأً)</h5>
                            <p class="text-sm">${easiestQuestions.length > 0 ? 'الأسئلة رقم: ' + easiestQuestions.join(', ') : 'لا توجد بيانات كافية'}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-center gap-4">
                        <button onclick="generateQuestionAnalysisReport()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">تحليل مفصل للأسئلة</button>
                        <button onclick="printReport('${classFilter}', '${examFilter}')" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">طباعة التقرير</button>
                    </div>
                </div>
            `;
            container.innerHTML = reportHTML;
        }

        function generateQuestionAnalysisReport() {
            // Re-filter logs to ensure we have the correct data
            const classFilter = document.getElementById('reportClassFilter').value;
            const examFilter = document.getElementById('reportExamFilter').value;
            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.studentClass === classFilter) &&
                (!examFilter || log.examName === examFilter)
            );
            if (filteredLogs.length === 0) return;
            const firstLog = filteredLogs[0];
            const modelName = Object.keys(answerKeyModels).find(key => 
                (answerKeyModels[key].subject === firstLog.examName || key === firstLog.examName) && 
                 answerKeyModels[key].answers.length === firstLog.answers.length
            );
            const reportCorrectAnswers = modelName ? answerKeyModels[modelName].answers : [];
            if (reportCorrectAnswers.length === 0) {
                 showNotification("لا يمكن إنشاء تحليل مفصل بدون نموذج إجابة مطابق.", "error");
                return;
            }

            const questionAnalysis = {};
            for (let i = 0; i < reportCorrectAnswers.length; i++) {
                questionAnalysis[i + 1] = { correct: 0, incorrect: 0, choices: {} };
            }

            filteredLogs.forEach(log => {
                log.answers.forEach((studentAnswer, i) => {
                    const questionNum = i + 1;
                    if (studentAnswer === reportCorrectAnswers[i]) {
                        questionAnalysis[questionNum].correct++;
                    } else {
                        questionAnalysis[questionNum].incorrect++;
                        const choice = studentAnswer || 'فراغ';
                        questionAnalysis[questionNum].choices[choice] = (questionAnalysis[questionNum].choices[choice] || 0) + 1;
                    }
                });
            });

             let reportHTML = `
                <div id="printable-analysis-report" class="bg-white p-6 rounded-lg shadow-md mt-6">
                     <div class="text-center border-b pb-4 mb-4">
                        <h3 class="text-2xl font-bold">تحليل الأسئلة المفصل</h3>
                        <p class="text-gray-600">${examFilter || 'الاختبار المحدد'}</p>
                    </div>
                    <div class="space-y-4">
            `;
            
            Object.entries(questionAnalysis).forEach(([qNum, data]) => {
                const totalAnswers = data.correct + data.incorrect;
                const correctPercentage = totalAnswers > 0 ? Math.round((data.correct / totalAnswers) * 100) : 0;
                const wrongChoices = Object.entries(data.choices).map(([choice, count]) => `${count} طالب اختاروا ${choice}`).join('، ');

                reportHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-lg">سؤال ${qNum} (الإجابة: ${reportCorrectAnswers[qNum-1]})</h4>
                            <span class="font-bold text-lg ${correctPercentage >= 70 ? 'text-green-600' : 'text-red-600'}">${correctPercentage}%</span>
                        </div>
                        <div class="text-sm grid grid-cols-2 gap-x-4">
                            <p><strong>صحيحة:</strong> ${data.correct}</p>
                            <p><strong>خاطئة:</strong> ${data.incorrect}</p>
                        </div>
                        ${data.incorrect > 0 ? `<p class="text-xs text-gray-500 mt-1">تفاصيل الأخطاء: ${wrongChoices}</p>` : ''}
                    </div>
                `;
            });

            reportHTML += `
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="printReportAnalysis()" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">طباعة تحليل الأسئلة</button>
                    </div>
                </div>
            `;
             document.getElementById('report-container').innerHTML += reportHTML;
        }
        
        function printReport(classFilter, examFilter) {
            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.studentClass === classFilter) &&
                (!examFilter || log.examName === examFilter)
            );
            const studentListHTML = filteredLogs.map(log => `
                <tr class="border-b">
                    <td class="p-2">${log.studentName}</td>
                    <td class="p-2 text-center">${log.score}</td>
                    <td class="p-2 text-center">${log.percentage}</td>
                </tr>
            `).join('');

            const reportContent = document.getElementById('printable-report').cloneNode(true);
            reportContent.querySelector('ul').outerHTML = `
                <table class="w-full text-sm mt-4">
                    <thead><tr class="border-b-2 border-black"><th class="p-2 text-right">اسم الطالب</th><th class="p-2">الدرجة</th><th class="p-2">النسبة</th></tr></thead>
                    <tbody>${studentListHTML}</tbody>
                </table>
            `;
            reportContent.querySelector('button').remove();
            
            const win = window.open('', 'Print', 'height=800,width=800');
            win.document.write(`<html><head><title>تقرير الأداء</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Cairo'}</style></head><body dir="rtl" class="p-4">${reportContent.innerHTML}</body></html>`);
            win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 500);
        }

        function printReportAnalysis() {
            const reportContent = document.getElementById('printable-analysis-report').innerHTML;
            const win = window.open('', 'Print', 'height=800,width=800');
            win.document.write(`<html><head><title>تحليل الأسئلة</title><script src="https://cdn.tailwindcss.com"><\/script><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"><style>body{font-family:'Cairo'}</style></head><body dir="rtl" class="p-4">${reportContent}</body></html>`);
            win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 500);
        }


        function printBlankSheet() {
            const qCount = parseInt(document.getElementById('questionCount').value);
            const oCount = parseInt(document.getElementById('optionsCount').value);
            const options = Array.from({ length: oCount }, (_, i) => String.fromCharCode(65 + i));
            const subjectName = document.getElementById('subjectName').value || 'غير محدد';
            const modelName = document.getElementById('answerKeyModel').value.replace('نموذج ', '');
            const splitPoint = Math.ceil(qCount / 2);

            let col1 = '';
            for (let i = 1; i <= splitPoint; i++) {
                col1 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col1 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col1 += `</div>`;
            }

            let col2 = '';
            for (let i = splitPoint + 1; i <= qCount; i++) {
                col2 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col2 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col2 += `</div>`;
            }

            const settings = getFromStorage('appSettings', {});
            const headerInfo = `
                <p>${settings.admin || ''}</p>
                <p>${settings.school || ''}</p>
                <h1>اختبار مادة: ${subjectName} - نموذج رقم (${modelName})</h1>
                <div class="sub-header">
                    <span>العام الدراسي: ${settings.year || ''}</span>
                    <span>الفصل الدراسي: ${settings.semester || ''}</span>
                </div>
            `;

            let content = `
                <style>
                    body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 20px; }
                    .page { max-width: 800px; margin: auto; }
                    .header-container { display: flex; justify-content: space-between; align-items: flex-start;  border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                    .header { text-align: center; flex-grow: 1; }
                    .header h1 { font-size: 1.5rem; font-weight: bold; margin: 5px 0;}
                    .header p { margin: 2px 0; font-size: 0.9rem; }
                    .sub-header { font-size: 0.9rem; color: #555; }
                    #qrcode-container { width: 80px; height: 80px; }
                    .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; font-size: 14px; }
                    .info-item { border-bottom: 1.5px dotted #888; padding-bottom: 8px; }
                    .columns-container { display: flex; justify-content: space-between; gap: 20px; }
                    .column { flex: 1; }
                    .separator { border-left: 1.5px dashed #ccc; }
                    .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
                    .q-num { font-weight: bold; width: 30px; }
                    .o-bubble { width: 22px; height: 22px; border: 1.5px solid black; border-radius: 50%; display: inline-block; }
                    .o-label { margin-left: -5px; margin-right: 8px; }
                    @media print { button { display: none; } }
                </style>
                <div class="page">
                    <div class="header-container">
                        <div id="qrcode-container"></div>
                        <div class="header">${headerInfo}</div>
                    </div>
                    <div class="info">
                        <div class="info-item"><strong>اسم الطالب:</strong></div>
                        <div class="info-item"><strong>الفصل:</strong></div>
                    </div>
                    <div class="columns-container">
                        <div class="column">${col1}</div>
                        ${qCount > 1 ? '<div class="separator"></div>' : ''}
                        <div class="column">${col2}</div>
                    </div>
                    <div style="text-align:center; margin-top: 30px;"><button onclick="window.print()">طباعة</button></div>
                </div>
            `;
            
            const win = window.open('', 'Print', 'height=800,width=800');
            win.document.write('<html><head><title>طباعة نموذج</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script></head><body>' + content + '</body></html>');
            win.document.close();

             setTimeout(() => { 
                if (win.QRCode) {
                    const qrData = JSON.stringify({ subject: subjectName, model: modelName, questions: qCount });
                    new win.QRCode(win.document.getElementById("qrcode-container"), { text: qrData, width: 80, height: 80, correctLevel : win.QRCode.CorrectLevel.H });
                }
                win.focus();
             }, 500);
        }
        
        // === Settings Section ===
        function saveSettings() {
            settings = {
                admin: document.getElementById('setting-admin').value,
                school: document.getElementById('setting-school').value,
                teacher: document.getElementById('setting-teacher').value,
                director: document.getElementById('setting-director').value,
                year: document.getElementById('setting-year').value,
                semester: document.getElementById('setting-semester').value,
            };
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('تم حفظ الإعدادات بنجاح!', 'success');
        }

        function loadSettings() {
            document.getElementById('setting-admin').value = settings.admin || '';
            document.getElementById('setting-school').value = settings.school || '';
            document.getElementById('setting-teacher').value = settings.teacher || '';
            document.getElementById('setting-director').value = settings.director || '';
            document.getElementById('setting-year').value = settings.year || '';
            document.getElementById('setting-semester').value = settings.semester || '';
        }

        function backupData() {
            const data = {
                appSettings: settings,
                studentsList: studentsList,
                examResults: resultsHistory,
                detailedAnswersLog: detailedAnswersLog,
                answerKeyModels: answerKeyModels,
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('تم إنشاء النسخة الاحتياطية بنجاح!', 'success');
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("هل أنت متأكد من استعادة البيانات؟ سيتم الكتابة فوق جميع البيانات الحالية.")) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.appSettings && data.studentsList && data.examResults) {
                        localStorage.setItem('appSettings', JSON.stringify(data.appSettings || {}));
                        localStorage.setItem('studentsList', JSON.stringify(data.studentsList || []));
                        localStorage.setItem('examResults', JSON.stringify(data.examResults || []));
                        localStorage.setItem('detailedAnswersLog', JSON.stringify(data.detailedAnswersLog || []));
                        localStorage.setItem('answerKeyModels', JSON.stringify(data.answerKeyModels || {}));
                        showNotification('تم استعادة البيانات بنجاح! سيتم إعادة تحميل الصفحة.', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        throw new Error("ملف غير صالح.");
                    }
                } catch (error) {
                    showNotification(`خطأ في استعادة البيانات: ${error.message}`, 'error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            const confirmation = prompt("للتأكيد، يرجى كتابة 'حذف' في المربع أدناه.");
            if (confirmation === 'حذف') {
                localStorage.clear();
                showNotification('تم حذف جميع البيانات بنجاح! سيتم إعادة تحميل الصفحة.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('لم يتم الحذف. الكتابة غير مطابقة.', 'info');
            }
        }
        
        // === Stats Section ===
        function updateGlobalStats() {
            const container = document.getElementById('stats-container');
            const totalCorrected = resultsHistory.length;
            const overallAverage = totalCorrected > 0 ? Math.round(resultsHistory.reduce((sum, r) => sum + parseInt(r.percentage), 0) / totalCorrected) : 0;
            const uniqueStudents = new Set(resultsHistory.map(r => r.studentName)).size;
            const uniqueExams = new Set(resultsHistory.map(r => r.examName)).size;

            container.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-600">${totalCorrected}</div>
                    <div class="text-sm">ورقة مصححة</div>
                </div>
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-600">${overallAverage}%</div>
                    <div class="text-sm">متوسط الأداء العام</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-purple-600">${uniqueStudents}</div>
                    <div class="text-sm">طالب فريد</div>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-yellow-600">${uniqueExams}</div>
                    <div class="text-sm">اختبار فريد</div>
                </div>
            `;
        }

    </script>
</body>
</html>

