<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª </title>
    <link rel="stylesheet" href="styles/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
    <style>
body {
    box-sizing: border-box;
}

.camera-container {
    position: relative;
    max-width: 100%;
    background: #1f2937;
    border-radius: 12px;
    overflow: hidden;
}

.overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 3px dashed #10b981;
    width: 80%;
    height: 60%;
    pointer-events: none;
    border-radius: 8px;
}

.result-animation {
    animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.correct-answer {
    background: linear-gradient(135deg, #10b981, #059669);
}

.wrong-answer {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.camera-button {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    transition: all 0.3s ease;
}

.camera-button:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}    </style>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ“± ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
            <p class="text-gray-600 text-lg">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ØªØµØ­ÙŠØ­ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ </p>
        </header>

        <main class="max-w-4xl mx-auto">
            <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                </h2>
                
                <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div class="bg-blue-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù Excel</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <button onclick="downloadStudentsTemplate()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium flex items-center justify-center gap-2">
                            ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel
                        </button>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        </div>
                    </div>
                    <p class="text-sm text-blue-700">
                        ğŸ’¡ Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠÙ†: "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" Ùˆ "Ø§Ù„ÙØµÙ„" (Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
                        <br>ğŸ“‹ ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª: .xlsx, .xls, .csv
                    </p>
                </div>

                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                <div id="studentsListSection" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="flex gap-2">
                            <button onclick="toggleMultipleCorrection()" id="multiCorrectionBtn"
                                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                ğŸ”„ ØªØµØ­ÙŠØ­ Ù…ØªØ¹Ø¯Ø¯
                            </button>
                            <button onclick="clearStudentsList()" 
                                    class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-blue-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                            <div class="text-xs text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                            <div class="text-xs text-green-800">ØªÙ… ØªØµØ­ÙŠØ­Ù‡Ø§</div>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                            <div class="text-xs text-yellow-800">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                            <div class="text-xs text-purple-800">Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</div>
                        </div>
                    </div>

                    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…:</label>
                                <input type="text" id="searchStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onkeyup="filterStudentsList()">
                            </div>
                            <div>
                                <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØµÙ„:</label>
                                <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterStudentsList()">
                                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                                </select>
                            </div>
                            <div>
                                <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ØªØµØ­ÙŠØ­:</label>
                                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onchange="filterStudentsList()">
                                    <option value="">Ø§Ù„ÙƒÙ„</option>
                                    <option value="corrected">ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­</option>
                                    <option value="pending">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ -->
                    <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                    </div>
                </div>

                <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ -->
                <div id="currentStudentSection" class="hidden bg-green-50 rounded-lg p-4 mb-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-3">ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-semibold" id="currentStudentName">-</div>
                            <div class="text-sm text-gray-600">
                                Ø§Ù„ÙØµÙ„: <span id="currentStudentClass">-</span>
                            </div>
                        </div>
                        <button onclick="selectDifferentStudent()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ØªØºÙŠÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                        <input type="number" id="questionCount" min="1" max="50" value="10" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„:</label>
                        <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="4">4 Ø®ÙŠØ§Ø±Ø§Øª (AØŒ BØŒ CØŒ D)</option>
                            <option value="5">5 Ø®ÙŠØ§Ø±Ø§Øª (AØŒ BØŒ CØŒ DØŒ E)</option>
                        </select>
                    </div>
                </div>
                <button onclick="generateAnswerSheet()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                </button>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© -->
            <div id="answerSheet" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</h3>
                <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                <button onclick="saveCorrectAnswers()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
                </button>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    ğŸ“· ØªØµÙˆÙŠØ± Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                </h2>
                
                <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ± ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„ -->
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <button onclick="showCameraSection()" id="cameraTabBtn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                        ğŸ“¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    </button>
                    <button onclick="showUploadSection()" id="uploadTabBtn"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">
                        ğŸ“ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©
                    </button>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
                <div id="cameraSection">
                    <div class="camera-container mb-4">
                        <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="overlay"></div>
                        <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg text-sm">
                            Ø¶Ø¹ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ù†Ù‚Ø·
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button onclick="startCamera()" id="startBtn"
                                class="camera-button text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                            ğŸ“¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                        </button>
                        <button onclick="captureImage()" id="captureBtn" disabled
                                class="bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed">
                            ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
                        </button>
                        <button onclick="stopCamera()" id="stopBtn" disabled
                                class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed disabled:bg-gray-400">
                            â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                        </button>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± -->
                <div id="uploadSection" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 border-t pt-4">ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</h3>
                    <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-50 file:text-blue-700
                        hover:file:bg-blue-100" />

                    <div id="imagePreviewContainer" class="mt-4 hidden border border-gray-300 rounded-lg p-2 max-h-96 overflow-y-auto">
                        <img id="imagePreview" class="w-full h-auto object-contain rounded-lg" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙˆØ±Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©" />
                    </div>

                    <div class="text-center mt-4">
                        <button onclick="processUploadedImage()" id="processUploadBtn" disabled
                                class="bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 mx-auto disabled:cursor-not-allowed">
                            ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø© -->
            <div id="capturedSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©:</h3>
                <img id="capturedImage" class="w-full max-w-md mx-auto rounded-lg shadow-md mb-4">
                <div class="text-center">
                    <button onclick="processAnswers()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium">
                        ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV
                    </button>
                </div>
            </div>
            <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
            <div id="studentInfoSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                        <select id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                onchange="updateStudentClass()">
                            <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option>
                        </select>
                    </div>
                    <div>
                        <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„ÙØµÙ„:</label>
                        <input type="text" id="studentClass" placeholder="Ø§Ù„ÙØµÙ„" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                        <input type="text" id="examName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª - Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                        <input type="date" id="examDate" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
            </div>

            <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµØ­ÙŠØ­ -->
            <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµØ­ÙŠØ­</h3>
                
                <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6 hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span id="resultStudentName">-</span></div>
                        <div><strong>Ø§Ù„ÙØµÙ„:</strong> <span id="resultStudentClass">-</span></div>
                        <div><strong>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> <span id="resultExamName">-</span></div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="resultExamDate">-</span></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="correctCount">0</div>
                        <div class="text-sm">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                    </div>
                    <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="wrongCount">0</div>
                        <div class="text-sm">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg text-center">
                        <div class="text-3xl font-bold" id="scorePercentage">0%</div>
                        <div class="text-sm">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold" id="letterGrade">-</div>
                        <div class="text-sm">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</div>
                    </div>
                </div>

                <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="exportResults()" 
                            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                    <button onclick="saveToHistory()" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
                    </button>
                    <button onclick="resetApp()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                        ğŸ”„ ØªØµØ­ÙŠØ­ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>

            <!-- Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
            <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ğŸ“š Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
                    <div class="flex gap-2">
                        <button onclick="exportAllResults()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                            ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„
                        </button>
                        <button onclick="toggleHistory()" id="historyToggle"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„
                        </button>
                    </div>
                </div>
                <div id="historyContent" class="hidden">
                    <div id="historyList" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="clearHistory()" 
                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                            ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª JavaScript -->
    <script>
	// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let correctAnswers = [];
let studentAnswers = [];
let startTime = null;
let resultsHistory = JSON.parse(localStorage.getItem('examResults') || '[]');

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
document.addEventListener('DOMContentLoaded', function() {
    updateHistoryDisplay();
    displayStudentsList();
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ
    document.getElementById('examDate').value = new Date().toISOString().split('T')[0];
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø·Ù„Ø§Ø¨
    document.getElementById('studentsFileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            parseStudentsFile(file);
        }
    });
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
    document.getElementById('imageInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = document.getElementById('imagePreview');
                const imagePreviewContainer = document.getElementById('imagePreviewContainer');
                const processBtn = document.getElementById('processUploadBtn');
                
                imagePreview.src = e.target.result;
                imagePreviewContainer.classList.remove('hidden');
                processBtn.disabled = false;
                processBtn.className = 'bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 mx-auto';
                
                showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù„ÙŠÙ„Ù‡Ø§.', 'success');
            };
            reader.readAsDataURL(file);
        }
    });
});

// ÙˆØ¸Ø§Ø¦Ù Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
function generateAnswerSheet() {
    const questionCount = parseInt(document.getElementById('questionCount').value);
    const optionsCount = parseInt(document.getElementById('optionsCount').value);
    const answersGrid = document.getElementById('answersGrid');
    const answerSheet = document.getElementById('answerSheet');
    
    answersGrid.innerHTML = '';
    
    const options = optionsCount === 4 ? ['A', 'B', 'C', 'D'] : ['A', 'B', 'C', 'D', 'E'];
    
    for (let i = 1; i <= questionCount; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'bg-gray-50 p-3 rounded-lg';
        questionDiv.innerHTML = `
            <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ ${i}:</label>
            <select id="answer${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</option>
                ${options.map(opt => `<option value="${opt}" ${opt === 'A' ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
        `;
        answersGrid.appendChild(questionDiv);
    }
    
    answerSheet.classList.remove('hidden');
}

function saveCorrectAnswers() {
    const questionCount = parseInt(document.getElementById('questionCount').value);
    correctAnswers = [];
    
    for (let i = 1; i <= questionCount; i++) {
        const answer = document.getElementById(`answer${i}`).value;
        if (!answer) {
            showNotification(`ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù„Ø³Ø¤Ø§Ù„ ${i}`, 'error');
            return;
        }
        correctAnswers.push(answer);
    }
    
    document.getElementById('studentInfoSection').classList.remove('hidden');
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØµÙˆÙŠØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.', 'success');
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV
function processAnswers() {
    if (correctAnswers.length === 0) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£ÙˆÙ„Ø§Ù‹!', 'error');
        return;
    }
    
    startTime = Date.now();
    
    const capturedImage = document.getElementById('capturedImage');
    showNotification('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV...', 'info');
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
    processImageWithOpenCV(capturedImage.src, correctAnswers.length)
        .then(results => {
            studentAnswers = results;
            displayResults();
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        });
}

function processUploadedImage() {
    if (correctAnswers.length === 0) {
        showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£ÙˆÙ„Ø§Ù‹!', 'error');
        return;
    }
    
    startTime = Date.now();
    
    const uploadedImage = document.getElementById('imagePreview');
    showNotification('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV...', 'info');
    
    processImageWithOpenCV(uploadedImage.src, correctAnswers.length)
        .then(results => {
            studentAnswers = results;
            displayResults();
            
            document.getElementById('capturedSection').classList.add('hidden');
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', error);
            showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
function displayResults() {
    let correctCount = 0;
    let wrongCount = 0;
    
    const detailedResults = document.getElementById('detailedResults');
    detailedResults.innerHTML = '';
    
    for (let i = 0; i < correctAnswers.length; i++) {
        const studentAnswer = studentAnswers[i];
        const correctAnswer = correctAnswers[i];
        const isCorrect = studentAnswer === correctAnswer;
        
        if (isCorrect) {
            correctCount++;
        } else {
            wrongCount++;
        }
        
        const resultDiv = document.createElement('div');
        let resultClass, statusIcon;
        
        if (isCorrect) {
            resultClass = 'correct-answer';
            statusIcon = 'âœ“';
        } else {
            resultClass = 'wrong-answer';
            statusIcon = 'âœ— ' + correctAnswer;
        }
        
        resultDiv.className = `p-3 rounded-lg text-white text-center font-medium ${resultClass}`;
        resultDiv.innerHTML = `
            <div class="text-sm">Ø³${i + 1}</div>
            <div class="text-lg">${studentAnswer}</div>
            <div class="text-xs">${statusIcon}</div>
        `;
        detailedResults.appendChild(resultDiv);
    }
    
    const percentage = Math.round((correctCount / correctAnswers.length) * 100);
    const letterGrade = getLetterGrade(percentage);
    const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
    
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('wrongCount').textContent = wrongCount;
    document.getElementById('scorePercentage').textContent = percentage + '%';
    document.getElementById('letterGrade').textContent = letterGrade;
    
    updateStudentResultInfo();
    
    document.getElementById('resultsSection').classList.remove('hidden');
    
    showNotification('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV!', 'success');
}

function getLetterGrade(percentage) {
    if (percentage >= 90) return 'Ù…Ù…ØªØ§Ø²';
    if (percentage >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
    if (percentage >= 70) return 'Ø¬ÙŠØ¯';
    if (percentage >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„';
    return 'Ø±Ø§Ø³Ø¨';
}

function updateStudentResultInfo() {
    const studentName = document.getElementById('studentName').value;
    const studentClass = document.getElementById('studentClass').value;
    const examName = document.getElementById('examName').value;
    const examDate = document.getElementById('examDate').value;
    
    if (studentName || studentClass || examName || examDate) {
        document.getElementById('resultStudentName').textContent = studentName || '-';
        document.getElementById('resultStudentClass').textContent = studentClass || '-';
        document.getElementById('resultExamName').textContent = examName || '-';
        document.getElementById('resultExamDate').textContent = examDate || '-';
        document.getElementById('studentResultInfo').classList.remove('hidden');
    }
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„
function toggleHistory() {
    const historyContent = document.getElementById('historyContent');
    const toggleBtn = document.getElementById('historyToggle');
    
    if (historyContent.classList.contains('hidden')) {
        historyContent.classList.remove('hidden');
        toggleBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„';
        updateHistoryDisplay();
    } else {
        historyContent.classList.add('hidden');
        toggleBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„';
    }
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    
    if (resultsHistory.length === 0) {
        historyList.innerHTML = '<div class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯</div>';
        return;
    }
    
    historyList.innerHTML = resultsHistory.map(result => `
        <div class="bg-gray-50 rounded-lg p-4 border-r-4 border-blue-500">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <h4 class="font-semibold text-gray-800">${result.studentName}</h4>
                    <p class="text-sm text-gray-600">${result.examName}</p>
                </div>
                <div class="text-left">
                    <div class="text-lg font-bold text-blue-600">${result.percentage}</div>
                    <div class="text-sm text-gray-600">${result.grade}</div>
                </div>
            </div>
            <div class="flex justify-between text-xs text-gray-500">
                <span>${result.timestamp}</span>
            </div>
        </div>
    `).join('');
}

function saveToHistory() {
    const studentName = document.getElementById('studentName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const studentClass = document.getElementById('studentClass').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const examName = document.getElementById('examName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const examDate = document.getElementById('examDate').value || new Date().toLocaleDateString('ar-SA');
    
    const result = {
        id: Date.now(),
        studentName,
        studentClass,
        examName,
        examDate,
        correctCount: parseInt(document.getElementById('correctCount').textContent),
        wrongCount: parseInt(document.getElementById('wrongCount').textContent),
        percentage: document.getElementById('scorePercentage').textContent,
        grade: document.getElementById('letterGrade').textContent,
        timestamp: new Date().toLocaleString('ar-SA')
    };
    
    resultsHistory.unshift(result);
    localStorage.setItem('examResults', JSON.stringify(resultsHistory));
    updateHistoryDisplay();
    
    updateStudentCorrectionStatus(result);
    
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

function updateStudentCorrectionStatus(result) {
    const student = studentsList.find(s => 
        s.name === result.studentName && s.class === result.studentClass
    );
    
    if (student) {
        student.corrected = true;
        student.result = {
            correctCount: result.correctCount,
            wrongCount: result.wrongCount,
            percentage: result.percentage,
            grade: result.grade
        };
        student.timestamp = result.timestamp;
        
        localStorage.setItem('studentsList', JSON.stringify(studentsList));
        displayStudentsList();
    }
}

function clearHistory() {
    if (resultsHistory.length === 0) {
        showNotification('Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº Ø¨Ø§Ù„ÙØ¹Ù„!', 'info');
        return;
    }
    
    resultsHistory = [];
    localStorage.removeItem('examResults');
    updateHistoryDisplay();
    showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

function exportResults() {
    const studentName = document.getElementById('studentName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const studentClass = document.getElementById('studentClass').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const examName = document.getElementById('examName').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const examDate = document.getElementById('examDate').value || new Date().toLocaleDateString('ar-SA');
    
    const correctCount = parseInt(document.getElementById('correctCount').textContent);
    const wrongCount = parseInt(document.getElementById('wrongCount').textContent);
    const percentage = document.getElementById('scorePercentage').textContent;
    const grade = document.getElementById('letterGrade').textContent;
    
    const reportContent = `
ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
====================

Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:
- Ø§Ù„Ø§Ø³Ù…: ${studentName}
- Ø§Ù„ÙØµÙ„: ${studentClass}
- Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${examName}
- ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${examDate}

Ø§Ù„Ù†ØªØ§Ø¦Ø¬:
- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctCount}
- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${wrongCount}
- Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${percentage}
- Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: ${grade}

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:
${correctAnswers.map((correct, i) => 
    `Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}: ${studentAnswers[i]} ${studentAnswers[i] === correct ? 'âœ“' : 'âœ— (Ø§Ù„ØµØ­ÙŠØ­Ø©: ' + correct + ')'}`
).join('\n')}

ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ: ${new Date().toLocaleString('ar-SA')}
            `;
    
    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Ù†ØªÙŠØ¬Ø©_${studentName}_${examName}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

function exportAllResults() {
    if (resultsHistory.length === 0) {
        showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!', 'error');
        return;
    }
    
    const csvContent = 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„ÙØµÙ„,Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±,ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±,Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©,Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©,Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©,Ø§Ù„ØªÙ‚Ø¯ÙŠØ±,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ­ÙŠØ­\n' +
        resultsHistory.map(result => 
            `"${result.studentName}","${result.studentClass}","${result.examName}","${result.examDate}",${result.correctCount},${result.wrongCount},"${result.percentage}","${result.grade}","${result.timestamp}"`
        ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Ø¬Ù…ÙŠØ¹_Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª_${new Date().toLocaleDateString('ar-SA')}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
}

// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 ${
        type === 'success' ? 'bg-green-600' :
        type === 'error' ? 'bg-red-600' :
        type === 'info' ? 'bg-blue-600' : 'bg-gray-600'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

function resetApp() {
    document.getElementById('capturedSection').classList.add('hidden');
    document.getElementById('resultsSection').classList.add('hidden');
    document.getElementById('studentInfoSection').classList.add('hidden');
    document.getElementById('studentResultInfo').classList.add('hidden');
    
    document.getElementById('studentName').value = '';
    document.getElementById('studentClass').value = '';
    document.getElementById('examName').value = '';
    document.getElementById('examDate').value = '';
    
    studentAnswers = [];
    startTime = null;
    
    updateStudentNameDropdown();
    
    showNotification('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØªØµØ­ÙŠØ­ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©!', 'info');
}

function showCameraSection() {
    document.getElementById('cameraSection').classList.remove('hidden');
    document.getElementById('uploadSection').classList.add('hidden');
    document.getElementById('cameraTabBtn').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    document.getElementById('uploadTabBtn').className = 'flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
}

// ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
async function processImageWithOpenCV(imageSrc, questionCount) {
    if (!cvReady) {
        throw new Error('OpenCV ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
    }

    return new Promise((resolve, reject) => {
        try {
            const img = new Image();
            img.onload = async function() {
                try {
                    showNotification('ğŸ” Ø¬Ø§Ø±ÙŠ ØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©...', 'info');
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± canvas Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // ØªØ­ÙˆÙŠÙ„ canvas Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© OpenCV
                    const src = cv.imread(canvas);
                    
                    // ØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©
                    const quality = assessImageQuality(src);
                    
                    if (quality.quality === 'Ø¶Ø¹ÙŠÙØ©') {
                        showNotification(`âš ï¸ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ${quality.quality}. ${quality.suggestions.join(' ')}`, 'warning');
                    } else {
                        showNotification('âœ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¬ÙŠØ¯Ø©ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...', 'success');
                    }
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø®Ø·ÙˆØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©
                    const processedImage = await advancedImageProcessing(src);
                    
                    // ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©
                    const answers = await detectAnswersWithHighAccuracy(processedImage, questionCount, src);
                    
                    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                    src.delete();
                    processedImage.delete();
                    
                    resolve(answers);
                } catch (error) {
                    reject(error);
                }
            };
            
            img.onerror = function() {
                reject(new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
            };
            
            img.src = imageSrc;
        } catch (error) {
            reject(error);
        }
    });
}

// Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function addQualityCheckSection() {
    const cameraSection = document.getElementById('cameraSection');
    const qualityCheckHTML = `
        <div id="qualityCheck" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <h4 class="font-semibold text-yellow-800 mb-2">ğŸ“Š ØªÙ‚ÙŠÙŠÙ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©</h4>
            <div id="qualityResults" class="text-sm text-yellow-700">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    `;
    
    cameraSection.insertAdjacentHTML('afterbegin', qualityCheckHTML);
}

// ØªØ­Ø¯ÙŠØ« ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ´Ù…Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©
function captureImageWithQualityCheck() {
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.9);
    const capturedImage = document.getElementById('capturedImage');
    capturedImage.src = imageData;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©
    checkImageQuality(canvas);
    
    document.getElementById('capturedSection').classList.remove('hidden');
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©
async function checkImageQuality(canvas) {
    try {
        showNotification('ğŸ” Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©...', 'info');
        
        const src = cv.imread(canvas);
        const quality = assessImageQuality(src);
        
        const qualityCheck = document.getElementById('qualityCheck');
        const qualityResults = document.getElementById('qualityResults');
        
        qualityCheck.classList.remove('hidden');
        qualityResults.innerHTML = `
            <div class="grid grid-cols-2 gap-2 mb-2">
                <div>Ø§Ù„ØªØ¨Ø§ÙŠÙ†:</div>
                <div class="font-semibold ${quality.contrast > 30 ? 'text-green-600' : 'text-red-600'}">
                    ${quality.contrast.toFixed(1)}
                </div>
                <div>Ø§Ù„ÙˆØ¶ÙˆØ­:</div>
                <div class="font-semibold ${quality.sharpness > 100 ? 'text-green-600' : 'text-red-600'}">
                    ${quality.sharpness.toFixed(1)}
                </div>
                <div>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…:</div>
                <div class="font-semibold ${quality.quality === 'Ø¬ÙŠØ¯Ø©' ? 'text-green-600' : 'text-red-600'}">
                    ${quality.quality}
                </div>
            </div>
            ${quality.suggestions.length > 0 ? `
                <div class="mt-2">
                    <strong>Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªØ­Ø³ÙŠÙ†:</strong>
                    <ul class="list-disc list-inside mt-1">
                        ${quality.suggestions.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `;
        
        if (quality.quality === 'Ø¬ÙŠØ¯Ø©') {
            showNotification('âœ… Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ù…ØªØ§Ø²Ø©! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„.', 'success');
        } else {
            showNotification('âš ï¸ Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© ØªØ­ØªØ§Ø¬ Ù„Ù„ØªØ­Ø³ÙŠÙ† Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ø£ÙØ¶Ù„.', 'warning');
        }
        
        src.delete();
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©:', error);
    }
}
function showUploadSection() {
    document.getElementById('cameraSection').classList.add('hidden');
    document.getElementById('uploadSection').classList.remove('hidden');
    document.getElementById('cameraTabBtn').className = 'flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    document.getElementById('uploadTabBtn').className = 'flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors';
    
    if (stream) {
        stopCamera();
    }
}
// Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
let studentsList = JSON.parse(localStorage.getItem('studentsList') || '[]');
let currentStudent = null;
let isMultipleCorrectionMode = false;
let multiCorrectionQueue = [];
let currentMultiIndex = 0;
let multiCorrectionResults = [];

// ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨
function downloadStudentsTemplate() {
    const wb = XLSX.utils.book_new();
    
    const data = [
        ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„ÙØµÙ„'],
        ['ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ', '1Ø£'],
        ['Ù…Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ø£Ø­Ù…Ø¯ Ø§Ù„Ù‚Ø­Ø·Ø§Ù†ÙŠ', '2Ø¨'],
        ['Ù†ÙˆØ±Ø§ Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¹ØªÙŠØ¨ÙŠ', '2Ø¨'],
        ['Ø®Ø§Ù„Ø¯ ÙŠÙˆØ³Ù Ø³Ø¹Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ', '3Ø¬'],
        ['Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ', '1Ø£'],
        ['Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø³Ø¹Ø¯ Ø¹Ù„ÙŠ Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ', '2Ø¨'],
        ['Ù…Ø±ÙŠÙ… Ø®Ø§Ù„Ø¯ Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ', '3Ø¬']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // ØªÙ†Ø³ÙŠÙ‚
    ws['A1'].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFF00" } } };
    ws['B1'].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFFF00" } } };
    
    ws['!cols'] = [
        { wch: 30 },
        { wch: 10 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨');
    XLSX.writeFile(wb, 'Ù†Ù…ÙˆØ°Ø¬_Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø·Ù„Ø§Ø¨.xlsx');
    
    showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Excel! Ø§Ù…Ù„Ø£Ù‡ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø«Ù… Ø§Ø±ÙØ¹Ù‡.', 'success');
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„Ø·Ù„Ø§Ø¨
function parseStudentsFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            let jsonData;
            
            if (file.name.toLowerCase().endsWith('.csv')) {
                const csvText = e.target.result;
                const lines = csvText.split('\n').filter(line => line.trim());
                jsonData = lines.map(line => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            result.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    result.push(current.trim());
                    return result;
                });
            } else {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            }
            
            if (jsonData.length < 2) {
                showNotification('Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨!', 'error');
                return;
            }
            
            const students = [];
            const headers = jsonData[0].map(h => String(h).trim());
            
            const nameIndex = headers.findIndex(h => 
                h.includes('Ø§Ø³Ù…') || h.includes('Ø§Ù„Ø§Ø³Ù…') || 
                h.toLowerCase().includes('name') || 
                h.toLowerCase().includes('student')
            );
            
            const classIndex = headers.findIndex(h => 
                h.includes('ÙØµÙ„') || h.includes('Ø§Ù„ÙØµÙ„') || 
                h.includes('ØµÙ') || h.includes('Ø§Ù„ØµÙ') ||
                h.toLowerCase().includes('class') || 
                h.toLowerCase().includes('grade')
            );
            
            if (nameIndex === -1) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…!', 'error');
                return;
            }
            
            if (classIndex === -1) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙØµÙ„!', 'error');
                return;
            }
            
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > Math.max(nameIndex, classIndex)) {
                    const name = String(row[nameIndex] || '').trim();
                    const className = String(row[classIndex] || '').trim();
                    
                    if (name && className) {
                        students.push({
                            id: Date.now() + i + Math.random() * 1000,
                            name: name,
                            studentId: `ST${String(Date.now() + i).slice(-6)}`,
                            class: className,
                            corrected: false,
                            result: null,
                            timestamp: null
                        });
                    }
                }
            }
            
            if (students.length === 0) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù!', 'error');
                return;
            }
            
            const existingNames = studentsList.map(s => s.name);
            const newStudents = students.filter(s => !existingNames.includes(s.name));
            
            if (newStudents.length === 0) {
                showNotification('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ÙˆÙ† Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©!', 'info');
                return;
            }
            
            studentsList = [...studentsList, ...newStudents];
            localStorage.setItem('studentsList', JSON.stringify(studentsList));
            displayStudentsList();
            
            showNotification(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${newStudents.length} Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:', error);
            showNotification('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù! ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ­ÙŠØ­ ÙˆØºÙŠØ± Ù…Ø­Ù…ÙŠ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.', 'error');
        }
    };
    
    if (file.name.toLowerCase().endsWith('.csv')) {
        reader.readAsText(file, 'UTF-8');
    } else {
        reader.readAsArrayBuffer(file);
    }
}

// Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
function displayStudentsList() {
    const studentsListSection = document.getElementById('studentsListSection');
    const studentsList_div = document.getElementById('studentsList');
    
    if (studentsList.length === 0) {
        studentsListSection.classList.add('hidden');
        return;
    }
    
    studentsListSection.classList.remove('hidden');
    updateStudentsStats();
    updateClassFilter();
    updateStudentNameDropdown();
    filterStudentsList();
}

function updateStudentNameDropdown() {
    const studentNameSelect = document.getElementById('studentName');
    const currentValue = studentNameSelect.value;
    
    studentNameSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</option>';
    
    const uncorrectedStudents = studentsList.filter(s => !s.corrected);
    uncorrectedStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.name;
        option.textContent = student.name;
        studentNameSelect.appendChild(option);
    });
    
    if (currentValue && uncorrectedStudents.find(s => s.name === currentValue)) {
        studentNameSelect.value = currentValue;
        updateStudentClass();
    }
}

function updateStudentClass() {
    const studentSelect = document.getElementById('studentName');
    const studentClassInput = document.getElementById('studentClass');
    
    if (studentSelect.value) {
        const selectedStudent = studentsList.find(s => s.name === studentSelect.value);
        if (selectedStudent) {
            studentClassInput.value = selectedStudent.class;
        }
    } else {
        studentClassInput.value = '';
    }
}

function updateStudentsStats() {
    const totalStudents = studentsList.length;
    const correctedStudents = studentsList.filter(s => s.corrected).length;
    const pendingStudents = totalStudents - correctedStudents;
    const uniqueClasses = [...new Set(studentsList.map(s => s.class))].length;
    
    document.getElementById('totalStudentsCount').textContent = totalStudents;
    document.getElementById('correctedCount').textContent = correctedStudents;
    document.getElementById('pendingCount').textContent = pendingStudents;
    document.getElementById('uniqueClassesCount').textContent = uniqueClasses;
}

function updateClassFilter() {
    const filterClass = document.getElementById('filterClass');
    const uniqueClasses = [...new Set(studentsList.map(s => s.class))];
    
    filterClass.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' +
        uniqueClasses.map(cls => `<option value="${cls}">${cls}</option>`).join('');
}

function filterStudentsList() {
    const searchTerm = document.getElementById('searchStudentName').value.toLowerCase();
    const classFilter = document.getElementById('filterClass').value;
    const statusFilter = document.getElementById('filterStatus').value;
    
    let filteredStudents = [...studentsList];
    
    if (searchTerm) {
        filteredStudents = filteredStudents.filter(student => 
            student.name.toLowerCase().includes(searchTerm)
        );
    }
    
    if (classFilter) {
        filteredStudents = filteredStudents.filter(student => 
            student.class === classFilter
        );
    }
    
    if (statusFilter) {
        filteredStudents = filteredStudents.filter(student => 
            statusFilter === 'corrected' ? student.corrected : !student.corrected
        );
    }
    
    displayFilteredStudents(filteredStudents);
}

function displayFilteredStudents(students) {
    const studentsList_div = document.getElementById('studentsList');
    
    if (students.length === 0) {
        studentsList_div.innerHTML = '<div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>';
        return;
    }
    
    studentsList_div.innerHTML = students.map(student => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border ${student.corrected ? 'border-green-300 bg-green-50' : 'border-gray-200'}">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center ${student.corrected ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'}">
                    ${student.corrected ? 'âœ“' : student.name.charAt(0)}
                </div>
                <div>
                    <div class="font-semibold text-gray-800">${student.name}</div>
                    <div class="text-sm text-gray-600">${student.studentId} | ${student.class}</div>
                    ${student.corrected ? `<div class="text-xs text-green-600">ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ${student.result?.percentage || '-'}</div>` : ''}
                </div>
            </div>
            <div class="flex gap-2">
                ${!student.corrected ? `
                    <button onclick="selectStudent(${student.id})" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        Ø§Ø®ØªÙŠØ§Ø±
                    </button>
                ` : `
                    <button onclick="viewStudentResult(${student.id})" 
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                    </button>
                `}
                <button onclick="editStudent(${student.id})" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                    ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button onclick="deleteStudent(${student.id})" 
                        class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                    Ø­Ø°Ù
                </button>
            </div>
        </div>
    `).join('');
}

function selectStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    currentStudent = student;
    
    document.getElementById('studentName').value = student.name;
    document.getElementById('studentClass').value = student.class;
    
    document.getElementById('currentStudentName').textContent = student.name;
    document.getElementById('currentStudentClass').textContent = student.class;
    document.getElementById('currentStudentSection').classList.remove('hidden');
    
    showNotification(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`, 'success');
}

function selectDifferentStudent() {
    document.getElementById('currentStudentSection').classList.add('hidden');
    currentStudent = null;
    document.getElementById('studentName').value = '';
    document.getElementById('studentClass').value = '';
}

function editStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', student.name);
    if (newName && newName.trim()) {
        student.name = newName.trim();
    }
    
    const newClass = prompt('Ø§Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', student.class);
    if (newClass && newClass.trim()) {
        student.class = newClass.trim();
    }
    
    localStorage.setItem('studentsList', JSON.stringify(studentsList));
    displayStudentsList();
    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨!', 'success');
}

function deleteStudent(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student) return;
    
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}ØŸ`)) {
        studentsList = studentsList.filter(s => s.id !== studentId);
        localStorage.setItem('studentsList', JSON.stringify(studentsList));
        displayStudentsList();
        
        if (currentStudent && currentStudent.id === studentId) {
            selectDifferentStudent();
        }
        
        showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨!', 'success');
    }
}

function viewStudentResult(studentId) {
    const student = studentsList.find(s => s.id === studentId);
    if (!student || !student.result) return;
    
    const result = student.result;
    const modalContent = `
        <div class="text-center">
            <div class="mb-4">
                <h4 class="text-lg font-semibold">${student.name}</h4>
                <p class="text-sm text-gray-600">${student.studentId} | ${student.class}</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-green-100 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-600">${result.correctCount}</div>
                    <div class="text-sm text-green-800">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                </div>
                <div class="bg-red-100 p-3 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">${result.wrongCount}</div>
                    <div class="text-sm text-red-800">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                </div>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg">
                <div class="text-3xl font-bold text-blue-600">${result.percentage}</div>
                <div class="text-sm text-blue-800">${result.grade}</div>
            </div>
            <div class="mt-4 text-xs text-gray-500">
                ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­: ${student.timestamp}
            </div>
        </div>
    `;
    
    showModal(`Ù†ØªÙŠØ¬Ø© ${student.name}`, modalContent);
}

function clearStudentsList() {
    if (studentsList.length === 0) {
        showNotification('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ø¨Ø§Ù„ÙØ¹Ù„!', 'info');
        return;
    }
    
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ')) {
        studentsList = [];
        localStorage.removeItem('studentsList');
        displayStudentsList();
        selectDifferentStudent();
        showNotification('ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨!', 'success');
    }
}

function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">${title}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">âœ•</button>
            </div>
            ${content}
        </div>
    `;
    document.body.appendChild(modal);
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
let stream = null;

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            } 
        });
        
        const video = document.getElementById('camera');
        video.srcObject = stream;
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('captureBtn').disabled = false;
        document.getElementById('captureBtn').className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2';
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('stopBtn').className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2';
        
    } catch (error) {
        showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§.', 'error');
    }
}

// Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
function captureImage() {
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    const capturedImage = document.getElementById('capturedImage');
    capturedImage.src = imageData;
    
    document.getElementById('capturedSection').classList.remove('hidden');
    showNotification('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.', 'success');
}

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('captureBtn').disabled = true;
    document.getElementById('captureBtn').className = 'bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed';
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('stopBtn').className = 'bg-gray-400 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 disabled:cursor-not-allowed';
}

async function processImageWithAI(imageSrc) {
    const res = await fetch(imageSrc);
    const blob = await res.blob();
    const formData = new FormData();
    formData.append('image', blob);
    const response = await fetch('/correct', { method: 'POST', body: formData });
    return await response.json();
}

	</script>
	
</body>
</html>
