<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px dashed #10b981;
            width: 80%;
            height: 60%;
            pointer-events: none;
            border-radius: 8px;
        }
        .countdown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0,0,0,0.7);
            opacity: 0;
            animation: fadeInOut 1s infinite;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .app-section {
            display: none;
        }
        .app-section.active {
            display: block;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Styles for report question analysis colors */
        .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } /* Light red */
        .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } /* Light orange */
        .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } /* Light green */
        .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } /* Lighter green */

        /* Print-specific styles */
        @media print {
            body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            button, input, select, aside, #menu-button { display: none !important; }
            main { margin: 0 !important; padding: 0 !important; }
            .app-section { display: none !important; } /* Hide all sections */
            #printable-report-content { display: block !important; } /* Show only print content */
            .bg-white { box-shadow: none !important; border: 1px solid #ccc; }
            .text-xs { font-size: 0.7rem !important; }
            .text-sm { font-size: 0.8rem !important; }
            .text-lg { font-size: 1rem !important; }
            .text-xl { font-size: 1.1rem !important; }
            .text-2xl { font-size: 1.2rem !important; }
            .font-bold { font-weight: bold !important; }
            .p-1 { padding: 0.25rem !important; }
            .p-2 { padding: 0.5rem !important; }
            .p-3 { padding: 0.75rem !important; }
            .mb-1 { margin-bottom: 0.25rem !important; }
            .mb-2 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 1rem !important; }
            .mt-4 { margin-top: 1rem !important; }
            .mt-6 { margin-top: 1.5rem !important; }
            .gap-4 { gap: 1rem !important; }
            .grid { display: grid !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
            .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
            .text-center { text-align: center !important; }
            .text-right { text-align: right !important; }
            .border { border-width: 1px !important; }
            .border-b { border-bottom-width: 1px !important; }
            .border-b-2 { border-bottom-width: 2px !important; }
            .border-black { border-color: black !important; }
            .border-gray-300 { border-color: #d1d5db !important; }
            .rounded-lg { border-radius: 0.5rem !important; }
            .w-full { width: 100% !important; }
            .mx-auto { margin-left: auto !important; margin-right: auto !important; }
            table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; }
            td, th { border: 1px solid #ddd !important; padding: 8px !important; text-align: center !important; }
            th { background-color: #f2f2f2 !important; font-weight: bold !important;}
            tr:nth-child(even){background-color: #f9f9f9 !important;}
             /* Ensure colored backgrounds print */
            .bg-blue-100 { background-color: #DBEAFE !important; }
            .bg-green-100 { background-color: #DCFCE7 !important; }
            .bg-red-100 { background-color: #FEE2E2 !important; }
            .bg-gray-50 { background-color: #F9FAFB !important; }
            .bg-gray-100 { background-color: #F3F4F6 !important; }

            /* Specific report styles */
            #printable-report-content .text-red-700 { color: #b91c1c !important; }
            #printable-report-content .text-green-700 { color: #15803d !important; }
            #printable-report-content .text-red-600 { color: #dc2626 !important; }
            #printable-report-content .text-green-600 { color: #16a34a !important; }
            #printable-report-content .text-blue-600 { color: #2563eb !important; }
            #printable-report-content .font-semibold { font-weight: 600 !important; }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <div class="flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 min-h-screen fixed md:relative inset-y-0 right-0 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <h1 class="text-2xl font-bold text-center mb-8">ุงููุตุญุญ ุงูุฐูู</h1>
            <nav class="flex flex-col gap-2">
                <a href="#dashboard" class="nav-link active p-3 rounded-lg hover:bg-gray-700">๐ ููุญุฉ ุงูุชุญูู</a>
                <a href="#answer-key" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ููุงุฐุฌ ุงูุฅุฌุงุจุฉ</a>
                <a href="#students" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ฅ ุงูุทูุงุจ</a>
                <a href="#correction" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ท ุงูุชุตุญูุญ</a>
                <a href="#history" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ุงูุณุฌูุงุช</a>
                <a href="#reports" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐จ๏ธ ุงูุชูุงุฑูุฑ</a>
                <a href="#stats" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ุงูุฅุญุตุงุฆูุงุช</a>
                <a href="#settings" class="nav-link p-3 rounded-lg hover:bg-gray-700">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8">
            <button id="menu-button" class="md:hidden fixed top-4 right-4 z-20 p-2 bg-gray-800 text-white rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            
            <!-- Section: Dashboard -->
            <section id="dashboard" class="app-section active">
                <header class="mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3 text-center">ุฃุทูู ุงูุนูุงู ูููุฉ ุงูุชุตุญูุญ ุงูููุฑู</h1>
                    <p class="text-lg md:text-xl text-center max-w-3xl mx-auto text-gray-600">"ุงููุตุญุญ ุงูุฐูู" ูู ูุณุงุนุฏู ุงูุฑููู ุงูุฐู ูุญูู ูููุฉ ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุงููุฑููุฉ ุฅูู ุนูููุฉ ุณุฑูุนุฉ ูุฏูููุฉ ูููุชุนุฉ ุจุงุณุชุฎุฏุงู ุฃุญุฏุซ ุชูููุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู.</p>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b pb-4">ุฃุจุฑุฒ ุงูููุฒุงุช</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex items-start gap-4">
                            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full text-2xl">โก๏ธ</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ุชุตุญูุญ ุฐูู ูุณุฑูุน</h3>
                                <p class="text-gray-600">ุญููู ูุงููุฑุง ูุงุชูู ุฅูู ูุงุณุญ ุถูุฆู ูุงุฆู ุงูุณุฑุนุฉ. ููุชูุท ุงูุชุทุจูู ุงูุฅุฌุงุจุงุช ุชููุงุฆูุงู ููุญูููุง ูู ุซูุงูู ูุนุฏูุฏุฉ ุจุฏูุฉ ุนุงููุฉ.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-full text-2xl">๐ฅ</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ุฅุฏุงุฑุฉ ุงูุทูุงุจ ูุงููุตูู</h3>
                                <p class="text-gray-600">ุงุณุชูุฑุฏ ููุงุฆู ุทูุงุจู ูู ูููุงุช Excel ุจุณูููุฉุ ูุชุชุจุน ุฃุฏุงุกููุ ููู ุจุชุตุญูุญ ุฃูุฑุงููู ุจุดูู ูุฑุฏู ุฃู ุฌูุงุนู.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full text-2xl">๐</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ููุงุฐุฌ ุฅุฌุงุจุฉ ูุฑูุฉ</h3>
                                <p class="text-gray-600">ุฃูุดุฆ ููุงุฐุฌ ุฅุฌุงุจุงุช ูุชุนุฏุฏุฉ ูุงุญูุธูุง. ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูุฏููุงู ุฃู ูู ุจุชุตููุฑ ูููุฐุฌ ูุญููู ููููุฑ ุนููู ุนูุงุก ุงูุฅุฏุฎุงู.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-red-100 text-red-600 p-3 rounded-full text-2xl">๐</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ุณุฌูุงุช ูุชูุงุฑูุฑ ููุตูุฉ</h3>
                                <p class="text-gray-600">ุงุญูุธ ุฌููุน ุงููุชุงุฆุฌ ุชููุงุฆูุงู ูู ุณุฌูุงุช ููุธูุฉ. ูู ุจุชุตุฏูุฑ ููุฎุตุงุช ุงููุชุงุฆุฌ ุฃู ุชูุงุฑูุฑ ุงูุฅุฌุงุจุงุช ุงูุชูุตูููุฉ ุฅูู ูููุงุช Excel ูุชุญููู ุฃุนูู.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงูุฅุฑุดุงุฏุงุช -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <button id="toggle-instructions-btn" class="w-full text-right">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                ๐ ุฏููู ุงูุจุฏุก ุงูุณุฑูุน
                            </h2>
                            <span id="instructions-arrow">โผ</span>
                        </div>
                    </button>
                    <div id="instructions-content" class="collapsible-content mt-4 pt-4 border-t">
                        <ol class="list-decimal list-inside space-y-4 text-gray-700">
                             <li>ุงุฐูุจ ุฅูู ูุณู <a href="#answer-key" class="quick-start-link text-blue-600 font-bold">"ููุงุฐุฌ ุงูุฅุฌุงุจุฉ"</a> ูุฌููุฒ ูููุฐุฌ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (ุฃุฏุฎู ุงููุงุฏุฉ ูุงุณู ุงูุงุฎุชุจุงุฑ ูุงูุชุงุฑูุฎ).</li>
                            <li>ุงุฐูุจ ุฅูู ูุณู <a href="#students" class="quick-start-link text-blue-600 font-bold">"ุงูุทูุงุจ"</a> ูุงุณุชูุฑุฏ ูุงุฆูุฉ ุทูุงุจู.</li>
                            <li>ุงูุชูู ุฅูู ูุณู <a href="#correction" class="quick-start-link text-blue-600 font-bold">"ุงูุชุตุญูุญ"</a> ูุงุฎุชุฑ ุทุงูุจุงู ุฃู ุงุจุฏุฃ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ!</li>
                        </ol>
                    </div>
                </div>
            </section>
            
            <!-- Section: Answer Key -->
            <section id="answer-key" class="app-section">
                <!-- ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ ุฅุนุฏุงุฏ ููุงุฐุฌ ุงูุฅุฌุงุจุฉ</h2>
                    
                    <div class="mb-4">
                        <label for="answerKeyModel" class="block text-sm font-medium text-gray-700 mb-2">ุงุฎุชุฑ ุฃู ุฃูุดุฆ ูููุฐุฌ ุฅุฌุงุจุฉ:</label>
                        <div class="flex gap-2">
                            <select id="answerKeyModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                            <button id="newModelBtn" title="ูููุฐุฌ ุฌุฏูุฏ" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-lg">โ</button>
                            <button id="renameModelBtn" title="ุฅุนุงุฏุฉ ุชุณููุฉ" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg">โ๏ธ</button>
                            <button id="deleteModelBtn" title="ุญุฐู ุงููููุฐุฌ" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg">๐๏ธ</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฃุณุฆูุฉ:</label>
                            <input type="number" id="questionCount" min="1" max="100" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฎูุงุฑุงุช:</label>
                            <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="4">4 (A, B, C, D)</option>
                                <option value="5">5 (A, B, C, D, E)</option>
                            </select>
                        </div>
                        <div>
                            <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">ุงููุงุฏุฉ:</label>
                            <input type="text" id="subjectName" placeholder="ูุซุงู: ุฑูุงุถูุงุช" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div id="examInfoSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div>
                            <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุงุฎุชุจุงุฑ:</label>
                            <input type="text" id="examName" placeholder="ูุซุงู: ุงูุงุฎุชุจุงุฑ ุงููุตูู ุงูุฃูู" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ:</label>
                            <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                     
                    <div class="mt-4 pt-4 border-t">
                         <h3 class="text-lg font-bold text-gray-800 mb-3">ุฅุฌุฑุงุกุงุช ุงููููุฐุฌ</h3>
                         <div class="flex flex-wrap gap-2">
                            <button id="manualEntryBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">โ๏ธ ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ูุฏููุงู</button>
                            <button id="scanKeyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ท ุชุตููุฑ ูููุฐุฌ ูุญููู</button>
                            <button id="printSheetBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐จ๏ธ ุทุจุงุนุฉ ูููุฐุฌ ูุงุฑุบ</button>
                        </div>
                    </div>

                    <div id="answerSheet" class="hidden mt-6 pt-4 border-t">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูุฏููุงู:</h3>
                        <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                        <button id="saveAnswersBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">ุญูุธ ุงูุฅุฌุงุจุงุช</button>
                    </div>
                </div>
            </section>
            
            <!-- Section: Students -->
            <section id="students" class="app-section">
                <!-- ุฅุฏุงุฑุฉ ุงูุทูุงุจ -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        ๐ฅ ุฅุฏุงุฑุฉ ุงูุทูุงุจ
                    </h2>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">๐ ุงุณุชูุฑุงุฏ ูุงุฆูุฉ ุงูุทูุงุจ</h3>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                   class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                        </div>
                    </div>

                    <!-- ูุงุฆูุฉ ุงูุทูุงุจ -->
                    <div id="studentsListSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">๐ ูุงุฆูุฉ ุงูุทูุงุจ</h3>
                            <div class="flex gap-2">
                                <button id="multiCorrectionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                    ๐ ุชุตุญูุญ ูุชุนุฏุฏ
                                </button>
                                <button id="clearStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    ๐๏ธ ูุณุญ ุงููุงุฆูุฉ
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                                <div class="text-xs text-blue-800">ุฅุฌูุงูู ุงูุทูุงุจ</div>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                                <div class="text-xs text-green-800">ุชู ุชุตุญูุญูุง</div>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                                <div class="text-xs text-yellow-800">ูู ุงูุงูุชุธุงุฑ</div>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                                <div class="text-xs text-purple-800">ุนุฏุฏ ุงููุตูู</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุญุซ ุจุงูุงุณู:</label>
                                    <input type="text" id="searchStudentName" placeholder="ุฌุฒุก ูู ุงุณู ุงูุทุงูุจ..." 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
                                    <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="">ุฌููุน ุงููุตูู</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">ุญุงูุฉ ุงูุชุตุญูุญ:</label>
                                    <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="">ุงููู</option>
                                        <option value="corrected">ุชู ุงูุชุตุญูุญ</option>
                                        <option value="pending">ูู ุงูุงูุชุธุงุฑ</option>
                                        <option value="absent">ุบุงุฆุจ</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </section>

            <!-- Section: Correction -->
            <section id="correction" class="app-section">
                <!-- ูุณู ุงููุงููุฑุง ูุชุญููู ุงูุตูุฑ -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ท ุชุตููุฑ ุฃู ุชุญููู ูุฑูุฉ ุงูุฅุฌุงุจุฉ</h2>

                    <div id="correctionSelectedStudentDisplay" class="mb-4 bg-green-50 rounded-lg p-4 hidden">
                         <h3 class="text-lg font-semibold text-green-800 mb-2">๐ค ุงูุทุงูุจ ุงููุญุฏุฏ ููุชุตุญูุญ</h3>
                         <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold" id="correctionStudentNameDisplay">-</div>
                                <div class="text-sm text-gray-600">
                                    ุงููุตู: <span id="correctionStudentClassDisplay">-</span>
                                </div>
                            </div>
                             <button id="changeCorrectionStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-medium text-sm">ุชุบููุฑ</button>
                        </div>
                    </div>


                    <div class="mb-4">
                        <label for="correctionStudentSelect" class="block text-sm font-medium text-gray-700 mb-2">๐ค ุงุฎุชุฑ ุทุงูุจุงู ููุชุตุญูุญ ุงููุฑุฏู (ุฃู ุงุฎุชุฑ ูู ูุณู ุงูุทูุงุจ):</label>
                        <select id="correctionStudentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- ุงุฎุชุฑ ูู ุงููุงุฆูุฉ --</option>
                        </select>
                    </div>

                    <div id="uploadOptions" class="flex flex-col sm:flex-row gap-4 my-6">
                        <button id="showCameraBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">๐น ุงุณุชุฎุฏุงู ุงููุงููุฑุง</button>
                        <button id="showUploadBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">๐ ุชุญููู ุตูุฑุฉ</button>
                    </div>
                    <div id="cameraSection" class="hidden">
                        <div class="camera-container mb-4">
                            <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <div class="overlay"></div>
                            <div id="countdown" class="countdown-text"></div>
                        </div>
                        <div class="text-center">
                            <button id="stopCameraBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โน๏ธ ุฅููุงู ุงููุงููุฑุง</button>
                        </div>
                    </div>
                    <div id="uploadSection" class="hidden">
                        <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                    </div>
                </div>

                 <!-- ุงูุชุตุญูุญ ุงููุชุนุฏุฏ -->
                <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">๐ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</h2>
                    <div id="multiCorrectionSetup">
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <p class="text-sm text-purple-700">ุณูุชู ุชุตุญูุญ ุฃูุฑุงู ุฌููุน ุงูุทูุงุจ ูู ูุงุฆูุฉ "ูู ุงูุงูุชุธุงุฑ" ุจุงูุชุชุงุจุน. ุตููุฑ ุงูุฃูุฑุงู ุจุงูุชุฑุชูุจ ูุณูุชู ุงูุงูุชูุงู ููุทุงูุจ ุงูุชุงูู ุชููุงุฆูุงู ุจุนุฏ ุญูุธ ุงููุชูุฌุฉ.</p>
                        </div>
                        <div class="text-center">
                            <button id="startMultiBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg">
                                ๐ ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
                            </button>
                        </div>
                    </div>
                    <div id="multiCorrectionActive" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>ุงูุชูุฏู</span>
                                <span id="progressText">0 ูู 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
                                    <div class="text-sm text-blue-600">ุงููุตู: <span id="multiStudentClass">-</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-600">ูุฑูุฉ ุฑูู</div>
                                    <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button id="skipStudentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โญ๏ธ ุชุฎุทู ูุฐุง ุงูุทุงูุจ</button>
                            <button id="stopMultiBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โน๏ธ ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</button>
                        </div>
                    </div>
                    <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">๐ ุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</h3>
                        <div id="multiReportContent"></div>
                        <div class="mt-4 flex gap-4 justify-center">
                            <button id="exportMultiReportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ุงูุชูุฑูุฑ</button>
                            <button id="resetMultiBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ ุชุตุญูุญ ุฌุฏูุฏ</button>
                        </div>
                    </div>
                </div>
                
                <!-- ุงูุตูุฑุฉ ุงูููุชูุทุฉ ููุงุฆูุฉ ุงูุชุฃููุฏ -->
                <div id="verificationContainer" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">๐ผ๏ธ ุงูุตูุฑุฉ ุงูููุชูุทุฉ</h3>
                             <img id="capturedImage" class="w-full rounded-lg shadow-md">
                        </div>
                        <div id="verificationSection">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุชุฃููุฏ ุงูุฅุฌุงุจุงุช</h3>
                            <div id="verificationGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto pr-2"></div>
                             <button id="confirmAnswersBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โ ุชุฃููุฏ ูุญุณุงุจ ุงููุชูุฌุฉ</button>
                        </div>
                     </div>
                </div>

                <!-- ูุชุงุฆุฌ ุงูุชุตุญูุญ -->
                <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">๐ ูุชุงุฆุฌ ุงูุชุตุญูุญ</h3>
                    <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>ุงูุทุงูุจ:</strong> <span id="resultStudentName">-</span></div>
                            <div><strong>ุงููุตู:</strong> <span id="resultStudentClass">-</span></div>
                            <div><strong>ุงูุงุฎุชุจุงุฑ:</strong> <span id="resultExamName">-</span></div>
                            <div><strong>ุงูุชุงุฑูุฎ:</strong> <span id="resultExamDate">-</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600" id="correctCount">0</div>
                            <div class="text-sm">ุตุญูุญุฉ</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600" id="wrongCount">0</div>
                            <div class="text-sm">ุฎุงุทุฆุฉ</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600" id="scorePercentage">0%</div>
                            <div class="text-sm">ุงููุณุจุฉ</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="letterGrade">-</div>
                            <div class="text-sm">ุงูุชูุฏูุฑ</div>
                        </div>
                    </div>
                    <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="saveAndNewBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">๐พ ุญูุธ ูุจุฏุก ูุฑูุฉ ุฌุฏูุฏุฉ</button>
                        <button id="exportResultBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">๐ ุชุตุฏูุฑ ุงููุชูุฌุฉ</button>
                    </div>
                </div>
            </section>
            
            <!-- Section: History -->
            <section id="history" class="app-section">
                 <!-- ุณุฌู ุงููุชุงุฆุฌ -->
                <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">๐ ุณุฌู ุงููุชุงุฆุฌ ุงููุญููุธุฉ</h3>
                        <div class="flex gap-2">
                            <button id="exportAllResultsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ููุฎุต ุงููุชุงุฆุฌ</button>
                             <button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐๏ธ ูุณุญ ุงูุณุฌู</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="historyClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
                                <select id="historyClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="historyExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงูุงุฎุชุจุงุฑ:</label>
                                <select id="historyExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="filterHistoryBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุชุทุจูู ุงูููุชุฑ</button>
                            </div>
                        </div>
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                </div>

                <!-- ุณุฌู ุฅุฌุงุจุงุช ุงูุทูุงุจ ุงูููุตู -->
                <div id="detailedHistorySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">๐ ุณุฌู ุฅุฌุงุจุงุช ุงูุทูุงุจ (ููุตู)</h3>
                        <div class="flex gap-2">
                            <button id="exportDetailedLogBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ุณุฌู ุงูุฅุฌุงุจุงุช (Excel)</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">ูุญุชูู ูุฐุง ุงูุณุฌู ุนูู ุฅุฌุงุจุฉ ูู ุทุงูุจ ููู ุณุคุงู. ุงุณุชุฎุฏู ุฒุฑ ุงูุชุตุฏูุฑ ูุชุญููู ุงูุจูุงูุงุช.</p>
                </div>
            </section>

            <!-- Section: Reports -->
            <section id="reports" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">๐จ๏ธ ุงูุชูุงุฑูุฑ ูุงูุทุจุงุนุฉ</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ุชูุฑูุฑ ุฃุฏุงุก ุงููุตู</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="reportClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ุงุฎุชุฑ ุงููุตู:</label>
                                    <select id="reportClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <label for="reportExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ:</label>
                                    <select id="reportExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div class="self-end">
                                    <button id="generateReportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุฅูุดุงุก ุชูุฑูุฑ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="report-container" class="mt-6"></div>
                </div>
            </section>
            
            <!-- Section: Stats -->
            <section id="stats" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ ุงูุฅุญุตุงุฆูุงุช</h2>
                      <div class="bg-gray-50 rounded-lg p-4 mb-6">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="statsClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
                                <select id="statsClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="statsExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงูุงุฎุชุจุงุฑ:</label>
                                <select id="statsExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="updateStatsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช</button>
                            </div>
                        </div>
                    </div>
                     <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ููุฎุต ุงูุฃุฏุงุก</h3>
                            <div id="summary-stats" class="grid grid-cols-2 gap-4"></div>
                        </div>
                         <div class="bg-gray-50 p-4 rounded-lg relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ุชูุฒูุน ุงูุชูุฏูุฑุงุช</h3>
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg md:col-span-2 relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ูุชูุณุท ุงูุฃุฏุงุก ุญุณุจ ุงููุตู</h3>
                            <canvas id="class-performance-chart"></canvas>
                        </div>
                     </div>
                </div>
            </section>

            <!-- Section: Settings -->
            <section id="settings" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
                    <div class="space-y-6">

                        <!-- Basic Info -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ููุชูุงุฑูุฑ</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="setting-admin" type="text" placeholder="ุฅุฏุงุฑุฉ ุงูุชุนููู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-school" type="text" placeholder="ุงููุฏุฑุณุฉ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-teacher" type="text" placeholder="ุงููุนูู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-director" type="text" placeholder="ุงููุฏูุฑ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-year" type="text" placeholder="ุงูุนุงู ุงูุฏุฑุงุณู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-semester" type="text" placeholder="ุงููุตู ุงูุฏุฑุงุณู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button id="saveSettingsBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</button>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="font-semibold text-lg text-gray-800 mb-4">ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช</h3>
                             <div class="flex flex-wrap gap-4">
                                <button id="backupBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ฅ ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช</button>
                                <div>
                                    <label for="restoreFile" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm cursor-pointer">๐ค ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</label>
                                    <input type="file" id="restoreFile" class="hidden" accept=".json">
                                </div>
                             </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                             <h3 class="font-semibold text-lg text-red-800 mb-2">ููุทูุฉ ุงูุฎุทุฑ</h3>
                             <p class="text-sm text-red-700 mb-4">ุณูุคุฏู ูุฐุง ุงูุฅุฌุฑุงุก ุฅูู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงูุชุทุจูู ุจุดูู ููุงุฆูุ ุจูุง ูู ุฐูู ุงูุทูุงุจุ ุงูููุงุฐุฌุ ูุงูุณุฌูุงุช.</p>
                             <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐๏ธ ูุณุญ ุฌููุน ุจูุงูุงุช ุงูุชุทุจูู</button>
                        </div>
                    </div>
                </div>
            </section>
             <!-- Div for printable report content -->
            <div id="printable-report-content" class="hidden"></div>

        </main>
    </div>

    <script>
        // Global state variables
        let correctAnswers = [];
        let studentAnswers = [];
        let stream = null;
        let currentStudent = null;
        let autoCaptureTimer = null;
        let isScanningForKey = false;
        
        // Data loaded from localStorage
        let settings = {};
        let studentsList = [];
        let resultsHistory = [];
        let detailedAnswersLog = [];
        let answerKeyModels = {};
        
        // Multi-correction state
        let isMultipleCorrectionMode = false;
        let multiCorrectionQueue = [];
        let currentMultiIndex = 0;
        let multiCorrectionResults = [];

        // Chart instances
        let gradeChart = null;
        let classChart = null;

        // === Safe localStorage Parsing ===
        function getFromStorage(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem(key);
                // Basic check for valid JSON start
                if (storedValue && (storedValue.startsWith('{') || storedValue.startsWith('['))) {
                    return JSON.parse(storedValue);
                }
                 // Handle potential corrupted primitive values or empty strings
                 if (storedValue === null || storedValue === undefined || storedValue === "") {
                     return defaultValue;
                 }
                 // Attempt to parse even if not starting with { or [ - might be a primitive
                 try { return JSON.parse(storedValue); } catch { return defaultValue; }

            } catch (e) {
                console.error(`Error parsing ${key} from localStorage:`, e);
                localStorage.removeItem(key); // Remove corrupted data
                return defaultValue;
            }
        }

        // === Navigation & UI Initialization ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('translate-x-full');
                overlay.classList.toggle('hidden');
            }
        }

        function showSection(sectionId) {
             console.log("Showing section:", sectionId);
            try {
                document.querySelectorAll('.app-section').forEach(section => {
                    section.classList.remove('active');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                } else {
                     console.error("Section not found:", sectionId);
                     document.getElementById('dashboard')?.classList.add('active'); // Fallback to dashboard
                }


                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
                 if(targetLink) targetLink.classList.add('active');
                
                // --- Section specific actions ---
                if (sectionId === 'correction') populateCorrectionStudentSelect();
                if (sectionId === 'reports') populateReportFilters();
                if (sectionId === 'stats') {
                    populateStatsFilters(); // Populate filters for stats
                    updateGlobalStats(); // Update stats on showing section
                }
                if (sectionId === 'students') displayStudentsList(); // Ensure list shows when navigating
                 if (sectionId === 'history') populateHistoryFilters(); // Populate filters for history


                if (sectionId !== 'correction') document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
                
                if (window.innerWidth < 768) { // md breakpoint
                    toggleSidebar();
                }
            } catch(e) {
                 console.error("Error in showSection:", e);
                 // Fallback to dashboard on error
                 document.querySelectorAll('.app-section').forEach(section => section.classList.remove('active'));
                 document.getElementById('dashboard')?.classList.add('active');
                 document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                 document.querySelector(`.nav-link[href="#dashboard"]`)?.classList.add('active');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
             try {
                // Event Listeners Setup - Moved here for robust initialization
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
                        if (sectionId) showSection(sectionId);
                        else console.error("Invalid href for nav link:", e.currentTarget);
                    });
                });

                document.querySelectorAll('.quick-start-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
                        if (sectionId) showSection(sectionId);
                         else console.error("Invalid href for quick start link:", e.currentTarget);
                    });
                });
                
                 // Event delegation for dynamically added buttons
                document.getElementById('studentsList')?.addEventListener('click', (e) => {
                    if (e.target.classList.contains('select-student-btn')) {
                        const studentId = e.target.dataset.id;
                         if(studentId) selectStudent(studentId);
                    }
                     if (e.target.classList.contains('absent-btn')) {
                         const studentId = e.target.dataset.id;
                         if(studentId) markAsAbsent(studentId);
                    }
                });


                // Mobile Sidebar Toggle
                document.getElementById('menu-button')?.addEventListener('click', toggleSidebar);
                document.getElementById('sidebar-overlay')?.addEventListener('click', toggleSidebar);

                // Instructions Toggle
                document.getElementById('toggle-instructions-btn')?.addEventListener('click', toggleInstructions);

                // File Inputs
                document.getElementById('studentsFileInput')?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) parseStudentsFile(file);
                });
                document.getElementById('imageInput')?.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) handleImageFile(file);
                });

                // Selects and Inputs with side effects
                document.getElementById('answerKeyModel')?.addEventListener('change', switchModel);
                document.getElementById('correctionStudentSelect')?.addEventListener('change', (e) => {
                    if(e.target.value) {
                        selectStudent(parseInt(e.target.value));
                    } else {
                        selectDifferentStudent();
                    }
                 });
                 
                 // Link subject/exam/date fields in Answer Key section
                 document.getElementById('subjectName')?.addEventListener('input', updateModelData);
                 document.getElementById('examName')?.addEventListener('input', updateModelData);
                 document.getElementById('examDate')?.addEventListener('change', updateModelData);
                 document.getElementById('questionCount')?.addEventListener('change', showManualEntry); 
                 document.getElementById('optionsCount')?.addEventListener('change', showManualEntry); 


                // Button listeners (check for element existence)
                document.getElementById('multiCorrectionBtn')?.addEventListener('click', toggleMultipleCorrection);
                document.getElementById('clearStudentsBtn')?.addEventListener('click', clearStudentsList);
                document.getElementById('newModelBtn')?.addEventListener('click', () => manageModels('new'));
                document.getElementById('renameModelBtn')?.addEventListener('click', () => manageModels('rename'));
                document.getElementById('deleteModelBtn')?.addEventListener('click', () => manageModels('delete'));
                document.getElementById('manualEntryBtn')?.addEventListener('click', showManualEntry);
                document.getElementById('scanKeyBtn')?.addEventListener('click', scanAnswerKey);
                document.getElementById('printSheetBtn')?.addEventListener('click', printBlankSheet);
                document.getElementById('saveAnswersBtn')?.addEventListener('click', saveCorrectAnswers);
                document.getElementById('showCameraBtn')?.addEventListener('click', showCameraSection);
                document.getElementById('showUploadBtn')?.addEventListener('click', showUploadSection);
                document.getElementById('stopCameraBtn')?.addEventListener('click', stopCamera);
                document.getElementById('startMultiBtn')?.addEventListener('click', startMultipleCorrection);
                document.getElementById('skipStudentBtn')?.addEventListener('click', skipCurrentStudent);
                document.getElementById('stopMultiBtn')?.addEventListener('click', stopMultipleCorrection);
                document.getElementById('exportMultiReportBtn')?.addEventListener('click', exportMultiReport);
                document.getElementById('resetMultiBtn')?.addEventListener('click', resetMultiCorrection);
                document.getElementById('confirmAnswersBtn')?.addEventListener('click', confirmAnswers);
                document.getElementById('saveAndNewBtn')?.addEventListener('click', saveToHistory);
                document.getElementById('exportResultBtn')?.addEventListener('click', exportResults);
                document.getElementById('exportAllResultsBtn')?.addEventListener('click', exportAllResults);
                document.getElementById('clearHistoryBtn')?.addEventListener('click', clearHistory);
                document.getElementById('exportDetailedLogBtn')?.addEventListener('click', exportDetailedAnswersLog);
                document.getElementById('generateReportBtn')?.addEventListener('click', generateClassReport);
                document.getElementById('saveSettingsBtn')?.addEventListener('click', saveSettings);
                document.getElementById('backupBtn')?.addEventListener('click', backupData);
                document.getElementById('clearAllDataBtn')?.addEventListener('click', clearAllData);
                document.getElementById('restoreFile')?.addEventListener('change', restoreData);
                document.getElementById('searchStudentName')?.addEventListener('keyup', filterStudentsList);
                document.getElementById('filterClass')?.addEventListener('change', filterStudentsList);
                document.getElementById('filterStatus')?.addEventListener('change', filterStudentsList);
                document.getElementById('changeCorrectionStudentBtn')?.addEventListener('click', selectDifferentStudent);
                document.getElementById('filterHistoryBtn')?.addEventListener('click', updateHistoryDisplay);
                document.getElementById('updateStatsBtn')?.addEventListener('click', updateGlobalStats);



                 const examDateInput = document.getElementById('examDate');
                 if(examDateInput) examDateInput.valueAsDate = new Date();

                loadInitialUI();

             } catch(e) {
                  console.error("Error during DOMContentLoaded setup:", e);
                  alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุชุทุจูู. ูุฏ ุชุญุชุงุฌ ุฅูู ุชุญุฏูุซ ุงูุตูุญุฉ.");
             }
        });


        function loadInitialUI() {
             console.log("Loading initial UI...");
            settings = getFromStorage('appSettings', {});
            studentsList = getFromStorage('studentsList', []);
            // Ensure student objects have a status
            studentsList = studentsList.map(s => ({ ...s, status: s.status || 'pending' })); 
            resultsHistory = getFromStorage('examResults', []);
            detailedAnswersLog = getFromStorage('detailedAnswersLog', []);
            answerKeyModels = getFromStorage('answerKeyModels', {});
            
            loadSettings();

            if (Object.keys(answerKeyModels).length === 0) {
                answerKeyModels['ูููุฐุฌ ุฃ'] = { name: "ูููุฐุฌ ุฃ", subject: "", examName: "", examDate: new Date().toISOString().split('T')[0], answers: [] };
                 localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels)); // Save default if empty
            }
            updateModelsDropdown(); 
            
            if (studentsList.length > 0) {
                 displayStudentsList();
             } else {
                 document.getElementById('studentsListSection')?.classList.add('hidden');
             }
            
            if (resultsHistory.length > 0) updateHistoryDisplay();
             else {
                 document.getElementById('historySection')?.classList.add('hidden');
            }
            if (detailedAnswersLog.length > 0) document.getElementById('detailedHistorySection')?.classList.remove('hidden');
             else {
                 document.getElementById('detailedHistorySection')?.classList.add('hidden');
             }
             // Ensure initial section is shown correctly
             const initialSection = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
             showSection(initialSection);
             console.log("Initial UI Load Complete.");
        }
        
        function toggleInstructions() {
            const content = document.getElementById('instructions-content');
            const arrow = document.getElementById('instructions-arrow');
            if(!content || !arrow) return;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = null;
                arrow.textContent = 'โผ';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.textContent = 'โฒ';
            }
        }


        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg z-50 text-center ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { 
                 if(notification && document.body.contains(notification)) {
                     document.body.removeChild(notification); 
                 }
            }, 3000);
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const capturedImage = document.getElementById('capturedImage');
                const verificationContainer = document.getElementById('verificationContainer');
                if(!capturedImage || !verificationContainer) return;

                capturedImage.src = e.target.result;
                verificationContainer.classList.remove('hidden');
                
                 processAnswers();
            };
            reader.onerror = (e) => {
                 console.error("FileReader error:", e);
                 showNotification("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงูุตูุฑุฉ.", "error");
            };
            if (typeof file === 'string') {
                 reader.readAsDataURL(dataURItoBlob(file));
            } else if (file instanceof Blob) {
                reader.readAsDataURL(file);
            } else {
                 console.error("Invalid file type passed to handleImageFile:", file);
                 showNotification("ููุน ููู ุบูุฑ ุตุงูุญ.", "error");
            }
        }
        
        function dataURItoBlob(dataURI) {
            try {
                const byteString = atob(dataURI.split(',')[1]);
                const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {type: mimeString});
            } catch (e) {
                 console.error("Error converting data URI to Blob:", e);
                 showNotification("ุฎุทุฃ ูู ุชุญููู ุงูุตูุฑุฉ.", "error");
                 return null;
            }
        }


        // === Student Management ===
        function downloadStudentsTemplate() {
            try {
                const wb = XLSX.utils.book_new();
                const data = [['ุงุณู ุงูุทุงูุจ', 'ุงููุตู'], ['ูุงุทูุฉ ุนูู ุงูุฒูุฑุงูู', '1/ุฃ'], ['ูุญูุฏ ุณุงูู ุงููุญุทุงูู', '2/ุจ']];
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'ูุงุฆูุฉ ุงูุทูุงุจ');
                XLSX.writeFile(wb, 'ูููุฐุฌ_ูุงุฆูุฉ_ุงูุทูุงุจ.xlsx');
            } catch(e) {
                 console.error("Error downloading template:", e);
                 showNotification("ุฎุทุฃ ูู ุชุญููู ุงููููุฐุฌ.", "error");
            }
        }

        function parseStudentsFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (!Array.isArray(jsonData) || jsonData.length < 2) throw new Error("ุงูููู ูุงุฑุบ ุฃู ุบูุฑ ุตุงูุญ.");
                    
                    const headers = jsonData[0].map(h => String(h || '').trim());
                    const nameIndex = headers.findIndex(h => h.includes('ุงุณู'));
                    const classIndex = headers.findIndex(h => h.includes('ูุตู'));
                    if (nameIndex === -1 || classIndex === -1) throw new Error("ูู ูุชู ุงูุนุซูุฑ ุนูู ุนููุฏู 'ุงุณู ุงูุทุงูุจ' ู 'ุงููุตู'");
                    
                    const existingStudents = new Set(studentsList.map(s => `${s.name}-${s.class}`));
                    const newStudents = jsonData.slice(1).map((row, i) => {
                         if (!Array.isArray(row)) return null; 
                        const name = String(row[nameIndex] || '').trim();
                        const className = String(row[classIndex] || '').trim();
                        if (name && className && !existingStudents.has(`${name}-${className}`)) {
                            return { id: Date.now() + i, name, class: className, corrected: false, result: null, status: 'pending' }; // Initialize with status
                        }
                        return null;
                    }).filter(s => s !== null);
                    
                    let notificationMessage;
                    let notificationType = 'info';

                    if (newStudents.length > 0) {
                        studentsList.push(...newStudents);
                        localStorage.setItem('studentsList', JSON.stringify(studentsList));
                        notificationMessage = `ุชู ุฅุถุงูุฉ ${newStudents.length} ุทุงูุจ ุฌุฏูุฏ!`;
                        notificationType = 'success';
                    } else {
                        notificationMessage = 'ูู ูุชู ุงูุนุซูุฑ ุนูู ุทูุงุจ ุฌุฏุฏ (ูุฏ ูููููู ููุฌูุฏูู ุจุงููุนู ูู ุงููุงุฆูุฉ). ุนุฑุถ ุงููุงุฆูุฉ ุงูุญุงููุฉ.';
                    }

                    displayStudentsList();
                    showNotification(notificationMessage, notificationType);

                } catch (error) {
                    console.error("Error parsing student file:", error);
                    showNotification(`ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: ${error.message}`, 'error');
                }
            };
             reader.onerror = (e) => {
                 console.error("FileReader error (students):", e);
                 showNotification("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงูุทูุงุจ.", "error");
            };
            reader.readAsArrayBuffer(file);
        }

        function displayStudentsList() {
            const section = document.getElementById('studentsListSection');
            if(!section) return;
            if (studentsList.length > 0) {
                 section.classList.remove('hidden');
                 updateStudentsStats();
                 updateClassFilter();
                 filterStudentsList();
                 populateCorrectionStudentSelect();
            } else {
                 section.classList.add('hidden');
            }
        }


        function updateStudentsStats() {
            const total = studentsList.length;
            const corrected = studentsList.filter(s => s.status === 'corrected').length;
            const pending = studentsList.filter(s => s.status === 'pending').length;
            const absent = studentsList.filter(s => s.status === 'absent').length;

            document.getElementById('totalStudentsCount').textContent = total;
            document.getElementById('correctedCount').textContent = corrected;
            document.getElementById('pendingCount').textContent = pending; 
            document.getElementById('uniqueClassesCount').textContent = [...new Set(studentsList.map(s => s.class))].length;
        }

        function updateClassFilter() {
            const filterClass = document.getElementById('filterClass');
            if(!filterClass) return;
            const uniqueClasses = [...new Set(studentsList.map(s => s.class))].sort();
            filterClass.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterStudentsList() {
            const searchTermInput = document.getElementById('searchStudentName');
            const classFilterSelect = document.getElementById('filterClass');
            const statusFilterSelect = document.getElementById('filterStatus');
            const listDiv = document.getElementById('studentsList');
            if (!searchTermInput || !classFilterSelect || !statusFilterSelect || !listDiv) return;

            const searchTerm = searchTermInput.value.toLowerCase();
            const classFilter = classFilterSelect.value;
            const statusFilter = statusFilterSelect.value;

            const filtered = studentsList.filter(student => 
                (!searchTerm || student.name.toLowerCase().includes(searchTerm)) &&
                (!classFilter || student.class === classFilter) &&
                (!statusFilter || student.status === statusFilter)
            );
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-gray-500 py-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ.</div>';
                return;
            }
            listDiv.innerHTML = filtered.map(student => {
                let statusHTML = '';
                let buttonHTML = '';
                switch(student.status) {
                    case 'corrected':
                        statusHTML = `<div class="text-xs text-green-600">ุงููุชูุฌุฉ: ${student.result?.percentage || '-'} (${student.result?.score || '-'})</div>`;
                        break;
                    case 'absent':
                        statusHTML = `<div class="text-xs text-gray-500">ุบุงุฆุจ</div>`;
                        break;
                    default: // pending
                        statusHTML = `<div class="text-xs text-yellow-600">ูู ุงูุงูุชุธุงุฑ</div>`;
                        if(!isMultipleCorrectionMode) {
                            buttonHTML = `
                                <button data-id="${student.id}" class="select-student-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">ุงุฎุชูุงุฑ</button>
                                <button data-id="${student.id}" class="absent-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">ุบูุงุจ</button>
                            `;
                        }
                        break;
                }

                return `
                <div class="flex items-center justify-between p-3 rounded-lg border ${student.status === 'corrected' ? 'bg-green-50' : (student.status === 'absent' ? 'bg-gray-200' : 'bg-gray-50')}">
                    <div>
                        <div class="font-semibold">${student.name}</div>
                        <div class="text-sm text-gray-600">ุงููุตู: ${student.class}</div>
                        ${statusHTML}
                    </div>
                    <div class="flex gap-2">
                        ${buttonHTML}
                    </div>
                </div>
            `}).join('');
        }
        
        function selectStudent(studentId) {
            currentStudent = studentsList.find(s => s.id === parseInt(studentId));
            const selectElement = document.getElementById('correctionStudentSelect');
            const displayContainer = document.getElementById('correctionSelectedStudentDisplay');
            const nameDisplay = document.getElementById('correctionStudentNameDisplay');
            const classDisplay = document.getElementById('correctionStudentClassDisplay');

            if (currentStudent && selectElement && displayContainer && nameDisplay && classDisplay) {
                selectElement.value = currentStudent.id;
                nameDisplay.textContent = currentStudent.name;
                classDisplay.textContent = currentStudent.class;
                displayContainer.classList.remove('hidden'); 
                showNotification(`ุชู ุงุฎุชูุงุฑ ุงูุทุงูุจ: ${currentStudent.name}. ููููู ุงูุขู ุจุฏุก ุงูุชุตุญูุญ.`, 'success');
            } else if (!currentStudent) {
                 console.error("Student not found with ID:", studentId);
                 selectDifferentStudent(); // Clear selection if student not found
            }
        }
        
        function markAsAbsent(studentId) {
            const idToMark = parseInt(studentId);
            const studentIndex = studentsList.findIndex(s => s.id === idToMark);
            if(studentIndex > -1) {
                studentsList[studentIndex].status = 'absent';
                studentsList[studentIndex].result = null; // Clear any previous result
                studentsList[studentIndex].corrected = false; // Ensure corrected is false
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                displayStudentsList(); // Refresh the list view
                showNotification(`ุชู ุชุณุฌูู ุงูุทุงูุจ ${studentsList[studentIndex].name} ูุบุงุฆุจ.`, 'info');
            } else {
                 console.error("Could not find student to mark as absent, ID:", studentId);
            }
        }


        function selectDifferentStudent() {
            currentStudent = null;
            const selectElement = document.getElementById('correctionStudentSelect');
            const displayContainer = document.getElementById('correctionSelectedStudentDisplay');
             if(selectElement) selectElement.value = '';
             if(displayContainer) displayContainer.classList.add('hidden');
        }
        
        function populateCorrectionStudentSelect() {
            const select = document.getElementById('correctionStudentSelect');
            if(!select) return;
            select.innerHTML = '<option value="">-- ุงุฎุชุฑ ูู ุงููุงุฆูุฉ --</option>';
            const pendingStudents = studentsList.filter(s => s.status === 'pending');
            pendingStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} - ${student.class}`;
                select.appendChild(option);
            });
             // Reselect current student if exists
             if (currentStudent) select.value = currentStudent.id;
        }

        function clearStudentsList() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุทูุงุจุ ุณูุชู ุญุฐู ุณุฌูุงุช ุงููุชุงุฆุฌ ุงููุฑุชุจุทุฉ ุจูู ุฃูุถุงู.')) {
                studentsList = [];
                resultsHistory = []; 
                detailedAnswersLog = [];
                localStorage.removeItem('studentsList');
                localStorage.removeItem('examResults');
                localStorage.removeItem('detailedAnswersLog');
                
                document.getElementById('studentsListSection')?.classList.add('hidden');
                updateStudentsStats(); 
                updateHistoryDisplay();
                document.getElementById('detailedHistorySection')?.classList.add('hidden');
                showNotification('ุชู ูุณุญ ูุงุฆูุฉ ุงูุทูุงุจ ูุฌููุน ุงูุณุฌูุงุช.', 'success');
            }
        }

        // === Answer Key Models Management ===
        function updateModelsDropdown() {
            const select = document.getElementById('answerKeyModel');
            if(!select) return;
            const currentModelName = select.value;
            select.innerHTML = '';
            Object.keys(answerKeyModels).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            select.value = currentModelName && answerKeyModels[currentModelName] ? currentModelName : Object.keys(answerKeyModels)[0];
            switchModel();
        }

        function switchModel() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName]) return;
            const modelData = answerKeyModels[modelName];
            correctAnswers = modelData.answers || [];
            const qCountInput = document.getElementById('questionCount');
            if(qCountInput) qCountInput.value = correctAnswers.length || 10;
            const subjectInput = document.getElementById('subjectName');
            if(subjectInput) subjectInput.value = modelData.subject || '';
            const examNameInput = document.getElementById('examName');
            if(examNameInput) examNameInput.value = modelData.examName || '';
            const examDateInput = document.getElementById('examDate');
            if(examDateInput) examDateInput.value = modelData.examDate || new Date().toISOString().split('T')[0];
            document.getElementById('answerSheet')?.classList.add('hidden'); // Keep hidden initially
            showNotification(`ุชู ุงูุชุญููู ุฅูู "${modelName}"`, 'info');
        }


        function manageModels(action) {
            const select = document.getElementById('answerKeyModel');
            if(!select) return;
            const currentName = select.value;
            let newName;

            switch(action) {
                case 'new':
                    newName = prompt("ุฃุฏุฎู ุงุณู ุงููููุฐุฌ ุงูุฌุฏูุฏ (ูุซุงู: ูููุฐุฌ ุจ):");
                    if (newName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = { name: newName, subject: "", examName: "", examDate: new Date().toISOString().split('T')[0], answers: [] };
                    } else if (newName) {
                        alert("ูุฐุง ุงูุงุณู ููุฌูุฏ ุจุงููุนู.");
                    }
                    break;
                case 'rename':
                    if (!currentName) return;
                    newName = prompt("ุฃุฏุฎู ุงูุงุณู ุงูุฌุฏูุฏ ูููููุฐุฌ:", currentName);
                    if (newName && newName !== currentName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = answerKeyModels[currentName];
                        delete answerKeyModels[currentName];
                    } else if (newName) {
                        alert("ูุง ูููู ุงูุชุณููุฉ ุจุงุณู ููุฌูุฏ ุจุงููุนู.");
                    }
                    break;
                case 'delete':
                    if (!currentName || Object.keys(answerKeyModels).length <= 1) {
                         alert("ูุฌุจ ุฃู ูููู ููุงู ูููุฐุฌ ูุงุญุฏ ุนูู ุงูุฃูู.");
                        return;
                    }
                    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูููุฐุฌ "${currentName}"ุ`)) {
                        delete answerKeyModels[currentName];
                    }
                    break;
            }
            localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));
            updateModelsDropdown();
        }

        // === Answer Sheet Setup ===
        function showManualEntry() {
            generateAnswerSheet();
        }

        function scanAnswerKey() {
            isScanningForKey = true;
            showNotification('ุงูุฑุฌุงุก ุชุตููุฑ ูุฑูุฉ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ.', 'info');
            showSection('correction');
            showCameraSection();
        }

        function generateAnswerSheet() {
            const questionCountInput = document.getElementById('questionCount');
            const optionsCountSelect = document.getElementById('optionsCount');
            const answersGrid = document.getElementById('answersGrid');
            const answerSheetDiv = document.getElementById('answerSheet');
             if(!questionCountInput || !optionsCountSelect || !answersGrid || !answerSheetDiv) return;


            const questionCount = parseInt(questionCountInput.value);
            const optionsCount = parseInt(optionsCountSelect.value);
            answersGrid.innerHTML = '';
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = modelName ? answerKeyModels[modelName] : {};
            const currentAnswers = modelData?.answers || [];

            if (isNaN(questionCount) || questionCount < 1) {
                 showNotification("ุนุฏุฏ ุงูุฃุณุฆูุฉ ุบูุฑ ุตุงูุญ.", "error");
                 return;
             }

            for (let i = 1; i <= questionCount; i++) {
                answersGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุณุคุงู ${i}:</label>
                        <select id="answer${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            ${options.map(opt => `<option value="${opt}" ${opt === (currentAnswers[i-1] || 'A') ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
             answerSheetDiv.classList.remove('hidden');
        }

        function saveCorrectAnswers() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName) return;
            const questionCountInput = document.getElementById('questionCount');
            const subjectInput = document.getElementById('subjectName');
            const examNameInput = document.getElementById('examName');
            const examDateInput = document.getElementById('examDate');
            const answerSheetDiv = document.getElementById('answerSheet');

             if(!questionCountInput || !subjectInput || !examNameInput || !examDateInput || !answerSheetDiv) return;


            const questionCount = parseInt(questionCountInput.value);
            correctAnswers = [];
             let allAnswered = true;
            for(let i=1; i<=questionCount; i++){
                const select = document.getElementById(`answer${i}`);
                if(select && select.value){
                    correctAnswers.push(select.value);
                } else {
                    allAnswered = false;
                     break; 
                }
            }

            if(!allAnswered){
                showNotification("ูุฑุฌู ุฅุฏุฎุงู ุฌููุน ุงูุฅุฌุงุจุงุช ูุจู ุงูุญูุธ.", "error");
                return;
            }

            answerKeyModels[modelName] = {
                name: modelName,
                subject: subjectInput.value,
                examName: examNameInput.value,
                examDate: examDateInput.value,
                answers: correctAnswers
            };
            localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));
            answerSheetDiv.classList.add('hidden');
            showNotification(`ุชู ุญูุธ ุงูุฅุฌุงุจุงุช ูู "${modelName}".`, 'success');
        }
        
        // Save model data whenever related fields change
        function updateModelData() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName]) return;
            
            const subject = document.getElementById('subjectName')?.value;
            const examName = document.getElementById('examName')?.value;
            const examDate = document.getElementById('examDate')?.value;

            answerKeyModels[modelName] = {
                ...answerKeyModels[modelName], // Keep existing answers
                subject: subject,
                examName: examName,
                examDate: examDate
            };
            localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));
        }


        // === Camera and Image Processing ===
        async function showCameraSection() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                const videoElement = document.getElementById('camera');
                if(videoElement) videoElement.srcObject = stream;
                document.getElementById('cameraSection')?.classList.remove('hidden');
                document.getElementById('uploadSection')?.classList.add('hidden');
                startAutoCapture();
            } catch (error) {
                 console.error("Camera access error:", error);
                showNotification('ูุง ูููู ุงููุตูู ูููุงููุฑุง. ุชุฃูุฏ ูู ููุญ ุงูุฅุฐู.', 'error');
            }
        }

        function startAutoCapture() {
            const countdownEl = document.getElementById('countdown');
            if(!countdownEl) return;
            let count = 3;
            countdownEl.textContent = count;
            countdownEl.style.display = 'block';

            if(autoCaptureTimer) clearInterval(autoCaptureTimer);

            autoCaptureTimer = setInterval(() => {
                count--;
                 if(countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(autoCaptureTimer);
                    if(countdownEl) countdownEl.style.display = 'none';
                    captureAndProcess();
                }
            }, 1000);
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            if(autoCaptureTimer) clearInterval(autoCaptureTimer);
            const countdownEl = document.getElementById('countdown');
            if(countdownEl) countdownEl.style.display = 'none';
            document.getElementById('cameraSection')?.classList.add('hidden');
            document.getElementById('capturedSection')?.classList.add('hidden');
        }

        function captureAndProcess() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            if(!video || !canvas || video.readyState !== 4) {
                 console.warn("Video not ready for capture.");
                 if(stream) startAutoCapture(); 
                 return;
             }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            clearInterval(autoCaptureTimer);
            
            if (isScanningForKey) {
                 stopCamera();
            }

            handleImageFile(canvas.toDataURL('image/jpeg'));
        }

        function showUploadSection() {
            stopCamera();
            document.getElementById('uploadSection')?.classList.remove('hidden');
            document.getElementById('cameraSection')?.classList.add('hidden');
        }
        
        async function processAnswers() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            correctAnswers = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName].answers : [];

            if (correctAnswers.length === 0 && !isScanningForKey) {
                showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ูุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุฃููุงู.', 'error'); return;
            }
            if (!currentStudent && !isMultipleCorrectionMode && !isScanningForKey) {
                showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุทุงูุจ ุฃููุงู.', 'error'); return;
            }
            
            document.getElementById('verificationContainer')?.classList.remove('hidden');
            
            const processBtn = document.getElementById('processBtn'), spinner = document.getElementById('processBtnSpinner'), btnText = document.getElementById('processBtnText');
            if(processBtn) processBtn.disabled = true;
            if(spinner) spinner.classList.remove('hidden');
            if(btnText) btnText.textContent = 'ุฌุงุฑู ุงูุชุญููู...';
            
            try {
                const imageSrc = document.getElementById('capturedImage')?.src;
                if (!imageSrc) throw new Error("ูู ูุชู ุงูุนุซูุฑ ุนูู ุตูุฑุฉ ูููุนุงูุฌุฉ.");

                const blob = dataURItoBlob(imageSrc);
                if (!blob) throw new Error("ูุดู ุชุญููู ุงูุตูุฑุฉ.");

                const formData = new FormData();
                formData.append('image', blob, 'answer_sheet.jpg');
                formData.append('num_questions', document.getElementById('questionCount')?.value || correctAnswers.length);
                formData.append('options_per_q', document.getElementById('optionsCount')?.value || 4);

                const response = await fetch('/api/correct', { method: 'POST', body: formData });
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'ูุดู ูู ุงูุชุญููู ูู ุงูุฎุงุฏู');
                
                if (isScanningForKey) {
                    isScanningForKey = false;
                    const scannedAnswers = data.answers;
                    const questionCount = parseInt(document.getElementById('questionCount')?.value || 0);
                    for (let i = 0; i < questionCount; i++) {
                        const select = document.getElementById(`answer${i + 1}`);
                        if (select && scannedAnswers[i]) {
                            select.value = scannedAnswers[i];
                        }
                    }
                    showNotification('ุชู ูุณุญ ุงูุฅุฌุงุจุงุช ุจูุฌุงุญ. ูุฑุฌู ูุฑุงุฌุนุชูุง ุซู ุงูุญูุธ.', 'success');
                    showManualEntry();
                    showSection('answer-key');

                } else {
                    studentAnswers = data.answers;
                    showAnswerVerification();
                }
            } catch (err) {
                 console.error("Error processing answers:", err);
                showNotification(`ูุดู ุชุญููู ุงูุตูุฑุฉ: ${err.message}`, 'error');
                resetForNewSheet();
            } finally {
                 if(processBtn) processBtn.disabled = false;
                 if(spinner) spinner.classList.add('hidden');
                 if(btnText) btnText.textContent = '๐ ุชุญููู ุงูุฅุฌุงุจุงุช';
            }
        }

        // === Verification and Results ===
        function showAnswerVerification() {
            const verificationGrid = document.getElementById('verificationGrid');
            const optionsCountSelect = document.getElementById('optionsCount');
             if(!verificationGrid || !optionsCountSelect || !Array.isArray(correctAnswers)) {
                 console.error("Cannot show verification: grid, select, or correctAnswers missing/invalid.");
                 return;
             }
             if (correctAnswers.length === 0) {
                  showNotification("ูุง ููุฌุฏ ูููุฐุฌ ุฅุฌุงุจุฉ ููุฐุง ุงูุนุฏุฏ ูู ุงูุฃุณุฆูุฉ. ูุฑุฌู ุงูุฅุนุฏุงุฏ ุฃููุงู.", "error");
                  resetForNewSheet();
                  return;
             }


            const optionsCount = parseInt(optionsCountSelect.value);
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            verificationGrid.innerHTML = '';
            for (let i = 0; i < correctAnswers.length; i++) {
                const answer = studentAnswers[i] || 'ูุฑุงุบ'; // Default to "ูุฑุงุบ" if undefined
                verificationGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ุณ ${i + 1}</label>
                        <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <option value="ูุฑุงุบ" ${answer === 'ูุฑุงุบ' ? 'selected' : ''}>ูุฑุงุบ</option>
                            ${options.map(opt => `<option value="${opt}" ${opt === answer ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>`;
            }
            document.getElementById('verificationSection')?.classList.remove('hidden');
        }


        function confirmAnswers() {
            studentAnswers = Array.from({ length: correctAnswers.length }, (_, i) => {
                 const select = document.getElementById(`verify${i}`);
                 return select ? select.value : 'ูุฑุงุบ';
            });
            document.getElementById('verificationContainer')?.classList.add('hidden');
            displayResults();
        }

        function displayResults() {
             if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
                 console.error("Cannot display results without correct answers.");
                 return; 
            }
            let correctCount = 0;
            const detailedResults = document.getElementById('detailedResults');
             if(!detailedResults) return;

            detailedResults.innerHTML = '';
            for (let i = 0; i < correctAnswers.length; i++) {
                 const sAnswer = studentAnswers[i] !== undefined ? studentAnswers[i] : 'ูุฑุงุบ';
                const isCorrect = sAnswer === correctAnswers[i];
                if (isCorrect) correctCount++;
                detailedResults.innerHTML += `
                    <div class="p-3 rounded-lg text-white text-center font-medium ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                        <div class="text-sm">ุณ ${i + 1}</div>
                        <div class="text-lg">${sAnswer || 'โ'}</div>
                        <div class="text-xs">${isCorrect ? 'โ' : `โ (${correctAnswers[i]})`}</div>
                    </div>`;
            }
            const wrongCount = correctAnswers.length - correctCount;
            const percentage = correctAnswers.length > 0 ? Math.round((correctCount / correctAnswers.length) * 100) : 0;
            
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('letterGrade').textContent = getLetterGrade(percentage);
            
            const studentForDisplay = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
             if (!studentForDisplay) {
                 console.error("No student selected for displaying results.");
                 return; 
             }
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};

            document.getElementById('resultStudentName').textContent = studentForDisplay.name;
            document.getElementById('resultStudentClass').textContent = studentForDisplay.class;
            document.getElementById('resultExamName').textContent = modelData.examName || 'ุบูุฑ ูุญุฏุฏ';
            document.getElementById('resultExamDate').textContent = modelData.examDate || '';
            document.getElementById('resultsSection')?.classList.remove('hidden');
        }

        function getLetterGrade(percentage) {
            if (percentage >= 90) return 'ููุชุงุฒ';
            if (percentage >= 80) return 'ุฌูุฏ ุฌุฏุงู';
            if (percentage >= 70) return 'ุฌูุฏ';
            if (percentage >= 60) return 'ููุจูู';
            return 'ุถุนูู'; // Changed from 'ุฑุงุณุจ'
        }

        function saveToHistory() {
            const studentForHistory = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
             if (!studentForHistory) {
                 showNotification("ูุง ููุฌุฏ ุทุงูุจ ูุญุฏุฏ ูุญูุธ ุงููุชูุฌุฉ.", "error");
                 return;
             }
             if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
                 showNotification("ูุง ูููู ุญูุธ ูุชูุฌุฉ ุจุฏูู ูููุฐุฌ ุฅุฌุงุจุฉ ุตุญูุญ.", "error");
                 return;
            }
            const correctCount = parseInt(document.getElementById('correctCount')?.textContent || '0');
            const totalQuestions = correctAnswers.length;
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};
            const result = {
                id: Date.now(), studentName: studentForHistory.name, studentClass: studentForHistory.class,
                examName: modelData.examName || 'ุบูุฑ ูุญุฏุฏ', examDate: modelData.examDate || '',
                score: `${correctCount}/${totalQuestions}`, 
                percentage: document.getElementById('scorePercentage')?.textContent || '0%', 
                grade: document.getElementById('letterGrade')?.textContent || '-',
            };
            const finalStudentAnswers = Array.from({ length: totalQuestions }, (_, i) => studentAnswers[i] || 'ูุฑุงุบ');
            const detailedResult = { ...result, answers: finalStudentAnswers };

            resultsHistory.unshift(result); detailedAnswersLog.unshift(detailedResult);
            localStorage.setItem('examResults', JSON.stringify(resultsHistory));
            localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
            updateHistoryDisplay();
            document.getElementById('detailedHistorySection')?.classList.remove('hidden');
            
            const studentIndex = studentsList.findIndex(s => s.id === studentForHistory.id);
            if (studentIndex !== -1) {
                studentsList[studentIndex].status = 'corrected'; 
                studentsList[studentIndex].result = { percentage: result.percentage, score: result.score };
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                displayStudentsList();
            }
            if (isMultipleCorrectionMode) {
                handleMultiCorrectionNext(result);
            } else {
                resetForNewSheet();
            }
        }

        function resetForNewSheet() {
            document.getElementById('resultsSection')?.classList.add('hidden');
            document.getElementById('verificationContainer')?.classList.add('hidden');
            selectDifferentStudent();
            showNotification('ุชู ุงูุญูุธ! ููููู ุงูุขู ุชุตุญูุญ ูุฑูุฉ ุฌุฏูุฏุฉ.', 'success');
            
            if (stream) {
                startAutoCapture(); 
            } else {
                document.getElementById('uploadOptions')?.classList.remove('hidden');
            }
        }

        // === History Management ===
         function populateHistoryFilters() {
            const classFilter = document.getElementById('historyClassFilter');
            const examFilter = document.getElementById('historyExamFilter');
             if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

            classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const historySection = document.getElementById('historySection');
             const classFilter = document.getElementById('historyClassFilter')?.value;
             const examFilter = document.getElementById('historyExamFilter')?.value;

            if(!historyList || !historySection) return;
            
            const filteredHistory = resultsHistory.filter(r => 
                (!classFilter || r.studentClass === classFilter) &&
                (!examFilter || r.examName === examFilter)
            );


            historySection.classList.toggle('hidden', filteredHistory.length === 0);
            if (filteredHistory.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500 py-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุทุงุจู ุงูููุชุฑ ุงููุญุฏุฏ.</p>';
                return;
            }
            historyList.innerHTML = filteredHistory.map(r => `
                <div class="bg-gray-50 rounded-lg p-3 border-r-4 border-blue-500">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${r.studentName}</h4>
                            <p class="text-sm text-gray-600">${r.examName || 'ุงุฎุชุจุงุฑ ุบูุฑ ูุณูู'} - ${r.examDate || 'ุจุฏูู ุชุงุฑูุฎ'}</p>
                        </div>
                        <div class="text-left">
                            <div class="text-lg font-bold text-blue-600">${r.percentage || '0%'}</div>
                            <div class="text-sm font-semibold text-gray-700">(${r.score || '0/0'})</div>
                            <div class="text-xs text-gray-600">${r.grade || '-'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function exportResults() {
             const studentName = document.getElementById('resultStudentName')?.textContent;
             const percentage = document.getElementById('scorePercentage')?.textContent;
             if (!studentName || !percentage) return;
             const report = `ูุชูุฌุฉ ุงูุทุงูุจ: ${studentName}\nุงููุณุจุฉ: ${percentage}`;
             const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url; a.download = `ูุชูุฌุฉ_${studentName}.txt`; a.click(); URL.revokeObjectURL(url);
        }

        function exportAllResults() {
            if (resultsHistory.length === 0) return;
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(resultsHistory);
                XLSX.utils.book_append_sheet(wb, ws, 'ุณุฌู ุงููุชุงุฆุฌ');
                XLSX.writeFile(wb, 'ุณุฌู_ุงููุชุงุฆุฌ_ุงููุงูู.xlsx');
            } catch(e) {
                 console.error("Error exporting all results:", e);
                 showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ููุฎุต ุงููุชุงุฆุฌ.", "error");
            }
        }

        function exportDetailedAnswersLog() {
            if (detailedAnswersLog.length === 0) { showNotification("ูุง ููุฌุฏ ุณุฌู ููุตู ูุชุตุฏูุฑู.", "info"); return; }
            try {
                const maxQuestions = Math.max(0, ...detailedAnswersLog.map(log => log.answers?.length || 0)); 
                const headers = ['ุงุณู ุงูุทุงูุจ', 'ุงููุตู', 'ุงุณู ุงูุงุฎุชุจุงุฑ', 'ุงูุชุงุฑูุฎ', 'ุงูุฏุฑุฌุฉ'];
                for(let i=1; i<= maxQuestions; i++) { headers.push(`ุณ${i}`); }
                const data = detailedAnswersLog.map(log => {
                    const row = {'ุงุณู ุงูุทุงูุจ': log.studentName, 'ุงููุตู': log.studentClass, 'ุงุณู ุงูุงุฎุชุจุงุฑ': log.examName, 'ุงูุชุงุฑูุฎ': log.examDate, 'ุงูุฏุฑุฌุฉ': log.score };
                    (log.answers || []).forEach((ans, i) => { row[`ุณ${i+1}`] = ans; }); 
                    return row;
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data, {header: headers});
                XLSX.utils.book_append_sheet(wb, ws, 'ุณุฌู ุฅุฌุงุจุงุช ุงูุทูุงุจ');
                XLSX.writeFile(wb, 'ุณุฌู_ุฅุฌุงุจุงุช_ุงูุทูุงุจ_ุงูููุตู.xlsx');
            } catch(e) {
                 console.error("Error exporting detailed log:", e);
                 showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ุณุฌู ุงูุฅุฌุงุจุงุช.", "error");
            }
        }


        function clearHistory() {
             if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุงูุณุฌูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
                resultsHistory = []; detailedAnswersLog = [];
                localStorage.removeItem('examResults');
                localStorage.removeItem('detailedAnswersLog');
                updateHistoryDisplay();
                document.getElementById('detailedHistorySection')?.classList.add('hidden');
             }
        }
        
        // === Multiple Correction Logic ===
        function toggleMultipleCorrection() {
             const uncorrected = studentsList.filter(s => s.status === 'pending');
             if (uncorrected.length === 0) { showNotification('ุฌููุน ุงูุทูุงุจ ุชู ุชุตุญูุญ ุฃูุฑุงููู!', 'info'); return; }
             const multiSection = document.getElementById('multipleCorrectionSection');
             if(multiSection) multiSection.classList.toggle('hidden');
             selectDifferentStudent(); // Clear single selection
             showSection('correction');
        }

        function startMultipleCorrection() {
            multiCorrectionQueue = studentsList.filter(s => s.status === 'pending');
            if (multiCorrectionQueue.length === 0) { showNotification('ูุง ุชูุฌุฏ ุฃูุฑุงู ูู ุงูุชุธุงุฑ ุงูุชุตุญูุญ!', 'error'); return; }
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName] || answerKeyModels[modelName].answers.length === 0) { 
                showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ูุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูููููุฐุฌ ุงูุญุงูู ุฃููุงู!', 'error'); 
                return; 
            }
            isMultipleCorrectionMode = true; currentMultiIndex = 0; multiCorrectionResults = [];
            document.getElementById('multiCorrectionSetup')?.classList.add('hidden');
            document.getElementById('multiCorrectionActive')?.classList.remove('hidden');
            showCurrentMultiStudent();
            showNotification(`ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ ูู ${multiCorrectionQueue.length} ุทุงูุจ.`, 'success');
        }

        function showCurrentMultiStudent() {
             if(currentMultiIndex >= multiCorrectionQueue.length) {
                 completeMultipleCorrection();
                 return;
             }
            const student = multiCorrectionQueue[currentMultiIndex];
            document.getElementById('multiStudentName').textContent = student.name;
            document.getElementById('multiStudentClass').textContent = student.class;
            document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
            updateMultiCorrectionProgress();
            
             if(!isScanningForKey) { 
                showCameraSection();
            }
        }

        function updateMultiCorrectionProgress() {
             if(multiCorrectionQueue.length === 0) return;
            const progress = ((currentMultiIndex) / multiCorrectionQueue.length) * 100;
            document.getElementById('progressText').textContent = `${currentMultiIndex} ูู ${multiCorrectionQueue.length}`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function handleMultiCorrectionNext(result) {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'completed', result });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent(); // This will trigger the camera again via resetForNewSheet->startAutoCapture
                showNotification(`ุชู ุญูุธ ุงููุชูุฌุฉ. ุงูุชูู ููุทุงูุจ ุงูุชุงูู: ${multiCorrectionQueue[currentMultiIndex].name}`, 'info');
            } else {
                completeMultipleCorrection();
            }
        }

        function skipCurrentStudent() {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'skipped', result: null });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent();
                 if(!stream) showCameraSection(); else startAutoCapture();
            } else {
                completeMultipleCorrection();
            }
        }


        function stopMultipleCorrection() {
             if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏุ')) {
                completeMultipleCorrection();
             }
        }

        function completeMultipleCorrection() {
            isMultipleCorrectionMode = false;
             stopCamera(); // Stop camera when multi-mode ends
            document.getElementById('multiCorrectionActive')?.classList.add('hidden');
            if (multiCorrectionResults.length > 0) {
                generateMultiCorrectionReport();
            } else {
                resetMultiCorrection();
            }
             showNotification('ุชู ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ.', 'success');
        }

        function generateMultiCorrectionReport() {
            const corrected = multiCorrectionResults.filter(r => r.status === 'completed').length;
            const skipped = multiCorrectionResults.filter(r => r.status === 'skipped').length;
            const avgScore = corrected > 0 ? Math.round(multiCorrectionResults.filter(r=>r.result).reduce((sum, r) => sum + parseInt(r.result.percentage), 0) / corrected) : 0;
            const reportContentDiv = document.getElementById('multiReportContent');
            const reportSectionDiv = document.getElementById('multiCorrectionReport');
            if(!reportContentDiv || !reportSectionDiv) return;

            reportContentDiv.innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-green-100 p-2 rounded-lg"><div class="font-bold text-lg">${corrected}</div><div class="text-xs">ุชู ุชุตุญูุญูุง</div></div>
                    <div class="bg-yellow-100 p-2 rounded-lg"><div class="font-bold text-lg">${skipped}</div><div class="text-xs">ุชู ุชุฎุทููุง</div></div>
                    <div class="bg-blue-100 p-2 rounded-lg"><div class="font-bold text-lg">${avgScore}%</div><div class="text-xs">ูุชูุณุท ุงูุฏุฑุฌุงุช</div></div>
                </div>
            `;
            reportSectionDiv.classList.remove('hidden');
        }

        function exportMultiReport() {
             if(multiCorrectionResults.length === 0) return;
            try {
                const reportData = multiCorrectionResults.map(r => ({
                    'ุงุณู ุงูุทุงูุจ': r.student.name, 
                    'ุงููุตู': r.student.class, 
                    'ุงูุญุงูุฉ': r.status === 'completed' ? 'ุชู ุงูุชุตุญูุญ' : 'ุชู ุงูุชุฎุทู', 
                    'ุงูุฏุฑุฌุฉ': r.result ? r.result.score : '-',
                    'ุงููุณุจุฉ': r.result ? r.result.percentage : '-',
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(reportData);
                XLSX.utils.book_append_sheet(wb, ws, 'ุชูุฑูุฑ ุงูุชุตุญูุญ');
                XLSX.writeFile(wb, 'ุชูุฑูุฑ_ุงูุชุตุญูุญ_ุงููุชุนุฏุฏ.xlsx');
            } catch(e) {
                 console.error("Error exporting multi-report:", e);
                 showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุชูุฑูุฑ.", "error");
            }
        }


        function resetMultiCorrection() {
            document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
            document.getElementById('multiCorrectionSetup')?.classList.remove('hidden');
            document.getElementById('multiCorrectionReport')?.classList.add('hidden');
        }
        
        // === Reports Section ===
        function populateReportFilters() {
            const classFilter = document.getElementById('reportClassFilter');
            const examFilter = document.getElementById('reportExamFilter');
             if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

            classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }
        
        function generateClassReport() {
            const classFilter = document.getElementById('reportClassFilter')?.value;
            const examFilter = document.getElementById('reportExamFilter')?.value;
            const container = document.getElementById('report-container');
             if (container === null || classFilter === undefined || examFilter === undefined) return;

            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.studentClass === classFilter) &&
                (!examFilter || log.examName === examFilter)
            );
            
             const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
             const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


            if (filteredLogs.length === 0 && absentStudents.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุทุงุจู ูุฐู ุงูููุงุชุฑ ูุฅูุดุงุก ุชูุฑูุฑ.</p>`;
                return;
            }
            
            const firstLog = filteredLogs[0]; // Use first log to find answer key
            let reportCorrectAnswers = [];
            let questionAnalysisHTML = '<p class="text-sm text-gray-500">ูุง ูููู ุชุญููู ุงูุฃุณุฆูุฉ ุจุฏูู ูููุฐุฌ ุฅุฌุงุจุฉ ูุทุงุจู ููุฐุง ุงูุงุฎุชุจุงุฑ.</p>';
            let hardestQuestionNum = '-';
            let easiestQuestionNum = '-';
            
            if (firstLog) {
                const modelName = Object.keys(answerKeyModels).find(key => {
                    const model = answerKeyModels[key];
                    // Match by examName AND number of answers
                    return model && (model.examName === firstLog.examName) && (model.answers && model.answers.length === (firstLog.answers?.length || 0));
                });
                reportCorrectAnswers = modelName ? (answerKeyModels[modelName].answers || []) : [];

                if (reportCorrectAnswers.length > 0) {
                     const questionErrors = {};
                     for (let i = 0; i < reportCorrectAnswers.length; i++) {
                         // Initialize with errors, choices map, and correct answer
                         questionErrors[i + 1] = { errors: 0, choices: {}, correct: reportCorrectAnswers[i] };
                     }
                     filteredLogs.forEach(log => {
                         (log.answers || []).forEach((studentAnswer, i) => {
                             if (i < reportCorrectAnswers.length && studentAnswer !== reportCorrectAnswers[i]) {
                                 questionErrors[i + 1].errors++;
                                 // Track incorrect choices (excluding blank)
                                 if(studentAnswer && studentAnswer !== 'ูุฑุงุบ'){ 
                                     questionErrors[i + 1].choices[studentAnswer] = (questionErrors[i + 1].choices[studentAnswer] || 0) + 1;
                                 }
                             }
                         });
                     });
                     
                     // Sort questions by error count (descending)
                     const sortedErrors = Object.entries(questionErrors).sort(([,a],[,b]) => b.errors - a.errors);
                     
                     hardestQuestionNum = sortedErrors.length > 0 ? sortedErrors[0][0] : '-';
                     easiestQuestionNum = sortedErrors.length > 0 ? sortedErrors[sortedErrors.length - 1][0] : '-';

                     // Build the analysis table HTML
                     questionAnalysisHTML = `
                        <table class="w-full text-sm mt-4 border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-300">
                                    <th class="p-1 border-l border-gray-300">ุฑูู ุงูุณุคุงู</th>
                                    <th class="p-1 border-l border-gray-300">ุนุฏุฏ ุงูุฃุฎุทุงุก</th>
                                    <th class="p-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedErrors.map(([qNum, data]) => {
                                    // Determine row color based on error rate
                                    let errorClass = 'q-errors-none';
                                    if(filteredLogs.length > 0) { // Avoid division by zero
                                        const errorRate = data.errors / filteredLogs.length;
                                        if (errorRate > 0.5) errorClass = 'q-errors-high';
                                        else if (errorRate > 0.25) errorClass = 'q-errors-medium';
                                        else if (errorRate > 0) errorClass = 'q-errors-low';
                                    }
                                    return `
                                    <tr class="border-b border-gray-200 ${errorClass}">
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${qNum}</td>
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${data.errors}</td>
                                        <td class="p-1 text-center">${data.correct || '-'}</td>
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>`;
                 }
            }


            const scores = filteredLogs.map(log => parseInt(log.percentage));
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0;
            const minScore = scores.length > 0 ? Math.min(...scores) : 0;
            const presentCount = filteredLogs.length;
            const absentCount = absentStudents.length;


            let reportHTML = `
                <div id="printable-report" class="bg-white p-6 rounded-lg shadow-md">
                    
                    <h4 class="text-lg font-bold mb-2">ููุฎุต ุงูุฃุฏุงุก</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                         <div class="bg-blue-100 p-3 rounded-lg"><div class="font-bold text-xl">${presentCount}</div><div class="text-xs">ุนุฏุฏ ุงูุญุถูุฑ</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-xl">${absentCount}</div><div class="text-xs">ุนุฏุฏ ุงูุบูุงุจ</div></div>
                        <div class="bg-green-100 p-3 rounded-lg"><div class="font-bold text-xl">${avgScore}%</div><div class="text-xs">ูุชูุณุท ุงูุญุถูุฑ</div></div>
                        <div class="bg-yellow-100 p-3 rounded-lg"><div class="font-bold text-xl">${maxScore}%</div><div class="text-xs">ุฃุนูู ุฏุฑุฌุฉ</div></div>
                       
                    </div>
                    
                    <h4 class="text-lg font-bold mt-6 mb-2">ุชุญููู ุงูุฃุณุฆูุฉ</h4>
                     <div class="grid grid-cols-2 gap-4 mb-4">
                         <div class="bg-red-50 p-3 rounded-lg text-center">
                            <h5 class="font-semibold mb-1 text-red-700">ุฃุตุนุจ ุณุคุงู</h5>
                            <p class="text-2xl font-bold text-red-600">${hardestQuestionNum}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <h5 class="font-semibold mb-1 text-green-700">ุฃุณูู ุณุคุงู</h5>
                            <p class="text-2xl font-bold text-green-600">${easiestQuestionNum}</p>
                        </div>
                    </div>
                    <div class="max-h-60 overflow-y-auto pr-2 mb-6 border rounded p-2 bg-gray-50">
                        ${questionAnalysisHTML}
                    </div>

                    <div class="text-center">
                        <button id="printReportBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงููุงูู</button>
                    </div>
                </div>
            `;
            container.innerHTML = reportHTML;
            
             // Re-attach listener for the newly created button
             const printBtn = document.getElementById('printReportBtn');
             if(printBtn) printBtn.addEventListener('click', printReport);
        }

        async function printReport() {
            const classFilter = document.getElementById('reportClassFilter')?.value;
            const examFilter = document.getElementById('reportExamFilter')?.value;
             if(classFilter === undefined || examFilter === undefined) return;
             const modelNameFromExam = Object.keys(answerKeyModels).find(key => answerKeyModels[key].examName === examFilter);
             const subjectName = modelNameFromExam ? answerKeyModels[modelNameFromExam].subject : (examFilter || 'ุงูุงุฎุชุจุงุฑ');
             const date = new Date().toLocaleDateString('ar-SA');
             const title = `ุชูุฑูุฑ ุฃุฏุงุก ${subjectName} ${examFilter ? '- ' + examFilter : ''}`;
            const fileName = `ุชูุฑูุฑ-${subjectName.replace(/[^a-zA-Z0-9]/g, '_')}-${date}`; // Sanitize file name

            
            // Get the generated content *excluding* the print button itself for printing
            const reportContainerClone = document.getElementById('report-container')?.cloneNode(true);
             if(!reportContainerClone) return;
            const printButtonInClone = reportContainerClone.querySelector('#printReportBtn');
            if(printButtonInClone) printButtonInClone.remove();
            let reportContent = reportContainerClone.innerHTML; // Contains summary + analysis table
             
            // Filter logs again to get student list for printing
            const studentLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.studentClass === classFilter) &&
                (!examFilter || log.examName === examFilter)
            );
            const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
            const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


            // Sort students alphabetically for the table
            allStudentsInFilter.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

            const studentListHTML = allStudentsInFilter.map((student, index) => {
                const log = studentLogs.find(l => l.studentName === student.name && l.studentClass === student.class);
                return `
                <tr class="border-b">
                    <td class="p-1 text-center">${index + 1}</td>
                    <td class="p-1 text-right">${student.name}</td>
                     <td class="p-1 text-center">${student.class}</td>
                    <td class="p-1 text-center">${log ? log.score : (student.status === 'absent' ? 'ุบุงุฆุจ' : '-')}</td>
                    <td class="p-1 text-center">${log ? log.percentage : '-'}</td>
                    <td class="p-1 text-center">${log ? log.grade : '-'}</td>
                </tr>
            `}).join('');
            
             const absentListHTML = absentStudents.map((student, index) => `
                 <li class="text-sm">${index + 1}. ${student.name} (${student.class})</li>
             `).join('');


            // Generate chart images for printing
             const gradeChartImage = await getReportChartsAsImages(studentLogs, 'pie');
             const classChartImage = await getReportChartsAsImages(studentLogs, 'bar', classFilter); // Pass classFilter for bar chart context


            const studentTable = `
                <h4 class="text-lg font-bold mt-6 mb-2">ุฏุฑุฌุงุช ุงูุทูุงุจ</h4>
                <table class="w-full text-sm mt-4">
                    <thead><tr class="border-b-2 border-black"><th class="p-1">#</th><th class="p-1 text-right">ุงุณู ุงูุทุงูุจ</th><th class="p-1">ุงููุตู</th><th class="p-1">ุงูุฏุฑุฌุฉ</th><th class="p-1">ุงููุณุจุฉ</th><th class="p-1">ุงูุชูุฏูุฑ</th></tr></thead>
                    <tbody>${studentListHTML}</tbody>
                </table>
                 <div style="page-break-before: always;"></div> <!-- Page break before charts -->
                 <h4 class="text-lg font-bold mt-6 mb-2">ุชูุฒูุน ุงูุชูุฏูุฑุงุช</h4>
                ${gradeChartImage ? `<img src="${gradeChartImage}" class="mx-auto block" style="max-width: 350px; margin-top: 10px;"/>` : '<p class="text-center text-gray-500">ูุง ูููู ุนุฑุถ ุฑุณู ุงูุชูุฏูุฑุงุช.</p>'}
                
                ${classChartImage ? `
                     <h4 class="text-lg font-bold mt-6 mb-2">ูุชูุณุท ุงูุฃุฏุงุก ุญุณุจ ุงููุตู</h4>
                     <img src="${classChartImage}" class="mx-auto block" style="max-width: 500px; margin-top: 10px;"/>
                 ` : ''}

                 ${absentCount > 0 ? `
                     <h4 class="text-lg font-bold mt-6 mb-2">ุงูุทูุงุจ ุงูุบุงุฆุจูู (${absentCount})</h4>
                     <ul class="list-decimal list-inside pr-4">${absentListHTML}</ul>
                 ` : ''}
            `;
            
            printContent(reportContent + studentTable, title, fileName); // Combine analysis table and student table
        }

        function printContent(content, title, fileName) {
            const settings = getFromStorage('appSettings', {});
            const classFilter = document.getElementById('reportClassFilter')?.value || '';
            const examFilter = document.getElementById('reportExamFilter')?.value || '';
            const date = new Date().toLocaleDateString('ar-SA');
            const safeFileName = fileName || `${title.replace(/[^a-zA-Z0-9]/g, '_')}_${date}`; // Use provided or generate

            const headerInfo = `
                <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <p>${settings.admin || ''}</p>
                    <p>${settings.school || ''}</p>
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin: 5px 0;">${title}</h1>
                    <div style="font-size: 0.9rem; color: #555;">
                        <span>${classFilter ? `ุงููุตู: ${classFilter}`: ''}</span>
                        <span>${examFilter ? ` | ุงุฎุชุจุงุฑ: ${examFilter}` : ''}</span>
                        <span> | ${date}</span>
                    </div>
                     <div style="font-size: 0.8rem; color: #555; margin-top: 5px;">
                        <span>ุงููุนูู: ${settings.teacher || ''}</span>
                        ${settings.director ? `<span> | ุงููุฏูุฑ: ${settings.director || ''}</span>` : ''}
                    </div>
                </div>
            `;

            const fullContent = headerInfo + content;
            const win = window.open('', '_blank');
             if(win){
                 // Added style block specifically for printing tables correctly
                 // Included CSS for colors from the main style block
                 win.document.write(`
                    <html>
                        <head>
                            <title>${safeFileName}</title>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                            <style>
                                body { font-family:'Cairo', sans-serif; direction: rtl; margin: 20px; } 
                                table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto; } 
                                tr { page-break-inside: avoid; page-break-after: auto; }
                                thead { display: table-header-group; } /* Repeat header on each page */
                                td, th { border: 1px solid #ddd !important; padding: 6px !important; text-align: center !important; font-size: 0.8rem; } 
                                th { background-color: #f2f2f2 !important; font-weight: bold !important;} 
                                tr:nth-child(even){background-color: #f9f9f9 !important;} 
                                img { max-width: 100%; height: auto; }
                                .page-break { page-break-before: always; }
                                /* Bring color styles directly here for printing */
                                .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } 
                                .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } 
                                .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } 
                                .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } 
                                .bg-blue-100 { background-color: #DBEAFE !important; }
                                .bg-green-100 { background-color: #DCFCE7 !important; }
                                .bg-red-100 { background-color: #FEE2E2 !important; }
                                .bg-gray-100 { background-color: #F3F4F6 !important; }
                                .bg-yellow-100 { background-color: #FEF3C7 !important; }
                                .text-red-700 { color: #b91c1c !important; }
                                .text-green-700 { color: #15803d !important; }
                                .text-red-600 { color: #dc2626 !important; }
                                .text-green-600 { color: #16a34a !important; }
                                .text-blue-600 { color: #2563eb !important; }
                                .font-semibold { font-weight: 600 !important; }
                                .font-bold { font-weight: 700 !important; }
                                @media print { 
                                    body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; } 
                                    button { display: none !important; } 
                                }
                            </style>
                        </head>
                        <body class="p-4">${fullContent}</body>
                    </html>`);
                win.document.close();
                setTimeout(() => { 
                    try { win.print(); } catch(e){ console.error("Print error:", e); }
                    // win.close(); // Keep window open for saving as PDF option
                 }, 500);
             } else {
                 showNotification("ูุดู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.", "error");
             }
        }



        function printBlankSheet() {
             const qCountInput = document.getElementById('questionCount');
             const oCountSelect = document.getElementById('optionsCount');
             const subjectInput = document.getElementById('subjectName');
             const modelSelect = document.getElementById('answerKeyModel');
             const examNameInput = document.getElementById('examName');
             const examDateInput = document.getElementById('examDate');

              if(!qCountInput || !oCountSelect || !subjectInput || !modelSelect || !examNameInput || !examDateInput) {
                 showNotification("ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงููููุฐุฌ.", "error");
                 return;
             }


            const qCount = parseInt(qCountInput.value);
            if (isNaN(qCount) || qCount < 1) {
                 showNotification("ุนุฏุฏ ุงูุฃุณุฆูุฉ ุบูุฑ ุตุงูุญ ูุทุจุงุนุฉ ุงููููุฐุฌ.", "error");
                 return;
             }
            const oCount = parseInt(oCountSelect.value);
            const options = Array.from({ length: oCount }, (_, i) => String.fromCharCode(65 + i));
            const subjectName = subjectInput.value || 'ุบูุฑ ูุญุฏุฏ';
            const modelName = modelSelect.value.replace('ูููุฐุฌ ', '');
            const examName = examNameInput.value || 'ุบูุฑ ูุญุฏุฏ';
            const examDate = examDateInput.value || '';
            const splitPoint = Math.ceil(qCount / 2);
            const date = new Date().toLocaleDateString('ar-SA');
            const fileName = `ูููุฐุฌ-ุฅุฌุงุจุฉ-${subjectName}-${date}`;


            let col1 = '';
            for (let i = 1; i <= splitPoint; i++) {
                col1 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col1 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col1 += `</div>`;
            }

            let col2 = '';
            for (let i = splitPoint + 1; i <= qCount; i++) {
                col2 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col2 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col2 += `</div>`;
            }

            const settings = getFromStorage('appSettings', {});
            const headerInfo = `
                <p>${settings.admin || ''}</p>
                <p>${settings.school || ''}</p>
                <h1>ุงุฎุชุจุงุฑ ูุงุฏุฉ: ${subjectName} - ูููุฐุฌ ุฑูู (${modelName})</h1>
                <div class="sub-header">
                    <span>ุงูุนุงู ุงูุฏุฑุงุณู: ${settings.year || ''}</span>
                    <span>ุงููุตู ุงูุฏุฑุงุณู: ${settings.semester || ''}</span>
                </div>
            `;

            let content = `
                <style>
                    body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 20px; }
                    .page { max-width: 800px; margin: auto; }
                    .header-container { display: flex; justify-content: space-between; align-items: flex-start;  border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                    .header { text-align: center; flex-grow: 1; }
                    .header h1 { font-size: 1.5rem; font-weight: bold; margin: 5px 0;}
                    .header p { margin: 2px 0; font-size: 0.9rem; }
                    .sub-header { font-size: 0.9rem; color: #555; }
                    #qrcode-container { width: 80px; height: 80px; margin-left: 10px; /* Added margin */ }
                    .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; font-size: 14px; }
                    .info-item { border-bottom: 1.5px dotted #888; padding-bottom: 8px; }
                    .columns-container { display: flex; justify-content: space-between; gap: 20px; }
                    .column { flex: 1; }
                    .separator { border-left: 1.5px dashed #ccc; margin: 0 10px; /* Added margin */ }
                    .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
                    .q-num { font-weight: bold; width: 30px; flex-shrink: 0; /* Prevent shrinking */ }
                    .o-bubble { width: 22px; height: 22px; border: 1.5px solid black; border-radius: 50%; display: inline-block; flex-shrink: 0; }
                    .o-label { margin-left: -5px; margin-right: 8px; flex-shrink: 0;}
                    @media print { button { display: none; } }
                </style>
                <div class="page">
                    <div class="header-container">
                        <div id="qrcode-container"></div>
                        <div class="header">${headerInfo}</div>
                    </div>
                    <div class="info">
                        <div class="info-item"><strong>ุงุณู ุงูุทุงูุจ:</strong></div>
                        <div class="info-item"><strong>ุงููุตู:</strong></div>
                        <div class="info-item"><strong>ุงุณู ุงูุงุฎุชุจุงุฑ:</strong> ${examName}</div>
                        <div class="info-item"><strong>ุงูุชุงุฑูุฎ:</strong> ${examDate}</div>
                    </div>
                    <div class="columns-container">
                        <div class="column">${col1}</div>
                        ${qCount > 1 ? '<div class="separator"></div>' : ''}
                        <div class="column">${col2}</div>
                    </div>
                    <div style="text-align:center; margin-top: 30px;"><button onclick="window.print()">ุทุจุงุนุฉ</button></div>
                </div>
            `;
            
            printContent(content, `ูููุฐุฌ ุฅุฌุงุจุฉ ${subjectName}`, fileName); 
        }
        
        // === Settings Section ===
        function saveSettings() {
            settings = {
                admin: document.getElementById('setting-admin')?.value || '',
                school: document.getElementById('setting-school')?.value || '',
                teacher: document.getElementById('setting-teacher')?.value || '',
                director: document.getElementById('setting-director')?.value || '',
                year: document.getElementById('setting-year')?.value || '',
                semester: document.getElementById('setting-semester')?.value || '',
            };
            localStorage.setItem('appSettings', JSON.stringify(settings));
            showNotification('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!', 'success');
        }

        function loadSettings() {
             const adminInput = document.getElementById('setting-admin');
             if(adminInput) adminInput.value = settings.admin || '';
             const schoolInput = document.getElementById('setting-school');
             if(schoolInput) schoolInput.value = settings.school || '';
             const teacherInput = document.getElementById('setting-teacher');
             if(teacherInput) teacherInput.value = settings.teacher || '';
             const directorInput = document.getElementById('setting-director');
             if(directorInput) directorInput.value = settings.director || '';
             const yearInput = document.getElementById('setting-year');
             if(yearInput) yearInput.value = settings.year || '';
             const semesterInput = document.getElementById('setting-semester');
             if(semesterInput) semesterInput.value = settings.semester || '';
        }

        function backupData() {
            try {
                const data = {
                    appSettings: settings,
                    studentsList: studentsList,
                    examResults: resultsHistory,
                    detailedAnswersLog: detailedAnswersLog,
                    answerKeyModels: answerKeyModels,
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!', 'success');
            } catch(e) {
                 console.error("Error backing up data:", e);
                 showNotification("ุฎุทุฃ ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.", "error");
            }
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุชุ ุณูุชู ุงููุชุงุจุฉ ููู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ.")) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // Add more validation if necessary
                    if (data.appSettings && data.studentsList && data.examResults && data.detailedAnswersLog && data.answerKeyModels) {
                         // Restore data
                         settings = data.appSettings || {};
                         studentsList = (data.studentsList || []).map(s => ({ ...s, status: s.status || 'pending' })); // Ensure status on restore
                         resultsHistory = data.examResults || [];
                         detailedAnswersLog = data.detailedAnswersLog || [];
                         answerKeyModels = data.answerKeyModels || {};
                         
                         // Save restored data to localStorage
                         localStorage.setItem('appSettings', JSON.stringify(settings));
                         localStorage.setItem('studentsList', JSON.stringify(studentsList));
                         localStorage.setItem('examResults', JSON.stringify(resultsHistory));
                         localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
                         localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));

                        showNotification('ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุชุญุฏูุซ ุงููุงุฌูุฉ.', 'success');
                        
                        // Instead of reload, call loadInitialUI to refresh display
                        loadInitialUI(); 
                        showSection('dashboard'); // Go to dashboard after restore


                    } else {
                        throw new Error("ููู ุงููุณุฎ ุงูุงุญุชูุงุทู ุบูุฑ ุตุงูุญ ุฃู ุชุงูู.");
                    }
                } catch (error) {
                     console.error("Error restoring data:", error);
                    showNotification(`ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช: ${error.message}`, 'error');
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
             reader.onerror = (e) => {
                 console.error("FileReader error (restore):", e);
                 showNotification("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.", "error");
                  event.target.value = ''; // Reset file input
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            const confirmation = prompt("ููุชุฃููุฏุ ูุฑุฌู ูุชุงุจุฉ 'ุญุฐู' ูู ุงููุฑุจุน ุฃุฏูุงู.");
            if (confirmation === 'ุญุฐู') {
                localStorage.clear();
                showNotification('ุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('ูู ูุชู ุงูุญุฐู. ุงููุชุงุจุฉ ุบูุฑ ูุทุงุจูุฉ.', 'info');
            }
        }
        
        // === Stats Section ===
         function populateStatsFilters() {
            const classFilter = document.getElementById('statsClassFilter');
            const examFilter = document.getElementById('statsExamFilter');
             if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

            classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function updateGlobalStats() {
            const container = document.getElementById('summary-stats');
            const gradeCtx = document.getElementById('grade-distribution-chart');
            const classCtx = document.getElementById('class-performance-chart');
            const classFilter = document.getElementById('statsClassFilter')?.value;
            const examFilter = document.getElementById('statsExamFilter')?.value;
            
             if(!container || !gradeCtx || !classCtx) {
                 console.warn("Stats elements not found, skipping update.");
                 return; 
             }
             
             const filteredResults = resultsHistory.filter(r => 
                 (!classFilter || r.studentClass === classFilter) &&
                 (!examFilter || r.examName === examFilter)
             );


            const totalCorrected = filteredResults.length;
            const overallAverage = totalCorrected > 0 ? Math.round(filteredResults.reduce((sum, r) => sum + (parseInt(r.percentage) || 0), 0) / totalCorrected) : 0;
            const uniqueStudents = new Set(filteredResults.map(r => r.studentName)).size;
            const uniqueExams = new Set(filteredResults.map(r => r.examName)).size;

            container.innerHTML = `
                <div class="bg-blue-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${totalCorrected}</div><div class="text-xs">ูุฑูุฉ ูุตุญุญุฉ</div></div>
                <div class="bg-green-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${overallAverage}%</div><div class="text-xs">ูุชูุณุท ุงูุฃุฏุงุก</div></div>
                <div class="bg-purple-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${uniqueStudents}</div><div class="text-xs">ุทุงูุจ ูุฑูุฏ</div></div>
                <div class="bg-yellow-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-600">${uniqueExams}</div><div class="text-xs">ุงุฎุชุจุงุฑ ูุฑูุฏ</div></div>
            `;
            
            // Grade Distribution Chart
             try {
                if(gradeChart) gradeChart.destroy();
                const gradeCounts = { 'ููุชุงุฒ': 0, 'ุฌูุฏ ุฌุฏุงู': 0, 'ุฌูุฏ': 0, 'ููุจูู': 0, 'ุถุนูู': 0 };
                 filteredResults.forEach(r => { 
                     const grade = r.grade || 'ุถุนูู'; // Default to 'ุถุนูู' if grade is missing
                     if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
                 });
                gradeChart = new Chart(gradeCtx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeCounts),
                        datasets: [{
                            data: Object.values(gradeCounts),
                            backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
             } catch (e) { console.error("Error creating grade chart:", e); }

            // Class Performance Chart
             try {
                if(classChart) classChart.destroy();
                const classPerformances = {};
                filteredResults.forEach(r => {
                     const className = r.studentClass || 'ุบูุฑ ูุญุฏุฏ';
                    if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
                    classPerformances[className].total += (parseInt(r.percentage) || 0); // Default to 0 if percentage is invalid
                    classPerformances[className].count++;
                });
                const classLabels = Object.keys(classPerformances).sort();
                const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
                classChart = new Chart(classCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: classLabels,
                        datasets: [{
                            label: 'ูุชูุณุท ุงูุฏุฑุฌุงุช',
                            data: classAverages,
                            backgroundColor: '#4f46e5',
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            } catch (e) { console.error("Error creating class chart:", e); }
        }
        
        async function getReportChartsAsImages(logs, chartType, classFilterValue) {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js library is not loaded.");
                return null;
            }
            const offscreenCanvas = document.createElement('canvas');
            const ctx = offscreenCanvas.getContext('2d');
            if(!ctx){
                 console.error("Could not get 2D context for offscreen canvas.");
                 return null;
            }
            
            let chartConfig;
            
            if(chartType === 'pie'){
                 offscreenCanvas.width = 400; offscreenCanvas.height = 250; 
                 const gradeCounts = { 'ููุชุงุฒ': 0, 'ุฌูุฏ ุฌุฏุงู': 0, 'ุฌูุฏ': 0, 'ููุจูู': 0, 'ุถุนูู': 0 };
                 logs.forEach(r => { 
                    const grade = r.grade || 'ุถุนูู';
                    if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
                 });
                 chartConfig = {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeCounts),
                        datasets: [{ data: Object.values(gradeCounts), backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'], }]
                    },
                    options: { responsive: false, animation: false, plugins: { legend: { display: true, position: 'bottom' } } }
                 };
            } else if (chartType === 'bar'){
                 offscreenCanvas.width = 600; offscreenCanvas.height = 300; 
                 const classPerformances = {};
                 const relevantHistory = classFilterValue ? resultsHistory.filter(r => r.studentClass === classFilterValue) : resultsHistory; // Filter history for bar chart

                 relevantHistory.forEach(r => {
                     const className = r.studentClass || 'ุบูุฑ ูุญุฏุฏ';
                    if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
                    classPerformances[className].total += (parseInt(r.percentage) || 0); 
                    classPerformances[className].count++;
                 });
                 const classLabels = Object.keys(classPerformances).sort();
                 const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
                 
                 chartConfig = {
                     type: 'bar',
                     data: {
                        labels: classLabels,
                        datasets: [{ label: 'ูุชูุณุท ุงูุฏุฑุฌุงุช', data: classAverages, backgroundColor: '#4f46e5', }]
                     },
                     options: { responsive: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
                 };
            } else {
                 return null; // Invalid chart type
            }

            return new Promise((resolve) => {
                let chartInstance = null;
                try {
                     chartInstance = new Chart(ctx, chartConfig);
                     requestAnimationFrame(() => {
                         requestAnimationFrame(() => { 
                             try { resolve(chartInstance.toBase64Image()); } 
                             catch (imgError) { console.error("Error converting chart to image:", imgError); resolve(null); } 
                             finally { if (chartInstance) chartInstance.destroy(); }
                         });
                     });
                } catch (chartError) {
                     console.error("Error creating chart instance:", chartError);
                     resolve(null); 
                     if (chartInstance) chartInstance.destroy(); 
                }
            });
        }

    </script>
</body>
</html>

