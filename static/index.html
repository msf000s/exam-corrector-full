<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช - ุงููุงุฌูุฉ ุงูุชุฌุฑูุจูุฉ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px dashed #10b981;
            width: 80%;
            height: 60%;
            pointer-events: none;
            border-radius: 8px;
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .empty-answer { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .debug-image { max-height: 400px; border: 2px solid #e5e7eb; border-radius: 8px; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- ุฑุฃุณ ุงูุตูุญุฉ -->
        <header class="text-center mb-12">
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-4xl mx-auto">
                <h1 class="text-5xl font-bold text-gray-800 mb-4">๐ฏ ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช</h1>
                <p class="text-xl text-gray-600 mb-6">ูุงุฌูุฉ ุชุฌุฑูุจูุฉ ูุงุฎุชุจุงุฑ ูุธุงู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุงูุขูู ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <div class="font-semibold text-green-800">โก ุณุฑูุน</div>
                        <div class="text-green-600">ุชุตุญูุญ ุขูู ููุฑู</div>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <div class="font-semibold text-blue-800">๐ฏ ุฏููู</div>
                        <div class="text-blue-600">ุฎูุงุฑุฒููุงุช ูุชูุฏูุฉ</div>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <div class="font-semibold text-purple-800">๐ ููุตู</div>
                        <div class="text-purple-600">ุชูุงุฑูุฑ ูุชุญูููุงุช</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto">
            <!-- ูุณู ุงูุฅุนุฏุงุฏุงุช -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชุตุญูุญ
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-3">๐ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ</h3>
                        <div class="space-y-2">
                            <textarea id="correctAnswers" rows="3" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ููุตููุฉ ุจูุงุตูุฉ (ูุซุงู: B,C,A,D,B,A,C,D,A,B)">B,C,A,D,B,A,C,D,A,B</textarea>
                            <button onclick="updateAnswerKey()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-sm">
                                ุชุญุฏูุซ ุงูุฅุฌุงุจุงุช
                            </button>
                        </div>
                    </div>

                    <!-- ุฅุนุฏุงุฏุงุช ุงูุฃุณุฆูุฉ -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-3">๐ ุฅุนุฏุงุฏุงุช ุงูุฃุณุฆูุฉ</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-1">ุนุฏุฏ ุงูุฃุณุฆูุฉ:</label>
                                <input type="number" id="numQuestions" min="1" max="50" value="10" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-1">ุนุฏุฏ ุงูุฎูุงุฑุงุช:</label>
                                <select id="optionsPerQuestion" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="4">4 ุฎูุงุฑุงุช (A,B,C,D)</option>
                                    <option value="5">5 ุฎูุงุฑุงุช (A,B,C,D,E)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ุฎูุงุฑุงุช ุฅุถุงููุฉ -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-800 mb-3">๐ง ุฎูุงุฑุงุช ุฅุถุงููุฉ</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="debugMode" class="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                <span class="text-sm text-purple-700">ูุถุน ุงูุชุตุญูุญ (ุนุฑุถ ุตูุฑุฉ ุงูุชุญููู)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoProcess" checked class="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                <span class="text-sm text-purple-700">ูุนุงูุฌุฉ ุชููุงุฆูุฉ ุจุนุฏ ุงูุฑูุน</span>
                            </label>
                            <button onclick="testConnection()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium text-sm">
                                ุงุฎุชุจุงุฑ ุงูุงุชุตุงู
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ุญุงูุฉ ุงูุฎุงุฏู -->
                <div id="serverStatus" class="bg-gray-100 rounded-lg p-4 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="statusIcon" class="w-8 h-8 rounded-full flex items-center justify-center"></div>
                            <div>
                                <div id="statusText" class="font-semibold"></div>
                                <div id="statusDetails" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <div id="statusTime" class="text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>

            <!-- ูุณู ุฑูุน ุงูุตูุฑ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- ุฑูุน ุงูุตูุฑุฉ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ๐ท ุฑูุน ุตูุฑุฉ ูุฑูุฉ ุงูุฅุฌุงุจุฉ
                    </h2>

                    <!-- ุทุฑู ุงูุฑูุน -->
                    <div class="flex flex-col gap-4 mb-6">
                        <!-- ุฑูุน ููู -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                            <input type="file" id="imageUpload" accept="image/*" class="hidden">
                            <div class="mb-4">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-2xl">๐</span>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">ุฑูุน ูู ุงูุฌูุงุฒ</h3>
                                <p class="text-sm text-gray-600">ุงุฎุชุฑ ุตูุฑุฉ ูู ุฌูุงุฒู</p>
                            </div>
                            <button onclick="document.getElementById('imageUpload').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                                ุงุฎุชุฑ ุตูุฑุฉ
                            </button>
                        </div>

                        <!-- ุงูุณุญุจ ูุงูุฅููุงุช -->
                        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors">
                            <div class="mb-4">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-2xl">โฌ๏ธ</span>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">ุณุญุจ ูุฅููุงุช</h3>
                                <p class="text-sm text-gray-600">ุงุณุญุจ ุงูุตูุฑุฉ ูุฃููุชูุง ููุง</p>
                            </div>
                            <p class="text-xs text-gray-500">ูุฏุนู: JPG, PNG, JPEG (ุงูุญุฏ ุงูุฃูุตู: 10MB)</p>
                        </div>
                    </div>

                    <!-- ูุนุงููุฉ ุงูุตูุฑุฉ -->
                    <div id="imagePreviewSection" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ูุนุงููุฉ ุงูุตูุฑุฉ:</h3>
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <img id="imagePreview" class="w-full h-64 object-contain rounded-lg mb-4">
                            <div class="flex gap-2">
                                <button onclick="processImage()" id="processBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium">
                                    ๐ ุจุฏุก ุงูุชุตุญูุญ
                                </button>
                                <button onclick="clearImage()" class="px-4 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-medium">
                                    โ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุงููุงููุฑุง -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ๐น ุงูุชุตููุฑ ุงููุจุงุดุฑ
                    </h2>

                    <div class="camera-container mb-4">
                        <video id="camera" autoplay playsinline class="w-full h-64 object-cover"></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="overlay"></div>
                        <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg text-sm">
                            ุถุน ูุฑูุฉ ุงูุฅุฌุงุจุฉ ุฏุงุฎู ุงูุฅุทุงุฑ
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="startCamera()" id="startCameraBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">
                            ๐น ุชุดุบูู ุงููุงููุฑุง
                        </button>
                        <button onclick="captureFromCamera()" id="captureBtn" disabled class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                            ๐ธ ุงูุชูุงุท ุตูุฑุฉ
                        </button>
                        <button onclick="stopCamera()" id="stopCameraBtn" disabled class="bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                            โน๏ธ ุฅููุงู ุงููุงููุฑุง
                        </button>
                    </div>
                </div>
            </div>

            <!-- ุงููุชุงุฆุฌ ูุงูุชุญููู -->
            <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden result-animation">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    ๐ ูุชุงุฆุฌ ุงูุชุตุญูุญ
                </h2>

                <!-- ุงูุฅุญุตุงุฆูุงุช -->
                <div id="resultsStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- ุณูุชู ุชุนุจุฆุชูุง ุจุงููุชุงุฆุฌ -->
                </div>

                <!-- ุงูุฅุฌุงุจุงุช ุงูุชูุตูููุฉ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ุงูุฅุฌุงุจุงุช ุงูููุชุดูุฉ:</h3>
                    <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <!-- ุณูุชู ุชุนุจุฆุชูุง ุจุงูุฅุฌุงุจุงุช -->
                    </div>
                </div>

                <!-- ุตูุฑุฉ ุงูุชุตุญูุญ -->
                <div id="debugSection" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ุตูุฑุฉ ุงูุชุญููู:</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <img id="debugImage" class="debug-image mx-auto">
                        <p class="text-sm text-gray-600 text-center mt-2">ุงูุฃุฎุถุฑ: ููุงุนุงุช ููุชุดูุฉุ ุงูุฃุญูุฑ: ููุงุนุงุช ุบูุฑ ููููุกุฉ</p>
                    </div>
                </div>

                <!-- ูุนูููุงุช ุฅุถุงููุฉ -->
                <div id="additionalInfo" class="bg-gray-50 rounded-lg p-4 hidden">
                    <h3 class="font-semibold text-gray-800 mb-3">ูุนูููุงุช ุงูุชุญููู:</h3>
                    <div id="analysisInfo" class="text-sm text-gray-600 space-y-1">
                        <!-- ูุนูููุงุช ุงูุชุญููู -->
                    </div>
                </div>

                <!-- ุฃุฒุฑุงุฑ ุงูุชุญูู -->
                <div class="flex flex-wrap gap-3 justify-center mt-6">
                    <button onclick="downloadResults()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                        ๐ ุญูุธ ุงููุชุงุฆุฌ
                    </button>
                    <button onclick="resetTest()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                        ๐ ุงุฎุชุจุงุฑ ุฌุฏูุฏ
                    </button>
                    <button onclick="shareResults()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                        ๐ค ูุดุงุฑูุฉ ุงููุชุงุฆุฌ
                    </button>
                </div>
            </div>

            <!-- ุณุฌู ุงูุงุฎุชุจุงุฑุงุช -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        ๐ ุณุฌู ุงูุงุฎุชุจุงุฑุงุช
                    </h2>
                    <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        ูุณุญ ุงูุณุฌู
                    </button>
                </div>

                <div id="testHistory" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ
                    </div>
                </div>
            </div>
        </main>

        <!-- ุชุฐููู ุงูุตูุญุฉ -->
        <footer class="text-center mt-12 text-gray-600">
            <p>ุชู ุงูุชุทููุฑ ุจุงุณุชุฎุฏุงู Flask + OpenCV + Render.com</p>
            <p class="text-sm mt-2">ูุงุฌูุฉ ุชุฌุฑูุจูุฉ ูุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุงูุขูู</p>
        </footer>
    </div>

    <script>
        // ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
        let currentStream = null;
        let testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
        const API_BASE = window.location.origin;

        // ุชููุฆุฉ ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            loadTestHistory();
            setupEventListeners();
        });

        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
        function setupEventListeners() {
            // ุฑูุน ุงูููู
            document.getElementById('imageUpload').addEventListener('change', handleFileUpload);
            
            // ุงูุณุญุจ ูุงูุฅููุงุช
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleFileDrop);
            
            // ุงููุนุงูุฌุฉ ุงูุชููุงุฆูุฉ
            document.getElementById('autoProcess').addEventListener('change', function() {
                if (this.checked && document.getElementById('imagePreviewSection').style.display !== 'none') {
                    processImage();
                }
            });
        }

        // ุงูุชุนุงูู ูุน ุฑูุน ุงูููู
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                previewImage(file);
            }
        }

        // ุงูุชุนุงูู ูุน ุงูุณุญุจ ูุงูุฅููุงุช
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#10b981';
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#d1d5db';
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                previewImage(file);
            }
        }

        // ูุนุงููุฉ ุงูุตูุฑุฉ
        function previewImage(file) {
            if (file.size > 10 * 1024 * 1024) {
                showNotification('ุญุฌู ุงูุตูุฑุฉ ูุจูุฑ ุฌุฏุงู! ุงูุญุฏ ุงูุฃูุตู 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewSection').classList.remove('hidden');
                
                if (document.getElementById('autoProcess').checked) {
                    processImage();
                }
            };
            reader.readAsDataURL(file);
        }

        // ูุณุญ ุงูุตูุฑุฉ
        function clearImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreviewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        // ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                document.getElementById('serverStatus').classList.remove('hidden');
                document.getElementById('statusIcon').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-500 text-white';
                document.getElementById('statusIcon').innerHTML = 'โ';
                document.getElementById('statusText').textContent = 'ุงูุฎุงุฏู ูุนูู ุจุดูู ุทุจูุนู';
                document.getElementById('statusDetails').textContent = `ุนุฏุฏ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: ${data.answer_key_count}`;
                document.getElementById('statusTime').textContent = new Date().toLocaleTimeString('ar-SA');
                
            } catch (error) {
                document.getElementById('serverStatus').classList.remove('hidden');
                document.getElementById('statusIcon').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-red-500 text-white';
                document.getElementById('statusIcon').innerHTML = 'โ';
                document.getElementById('statusText').textContent = 'ูุง ูููู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
                document.getElementById('statusDetails').textContent = 'ุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช';
                document.getElementById('statusTime').textContent = new Date().toLocaleTimeString('ar-SA');
            }
        }

        // ุชุญุฏูุซ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ
        async function updateAnswerKey() {
            const answersText = document.getElementById('correctAnswers').value;
            const answers = answersText.split(',').map(a => a.trim().toUpperCase());
            
            try {
                const response = await fetch(`${API_BASE}/api/answer_key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ุชู ุชุญุฏูุซ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุจูุฌุงุญ!', 'success');
                    testConnection(); // ุชุญุฏูุซ ุญุงูุฉ ุงูุฎุงุฏู
                } else {
                    showNotification('ูุดู ูู ุชุญุฏูุซ ุงูุฅุฌุงุจุงุช: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
            }
        }

        // ูุนุงูุฌุฉ ุงูุตูุฑุฉ
        async function processImage() {
            const fileInput = document.getElementById('imageUpload');
            const processBtn = document.getElementById('processBtn');
            
            if (!fileInput.files[0]) {
                showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ ุฃููุงู', 'error');
                return;
            }

            // ุนุฑุถ ุชุญููู
            processBtn.innerHTML = 'โณ ุฌุงุฑู ุงููุนุงูุฌุฉ...';
            processBtn.disabled = true;

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('num_questions', document.getElementById('numQuestions').value);
            formData.append('options_per_question', document.getElementById('optionsPerQuestion').value);
            formData.append('debug', document.getElementById('debugMode').checked);

            try {
                const response = await fetch(`${API_BASE}/api/correct`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                    saveToHistory(data);
                    showNotification('ุชู ุชุตุญูุญ ุงููุฑูุฉ ุจูุฌุงุญ!', 'success');
                } else {
                    showNotification('ูุดู ูู ุงููุนุงูุฌุฉ: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
            } finally {
                processBtn.innerHTML = '๐ ุจุฏุก ุงูุชุตุญูุญ';
                processBtn.disabled = false;
            }
        }

        // ุนุฑุถ ุงููุชุงุฆุฌ
        function displayResults(data) {
            // ุนุฑุถ ูุณู ุงููุชุงุฆุฌ
            document.getElementById('resultsSection').classList.remove('hidden');

            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            const statsHtml = `
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-600">${data.correct_count}</div>
                    <div class="text-sm text-green-800">ุฅุฌุงุจุงุช ุตุญูุญุฉ</div>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-red-600">${data.wrong_count}</div>
                    <div class="text-sm text-red-800">ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-600">${data.percentage}%</div>
                    <div class="text-sm text-blue-800">ุงููุณุจุฉ ุงููุฆููุฉ</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">${data.bubbles_detected || 0}</div>
                    <div class="text-sm text-purple-800">ููุงุนุงุช ููุชุดูุฉ</div>
                </div>
            `;
            document.getElementById('resultsStats').innerHTML = statsHtml;

            // ุนุฑุถ ุงูุฅุฌุงุจุงุช ุงูุชูุตูููุฉ
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';
            
            data.answers.forEach((answer, index) => {
                const correctAnswer = data.answers.length > index ? data.answers[index] : '?';
                const isCorrect = answer === correctAnswer && answer !== 'ูุฑุงุบ';
                const isEmpty = answer === 'ูุฑุงุบ';
                
                let bgClass = 'wrong-answer';
                if (isCorrect) bgClass = 'correct-answer';
                if (isEmpty) bgClass = 'empty-answer';
                
                const answerDiv = document.createElement('div');
                answerDiv.className = `p-3 rounded-lg text-white text-center font-medium ${bgClass}`;
                answerDiv.innerHTML = `
                    <div class="text-sm">ุณ${index + 1}</div>
                    <div class="text-lg">${answer}</div>
                    <div class="text-xs">${isCorrect ? 'โ' : isEmpty ? 'โ' : 'โ'}</div>
                `;
                answersGrid.appendChild(answerDiv);
            });

            // ุนุฑุถ ุตูุฑุฉ ุงูุชุตุญูุญ ุฅุฐุง ูุงูุช ูุชููุฑุฉ
            if (data.debug_image) {
                document.getElementById('debugSection').classList.remove('hidden');
                document.getElementById('debugImage').src = data.debug_image;
            } else {
                document.getElementById('debugSection').classList.add('hidden');
            }

            // ุนุฑุถ ูุนูููุงุช ุฅุถุงููุฉ
            if (data.bubbles_detected !== undefined || data.perspective_corrected !== undefined) {
                document.getElementById('additionalInfo').classList.remove('hidden');
                let infoHtml = '';
                if (data.bubbles_detected !== undefined) {
                    infoHtml += `<div>๐ ุงูููุงุนุงุช ุงูููุชุดูุฉ: ${data.bubbles_detected}</div>`;
                }
                if (data.perspective_corrected !== undefined) {
                    infoHtml += `<div>๐ ุชุตุญูุญ ุงูููุธูุฑ: ${data.perspective_corrected ? 'ูุนู' : 'ูุง'}</div>`;
                }
                document.getElementById('analysisInfo').innerHTML = infoHtml;
            }
        }

        // ุงููุงููุฑุง
        async function startCamera() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('camera');
                video.srcObject = currentStream;
                
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = false;
                
            } catch (error) {
                showNotification('ูุง ูููู ุงููุตูู ุฅูู ุงููุงููุฑุง', 'error');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
        }

        function captureFromCamera() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // ุชุญููู ุฅูู ููู
            canvas.toBlob(function(blob) {
                const file = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
                
                // ูุญุงูุงุฉ ุฑูุน ุงูููู
                const fileInput = document.getElementById('imageUpload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // ูุนุงููุฉ ุงูุตูุฑุฉ
                previewImage(file);
                
                // ุฅููุงู ุงููุงููุฑุง
                stopCamera();
            }, 'image/jpeg', 0.8);
        }

        // ุฅุฏุงุฑุฉ ุงูุณุฌู
        function saveToHistory(data) {
            const testRecord = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('ar-SA'),
                correct_count: data.correct_count,
                wrong_count: data.wrong_count,
                percentage: data.percentage,
                total_questions: data.total_questions
            };
            
            testHistory.unshift(testRecord);
            if (testHistory.length > 10) {
                testHistory = testHistory.slice(0, 10);
            }
            
            localStorage.setItem('testHistory', JSON.stringify(testHistory));
            loadTestHistory();
        }

        function loadTestHistory() {
            const historyContainer = document.getElementById('testHistory');
            
            if (testHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-gray-500 py-8">ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ุณุงุจูุฉ</div>';
                return;
            }
            
            historyContainer.innerHTML = testHistory.map(record => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <div class="font-semibold text-gray-800">ุงุฎุชุจุงุฑ ${record.id.toString().slice(-4)}</div>
                        <div class="text-sm text-gray-600">${record.timestamp}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-blue-600">${record.percentage}%</div>
                        <div class="text-sm text-gray-600">${record.correct_count}/${record.total_questions}</div>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('ูู ุชุฑูุฏ ูุณุญ ุณุฌู ุงูุงุฎุชุจุงุฑุงุชุ')) {
                testHistory = [];
                localStorage.removeItem('testHistory');
                loadTestHistory();
                showNotification('ุชู ูุณุญ ุงูุณุฌู', 'success');
            }
        }

        // ุฃุฏูุงุช ูุณุงุนุฏุฉ
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function downloadResults() {
            const results = document.getElementById('resultsSection').innerText;
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ูุชูุฌุฉ_ุงูุชุตุญูุญ_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareResults() {
            if (navigator.share) {
                navigator.share({
                    title: 'ูุชูุฌุฉ ุชุตุญูุญ ุงูุงุฎุชุจุงุฑ',
                    text: `ุชู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑ ุจูุณุจุฉ ${document.querySelector('#resultsStats .bg-blue-100 .text-3xl').textContent} ูุฌุงุญ`,
                    url: window.location.href
                });
            } else {
                showNotification('ูุดุงุฑูุฉ ุงููุชุงุฆุฌ ุบูุฑ ูุชุงุญุฉ ูู ูุฐุง ุงููุชุตูุญ', 'info');
            }
        }

        function resetTest() {
            clearImage();
            document.getElementById('resultsSection').classList.add('hidden');
            showNotification('ุชู ุฅุนุฏุงุฏ ุงุฎุชุจุงุฑ ุฌุฏูุฏ', 'info');
        }
    </script>
</body>
</html>
