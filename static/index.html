<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تصحيح الاختبارات باستخدام الذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            /* لضمان أن الفيديو يملأ الحاوية ويحافظ على الارتفاع */
            height: 60vh; /* ارتفاع ثابت نسبيًا */
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            /* التعديل: حدود أوضح وتعتيم للخلفية */
            border: 4px solid #f97316; /* لون برتقالي واضح */
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); /* تعتيم ما حول الإطار */
            width: 90%; /* توسيع الإطار ليغطي مساحة أكبر */
            height: 90%; /* توسيع الإطار ليغطي مساحة أكبر */
            pointer-events: none;
            border-radius: 8px;
            z-index: 10;
        }
        .countdown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0,0,0,0.7);
            opacity: 0;
            animation: fadeInOut 1s infinite;
            z-index: 15; /* تأكد من أنه أعلى من كل شيء */
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .app-section {
            display: none;
        }
        .app-section.active {
            display: block;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Styles for report question analysis colors */
        .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } /* Light red (High Difficulty) */
        .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } /* Light orange (Medium Difficulty) */
        .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } /* Light green (Low Difficulty) */
        .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } /* Lighter green (No Errors) */

        /* Print-specific styles */
        @media print {
            body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            button, input, select, aside, #menu-button, #printReportBtn { display: none !important; } /* Hide print button in print view */
            main { margin: 0 !important; padding: 0 !important; }
            .app-section { display: none !important; } /* Hide all sections */
            #printable-report-content { display: block !important; } /* Show only print content */
            .bg-white { box-shadow: none !important; border: 1px solid #ccc; }
            .text-xs { font-size: 0.7rem !important; }
            .text-sm { font-size: 0.8rem !important; }
            .text-lg { font-size: 1rem !important; }
            .text-xl { font-size: 1.1rem !important; }
            .text-2xl { font-size: 1.2rem !important; }
            .font-bold { font-weight: bold !important; }
            .p-1 { padding: 0.25rem !important; }
            .p-2 { padding: 0.5rem !important; }
            .p-3 { padding: 0.75rem !important; }
            .mb-1 { margin-bottom: 0.25rem !important; }
            .mb-2 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 1rem !important; }
            .mt-4 { margin-top: 1rem !important; }
            .mt-6 { margin-top: 1.5rem !important; }
            .gap-4 { gap: 1rem !important; }
            .grid { display: grid !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
            .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
            .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)) !important; }
            .text-center { text-align: center !important; }
            .text-right { text-align: right !important; }
            .border { border-width: 1px !important; }
            .border-b { border-bottom-width: 1px !important; }
            .border-b-2 { border-bottom-width: 2px !important; }
            .border-black { border-color: black !important; }
            .border-gray-300 { border-color: #d1d5db !important; }
            .rounded-lg { border-radius: 0.5rem !important; }
            .w-full { width: 100% !important; }
            .mx-auto { margin-left: auto !important; margin-right: auto !important; }
            table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto !important;}
            tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            thead { display: table-header-group !important; } /* Repeat header on each page */
            td, th { border: 1px solid #ddd !important; padding: 4px !important; text-align: center !important; font-size: 0.75rem !important; } /* Reduced padding/font */
            th { background-color: #f2f2f2 !important; font-weight: bold !important;}
            tr:nth-child(even){background-color: #f9f9f9 !important;}
            img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important;}
            .page-break { page-break-before: always !important; }
             /* Ensure colored backgrounds print */
            .bg-blue-100 { background-color: #DBEAFE !important; }
            .bg-green-100 { background-color: #DCFCE7 !important; }
            .bg-red-100 { background-color: #FEE2E2 !important; }
            .bg-gray-50 { background-color: #F9FAFB !important; }
            .bg-gray-100 { background-color: #F3F4F6 !important; }
            .bg-yellow-100 { background-color: #FEF3C7 !important; }
            .bg-orange-100 { background-color: #FFEDD5 !important; }

            /* Specific report styles */
            #printable-report-content .text-red-700 { color: #b91c1c !important; }
            #printable-report-content .text-green-700 { color: #15803d !important; }
            #printable-report-content .text-red-600 { color: #dc2626 !important; }
            #printable-report-content .text-green-600 { color: #16a34a !important; }
            #printable-report-content .text-blue-600 { color: #2563eb !important; }
            #printable-report-content .font-semibold { font-weight: 600 !important; }
            #printable-report-content .font-bold { font-weight: 700 !important; }
            #printable-report-content .pr-2 { padding-right: 0 !important; }
            #printable-report-content .question-analysis-table td,
            #printable-report-content .question-analysis-table th { font-size: 0.7rem !important; padding: 3px !important; } /* Smaller font for analysis table */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <div class="flex flex-col md:flex-row">
                <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 min-h-screen fixed md:relative inset-y-0 right-0 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <h1 class="text-2xl font-bold text-center mb-8">المصحح الذكي</h1>
            <nav class="flex flex-col gap-2">
                <a href="#dashboard" class="nav-link active p-3 rounded-lg hover:bg-gray-700">🏠 لوحة التحكم</a>
                <a href="#answer-key" class="nav-link p-3 rounded-lg hover:bg-gray-700">🔑 نماذج الإجابة</a>
                <a href="#students" class="nav-link p-3 rounded-lg hover:bg-gray-700">👥 الطلاب</a>
                <a href="#correction" class="nav-link p-3 rounded-lg hover:bg-gray-700">📷 التصحيح</a>
                <a href="#history" class="nav-link p-3 rounded-lg hover:bg-gray-700">📚 السجلات</a>
                <a href="#reports" class="nav-link p-3 rounded-lg hover:bg-gray-700">🖨️ التقارير</a>
                <a href="#stats" class="nav-link p-3 rounded-lg hover:bg-gray-700">📈 الإحصائيات</a>
                <a href="#settings" class="nav-link p-3 rounded-lg hover:bg-gray-700">⚙️ الإعدادات</a>
            </nav>
        </aside>

                <main class="flex-1 p-4 md:p-8">
            <button id="menu-button" class="md:hidden fixed top-4 right-4 z-20 p-2 bg-gray-800 text-white rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            
                        <section id="dashboard" class="app-section active">
                <header class="mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3 text-center">أطلق العنان لقوة التصحيح الفوري</h1>
                    <p class="text-lg md:text-xl text-center max-w-3xl mx-auto text-gray-600">"المصحح الذكي" هو مساعدك الرقمي الذي يحول مهمة تصحيح الاختبارات المرهقة إلى عملية سريعة ودقيقة وممتعة باستخدام أحدث تقنيات الذكاء الاصطناعي.</p>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b pb-4">أبرز الميزات</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex items-start gap-4">
                            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full text-2xl">⚡️</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">تصحيح ذكي وسريع</h3>
                                <p class="text-gray-600">حوّل كاميرا هاتفك إلى ماسح ضوئي فائق السرعة. يلتقط التطبيق الإجابات تلقائياً ويحللها في ثوانٍ معدودة بدقة عالية.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-full text-2xl">👥</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">إدارة الطلاب والفصول</h3>
                                <p class="text-gray-600">استورد قوائم طلابك من ملفات Excel بسهولة، وتتبع أداءهم، وقم بتصحيح أوراقهم بشكل فردي أو جماعي.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full text-2xl">🔑</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">نماذج إجابة مرنة</h3>
                                <p class="text-gray-600">أنشئ نماذج إجابات متعددة واحفظها. أدخل الإجابات الصحيحة يدوياً أو قم بتصوير نموذج محلول ليوفر عليك عناء الإدخال.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-red-100 text-red-600 p-3 rounded-full text-2xl">📊</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">سجلات وتقارير مفصلة</h3>
                                <p class="text-gray-600">احفظ جميع النتائج تلقائياً في سجلات منظمة. قم بتصدير ملخصات النتائج أو تقارير الإجابات التفصيلية إلى ملفات Excel لتحليل أعمق.</p>
                            </div>
                        </div>
                    </div>
                </div>

                                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <button id="toggle-instructions-btn" class="w-full text-right">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                📖 دليل البدء السريع
                            </h2>
                            <span id="instructions-arrow">▼</span>
                        </div>
                    </button>
                    <div id="instructions-content" class="collapsible-content mt-4 pt-4 border-t">
                        <ol class="list-decimal list-inside space-y-4 text-gray-700">
                             <li>اذهب إلى قسم <a href="#answer-key" class="quick-start-link text-blue-600 font-bold">"نماذج الإجابة"</a> وجهّز نموذج الإجابة الصحيحة (أدخل المادة واسم الاختبار والتاريخ).</li>
                            <li>اذهب إلى قسم <a href="#students" class="quick-start-link text-blue-600 font-bold">"الطلاب"</a> واستورد قائمة طلابك.</li>
                            <li>انتقل إلى قسم <a href="#correction" class="quick-start-link text-blue-600 font-bold">"التصحيح"</a> واختر طالباً أو ابدأ التصحيح المتعدد!</li>
                        </ol>
                    </div>
                </div>
            </section>
            
                        <section id="answer-key" class="app-section">
                                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🔑 إعداد نماذج الإجابة</h2>
                    
                    <div class="mb-4">
                        <label for="answerKeyModel" class="block text-sm font-medium text-gray-700 mb-2">اختر أو أنشئ نموذج إجابة:</label>
                        <div class="flex gap-2">
                            <select id="answerKeyModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                            <button id="newModelBtn" title="نموذج جديد" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-lg">➕</button>
                            <button id="renameModelBtn" title="إعادة تسمية" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg">✏️</button>
                            <button id="deleteModelBtn" title="حذف النموذج" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg">🗑️</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">عدد الأسئلة:</label>
                            <input type="number" id="questionCount" min="1" max="100" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">عدد الخيارات:</label>
                            <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="4">4 (A, B, C, D)</option>
                                <option value="5">5 (A, B, C, D, E)</option>
                            </select>
                        </div>
                        <div>
                            <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">المادة:</label>
                            <input type="text" id="subjectName" placeholder="مثال: رياضيات" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div id="examInfoSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <div>
                            <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">اسم الاختبار:</label>
                            <input type="text" id="examName" placeholder="مثال: الاختبار الفصلي الأول" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">تاريخ الاختبار:</label>
                            <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                         <h3 class="text-lg font-bold text-gray-800 mb-3">إجراءات النموذج</h3>
                         <div class="flex flex-wrap gap-2">
                            <button id="manualEntryBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">✏️ إعداد الإجابات يدوياً</button>
                            <button id="scanKeyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">📷 تصوير نموذج محلول</button>
                            <button id="printSheetBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium text-sm">🖨️ طباعة نموذج فارغ</button>
                        </div>
                    </div>

                    <div id="answerSheet" class="hidden mt-6 pt-4 border-t">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📝 أدخل الإجابات الصحيحة يدوياً:</h3>
                        <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                        <button id="saveAnswersBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">حفظ الإجابات</button>
                    </div>
                </div>
            </section>
            
                        <section id="students" class="app-section">
                                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        👥 إدارة الطلاب
                    </h2>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">📊 استيراد قائمة الطلاب</h3>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                        </div>
                    </div>

                                        <div id="studentsListSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">📋 قائمة الطلاب</h3>
                            <div class="flex gap-2">
                                <button id="multiCorrectionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                    🔄 تصحيح متعدد
                                </button>
                                <button id="clearStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    🗑️ مسح القائمة
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                                <div class="text-xs text-blue-800">إجمالي الطلاب</div>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                                <div class="text-xs text-green-800">تم تصحيحها</div>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                                <div class="text-xs text-yellow-800">في الانتظار</div>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                                <div class="text-xs text-purple-800">عدد الفصول</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">البحث بالاسم:</label>
                                    <input type="text" id="searchStudentName" placeholder="جزء من اسم الطالب..." 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالفصل:</label>
                                    <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="">جميع الفصول</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">حالة التصحيح:</label>
                                    <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="">الكل</option>
                                        <option value="corrected">تم التصحيح</option>
                                        <option value="pending">في الانتظار</option>
                                        <option value="absent">غائب</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </section>

                        <section id="correction" class="app-section">
                                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">📷 تصوير أو تحميل ورقة الإجابة</h2>

                    <div id="correctionSelectedStudentDisplay" class="mb-4 bg-green-50 rounded-lg p-4 hidden">
                         <h3 class="text-lg font-semibold text-green-800 mb-2">👤 الطالب المحدد للتصحيح</h3>
                         <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold" id="correctionStudentNameDisplay">-</div>
                                <div class="text-sm text-gray-600">
                                    الفصل: <span id="correctionStudentClassDisplay">-</span>
                                </div>
                            </div>
                             <button id="changeCorrectionStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-medium text-sm">تغيير</button>
                         </div>
                    </div>


                    <div class="mb-4">
                        <label for="correctionStudentSelect" class="block text-sm font-medium text-gray-700 mb-2">👤 اختر طالباً للتصحيح الفردي (أو اختر من قسم الطلاب):</label>
                        <select id="correctionStudentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- اختر من القائمة --</option>
                        </select>
                    </div>

                    <div id="uploadOptions" class="flex flex-col sm:flex-row gap-4 my-6">
                        <button id="showCameraBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">📹 استخدام الكاميرا</button>
                        <button id="showUploadBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">📁 تحميل صورة</button>
                    </div>
                    <div id="cameraSection" class="hidden">
                        <div class="camera-container mb-4">
                            <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <div class="overlay"></div>
                            <div id="countdown" class="countdown-text"></div>
                        </div>
                        <div class="text-center">
                            <button id="stopCameraBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏹️ إيقاف الكاميرا</button>
                        </div>
                    </div>
                    <div id="uploadSection" class="hidden">
                        <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                    </div>
                </div>

                                 <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">🔄 التصحيح المتعدد</h2>
                    <div id="multiCorrectionSetup">
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <p class="text-sm text-purple-700">سيتم تصحيح أوراق جميع الطلاب في قائمة "في الانتظار" بالتتابع. صوّر الأوراق بالترتيب وسيتم الانتقال للطالب التالي تلقائياً بعد حفظ النتيجة.</p>
                        </div>
                        <div class="text-center">
                            <button id="startMultiBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg">
                                🚀 بدء التصحيح المتعدد
                            </button>
                        </div>
                    </div>
                    <div id="multiCorrectionActive" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>التقدم</span>
                                <span id="progressText">0 من 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
                                    <div class="text-sm text-blue-600">الفصل: <span id="multiStudentClass">-</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-600">ورقة رقم</div>
                                    <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button id="skipStudentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏭️ تخطي هذا الطالب</button>
                            <button id="stopMultiBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">⏹️ إنهاء التصحيح المتعدد</button>
                        </div>
                    </div>
                    <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">📊 تقرير التصحيح المتعدد</h3>
                        <div id="multiReportContent"></div>
                        <div class="mt-4 flex gap-4 justify-center">
                            <button id="exportMultiReportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">📄 تصدير التقرير</button>
                            <button id="resetMultiBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">🔄 تصحيح جديد</button>
                        </div>
                    </div>
                </div>
                
                                <div id="verificationContainer" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">🖼️ الصورة الملتقطة</h3>
                             <img id="capturedImage" class="w-full rounded-lg shadow-md">
                        </div>
                        <div id="verificationSection">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">🔍 تأكيد الإجابات</h3>
                            <div id="verificationGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto pr-2"></div>
                             <button id="confirmAnswersBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">✅ تأكيد وحساب النتيجة</button>
                        </div>
                    </div>
                </div>

                                <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">📊 نتائج التصحيح</h3>
                    <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>الطالب:</strong> <span id="resultStudentName">-</span></div>
                            <div><strong>الفصل:</strong> <span id="resultStudentClass">-</span></div>
                            <div><strong>الاختبار:</strong> <span id="resultExamName">-</span></div>
                            <div><strong>التاريخ:</strong> <span id="resultExamDate">-</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600" id="correctCount">0</div>
                            <div class="text-sm">صحيحة</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600" id="wrongCount">0</div>
                            <div class="text-sm">خاطئة</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600" id="scorePercentage">0%</div>
                            <div class="text-sm">النسبة</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="letterGrade">-</div>
                            <div class="text-sm">التقدير</div>
                        </div>
                    </div>
                    <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="saveAndNewBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">💾 حفظ وبدء ورقة جديدة</button>
                        <button id="exportResultBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">📄 تصدير النتيجة</button>
                    </div>
                </div>
            </section>
            
                        <section id="history" class="app-section">
                                 <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">📚 سجل النتائج المحفوظة</h3>
                        <div class="flex gap-2">
                            <button id="exportAllResultsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">📊 تصدير ملخص النتائج</button>
                             <button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">🗑️ مسح السجل</button>
                        </div>
                    </div>
                    <div id="historyFilters" class="bg-gray-50 rounded-lg p-4 mb-4 hidden">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="historyClassFilter" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالفصل:</label>
                                <select id="historyClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="historyExamFilter" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالاختبار:</label>
                                <select id="historyExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="filterHistoryBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">🔍 تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                </div>

                                <div id="detailedHistorySection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">📋 سجل إجابات الطلاب (مفصل)</h3>
                        <div class="flex gap-2">
                            <button id="exportDetailedLogBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-medium text-sm">📄 تصدير سجل الإجابات (Excel)</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">يحتوي هذا السجل على إجابة كل طالب لكل سؤال. استخدم زر التصدير لتحليل البيانات.</p>
                </div>
            </section>

                        <section id="reports" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">🖨️ التقارير والطباعة</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">تقرير أداء الفصل</h3>
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="reportClassFilter" class="block text-sm font-medium text-gray-700 mb-1">اختر الفصل:</label>
                                    <select id="reportClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <label for="reportExamFilter" class="block text-sm font-medium text-gray-700 mb-1">اختر الاختبار:</label>
                                    <select id="reportExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div class="self-end">
                                    <button id="generateReportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">📊 إنشاء تقرير</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="report-container" class="mt-6"></div>
                </div>
            </section>
            
                        <section id="stats" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                     <h2 class="text-2xl font-bold text-gray-800 mb-4">📈 الإحصائيات</h2>
                     <div class="bg-gray-50 rounded-lg p-4 mb-6">
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="statsClassFilter" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالفصل:</label>
                                <select id="statsClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="statsExamFilter" class="block text-sm font-medium text-gray-700 mb-1">فلترة بالاختبار:</label>
                                <select id="statsExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="updateStatsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">🔄 تحديث الإحصائيات</button>
                            </div>
                        </div>
                    </div>
                     <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ملخص الأداء</h3>
                            <div id="summary-stats" class="grid grid-cols-2 gap-4"></div>
                        </div>
                         <div class="bg-gray-50 p-4 rounded-lg relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">توزيع التقديرات</h3>
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg md:col-span-2 relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">متوسط الأداء حسب الفصل</h3>
                            <canvas id="class-performance-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

                        <section id="settings" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">⚙️ الإعدادات</h2>
                    <div class="space-y-6">

                                                <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">البيانات الأساسية للتقارير</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="setting-admin" type="text" placeholder="إدارة التعليم" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-school" type="text" placeholder="المدرسة" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-teacher" type="text" placeholder="المعلم" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-director" type="text" placeholder="المدير" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-year" type="text" placeholder="العام الدراسي" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-semester" type="text" placeholder="الفصل الدراسي" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button id="saveSettingsBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">حفظ البيانات الأساسية</button>
                        </div>
                        
                                                <div class="bg-gray-50 p-4 rounded-lg">
                             <h3 class="font-semibold text-lg text-gray-800 mb-4">إدارة البيانات</h3>
                             <div class="flex flex-wrap gap-4">
                                <button id="backupBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">📥 نسخ احتياطي للبيانات</button>
                                <div>
                                    <label for="restoreFile" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm cursor-pointer">📤 استعادة نسخة احتياطية</label>
                                    <input type="file" id="restoreFile" class="hidden" accept=".json">
                                </div>
                             </div>
                        </div>

                                                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                             <h3 class="font-semibold text-lg text-red-800 mb-2">منطقة الخطر</h3>
                             <p class="text-sm text-red-700 mb-4">سيؤدي هذا الإجراء إلى حذف جميع البيانات المحفوظة في التطبيق بشكل نهائي، بما في ذلك الطلاب، النماذج، والسجلات.</p>
                             <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">🗑️ مسح جميع بيانات التطبيق</button>
                        </div>
                    </div>
                </div>
            </section>
                         <div id="printable-report-content" class="hidden print:block"></div>

        </main>
    </div>

    <script>
        // Global state variables
        let correctAnswers = [];
        let studentAnswers = [];
        let stream = null;
        let currentStudent = null;
        let autoCaptureTimer = null;
        let isScanningForKey = false;
        
        // Data loaded from localStorage
        let settings = {};
        let studentsList = [];
        let resultsHistory = [];
        let detailedAnswersLog = [];
        let answerKeyModels = {};
        
        // Multi-correction state
        let isMultipleCorrectionMode = false;
        let multiCorrectionQueue = [];
        let currentMultiIndex = 0;
        let multiCorrectionResults = [];

        // Chart instances
        let gradeChart = null;
        let classChart = null;

        // === Safe localStorage Parsing ===
        function getFromStorage(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue === null || storedValue === undefined) return defaultValue;
                // Attempt to parse only if it looks like JSON
                if (storedValue.startsWith('{') || storedValue.startsWith('[')) {
                     try { return JSON.parse(storedValue); } catch { return defaultValue; }
                }
                // Handle cases where non-JSON might be stored accidentally (shouldn't happen with current code)
                console.warn(`Value for ${key} in localStorage is not valid JSON.`);
                localStorage.removeItem(key); // Remove invalid data
                return defaultValue;
            } catch (e) {
                console.error(`Error parsing ${key} from localStorage:`, e);
                localStorage.removeItem(key); 
                return defaultValue;
            }
        }

        // === Navigation & UI Initialization ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('translate-x-full');
                overlay.classList.toggle('hidden');
            }
        }

        function showSection(sectionId) {
             console.log("Showing section:", sectionId);
            try {
                document.querySelectorAll('.app-section').forEach(section => {
                    section.classList.remove('active');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                } else {
                     console.error("Section not found:", sectionId);
                     document.getElementById('dashboard')?.classList.add('active'); 
                }


                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
                 if(targetLink) targetLink.classList.add('active');
                
                // --- Section specific actions ---
                if (sectionId === 'correction') populateCorrectionStudentSelect();
                if (sectionId === 'reports') populateReportFilters();
                if (sectionId === 'stats') {
                    populateStatsFilters(); 
                    updateGlobalStats(); 
                }
                if (sectionId === 'students') displayStudentsList(); 
                 if (sectionId === 'history') populateHistoryFilters(); 


                if (sectionId !== 'correction') document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
                
                if (window.innerWidth < 768) { 
                    toggleSidebar();
                }
                 window.location.hash = sectionId; // Update hash for deep linking/refresh
            } catch(e) {
                 console.error("Error in showSection:", e);
                 document.querySelectorAll('.app-section').forEach(section => section.classList.remove('active'));
                 document.getElementById('dashboard')?.classList.add('active');
                 document.querySelector(`.nav-link[href="#dashboard"]`)?.classList.add('active');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
             try {
                // Event Listeners Setup - More Robust
                 const addSafeListener = (selector, event, handler) => {
                     const element = document.querySelector(selector);
                     if (element) {
                         element.addEventListener(event, handler);
                     } else {
                         console.warn(`Element not found for selector: ${selector}`);
                     }
                 };

                 const addSafeListenerById = (id, event, handler) => {
                     const element = document.getElementById(id);
                     if (element) {
                         element.addEventListener(event, handler);
                     } else {
                          console.warn(`Element not found for ID: ${id}`);
                     }
                 };


                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
                        if (sectionId) showSection(sectionId);
                         else console.error("Invalid href for nav link:", e.currentTarget);
                    });
                });

                document.querySelectorAll('.quick-start-link').forEach(link => {
                     link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
                        if (sectionId) showSection(sectionId);
                         else console.error("Invalid href for quick start link:", e.currentTarget);
                    });
                });
                
                addSafeListenerById('studentsList', 'click', (e) => {
                    if (e.target.classList.contains('select-student-btn')) {
                        const studentId = e.target.dataset.id;
                         if(studentId) selectStudent(studentId);
                    }
                     if (e.target.classList.contains('absent-btn')) {
                         const studentId = e.target.dataset.id;
                         if(studentId) markAsAbsent(studentId);
                     }
                });

                addSafeListenerById('menu-button', 'click', toggleSidebar);
                addSafeListenerById('sidebar-overlay', 'click', toggleSidebar);
                addSafeListenerById('toggle-instructions-btn', 'click', toggleInstructions);

                addSafeListenerById('studentsFileInput', 'change', (e) => {
                    const file = e.target.files[0];
                    if (file) parseStudentsFile(file);
                });
                addSafeListenerById('imageInput', 'change', (e) => {
                    const file = e.target.files[0];
                    if (file) handleImageFile(file);
                });

                addSafeListenerById('answerKeyModel', 'change', switchModel);
                addSafeListenerById('correctionStudentSelect', 'change', (e) => {
                    if(e.target.value) {
                        selectStudent(parseInt(e.target.value));
                    } else {
                        selectDifferentStudent();
                    }
                });
                
                addSafeListenerById('subjectName', 'input', updateModelData);
                addSafeListenerById('examName', 'input', updateModelData);
                addSafeListenerById('examDate', 'change', updateModelData);
                addSafeListenerById('questionCount', 'change', showManualEntry); 
                addSafeListenerById('optionsCount', 'change', showManualEntry); 

                addSafeListenerById('multiCorrectionBtn', 'click', toggleMultipleCorrection);
                addSafeListenerById('clearStudentsBtn', 'click', clearStudentsList);
                addSafeListenerById('newModelBtn', 'click', () => manageModels('new'));
                addSafeListenerById('renameModelBtn', 'click', () => manageModels('rename'));
                addSafeListenerById('deleteModelBtn', 'click', () => manageModels('delete'));
                addSafeListenerById('manualEntryBtn', 'click', showManualEntry);
                addSafeListenerById('scanKeyBtn', 'click', scanAnswerKey);
                addSafeListenerById('printSheetBtn', 'click', printBlankSheet);
                addSafeListenerById('saveAnswersBtn', 'click', saveCorrectAnswers);
                addSafeListenerById('showCameraBtn', 'click', showCameraSection);
                addSafeListenerById('showUploadBtn', 'click', showUploadSection);
                addSafeListenerById('stopCameraBtn', 'click', stopCamera);
                addSafeListenerById('startMultiBtn', 'click', startMultipleCorrection);
                addSafeListenerById('skipStudentBtn', 'click', skipCurrentStudent);
                addSafeListenerById('stopMultiBtn', 'click', stopMultipleCorrection);
                addSafeListenerById('exportMultiReportBtn', 'click', exportMultiReport);
                addSafeListenerById('resetMultiBtn', 'click', resetMultiCorrection);
                addSafeListenerById('confirmAnswersBtn', 'click', confirmAnswers);
                addSafeListenerById('saveAndNewBtn', 'click', saveToHistory);
                addSafeListenerById('exportResultBtn', 'click', exportResults);
                addSafeListenerById('exportAllResultsBtn', 'click', exportAllResults);
                addSafeListenerById('clearHistoryBtn', 'click', clearHistory);
                addSafeListenerById('exportDetailedLogBtn', 'click', exportDetailedAnswersLog);
                addSafeListenerById('generateReportBtn', 'click', generateClassReport);
                addSafeListenerById('saveSettingsBtn', 'click', saveSettings);
                addSafeListenerById('backupBtn', 'click', backupData);
                addSafeListenerById('clearAllDataBtn', 'click', clearAllData);
                addSafeListenerById('restoreFile', 'change', restoreData);
                addSafeListenerById('searchStudentName', 'keyup', filterStudentsList);
                addSafeListenerById('filterClass', 'change', filterStudentsList);
                addSafeListenerById('filterStatus', 'change', filterStudentsList);
                addSafeListenerById('changeCorrectionStudentBtn', 'click', selectDifferentStudent);
                addSafeListenerById('filterHistoryBtn', 'click', updateHistoryDisplay);
                addSafeListenerById('updateStatsBtn', 'click', updateGlobalStats);

                 const examDateInput = document.getElementById('examDate');
                 if(examDateInput) examDateInput.valueAsDate = new Date();

                loadInitialUI();

             } catch(e) {
                  console.error("Error during DOMContentLoaded setup:", e);
                  alert("حدث خطأ أثناء تحميل التطبيق. قد تحتاج إلى تحديث الصفحة.");
             }
        });


        function loadInitialUI() {
             console.log("Loading initial UI...");
            settings = getFromStorage('appSettings', {});
            studentsList = getFromStorage('studentsList', []);
            // Ensure status property exists, default to 'pending' if missing
            studentsList = studentsList.map(s => ({ ...s, status: s.status || 'pending' })); 
            resultsHistory = getFromStorage('examResults', []);
            detailedAnswersLog = getFromStorage('detailedAnswersLog', []);
            answerKeyModels = getFromStorage('answerKeyModels', {});
            
            loadSettings();

            if (Object.keys(answerKeyModels).length === 0) {
                answerKeyModels['نموذج أ'] = { name: "نموذج أ", subject: "", examName: "", examDate: new Date().toISOString().split('T')[0], answers: [] };
                 localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels)); // Save default if empty
            }
            updateModelsDropdown(); 
            
            if (studentsList.length > 0) {
                 displayStudentsList();
             } else {
                 document.getElementById('studentsListSection')?.classList.add('hidden');
             }
            
            if (resultsHistory.length > 0) {
                updateHistoryDisplay();
            } else {
                 document.getElementById('historySection')?.classList.add('hidden');
                 document.getElementById('historyFilters')?.classList.add('hidden');
            }
            if (detailedAnswersLog.length > 0) document.getElementById('detailedHistorySection')?.classList.remove('hidden');
             else {
                 document.getElementById('detailedHistorySection')?.classList.add('hidden');
             }
             const initialSection = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
             // Validate initialSection before showing
             const validSections = ['dashboard', 'students', 'answer-key', 'correction', 'history', 'reports', 'stats', 'settings'];
             showSection(validSections.includes(initialSection) ? initialSection : 'dashboard');
             console.log("Initial UI Load Complete.");
        }
        
        function toggleInstructions() {
            const content = document.getElementById('instructions-content');
            const arrow = document.getElementById('instructions-arrow');
            if(!content || !arrow) return;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = null;
                arrow.textContent = '▼';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.textContent = '▲';
            }
        }


        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg z-50 text-center ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { 
                 if(notification && document.body.contains(notification)) {
                     document.body.removeChild(notification); 
                 }
            }, 3000);
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const capturedImage = document.getElementById('capturedImage');
                const verificationContainer = document.getElementById('verificationContainer');
                if(!capturedImage || !verificationContainer) return;

                capturedImage.src = e.target.result;
                verificationContainer.classList.remove('hidden');
                
                 processAnswers(e.target.result);
            };
            reader.onerror = (e) => {
                 console.error("FileReader error:", e);
                 showNotification("خطأ في قراءة ملف الصورة.", "error");
            };
            if (typeof file === 'string') {
                 reader.readAsDataURL(dataURItoBlob(file));
            } else if (file instanceof Blob) {
                reader.readAsDataURL(file);
            } else {
                 console.error("Invalid file type passed to handleImageFile:", file);
                 showNotification("نوع ملف غير صالح.", "error");
            }
        }
        
        function dataURItoBlob(dataURI) {
            try {
                const byteString = atob(dataURI.split(',')[1]);
                const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {type: mimeString});
            } catch (e) {
                 console.error("Error converting data URI to Blob:", e);
                 showNotification("خطأ في تحويل الصورة.", "error");
                 return null;
            }
        }


        // === Student Management ===
        function downloadStudentsTemplate() { /* ... (الكود الأصلي) ... */ }
        function parseStudentsFile(file) { /* ... (الكود الأصلي) ... */ }
        function displayStudentsList() { /* ... (الكود الأصلي) ... */ }
        function updateStudentsStats() { /* ... (الكود الأصلي) ... */ }
        function updateClassFilter() { /* ... (الكود الأصلي) ... */ }
        function filterStudentsList() { /* ... (الكود الأصلي) ... */ }
        function selectStudent(studentId) { /* ... (الكود الأصلي) ... */ }
        function markAsAbsent(studentId) { /* ... (الكود الأصلي) ... */ }
        function selectDifferentStudent() { /* ... (الكود الأصلي) ... */ }
        function populateCorrectionStudentSelect() { /* ... (الكود الأصلي) ... */ }
        function clearStudentsList() { /* ... (الكود الأصلي) ... */ }

        // === Answer Key Models Management ===
        function updateModelsDropdown() { /* ... (الكود الأصلي) ... */ }
        function switchModel() { /* ... (الكود الأصلي) ... */ }
        function manageModels(action) { /* ... (الكود الأصلي) ... */ }
        function showManualEntry() { /* ... (الكود الأصلي) ... */ }
        function scanAnswerKey() { /* ... (الكود الأصلي) ... */ }
        function generateAnswerSheet() { /* ... (الكود الأصلي) ... */ }
        function saveCorrectAnswers() { /* ... (الكود الأصلي) ... */ }
        function updateModelData() { /* ... (الكود الأصلي) ... */ }


        // === Camera and Image Processing (الكود الأصلي مع التعديلات) ===
        
        // التعديل: تطبيق قيود الكاميرا والتركيز التلقائي
        async function showCameraSection() {
            stopCamera(); // إيقاف أي تيار سابق

            try {
                // طلب أعلى دقة ممكنة والتركيز التلقائي المستمر
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // الكاميرا الخلفية
                        width: { ideal: 4096 },   // محاولة الحصول على دقة عالية
                        height: { ideal: 2160 },
                        advanced: [{ focusMode: "continuous" }, { zoom: 1.0 }] // طلب التركيز التلقائي
                    } 
                });

                const videoElement = document.getElementById('camera');
                if(videoElement) videoElement.srcObject = stream;
                
                document.getElementById('cameraSection')?.classList.remove('hidden');
                document.getElementById('uploadSection')?.classList.add('hidden');
                
                // التعديل: إشعار توجيهي للمستخدم
                showNotification('يرجى التأكد من أن الورقة داخل الإطار البرتقالي والتركيز واضح. سيبدأ العد التنازلي.', 'info');

                // التعديل: تأخير للسماح للكاميرا بالتركيز قبل بدء العد التنازلي
                setTimeout(startAutoCapture, 1000); 

            } catch (error) {
                console.error("Camera access error:", error);
                showNotification('لا يمكن الوصول للكاميرا. تأكد من منح الإذن.', 'error');
            }
        }

        function startAutoCapture() {
            const countdownEl = document.getElementById('countdown');
            if(!countdownEl) return;
            let count = 3;
            countdownEl.textContent = count;
            countdownEl.style.display = 'block';

            if(autoCaptureTimer) clearInterval(autoCaptureTimer);

            autoCaptureTimer = setInterval(() => {
                count--;
                 if(countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(autoCaptureTimer);
                     if(countdownEl) countdownEl.style.display = 'none';
                    captureAndProcess();
                }
            }, 1000);
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            if(autoCaptureTimer) clearInterval(autoCaptureTimer);
            const countdownEl = document.getElementById('countdown');
            if(countdownEl) countdownEl.style.display = 'none';
            document.getElementById('cameraSection')?.classList.add('hidden');
            document.getElementById('capturedSection')?.classList.add('hidden');
        }

        function captureAndProcess() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            if(!video || !canvas || video.readyState !== 4) {
                 console.warn("Video not ready for capture. Retrying in 1s.");
                 if(stream) setTimeout(startAutoCapture, 1000); 
                 return;
             }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            clearInterval(autoCaptureTimer);
            
            if (isScanningForKey) {
                 stopCamera();
            }

            handleImageFile(canvas.toDataURL('image/jpeg'));
        }

        function showUploadSection() {
            stopCamera();
            document.getElementById('uploadSection')?.classList.remove('hidden');
            document.getElementById('cameraSection')?.classList.add('hidden');
        }
        
         /**
          * الوظيفة الرئيسية لتحليل الصورة إما لإجابات الطالب أو لنموذج الإجابة.
          */
        async function processAnswers(imageDataUrl) {
            const modelName = document.getElementById('answerKeyModel')?.value;
            correctAnswers = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName].answers : [];

            if (correctAnswers.length === 0 && !isScanningForKey) {
                showNotification('يرجى إعداد وحفظ الإجابات الصحيحة أولاً.', 'error'); return;
            }
            if (!currentStudent && !isMultipleCorrectionMode && !isScanningForKey) {
                showNotification('يرجى اختيار طالب أولاً.', 'error'); return;
            }
            
            document.getElementById('verificationContainer')?.classList.remove('hidden');
            
            showNotification('جاري تحليل الصورة بواسطة الذكاء الاصطناعي... (يرجى الانتظار)', 'info');

            try {
// Extract base64 part
            const base64Image = imageDataUrl.split(',')[1];
            
            const payload = {
                image_base64: base64Image,
                num_questions: document.getElementById('questionCount')?.value || correctAnswers.length,
                options_per_q: document.getElementById('optionsCount')?.value || 4,
                correct_answers: isScanningForKey ? [] : correctAnswers
            };


            // --- استدعاء خادم التحليل الخارجي (Python Backend) ---
            const response = await fetch('/api/correct', { 
                method: 'POST', 
                // *** التعديل الرئيسي: إضافة رأس Content-Type ***
                headers: { 
                    'Content-Type': 'application/json' 
                },
                // *** تحويل حمولة البيانات إلى JSON String ***
                body: JSON.stringify(payload)
            });
            const data = await response.json();
			
                // --- نهاية الاستدعاء ---

                if (!data.success) throw new Error(data.error || 'فشل في التحليل من الخادم');
                
                if (isScanningForKey) {
                    isScanningForKey = false;
                    const scannedAnswers = data.answers;
                    const questionCount = parseInt(document.getElementById('questionCount')?.value || 0);
                    for (let i = 0; i < questionCount; i++) {
                        const select = document.getElementById(`answer${i + 1}`);
                        if (select && scannedAnswers[i]) {
                            select.value = scannedAnswers[i] === 'Blank' ? 'A' : scannedAnswers[i];
                        }
                    }
                    showNotification('تم مسح الإجابات بنجاح. يرجى مراجعتها ثم الحفظ.', 'success');
                    showManualEntry();
                    showSection('answer-key');

                } else {
                    studentAnswers = data.answers;
                    showAnswerVerification();
                }
            } catch (err) {
                console.error("Error processing answers:", err);
                showNotification(`فشل تحليل الصورة: ${err.message}`, 'error');
                resetForNewSheet();
            }
        

// === Verification and Results ===
function showAnswerVerification() {
    const verificationGrid = document.getElementById('verificationGrid');
    const optionsCountSelect = document.getElementById('optionsCount');
    if(!verificationGrid || !optionsCountSelect || !Array.isArray(correctAnswers)) {
        console.error("Cannot show verification: grid, select, or correctAnswers missing/invalid.");
        return;
    }
    if (correctAnswers.length === 0) {
        showNotification("لا يوجد نموذج إجابة لهذا العدد من الأسئلة. يرجى الإعداد أولاً.", "error");
        resetForNewSheet();
        return;
    }

    const optionsCount = parseInt(optionsCountSelect.value);
    const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
    verificationGrid.innerHTML = '';
    
    // تأكد من أن studentAnswers لديه طول مناسب
    while (studentAnswers.length < correctAnswers.length) {
        studentAnswers.push('Blank');
    }

    for (let i = 0; i < correctAnswers.length; i++) {
        const answer = studentAnswers[i] || 'Blank';
        verificationGrid.innerHTML += `
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <label class="block text-sm font-medium text-gray-700 mb-2">س ${i + 1}</label>
                <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    <option value="Blank" ${answer === 'Blank' ? 'selected' : ''}>فراغ</option>
                    ${options.map(opt => `<option value="${opt}" ${opt === answer ? 'selected' : ''}>${opt}</option>`).join('')}
                    ${!options.includes(answer) && answer !== 'Blank' ? `<option value="${answer}" selected>${answer} (غريب)</option>` : ''}
                </select>
            </div>`;
    }
    document.getElementById('verificationSection')?.classList.remove('hidden');
}


function confirmAnswers() {
    // قراءة الإجابات من قائمة التحقق يدوياً (لتضمين أي تعديلات قام بها المستخدم)
    studentAnswers = Array.from({ length: correctAnswers.length }, (_, i) => {
        const select = document.getElementById(`verify${i}`);
        return select ? select.value : 'Blank';
    });
    document.getElementById('verificationContainer')?.classList.add('hidden');
    displayResults();
}

function displayResults() {
    if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
        console.error("Cannot display results without correct answers.");
        return;
    }
    let correctCount = 0;
    const detailedResults = document.getElementById('detailedResults');
    if(!detailedResults) return;

    detailedResults.innerHTML = '';
    for (let i = 0; i < correctAnswers.length; i++) {
        const sAnswer = studentAnswers[i] !== undefined ? studentAnswers[i] : 'Blank';
        const displayAnswer = sAnswer === 'Blank' ? 'فراغ' : sAnswer;
        const isCorrect = sAnswer === correctAnswers[i];
        if (isCorrect) correctCount++;
        detailedResults.innerHTML += `
            <div class="p-3 rounded-lg text-white text-center font-medium ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                <div class="text-sm">س ${i + 1}</div>
                <div class="text-lg">${displayAnswer || '∅'}</div>
                <div class="text-xs">${isCorrect ? '✓' : `✗ (${correctAnswers[i]})`}</div>
            </div>`;
    }
    const wrongCount = correctAnswers.length - correctCount;
    const percentage = correctAnswers.length > 0 ? Math.round((correctCount / correctAnswers.length) * 100) : 0;
    
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('wrongCount').textContent = wrongCount;
    document.getElementById('scorePercentage').textContent = `${percentage}%`;
    document.getElementById('letterGrade').textContent = getLetterGrade(percentage);
    
    const studentForDisplay = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
    if (!studentForDisplay) {
        console.error("No student selected for displaying results.");
        return;
    }
    const modelName = document.getElementById('answerKeyModel')?.value;
    const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};

    document.getElementById('resultStudentName').textContent = studentForDisplay.name;
    document.getElementById('resultStudentClass').textContent = studentForDisplay.class;
    document.getElementById('resultExamName').textContent = modelData.examName || 'غير محدد';
    document.getElementById('resultExamDate').textContent = modelData.examDate || '';
    document.getElementById('resultsSection')?.classList.remove('hidden');
}

function getLetterGrade(percentage) {
    if (percentage >= 90) return 'ممتاز';
    if (percentage >= 80) return 'جيد جداً';
    if (percentage >= 70) return 'جيد';
    if (percentage >= 60) return 'مقبول';
    return 'ضعيف'; 
}

function saveToHistory() {
    const studentForHistory = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
    if (!studentForHistory) {
        showNotification("لا يوجد طالب محدد لحفظ النتيجة.", "error");
        return;
    }
    if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
        showNotification("لا يمكن حفظ نتيجة بدون نموذج إجابة صحيح.", "error");
        return;
    }
    const correctCount = parseInt(document.getElementById('correctCount')?.textContent || '0');
    const totalQuestions = correctAnswers.length;
    const modelName = document.getElementById('answerKeyModel')?.value;
    const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};
    const result = {
        id: Date.now(), studentName: studentForHistory.name, studentClass: studentForHistory.class,
        examName: modelData.examName || 'غير محدد', examDate: modelData.examDate || '',
        score: `${correctCount}/${totalQuestions}`,
        percentage: document.getElementById('scorePercentage')?.textContent || '0%',
        grade: document.getElementById('letterGrade')?.textContent || '-',
    };
    const finalStudentAnswers = Array.from({ length: totalQuestions }, (_, i) => studentAnswers[i] || 'Blank');
    const detailedResult = { ...result, answers: finalStudentAnswers };

    resultsHistory.unshift(result); detailedAnswersLog.unshift(detailedResult);
    localStorage.setItem('examResults', JSON.stringify(resultsHistory));
    localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
    updateHistoryDisplay();
    document.getElementById('detailedHistorySection')?.classList.remove('hidden');
    
    const studentIndex = studentsList.findIndex(s => s.id === studentForHistory.id);
    if (studentIndex !== -1) {
        studentsList[studentIndex].status = 'corrected';
        studentsList[studentIndex].result = { percentage: result.percentage, score: result.score };
        localStorage.setItem('studentsList', JSON.stringify(studentsList));
        displayStudentsList();
    }
    if (isMultipleCorrectionMode) {
        handleMultiCorrectionNext(result);
    } else {
        resetForNewSheet();
    }
}

function resetForNewSheet() {
    document.getElementById('resultsSection')?.classList.add('hidden');
    document.getElementById('verificationContainer')?.classList.add('hidden');
    selectDifferentStudent();
    showNotification('تم الحفظ! يمكنك الآن تصحيح ورقة جديدة.', 'success');
    
    if (stream) {
        // إعادة تشغيل الكاميرا والعد التنازلي بعد الحفظ التلقائي
        stopCamera();
        showCameraSection();
    } else {
        document.getElementById('uploadOptions')?.classList.remove('hidden');
    }
}

// ----------------------------------------------------
// === History Management ===
// ----------------------------------------------------

function populateHistoryFilters() {
    const classFilter = document.getElementById('historyClassFilter');
    const examFilter = document.getElementById('historyExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">جميع الفصول</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">جميع الاختبارات</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    const historySection = document.getElementById('historySection');
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const historyFiltersDiv = document.getElementById('historyFilters');


    if(!historyList || !historySection || !historyFiltersDiv) return;
    
    historyFiltersDiv.classList.toggle('hidden', resultsHistory.length === 0);

    const filteredHistory = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );


    historySection.classList.toggle('hidden', resultsHistory.length === 0); 
    if (filteredHistory.length === 0 && resultsHistory.length > 0) { 
        historyList.innerHTML = '<p class="text-center text-gray-500 py-4">لا توجد نتائج تطابق الفلتر المحدد.</p>';
    } else if (filteredHistory.length === 0 && resultsHistory.length === 0){
        historyList.innerHTML = ''; 
    } else {
        historyList.innerHTML = filteredHistory.map(r => `
            <div class="bg-gray-50 rounded-lg p-3 border-r-4 border-blue-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold">${r.studentName}</h4>
                        <p class="text-sm text-gray-600">${r.examName || 'اختبار غير مسمى'} - ${r.examDate || 'بدون تاريخ'}</p>
                    </div>
                    <div class="text-left">
                        <div class="text-lg font-bold text-blue-600">${r.percentage || '0%'}</div>
                        <div class="text-sm font-semibold text-gray-700">(${r.score || '0/0'})</div>
                        <div class="text-xs text-gray-600">${r.grade || '-'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

function exportResults() {
    const studentName = document.getElementById('resultStudentName')?.textContent;
    const percentage = document.getElementById('scorePercentage')?.textContent;
    if (!studentName || !percentage) return;
    const report = `نتيجة الطالب: ${studentName}\nالنسبة: ${percentage}`;
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `نتيجة_${studentName}.txt`; a.click(); URL.revokeObjectURL(url);
}

function exportAllResults() {
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const filteredHistory = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );
    if (filteredHistory.length === 0) {
        showNotification("لا توجد نتائج مطابقة للفلتر لتصديرها.", "info");
        return;
    }
    try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(filteredHistory);
        XLSX.utils.book_append_sheet(wb, ws, 'سجل النتائج');
        XLSX.writeFile(wb, 'سجل_النتائج_المفلتر.xlsx');
    } catch(e) {
        console.error("Error exporting filtered results:", e);
        showNotification("خطأ في تصدير ملخص النتائج.", "error");
    }
}

function exportDetailedAnswersLog() {
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const filteredLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );

    if (filteredLogs.length === 0) { 
        showNotification("لا يوجد سجل مفصل مطابق للفلتر لتصديره.", "info"); 
        return; 
    }
    try {
        const maxQuestions = Math.max(0, ...filteredLogs.map(log => log.answers?.length || 0));
        const headers = ['اسم الطالب', 'الفصل', 'اسم الاختبار', 'التاريخ', 'الدرجة'];
        for(let i=1; i<= maxQuestions; i++) { headers.push(`س${i}`); }
        const data = filteredLogs.map(log => {
            const row = {'اسم الطالب': log.studentName, 'الفصل': log.studentClass, 'اسم الاختبار': log.examName, 'التاريخ': log.examDate, 'الدرجة': log.score };
            (log.answers || []).forEach((ans, i) => { row[`س${i+1}`] = ans; });
            return row;
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data, {header: headers});
        XLSX.utils.book_append_sheet(wb, ws, 'سجل إجابات الطلاب');
        XLSX.writeFile(wb, 'سجل_إجابات_الطلاب_المفصل_المفلتر.xlsx');
    } catch(e) {
        console.error("Error exporting filtered detailed log:", e);
        showNotification("خطأ في تصدير سجل الإجابات.", "error");
    }
}


function clearHistory() {
    if (confirm('هل أنت متأكد من مسح السجل؟ لا يمكن التراجع عن هذا الإجراء.')) {
        resultsHistory = []; detailedAnswersLog = [];
        localStorage.removeItem('examResults');
        localStorage.removeItem('detailedAnswersLog');
        updateHistoryDisplay();
        document.getElementById('detailedHistorySection')?.classList.add('hidden');
    }
}

// ----------------------------------------------------
// === Multiple Correction Logic ===
// ----------------------------------------------------

function toggleMultipleCorrection() {
    const uncorrected = studentsList.filter(s => s.status === 'pending');
    if (uncorrected.length === 0) { showNotification('جميع الطلاب تم تصحيح أوراقهم!', 'info'); return; }
    const multiSection = document.getElementById('multipleCorrectionSection');
    if(multiSection) multiSection.classList.toggle('hidden');
    selectDifferentStudent(); // Clear single selection
    showSection('correction');
}

function startMultipleCorrection() {
    multiCorrectionQueue = studentsList.filter(s => s.status === 'pending');
    if (multiCorrectionQueue.length === 0) { showNotification('لا توجد أوراق في انتظار التصحيح!', 'error'); return; }
    const modelName = document.getElementById('answerKeyModel')?.value;
    if (!modelName || !answerKeyModels[modelName] || answerKeyModels[modelName].answers.length === 0) { 
        showNotification('يرجى إعداد وحفظ الإجابات الصحيحة للنموذج الحالي أولاً!', 'error'); 
        return; 
    }
    isMultipleCorrectionMode = true; currentMultiIndex = 0; multiCorrectionResults = [];
    document.getElementById('multiCorrectionSetup')?.classList.add('hidden');
    document.getElementById('multiCorrectionActive')?.classList.remove('hidden');
    showCurrentMultiStudent();
    showNotification(`بدء التصحيح المتعدد لـ ${multiCorrectionQueue.length} طالب.`, 'success');
}

function showCurrentMultiStudent() {
    if(currentMultiIndex >= multiCorrectionQueue.length) {
        completeMultipleCorrection();
        return;
    }
    const student = multiCorrectionQueue[currentMultiIndex];
    document.getElementById('multiStudentName').textContent = student.name;
    document.getElementById('multiStudentClass').textContent = student.class;
    document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
    updateMultiCorrectionProgress();
    
    if(!stream) {
        showCameraSection();
    } else {
        startAutoCapture(); // إعادة تشغيل الالتقاط التلقائي
    }
}

function updateMultiCorrectionProgress() {
    if(multiCorrectionQueue.length === 0) return;
    const progress = ((currentMultiIndex) / multiCorrectionQueue.length) * 100;
    document.getElementById('progressText').textContent = `${currentMultiIndex} من ${multiCorrectionQueue.length}`;
    document.getElementById('progressBar').style.width = `${progress}%`;
}

function handleMultiCorrectionNext(result) {
    multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'completed', result });
    currentMultiIndex++;
    if (currentMultiIndex < multiCorrectionQueue.length) {
        showCurrentMultiStudent(); // Display next student info
        resetForNewSheet(); 
        showNotification(`تم حفظ النتيجة. انتقل للطالب التالي: ${multiCorrectionQueue[currentMultiIndex].name}`, 'info');
    } else {
        completeMultipleCorrection();
    }
}


function skipCurrentStudent() {
    multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'skipped', result: null });
    currentMultiIndex++;
    if (currentMultiIndex < multiCorrectionQueue.length) {
        showCurrentMultiStudent();
        if(!stream) showCameraSection(); else startAutoCapture();
    } else {
        completeMultipleCorrection();
    }
}


function stopMultipleCorrection() {
    if (confirm('هل أنت متأكد من إنهاء التصحيح المتعدد؟')) {
        completeMultipleCorrection();
    }
}

function completeMultipleCorrection() {
    isMultipleCorrectionMode = false;
    stopCamera(); // Stop camera when multi-mode ends
    document.getElementById('multiCorrectionActive')?.classList.add('hidden');
    if (multiCorrectionResults.length > 0) {
        generateMultiCorrectionReport();
    } else {
        resetMultiCorrection();
    }
    showNotification('تم إنهاء التصحيح المتعدد.', 'success');
}

function generateMultiCorrectionReport() {
    const corrected = multiCorrectionResults.filter(r => r.status === 'completed').length;
    const skipped = multiCorrectionResults.filter(r => r.status === 'skipped').length;
    const avgScore = corrected > 0 ? Math.round(multiCorrectionResults.filter(r=>r.result).reduce((sum, r) => sum + (parseInt(r.result.percentage) || 0), 0) / corrected) : 0;
    const reportContentDiv = document.getElementById('multiReportContent');
    const reportSectionDiv = document.getElementById('multiCorrectionReport');
    if(!reportContentDiv || !reportSectionDiv) return;

    reportContentDiv.innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-4 text-center">
            <div class="bg-green-100 p-2 rounded-lg"><div class="font-bold text-lg">${corrected}</div><div class="text-xs">تم تصحيحها</div></div>
            <div class="bg-yellow-100 p-2 rounded-lg"><div class="font-bold text-lg">${skipped}</div><div class="text-xs">تم تخطيها</div></div>
            <div class="bg-blue-100 p-2 rounded-lg"><div class="font-bold text-lg">${avgScore}%</div><div class="text-xs">متوسط الدرجات</div></div>
        </div>
    `;
    reportSectionDiv.classList.remove('hidden');
}

function exportMultiReport() {
    if(multiCorrectionResults.length === 0) return;
    try {
        const reportData = multiCorrectionResults.map(r => ({
            'اسم الطالب': r.student.name, 
            'الفصل': r.student.class, 
            'الحالة': r.status === 'completed' ? 'تم التصحيح' : 'تم التخطي', 
            'الدرجة': r.result ? r.result.score : '-',
            'النسبة': r.result ? r.result.percentage : '-',
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(reportData);
        XLSX.utils.book_append_sheet(wb, ws, 'تقرير التصحيح');
        XLSX.writeFile(wb, 'تقرير_التصحيح_المتعدد.xlsx');
    } catch(e) {
        console.error("Error exporting multi-report:", e);
        showNotification("خطأ في تصدير التقرير.", "error");
    }
}


function resetMultiCorrection() {
    document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
    document.getElementById('multiCorrectionSetup')?.classList.remove('hidden');
    document.getElementById('multiCorrectionReport')?.classList.add('hidden');
}

// ----------------------------------------------------
// === Reports Section ===
// ----------------------------------------------------

function populateReportFilters() {
    const classFilter = document.getElementById('reportClassFilter');
    const examFilter = document.getElementById('reportExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">جميع الفصول</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">جميع الاختبارات</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function generateClassReport() {
    const classFilter = document.getElementById('reportClassFilter')?.value;
    const examFilter = document.getElementById('reportExamFilter')?.value;
    const container = document.getElementById('report-container');
    if (container === null || classFilter === undefined || examFilter === undefined) return;

    const filteredLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );
    
    const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
    const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


    if (filteredLogs.length === 0 && absentStudents.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500">لا توجد بيانات تطابق هذه الفلاتر لإنشاء تقرير.</p>`;
        return;
    }
    
    const firstLog = filteredLogs[0]; // Use first log to find answer key
    let reportCorrectAnswers = [];
    let questionAnalysisHTML = '<p class="text-sm text-gray-500">لا يمكن تحليل الأسئلة بدون نموذج إجابة مطابق لهذا الاختبار.</p>';
    let hardestQuestionNum = '-';
    let easiestQuestionNum = '-';
    let totalQuestions = 0;
    
    if (firstLog) {
        const modelName = Object.keys(answerKeyModels).find(key => {
            const model = answerKeyModels[key];
            // Match by examName AND number of answers
            return model && (model.examName === firstLog.examName) && (model.answers && model.answers.length === (firstLog.answers?.length || 0));
        });
        reportCorrectAnswers = modelName ? (answerKeyModels[modelName].answers || []) : [];
        totalQuestions = reportCorrectAnswers.length; // Get total questions count

        if (reportCorrectAnswers.length > 0) {
            const questionErrors = {};
            for (let i = 0; i < reportCorrectAnswers.length; i++) {
                 // Initialize with errors, corrects count, and correct answer
                 questionErrors[i + 1] = { qNum: i + 1, errors: 0, corrects: 0, correct: reportCorrectAnswers[i] };
            }
            filteredLogs.forEach(log => {
                 (log.answers || []).forEach((studentAnswer, i) => {
                     if (i < reportCorrectAnswers.length) {
                          if (studentAnswer === reportCorrectAnswers[i]) {
                              questionErrors[i + 1].corrects++;
                          } else {
                              questionErrors[i + 1].errors++;
                          }
                          // Track incorrect choices (excluding Blank) - No longer strictly needed for this column but kept for analysis logic
                          if(studentAnswer && studentAnswer !== 'Blank' && studentAnswer !== reportCorrectAnswers[i]){ 
                              questionErrors[i + 1].choices = questionErrors[i + 1].choices || {};
                              questionErrors[i + 1].choices[studentAnswer] = (questionErrors[i + 1].choices[studentAnswer] || 0) + 1;
                          }
                      }
                 });
            });
            
            // Get all questions numerically (Goal 4)
            const analysisArray = Object.values(questionErrors).sort((a, b) => a.qNum - b.qNum);
            
            // Find easiest/hardest from the analysis array
            if (analysisArray.length > 0) {
                const sortedByError = [...analysisArray].sort((a, b) => b.errors - a.errors);
                hardestQuestionNum = sortedByError.length > 0 ? sortedByError[0].qNum : '-';
                easiestQuestionNum = sortedByError.length > 0 ? sortedByError[sortedByError.length - 1].qNum : '-';
            }
            
            
            // Build the analysis table HTML (Goal 5)
            questionAnalysisHTML = `
                <table class="w-full text-sm mt-4 border-collapse border border-gray-300 question-analysis-table">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-300">
                            <th class="p-1 border-l border-gray-300">رقم السؤال</th>
                            <th class="p-1 border-l border-gray-300">الإجابات الصحيحة</th>
                            <th class="p-1 border-l border-gray-300">عدد الأخطاء</th>
                            <th class="p-1 border-l border-gray-300">درجة الصعوبة</th>
                            <th class="p-1">الإجابة الصحيحة (النموذج)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisArray.map(data => {
                             // Determine row color based on error rate
                            let errorClass = 'q-errors-none';
                            let difficultyText = 'سهلة جداً';
                            if(filteredLogs.length > 0) { // Avoid division by zero
                                const errorRate = data.errors / filteredLogs.length;
                                if (errorRate > 0.5) { errorClass = 'q-errors-high'; difficultyText = 'صعبة'; }
                                else if (errorRate > 0.25) { errorClass = 'q-errors-medium'; difficultyText = 'متوسطة'; }
                                else if (errorRate > 0) { errorClass = 'q-errors-low'; difficultyText = 'سهلة'; }
                            }
                            return `
                            <tr class="border-b border-gray-200 ${errorClass}">
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.qNum}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.corrects}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.errors}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${difficultyText}</td>
                                <td class="p-1 text-center">${data.correct || '-'}</td>
                            </tr>`
                        }).join('')}
                    </tbody>
                </table>`;
        }
    }


    const scores = filteredLogs.map(log => parseInt(log.percentage));
    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
    const maxScore = scores.length > 0 ? Math.max(...scores) : 0;
    const minScore = scores.length > 0 ? Math.min(...scores) : 0;
    const presentCount = filteredLogs.length;
    const absentCount = absentStudents.length;


    let reportHTML = `
        <div id="printable-report" class="bg-white p-6 rounded-lg shadow-md">
            
            <h4 class="text-lg font-bold mb-2">ملخص الأداء</h4>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
                <div class="bg-blue-100 p-3 rounded-lg"><div class="font-bold text-xl">${presentCount}</div><div class="text-xs">عدد الحضور</div></div>
                <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-xl">${absentCount}</div><div class="text-xs">عدد الغياب</div></div>
                <div class="bg-orange-100 p-3 rounded-lg"><div class="font-bold text-xl">${totalQuestions}</div><div class="text-xs">إجمالي الأسئلة</div></div>
                <div class="bg-green-100 p-3 rounded-lg"><div class="font-bold text-xl">${avgScore}%</div><div class="text-xs">متوسط الحضور</div></div>
                <div class="bg-yellow-100 p-3 rounded-lg"><div class="font-bold text-xl">${maxScore}%</div><div class="text-xs">أعلى درجة</div></div>
                
            </div>
            
            <h4 class="text-lg font-bold mt-6 mb-2">تحليل الأسئلة</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-red-50 p-3 rounded-lg text-center">
                    <h5 class="font-semibold mb-1 text-red-700">أصعب سؤال</h5>
                    <p class="text-2xl font-bold text-red-600">س ${hardestQuestionNum}</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg text-center">
                    <h5 class="font-semibold mb-1 text-green-700">أسهل سؤال</h5>
                    <p class="text-2xl font-bold text-green-600">س ${easiestQuestionNum}</p>
                </div>
            </div>
            <div class="mb-6 border rounded p-2 bg-gray-50">
                ${questionAnalysisHTML}
            </div>

            <div class="text-center">
                <button id="printReportBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">طباعة التقرير الكامل</button>
            </div>
        </div>
    `;
    container.innerHTML = reportHTML;
    
    // Re-attach listener for the newly created button
    const printBtn = document.getElementById('printReportBtn');
    if(printBtn) printBtn.addEventListener('click', printReport);
}

async function printReport() {
    const classFilter = document.getElementById('reportClassFilter')?.value;
    const examFilter = document.getElementById('reportExamFilter')?.value;
    if(classFilter === undefined || examFilter === undefined) return;
    const modelNameFromExam = Object.keys(answerKeyModels).find(key => answerKeyModels[key].examName === examFilter);
    const subjectName = modelNameFromExam ? answerKeyModels[modelNameFromExam].subject : (examFilter || 'الاختبار');
    const date = new Date().toLocaleDateString('ar-SA');
    const title = `تقرير أداء ${subjectName} ${examFilter ? '- ' + examFilter : ''}`;
    const fileName = `تقرير-${subjectName.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}-${date}`; // Sanitize file name better

    
    // Get the generated content *excluding* the print button itself for printing
    const reportContainerClone = document.getElementById('report-container')?.cloneNode(true);
    if(!reportContainerClone) return;
    const printButtonInClone = reportContainerClone.querySelector('#printReportBtn');
    if(printButtonInClone) printButtonInClone.remove();
    
    // Extract core analysis content to be printed early (Goal 2, 3, 4, 5)
    const summaryHTML = reportContainerClone.querySelector('h4:nth-of-type(1)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-6')?.outerHTML;
    const analysisHTML = reportContainerClone.querySelector('h4:nth-of-type(2)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-4')?.outerHTML + reportContainerClone.querySelector('.mb-6.border.rounded.p-2.bg-gray-50')?.outerHTML;


    // Filter logs again to get student list for printing
    const studentLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );
    const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
    const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


    // Sort students alphabetically for the table
    allStudentsInFilter.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

    const studentListHTML = allStudentsInFilter.map((student, index) => {
        const log = studentLogs.find(l => l.studentName === student.name && l.studentClass === student.class);
        return `
            <tr class="border-b">
                <td class="p-1 text-center">${index + 1}</td>
                <td class="p-1 text-right">${student.name}</td>
                <td class="p-1 text-center">${student.class}</td>
                <td class="p-1 text-center">${log ? log.score : (student.status === 'absent' ? 'غائب' : '-')}</td>
                <td class="p-1 text-center">${log ? log.percentage : '-'}</td>
                <td class="p-1 text-center">${log ? log.grade : '-'}</td>
            </tr>
        `}).join('');
    
    const absentListHTML = absentStudents.map((student, index) => `
            <li class="text-sm">${index + 1}. ${student.name} (${student.class})</li>
    `).join('');


    // Generate chart images for printing (Goal 2)
    const gradeChartImage = await getReportChartsAsImages(studentLogs, 'pie');
    // For class chart in report, only show if no specific class is selected
    const classChartImage = (!classFilter) ? await getReportChartsAsImages(studentLogs, 'bar', classFilter) : null;


    const chartsHTML = `
            <div class="page-break" style="page-break-before: always;"></div> 
            <h4 class="text-lg font-bold mt-6 mb-2 text-center">توزيع التقديرات</h4>
            <div style="text-align: center; margin-bottom: 20px;">
                ${gradeChartImage ? `<img src="${gradeChartImage}" class="mx-auto block" style="max-width: 350px; margin-top: 10px; border: 1px solid #ccc;"/>` : '<p class="text-center text-gray-500">لا يمكن عرض رسم التقديرات (تأكد من وجود بيانات).</p>'}
            </div>
            
            ${classChartImage ? `
                    <h4 class="text-lg font-bold mt-6 mb-2 text-center">متوسط الأداء حسب الفصل</h4>
                    <div style="text-align: center; margin-bottom: 20px;">
                       <img src="${classChartImage}" class="mx-auto block" style="max-width: 600px; margin-top: 10px; border: 1px solid #ccc;"/>
                    </div>
            ` : ''}
    `;


    const studentTable = `
            <div class="page-break" style="page-break-before: always;"></div> 
            <h4 class="text-lg font-bold mt-6 mb-2">درجات الطلاب</h4>
            <table class="w-full text-sm mt-4">
                <thead><tr class="border-b-2 border-black"><th class="p-1">#</th><th class="p-1 text-right">اسم الطالب</th><th class="p-1">الفصل</th><th class="p-1">الدرجة</th><th class="p-1">النسبة</th><th class="p-1">التقدير</th></tr></thead>
                <tbody>${studentListHTML}</tbody>
            </table>
            
            ${absentStudents.length > 0 ? `
                    <h4 class="text-lg font-bold mt-6 mb-2">الطلاب الغائبون (${absentStudents.length})</h4>
                    <ul class="list-decimal list-inside pr-4">${absentListHTML}</ul>
            ` : ''}
    `;
    
    // Final content assembly (Goal 2)
    const finalPrintContent = summaryHTML + analysisHTML + chartsHTML + studentTable;

    // Use the separate div for print content
    const printDiv = document.getElementById('printable-report-content');
    if (printDiv) {
        printDiv.innerHTML = finalPrintContent; 
        printContent(printDiv.innerHTML, title, fileName); // Pass the combined HTML
    } else {
        console.error("Printable report content div not found.");
    }
}

function printContent(content, title, fileName) {
    const settings = getFromStorage('appSettings', {});
    const classFilter = document.getElementById('reportClassFilter')?.value || '';
    const examFilter = document.getElementById('reportExamFilter')?.value || '';
    const date = new Date().toLocaleDateString('ar-SA');
    const safeFileName = fileName || `${title.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}_${date}`; // Use provided or generate

    const headerInfo = `
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
            <p style="margin: 2px 0;">${settings.admin || ''}</p>
            <p style="margin: 2px 0;">${settings.school || ''}</p>
            <h1 style="font-size: 1.5rem; font-weight: bold; margin: 5px 0;">${title}</h1>
            <div style="font-size: 0.9rem; color: #555;">
                <span>${classFilter ? `الفصل: ${classFilter}`: ''}</span>
                <span>${examFilter ? ` | اختبار: ${examFilter}` : ''}</span>
                <span> | ${date}</span>
            </div>
            <div style="font-size: 0.8rem; color: #555; margin-top: 5px;">
                <span>المعلم: ${settings.teacher || ''}</span>
                ${settings.director ? `<span> | المدير: ${settings.director || ''}</span>` : ''}
            </div>
        </div>
    `;

    const fullContent = headerInfo + content;
    const win = window.open('', '_blank');
    if(win){
        win.document.write(`
            <html>
                <head>
                    <title>${safeFileName}</title>
                    <script src="https://cdn.tailwindcss.com"></script> 
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                     <style>
                        body { font-family:'Cairo', sans-serif; direction: rtl; margin: 20px; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; } 
                        table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto !important; } 
                        tr { page-break-inside: avoid !important; page-break-after: auto !important; }
                        thead { display: table-header-group !important; } 
                        td, th { border: 1px solid #ddd !important; padding: 4px !important; text-align: center !important; font-size: 0.75rem !important; } 
                        th { background-color: #f2f2f2 !important; font-weight: bold !important;} 
                        tr:nth-child(even){background-color: #f9f9f9 !important;} 
                        img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important;}
                        .page-break { page-break-before: always !important; }
                        .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } 
                        .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } 
                        .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } 
                        .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } 
                        .bg-blue-100 { background-color: #DBEAFE !important; }
                        .bg-green-100 { background-color: #DCFCE7 !important; }
                        .bg-red-100 { background-color: #FEE2E2 !important; }
                        .bg-gray-100 { background-color: #F3F4F6 !important; }
                        .bg-yellow-100 { background-color: #FEF3C7 !important; }
                        .bg-orange-100 { background-color: #FFEDD5 !important; }
                        .bg-red-50 { background-color: #FEF2F2 !important; }
                        .bg-green-50 { background-color: #F0FDF4 !important; }
                        .bg-gray-50 { background-color: #F9FAFB !important; }
                        .text-red-700 { color: #b91c1c !important; }
                        .text-green-700 { color: #15803d !important; }
                        .text-red-600 { color: #dc2626 !important; }
                        .text-green-600 { color: #16a34a !important; }
                        .text-blue-600 { color: #2563eb !important; }
                        .font-semibold { font-weight: 600 !important; }
                        .font-bold { font-weight: 700 !important; }
                        .text-xs { font-size: 0.7rem !important; }
                        .text-sm { font-size: 0.8rem !important; }
                        .text-lg { font-size: 1rem !important; }
                        .text-xl { font-size: 1.1rem !important; }
                        .text-2xl { font-size: 1.2rem !important; }
                        .p-1 { padding: 0.25rem !important; }
                        .p-2 { padding: 0.5rem !important; }
                        .p-3 { padding: 0.75rem !important; }
                        .mb-1 { margin-bottom: 0.25rem !important; }
                        .mb-2 { margin-bottom: 0.5rem !important; }
                        .mb-4 { margin-bottom: 1rem !important; }
                        .mt-4 { margin-top: 1rem !important; }
                        .mt-6 { margin-top: 1.5rem !important; }
                        .gap-4 { gap: 1rem !important; }
                        .grid { display: grid !important; }
                        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
                        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
                        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
                        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)) !important; }
                        .text-center { text-align: center !important; }
                        .text-right { text-align: right !important; }
                        .rounded-lg { border-radius: 0.5rem !important; }
                        @media print { button { display: none !important; } }
                    </style>
                </head>
                <body class="p-4">${fullContent}</body>
            </html>`);
        win.document.close();
        setTimeout(() => { 
            try { win.print(); } catch(e){ console.error("Print error:", e); }
        }, 500);
    } else {
        showNotification("فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.", "error");
    }
}

function printBlankSheet() {
    const qCountInput = document.getElementById('questionCount');
    const oCountSelect = document.getElementById('optionsCount');
    const subjectInput = document.getElementById('subjectName');
    const modelSelect = document.getElementById('answerKeyModel');
    const examNameInput = document.getElementById('examName');
    const examDateInput = document.getElementById('examDate');

    if(!qCountInput || !oCountSelect || !subjectInput || !modelSelect || !examNameInput || !examDateInput) {
        showNotification("خطأ: لم يتم العثور على عناصر النموذج.", "error");
        return;
    }


    const qCount = parseInt(qCountInput.value);
    if (isNaN(qCount) || qCount < 1) {
        showNotification("عدد الأسئلة غير صالح لطباعة النموذج.", "error");
        return;
    }
    const oCount = parseInt(oCountSelect.value);
    const options = Array.from({ length: oCount }, (_, i) => String.fromCharCode(65 + i));
    const subjectName = subjectInput.value || 'غير محدد';
    const modelName = modelSelect.value.replace('نموذج ', '');
    const examName = examNameInput.value || 'غير محدد';
    const examDate = examDateInput.value || '';
    const splitPoint = Math.ceil(qCount / 2);
    const date = new Date().toLocaleDateString('ar-SA');
    const fileName = `نموذج-إجابة-${subjectName}-${date}`;


    let col1 = '';
    for (let i = 1; i <= splitPoint; i++) {
        col1 += `<div class="q-item"><span class="q-num">${i}.</span>`;
        options.forEach(opt => { col1 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
        col1 += `</div>`;
    }

    let col2 = '';
    for (let i = splitPoint + 1; i <= qCount; i++) {
        col2 += `<div class="q-item"><span class="q-num">${i}.</span>`;
        options.forEach(opt => { col2 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
        col2 += `</div>`;
    }
    
    // *** تم تغيير الترويسة ليتم دمجها في printContent
    const printContent = `
        <style>
            body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 0; }
            .page { max-width: 800px; margin: auto; padding: 20px; }
            .header-container { display: flex; justify-content: space-between; align-items: flex-start;  border-bottom: none; /* يتم إضافة الحدود في دالة الطباعة */ }
            .header-info { text-align: center; flex-grow: 1; }
            .header-info h1 { font-size: 1.5rem; font-weight: bold; margin: 5px 0;}
            .header-info p { margin: 2px 0; font-size: 0.9rem; }
            .sub-header { font-size: 0.9rem; color: #555; }
            #qrcode-container { width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0; }
            .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; font-size: 14px; }
            .info-item { border-bottom: 1.5px dotted #888; padding-bottom: 8px; }
            .columns-container { display: flex; justify-content: space-between; gap: 20px; }
            .column { flex: 1; }
            .separator { border-left: 1.5px dashed #ccc; margin: 0 10px; flex-shrink: 0; }
            .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
            .q-num { font-weight: bold; width: 30px; flex-shrink: 0; }
            .o-bubble { width: 22px; height: 22px; border: 1.5px solid black; border-radius: 50%; display: inline-block; flex-shrink: 0; }
            .o-label { margin-left: -5px; margin-right: 8px; flex-shrink: 0;}
            @media print { button { display: none; } }
        </style>
        <div class="page">
            <div class="header-container">
                <div id="qrcode-container-print" style="width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0;"></div>
                <div class="header-info" style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <p>${settings.admin || ''}</p>
                    <p>${settings.school || ''}</p>
                    <h1>اختبار مادة: ${subjectName} - نموذج رقم (${modelName})</h1>
                    <div class="sub-header">
                        <span>العام الدراسي: ${settings.year || ''}</span>
                        <span>الفصل الدراسي: ${settings.semester || ''}</span>
                    </div>
                </div>
            </div>
            <div class="info">
                <div class="info-item"><strong>اسم الطالب:</strong></div>
                <div class="info-item"><strong>الفصل:</strong></div>
                <div class="info-item"><strong>اسم الاختبار:</strong> ${examName}</div>
                <div class="info-item"><strong>التاريخ:</strong> ${examDate}</div>
            </div>
            <div class="columns-container">
                <div class="column">${col1}</div>
                ${qCount > 1 ? '<div class="separator"></div>' : ''}
                <div class="column">${col2}</div>
            </div>
        </div>
    `;
    
    // نستخدم دالة الطباعة الخاصة لفتح النافذة وتطبيق التنسيقات
    const win = window.open('', '_blank');
    if(win){
        win.document.write(`
            <html>
                <head>
                    <title>${fileName}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        /* Styles defined within the printContent template */
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <div style="text-align:center; margin-top: 30px;"><button onclick="window.print()">طباعة النموذج</button></div>
                    <script>
                        const qrcode = new QRCode(document.getElementById("qrcode-container-print"), {
                            text: "${modelSelect.value}|${subjectName}|${examName}|${examDate}",
                            width: 80,
                            height: 80,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    </script>
                </body>
            </html>`);
        win.document.close();
        setTimeout(() => { 
            try { 
                // Check if print dialog opened, if not, show button
                if(win.document.readyState === 'complete'){
                    win.print();
                } 
            } catch(e){ 
                console.error("Print error:", e); 
            }
        }, 500);
    } else {
        showNotification("فشل فتح نافذة الطباعة. يرجى السماح بالنوافذ المنبثقة.", "error");
    }
}


// ----------------------------------------------------
// === Settings Section ===
// ----------------------------------------------------

function saveSettings() {
    settings = {
        admin: document.getElementById('setting-admin')?.value || '',
        school: document.getElementById('setting-school')?.value || '',
        teacher: document.getElementById('setting-teacher')?.value || '',
        director: document.getElementById('setting-director')?.value || '',
        year: document.getElementById('setting-year')?.value || '',
        semester: document.getElementById('setting-semester')?.value || '',
    };
    localStorage.setItem('appSettings', JSON.stringify(settings));
    showNotification('تم حفظ الإعدادات بنجاح!', 'success');
}

function loadSettings() {
    const adminInput = document.getElementById('setting-admin');
    if(adminInput) adminInput.value = settings.admin || '';
    const schoolInput = document.getElementById('setting-school');
    if(schoolInput) schoolInput.value = settings.school || '';
    const teacherInput = document.getElementById('setting-teacher');
    if(teacherInput) teacherInput.value = settings.teacher || '';
    const directorInput = document.getElementById('setting-director');
    if(directorInput) directorInput.value = settings.director || '';
    const yearInput = document.getElementById('setting-year');
    if(yearInput) yearInput.value = settings.year || '';
    const semesterInput = document.getElementById('setting-semester');
    if(semesterInput) semesterInput.value = settings.semester || '';
}

function backupData() {
    try {
        const data = {
            appSettings: settings,
            studentsList: studentsList,
            examResults: resultsHistory,
            detailedAnswersLog: detailedAnswersLog,
            answerKeyModels: answerKeyModels,
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('تم إنشاء النسخة الاحتياطية بنجاح!', 'success');
    } catch(e) {
        console.error("Error backing up data:", e);
        showNotification("خطأ في إنشاء النسخة الاحتياطية.", "error");
    }
}

function restoreData(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("هل أنت متأكد من استعادة البيانات؟ سيتم الكتابة فوق جميع البيانات الحالية.")) {
        event.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // Add more validation if necessary
            if (data.appSettings && data.studentsList && data.examResults && data.detailedAnswersLog && data.answerKeyModels) {
                // Restore data
                settings = data.appSettings || {};
                studentsList = (data.studentsList || []).map(s => ({ ...s, status: s.status || 'pending' })); // Ensure status on restore
                resultsHistory = data.examResults || [];
                detailedAnswersLog = data.detailedAnswersLog || [];
                answerKeyModels = data.answerKeyModels || {};
                
                // Save restored data to localStorage
                localStorage.setItem('appSettings', JSON.stringify(settings));
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                localStorage.setItem('examResults', JSON.stringify(resultsHistory));
                localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
                localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));

                showNotification('تم استعادة البيانات بنجاح! سيتم تحديث الواجهة.', 'success');
                
                // Instead of reload, call loadInitialUI to refresh display
                loadInitialUI(); 
                showSection('dashboard'); // Go to dashboard after restore


            } else {
                throw new Error("ملف النسخ الاحتياطي غير صالح أو تالف.");
            }
        } catch (error) {
            console.error("Error restoring data:", error);
            showNotification(`خطأ في استعادة البيانات: ${error.message}`, 'error');
        } finally {
            event.target.value = ''; // Reset file input
        }
    };
    reader.onerror = (e) => {
        console.error("FileReader error (restore):", e);
        showNotification("خطأ في قراءة ملف النسخة الاحتياطية.", "error");
        event.target.value = ''; // Reset file input
    };
    reader.readAsText(file);
}

function clearAllData() {
    const confirmation = prompt("للتأكيد، يرجى كتابة 'حذف' في المربع أدناه.");
    if (confirmation === 'حذف') {
        localStorage.clear();
        showNotification('تم حذف جميع البيانات بنجاح! سيتم إعادة تحميل الصفحة.', 'success');
        setTimeout(() => location.reload(), 1500);
    } else {
        showNotification('لم يتم الحذف. الكتابة غير مطابقة.', 'info');
    }
}

// ----------------------------------------------------
// === Stats Section ===
// ----------------------------------------------------

function populateStatsFilters() {
    const classFilter = document.getElementById('statsClassFilter');
    const examFilter = document.getElementById('statsExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">جميع الفصول</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">جميع الاختبارات</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function updateGlobalStats() {
    const container = document.getElementById('summary-stats');
    const gradeCtx = document.getElementById('grade-distribution-chart');
    const classCtx = document.getElementById('class-performance-chart');
    const classFilter = document.getElementById('statsClassFilter')?.value;
    const examFilter = document.getElementById('statsExamFilter')?.value;
    
    if(!container || !gradeCtx || !classCtx) {
        console.warn("Stats elements not found, skipping update.");
        return; 
    }
    
    const filteredResults = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );


    const totalCorrected = filteredResults.length;
    const overallAverage = totalCorrected > 0 ? Math.round(filteredResults.reduce((sum, r) => sum + (parseInt(r.percentage) || 0), 0) / totalCorrected) : 0;
    const uniqueStudents = new Set(filteredResults.map(r => r.studentName)).size;
    const uniqueExams = new Set(filteredResults.map(r => r.examName)).size;

    container.innerHTML = `
        <div class="bg-blue-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${totalCorrected}</div><div class="text-xs">ورقة مصححة</div></div>
        <div class="bg-green-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${overallAverage}%</div><div class="text-xs">متوسط الأداء</div></div>
        <div class="bg-purple-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${uniqueStudents}</div><div class="text-xs">طالب فريد</div></div>
        <div class="bg-yellow-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-600">${uniqueExams}</div><div class="text-xs">اختبار فريد</div></div>
    `;
    
    // Grade Distribution Chart
    try {
        if(gradeChart) gradeChart.destroy();
        const gradeCtx2D = gradeCtx.getContext('2d');
        if(!gradeCtx2D) throw new Error("Could not get 2D context for grade chart");

        const gradeCounts = { 'ممتاز': 0, 'جيد جداً': 0, 'جيد': 0, 'مقبول': 0, 'ضعيف': 0 };
        filteredResults.forEach(r => { 
            const grade = r.grade || 'ضعيف'; 
            if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
        });
        gradeChart = new Chart(gradeCtx2D, {
            type: 'pie',
            data: {
                labels: Object.keys(gradeCounts),
                datasets: [{
                    data: Object.values(gradeCounts),
                    backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    } catch (e) { console.error("Error creating grade chart:", e); }

    // Class Performance Chart
    try {
        if(classChart) classChart.destroy();
        const classCtx2D = classCtx.getContext('2d');
        if(!classCtx2D) throw new Error("Could not get 2D context for class chart");

        const classPerformances = {};
        filteredResults.forEach(r => {
            const className = r.studentClass || 'غير محدد';
            if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
            classPerformances[className].total += (parseInt(r.percentage) || 0); 
            classPerformances[className].count++;
        });
        const classLabels = Object.keys(classPerformances).sort();
        const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
        classChart = new Chart(classCtx2D, {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{
                    label: 'متوسط الدرجات',
                    data: classAverages,
                    backgroundColor: '#4f46e5',
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    } catch (e) { console.error("Error creating class chart:", e); }
}

async function getReportChartsAsImages(logs, chartType, classFilterValue) {
    if (typeof Chart === 'undefined') {
        console.error("Chart.js library is not loaded.");
        return null;
    }
    const offscreenCanvas = document.createElement('canvas');
    const ctx = offscreenCanvas.getContext('2d');
    if(!ctx){
        console.error("Could not get 2D context for offscreen canvas.");
        return null;
    }
    
    let chartConfig;
    
    if(chartType === 'pie'){
        offscreenCanvas.width = 400; offscreenCanvas.height = 250; 
        const gradeCounts = { 'ممتاز': 0, 'جيد جداً': 0, 'جيد': 0, 'مقبول': 0, 'ضعيف': 0 };
        logs.forEach(r => { 
            const grade = r.grade || 'ضعيف';
            if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
        });
        chartConfig = {
            type: 'pie',
            data: {
                labels: Object.keys(gradeCounts),
                datasets: [{ data: Object.values(gradeCounts), backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'], }]
            },
            options: { responsive: false, animation: false, plugins: { legend: { display: true, position: 'bottom' } } }
        };
    } else if (chartType === 'bar'){
        offscreenCanvas.width = 600; offscreenCanvas.height = 300; 
        const classPerformances = {};
        // If no class filter is active in the report, show all classes' averages across all selected exams
        const relevantHistory = resultsHistory.filter(r => !classFilterValue || r.studentClass === classFilterValue); 

        relevantHistory.forEach(r => {
            const className = r.studentClass || 'غير محدد';
            if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
            classPerformances[className].total += (parseInt(r.percentage) || 0); 
            classPerformances[className].count++;
        });
        const classLabels = Object.keys(classPerformances).sort();
        const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
        
        chartConfig = {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{ label: 'متوسط الدرجات', data: classAverages, backgroundColor: '#4f46e5', }]
            },
            options: { responsive: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
        };
    } else {
        return null; // Invalid chart type
    }

    // Await chart rendering
    return new Promise((resolve) => {
        let chartInstance = null;
        chartConfig.options = chartConfig.options || {};
        chartConfig.options.animation = {
            duration: 0, // No animation
            onComplete: () => {
                try {
                    const dataUrl = chartInstance.toBase64Image();
                    resolve(dataUrl);
                } catch (imgError) {
                    console.error("Error converting chart to image:", imgError);
                    resolve(null);
                } finally {
                    if (chartInstance) chartInstance.destroy();
                }
            }
        };
        try {
            chartInstance = new Chart(ctx, chartConfig);
            if (!chartInstance) throw new Error("Chart instance creation failed.");
        } catch (chartError) {
            console.error("Error creating chart instance:", chartError);
            resolve(null);
        }
    });

}
    </script>
</body>
</html>
