<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª - Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px dashed #10b981;
            width: 80%;
            height: 60%;
            pointer-events: none;
            border-radius: 8px;
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .empty-answer { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .debug-image { max-height: 400px; border: 2px solid #e5e7eb; border-radius: 8px; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
        <header class="text-center mb-12">
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-4xl mx-auto">
                <h1 class="text-5xl font-bold text-gray-800 mb-4">ğŸ¯ ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h1>
                <p class="text-xl text-gray-600 mb-6">ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù„ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="bg-green-100 p-3 rounded-lg">
                        <div class="font-semibold text-green-800">âš¡ Ø³Ø±ÙŠØ¹</div>
                        <div class="text-green-600">ØªØµØ­ÙŠØ­ Ø¢Ù„ÙŠ ÙÙˆØ±ÙŠ</div>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <div class="font-semibold text-blue-800">ğŸ¯ Ø¯Ù‚ÙŠÙ‚</div>
                        <div class="text-blue-600">Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</div>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <div class="font-semibold text-purple-800">ğŸ“Š Ù…ÙØµÙ„</div>
                        <div class="text-purple-600">ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto">
            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <!-- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-3">ğŸ”‘ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</h3>
                        <div class="space-y-2">
                            <textarea id="correctAnswers" rows="3" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ù…Ø«Ø§Ù„: B,C,A,D,B,A,C,D,A,B)">B,C,A,D,B,A,C,D,A,B</textarea>
                            <button onclick="updateAnswerKey()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium text-sm">
                                ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                            </button>
                        </div>
                    </div>

                    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-3">ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                                <input type="number" id="numQuestions" min="1" max="50" value="10" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-green-700 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</label>
                                <select id="optionsPerQuestion" class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="4">4 Ø®ÙŠØ§Ø±Ø§Øª (A,B,C,D)</option>
                                    <option value="5">5 Ø®ÙŠØ§Ø±Ø§Øª (A,B,C,D,E)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                    <div class="bg-purple-50 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-800 mb-3">ğŸ”§ Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="debugMode" class="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                <span class="text-sm text-purple-700">ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ (Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoProcess" checked class="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                <span class="text-sm text-purple-700">Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¹</span>
                            </label>
                            <button onclick="testConnection()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-medium text-sm">
                                Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù… -->
                <div id="serverStatus" class="bg-gray-100 rounded-lg p-4 hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="statusIcon" class="w-8 h-8 rounded-full flex items-center justify-center"></div>
                            <div>
                                <div id="statusText" class="font-semibold"></div>
                                <div id="statusDetails" class="text-sm text-gray-600"></div>
                            </div>
                        </div>
                        <div id="statusTime" class="text-sm text-gray-500"></div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ğŸ“· Ø±ÙØ¹ ØµÙˆØ±Ø© ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
                    </h2>

                    <!-- Ø·Ø±Ù‚ Ø§Ù„Ø±ÙØ¹ -->
                    <div class="flex flex-col gap-4 mb-6">
                        <!-- Ø±ÙØ¹ Ù…Ù„Ù -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                            <input type="file" id="imageUpload" accept="image/*" class="hidden">
                            <div class="mb-4">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-2xl">ğŸ“</span>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²</h3>
                                <p class="text-sm text-gray-600">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ</p>
                            </div>
                            <button onclick="document.getElementById('imageUpload').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                                Ø§Ø®ØªØ± ØµÙˆØ±Ø©
                            </button>
                        </div>

                        <!-- Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª -->
                        <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition-colors">
                            <div class="mb-4">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-2xl">â¬‡ï¸</span>
                                </div>
                                <h3 class="font-semibold text-gray-800 mb-1">Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª</h3>
                                <p class="text-sm text-gray-600">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ£ÙÙ„ØªÙ‡Ø§ Ù‡Ù†Ø§</p>
                            </div>
                            <p class="text-xs text-gray-500">ÙŠØ¯Ø¹Ù…: JPG, PNG, JPEG (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB)</p>
                        </div>
                    </div>

                    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© -->
                    <div id="imagePreviewSection" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©:</h3>
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <img id="imagePreview" class="w-full h-64 object-contain rounded-lg mb-4">
                            <div class="flex gap-2">
                                <button onclick="processImage()" id="processBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium">
                                    ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­
                                </button>
                                <button onclick="clearImage()" class="px-4 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-medium">
                                    âœ•
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        ğŸ“¹ Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
                    </h2>

                    <div class="camera-container mb-4">
                        <video id="camera" autoplay playsinline class="w-full h-64 object-cover"></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="overlay"></div>
                        <div class="absolute top-4 right-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg text-sm">
                            Ø¶Ø¹ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="startCamera()" id="startCameraBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium">
                            ğŸ“¹ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                        </button>
                        <button onclick="captureFromCamera()" id="captureBtn" disabled class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                            ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
                        </button>
                        <button onclick="stopCamera()" id="stopCameraBtn" disabled class="bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                            â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                        </button>
                    </div>
                </div>
            </div>

            <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ -->
            <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden result-animation">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµØ­ÙŠØ­
                </h2>

                <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div id="resultsStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                </div>

                <!-- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h3>
                    <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª -->
                    </div>
                </div>

                <!-- ØµÙˆØ±Ø© Ø§Ù„ØªØµØ­ÙŠØ­ -->
                <div id="debugSection" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ØµÙˆØ±Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <img id="debugImage" class="debug-image mx-auto">
                        <p class="text-sm text-gray-600 text-center mt-2">Ø§Ù„Ø£Ø®Ø¶Ø±: ÙÙ‚Ø§Ø¹Ø§Øª Ù…ÙƒØªØ´ÙØ©ØŒ Ø§Ù„Ø£Ø­Ù…Ø±: ÙÙ‚Ø§Ø¹Ø§Øª ØºÙŠØ± Ù…Ù…Ù„ÙˆØ¡Ø©</p>
                    </div>
                </div>

                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
                <div id="additionalInfo" class="bg-gray-50 rounded-lg p-4 hidden">
                    <h3 class="font-semibold text-gray-800 mb-3">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h3>
                    <div id="analysisInfo" class="text-sm text-gray-600 space-y-1">
                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ -->
                    </div>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="flex flex-wrap gap-3 justify-center mt-6">
                    <button onclick="downloadResults()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                        ğŸ“„ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                    <button onclick="resetTest()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                        ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    </button>
                    <button onclick="shareResults()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                        ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </div>
            </div>

            <!-- Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        ğŸ“š Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                    </h2>
                    <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                        Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
                    </button>
                </div>

                <div id="testHistory" class="space-y-3 max-h-64 overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
                    </div>
                </div>
            </div>
        </main>

        <!-- ØªØ°ÙŠÙŠÙ„ Ø§Ù„ØµÙØ­Ø© -->
        <footer class="text-center mt-12 text-gray-600">
            <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Flask + OpenCV + Render.com</p>
            <p class="text-sm mt-2">ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø¢Ù„ÙŠ</p>
        </footer>
    </div>

    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let currentStream = null;
        let testHistory = JSON.parse(localStorage.getItem('testHistory') || '[]');
        const API_BASE = window.location.origin;

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            loadTestHistory();
            setupEventListeners();
        });

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
        function setupEventListeners() {
            // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
            document.getElementById('imageUpload').addEventListener('change', handleFileUpload);
            
            // Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleFileDrop);
            
            // Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            document.getElementById('autoProcess').addEventListener('change', function() {
                if (this.checked && document.getElementById('imagePreviewSection').style.display !== 'none') {
                    processImage();
                }
            });
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                previewImage(file);
            }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#10b981';
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#d1d5db';
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                previewImage(file);
            }
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
        function previewImage(file) {
            if (file.size > 10 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewSection').classList.remove('hidden');
                
                if (document.getElementById('autoProcess').checked) {
                    processImage();
                }
            };
            reader.readAsDataURL(file);
        }

        // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø©
        function clearImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreviewSection').classList.add('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                document.getElementById('serverStatus').classList.remove('hidden');
                document.getElementById('statusIcon').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-green-500 text-white';
                document.getElementById('statusIcon').innerHTML = 'âœ“';
                document.getElementById('statusText').textContent = 'Ø§Ù„Ø®Ø§Ø¯Ù… ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ';
                document.getElementById('statusDetails').textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${data.answer_key_count}`;
                document.getElementById('statusTime').textContent = new Date().toLocaleTimeString('ar-SA');
                
            } catch (error) {
                document.getElementById('serverStatus').classList.remove('hidden');
                document.getElementById('statusIcon').className = 'w-8 h-8 rounded-full flex items-center justify-center bg-red-500 text-white';
                document.getElementById('statusIcon').innerHTML = 'âœ•';
                document.getElementById('statusText').textContent = 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
                document.getElementById('statusDetails').textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
                document.getElementById('statusTime').textContent = new Date().toLocaleTimeString('ar-SA');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
        async function updateAnswerKey() {
            const answersText = document.getElementById('correctAnswers').value;
            const answers = answersText.split(',').map(a => a.trim().toUpperCase());
            
            try {
                const response = await fetch(`${API_BASE}/api/answer_key`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers: answers })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    testConnection(); // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø§Ø¯Ù…
                } else {
                    showNotification('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        async function processImage() {
            const fileInput = document.getElementById('imageUpload');
            const processBtn = document.getElementById('processBtn');
            
            if (!fileInput.files[0]) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }

            // Ø¹Ø±Ø¶ ØªØ­Ù…ÙŠÙ„
            processBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
            processBtn.disabled = true;

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('num_questions', document.getElementById('numQuestions').value);
            formData.append('options_per_question', document.getElementById('optionsPerQuestion').value);
            formData.append('debug', document.getElementById('debugMode').checked);

            try {
                const response = await fetch(`${API_BASE}/api/correct`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                    saveToHistory(data);
                    showNotification('ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„ÙˆØ±Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    showNotification('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ' + data.error, 'error');
                }
            } catch (error) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            } finally {
                processBtn.innerHTML = 'ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­';
                processBtn.disabled = false;
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        function displayResults(data) {
            // Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            document.getElementById('resultsSection').classList.remove('hidden');

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            const statsHtml = `
                <div class="bg-green-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-green-600">${data.correct_count}</div>
                    <div class="text-sm text-green-800">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div>
                </div>
                <div class="bg-red-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-red-600">${data.wrong_count}</div>
                    <div class="text-sm text-red-800">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-blue-600">${data.percentage}%</div>
                    <div class="text-sm text-blue-800">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">${data.bubbles_detected || 0}</div>
                    <div class="text-sm text-purple-800">ÙÙ‚Ø§Ø¹Ø§Øª Ù…ÙƒØªØ´ÙØ©</div>
                </div>
            `;
            document.getElementById('resultsStats').innerHTML = statsHtml;

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            const answersGrid = document.getElementById('answersGrid');
            answersGrid.innerHTML = '';
            
            data.answers.forEach((answer, index) => {
                const correctAnswer = data.answers.length > index ? data.answers[index] : '?';
                const isCorrect = answer === correctAnswer && answer !== 'ÙØ±Ø§Øº';
                const isEmpty = answer === 'ÙØ±Ø§Øº';
                
                let bgClass = 'wrong-answer';
                if (isCorrect) bgClass = 'correct-answer';
                if (isEmpty) bgClass = 'empty-answer';
                
                const answerDiv = document.createElement('div');
                answerDiv.className = `p-3 rounded-lg text-white text-center font-medium ${bgClass}`;
                answerDiv.innerHTML = `
                    <div class="text-sm">Ø³${index + 1}</div>
                    <div class="text-lg">${answer}</div>
                    <div class="text-xs">${isCorrect ? 'âœ“' : isEmpty ? 'âˆ…' : 'âœ—'}</div>
                `;
                answersGrid.appendChild(answerDiv);
            });

            // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„ØªØµØ­ÙŠØ­ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
            if (data.debug_image) {
                document.getElementById('debugSection').classList.remove('hidden');
                document.getElementById('debugImage').src = data.debug_image;
            } else {
                document.getElementById('debugSection').classList.add('hidden');
            }

            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            if (data.bubbles_detected !== undefined || data.perspective_corrected !== undefined) {
                document.getElementById('additionalInfo').classList.remove('hidden');
                let infoHtml = '';
                if (data.bubbles_detected !== undefined) {
                    infoHtml += `<div>ğŸ” Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©: ${data.bubbles_detected}</div>`;
                }
                if (data.perspective_corrected !== undefined) {
                    infoHtml += `<div>ğŸ“ ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù†Ø¸ÙˆØ±: ${data.perspective_corrected ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</div>`;
                }
                document.getElementById('analysisInfo').innerHTML = infoHtml;
            }
        }

        // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                
                const video = document.getElementById('camera');
                video.srcObject = currentStream;
                
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = false;
                
            } catch (error) {
                showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§', 'error');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            document.getElementById('startCameraBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('stopCameraBtn').disabled = true;
        }

        function captureFromCamera() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù„Ù
            canvas.toBlob(function(blob) {
                const file = new File([blob], 'camera_capture.jpg', { type: 'image/jpeg' });
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù
                const fileInput = document.getElementById('imageUpload');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
                previewImage(file);
                
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                stopCamera();
            }, 'image/jpeg', 0.8);
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¬Ù„
        function saveToHistory(data) {
            const testRecord = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('ar-SA'),
                correct_count: data.correct_count,
                wrong_count: data.wrong_count,
                percentage: data.percentage,
                total_questions: data.total_questions
            };
            
            testHistory.unshift(testRecord);
            if (testHistory.length > 10) {
                testHistory = testHistory.slice(0, 10);
            }
            
            localStorage.setItem('testHistory', JSON.stringify(testHistory));
            loadTestHistory();
        }

        function loadTestHistory() {
            const historyContainer = document.getElementById('testHistory');
            
            if (testHistory.length === 0) {
                historyContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
                return;
            }
            
            historyContainer.innerHTML = testHistory.map(record => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <div class="font-semibold text-gray-800">Ø§Ø®ØªØ¨Ø§Ø± ${record.id.toString().slice(-4)}</div>
                        <div class="text-sm text-gray-600">${record.timestamp}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-blue-600">${record.percentage}%</div>
                        <div class="text-sm text-gray-600">${record.correct_count}/${record.total_questions}</div>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªØŸ')) {
                testHistory = [];
                localStorage.removeItem('testHistory');
                loadTestHistory();
                showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'success');
            }
        }

        // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg text-white font-medium z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                'bg-blue-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -100%)';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function downloadResults() {
            const results = document.getElementById('resultsSection').innerText;
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ù†ØªÙŠØ¬Ø©_Ø§Ù„ØªØµØ­ÙŠØ­_${new Date().toLocaleDateString('ar-SA')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareResults() {
            if (navigator.share) {
                navigator.share({
                    title: 'Ù†ØªÙŠØ¬Ø© ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
                    text: `ØªÙ… ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø³Ø¨Ø© ${document.querySelector('#resultsStats .bg-blue-100 .text-3xl').textContent} Ù†Ø¬Ø§Ø­`,
                    url: window.location.href
                });
            } else {
                showNotification('Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØºÙŠØ± Ù…ØªØ§Ø­Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­', 'info');
            }
        }

        function resetTest() {
            clearImage();
            document.getElementById('resultsSection').classList.add('hidden');
            showNotification('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯', 'info');
        }
    </script>
</body>
</html>
