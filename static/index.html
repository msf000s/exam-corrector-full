<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        .camera-container {
            position: relative;
            max-width: 100%;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            height: 60vh;
        }
        .overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f97316;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            width: 90%;
            height: 90%;
            pointer-events: none;
            border-radius: 8px;
            z-index: 10;
        }
        .countdown-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            color: white;
            font-weight: bold;
            text-shadow: 0 0 15px rgba(0,0,0,0.7);
            opacity: 0;
            animation: fadeInOut 1s infinite;
            z-index: 15;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .result-animation { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
        .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .app-section {
            display: none;
        }
        .app-section.active {
            display: block;
        }
        .nav-link.active {
            background-color: #4f46e5;
            color: white;
        }
        /* Styles for report question analysis colors */
        .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } /* Light red (High Difficulty) */
        .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } /* Light orange (Medium Difficulty) */
        .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } /* Light green (Low Difficulty) */
        .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } /* Lighter green (No Errors) */

        /* Print-specific styles */
        @media print {
            body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
            button, input, select, aside, #menu-button, #printReportBtn { display: none !important; } /* Hide print button in print view */
            main { margin: 0 !important; padding: 0 !important; }
            .app-section { display: none !important; } /* Hide all sections */
            #printable-report-content { display: block !important; } /* Show only print content */
            .bg-white { box-shadow: none !important; border: 1px solid #ccc; }
            .text-xs { font-size: 0.7rem !important; }
            .text-sm { font-size: 0.8rem !important; }
            .text-lg { font-size: 1rem !important; }
            .text-xl { font-size: 1.1rem !important; }
            .text-2xl { font-size: 1.2rem !important; }
            .font-bold { font-weight: bold !important; }
            .p-1 { padding: 0.25rem !important; }
            .p-2 { padding: 0.5rem !important; }
            .p-3 { padding: 0.75rem !important; }
            .mb-1 { margin-bottom: 0.25rem !important; }
            .mb-2 { margin-bottom: 0.5rem !important; }
            .mb-4 { margin-bottom: 1rem !important; }
            .mt-4 { margin-top: 1rem !important; }
            .mt-6 { margin-top: 1.5rem !important; }
            .gap-4 { gap: 1rem !important; }
            .grid { display: grid !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
            .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
            .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)) !important; }
            .text-center { text-align: center !important; }
            .text-right { text-align: right !important; }
            .border { border-width: 1px !important; }
            .border-b { border-bottom-width: 1px !important; }
            .border-b-2 { border-bottom-width: 2px !important; }
            .border-black { border-color: black !important; }
            .border-gray-300 { border-color: #d1d5db !important; }
            .rounded-lg { border-radius: 0.5rem !important; }
            .w-full { width: 100% !important; }
            .mx-auto { margin-left: auto !important; margin-right: auto !important; }
            table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto !important;}
            tr { page-break-inside: avoid !important; page-break-after: auto !important; }
            thead { display: table-header-group !important; } /* Repeat header on each page */
            td, th { border: 1px solid #ddd !important; padding: 4px !important; text-align: center !important; font-size: 0.75rem !important; } /* Reduced padding/font */
            th { background-color: #f2f2f2 !important; font-weight: bold !important;}
            tr:nth-child(even){background-color: #f9f9f9 !important;}
            img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important;}
            .page-break { page-break-before: always !important; }
            /* Ensure colored backgrounds print */
            .bg-blue-100 { background-color: #DBEAFE !important; }
            .bg-green-100 { background-color: #DCFCE7 !important; }
            .bg-red-100 { background-color: #FEE2E2 !important; }
            .bg-gray-50 { background-color: #F9FAFB !important; }
            .bg-gray-100 { background-color: #F3F4F6 !important; }
            .bg-yellow-100 { background-color: #FEF3C7 !important; }
            .bg-orange-100 { background-color: #FFEDD5 !important; }

            /* Specific report styles */
            #printable-report-content .text-red-700 { color: #b91c1c !important; }
            #printable-report-content .text-green-700 { color: #15803d !important; }
            #printable-report-content .text-red-600 { color: #dc2626 !important; }
            #printable-report-content .text-green-600 { color: #16a34a !important; }
            #printable-report-content .text-blue-600 { color: #2563eb !important; }
            #printable-report-content .font-semibold { font-weight: 600 !important; }
            #printable-report-content .font-bold { font-weight: 700 !important; }
            #printable-report-content .pr-2 { padding-right: 0 !important; }
            #printable-report-content .question-analysis-table td,
            #printable-report-content .question-analysis-table th { font-size: 0.7rem !important; padding: 3px !important; } /* Smaller font for analysis table */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <div class="flex flex-col md:flex-row">
        <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 min-h-screen fixed md:relative inset-y-0 right-0 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <h1 class="text-2xl font-bold text-center mb-8">Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙƒÙŠ</h1>
            <nav class="flex flex-col gap-2">
                <a href="#dashboard" class="nav-link active p-3 rounded-lg hover:bg-gray-700">ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
                <a href="#answer-key" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ”‘ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</a>
                <a href="#students" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ‘¥ Ø§Ù„Ø·Ù„Ø§Ø¨</a>
                <a href="#correction" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ“· Ø§Ù„ØªØµØ­ÙŠØ­</a>
                <a href="#history" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ“š Ø§Ù„Ø³Ø¬Ù„Ø§Øª</a>
                <a href="#reports" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ–¨ï¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
                <a href="#stats" class="nav-link p-3 rounded-lg hover:bg-gray-700">ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</a>
                <a href="#settings" class="nav-link p-3 rounded-lg hover:bg-gray-700">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8">
            <button id="menu-button" class="md:hidden fixed top-4 right-4 z-20 p-2 bg-gray-800 text-white rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            
            <section id="dashboard" class="app-section active">
                <header class="mb-10">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3 text-center">Ø£Ø·Ù„Ù‚ Ø§Ù„Ø¹Ù†Ø§Ù† Ù„Ù‚ÙˆØ© Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙÙˆØ±ÙŠ</h1>
                    <p class="text-lg md:text-xl text-center max-w-3xl mx-auto text-gray-600">"Ø§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙƒÙŠ" Ù‡Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø°ÙŠ ÙŠØ­ÙˆÙ„ Ù…Ù‡Ù…Ø© ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ù‡Ù‚Ø© Ø¥Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ© Ø³Ø±ÙŠØ¹Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…Ù…ØªØ¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.</p>
                </header>

                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b pb-4">Ø£Ø¨Ø±Ø² Ø§Ù„Ù…ÙŠØ²Ø§Øª</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="flex items-start gap-4">
                            <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full text-2xl">âš¡ï¸</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ØªØµØ­ÙŠØ­ Ø°ÙƒÙŠ ÙˆØ³Ø±ÙŠØ¹</h3>
                                <p class="text-gray-600">Ø­ÙˆÙ‘Ù„ ÙƒØ§Ù…ÙŠØ±Ø§ Ù‡Ø§ØªÙÙƒ Ø¥Ù„Ù‰ Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ ÙØ§Ø¦Ù‚ Ø§Ù„Ø³Ø±Ø¹Ø©. ÙŠÙ„ØªÙ‚Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙŠØ­Ù„Ù„Ù‡Ø§ ÙÙŠ Ø«ÙˆØ§Ù†Ù Ù…Ø¹Ø¯ÙˆØ¯Ø© Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-green-100 text-green-600 p-3 rounded-full text-2xl">ğŸ‘¥</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„ÙØµÙˆÙ„</h3>
                                <p class="text-gray-600">Ø§Ø³ØªÙˆØ±Ø¯ Ù‚ÙˆØ§Ø¦Ù… Ø·Ù„Ø§Ø¨Ùƒ Ù…Ù† Ù…Ù„ÙØ§Øª Excel Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ ÙˆØªØªØ¨Ø¹ Ø£Ø¯Ø§Ø¡Ù‡Ù…ØŒ ÙˆÙ‚Ù… Ø¨ØªØµØ­ÙŠØ­ Ø£ÙˆØ±Ø§Ù‚Ù‡Ù… Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ Ø£Ùˆ Ø¬Ù…Ø§Ø¹ÙŠ.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full text-2xl">ğŸ”‘</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">Ù†Ù…Ø§Ø°Ø¬ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø±Ù†Ø©</h3>
                                <p class="text-gray-600">Ø£Ù†Ø´Ø¦ Ù†Ù…Ø§Ø°Ø¬ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙˆØ§Ø­ÙØ¸Ù‡Ø§. Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ù‚Ù… Ø¨ØªØµÙˆÙŠØ± Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ù„ÙˆÙ„ Ù„ÙŠÙˆÙØ± Ø¹Ù„ÙŠÙƒ Ø¹Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-red-100 text-red-600 p-3 rounded-full text-2xl">ğŸ“Š</div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">Ø³Ø¬Ù„Ø§Øª ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ù…ÙØµÙ„Ø©</h3>
                                <p class="text-gray-600">Ø§Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ù…Ù†Ø¸Ù…Ø©. Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ù…Ù„Ø®ØµØ§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ùˆ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ø¥Ù„Ù‰ Ù…Ù„ÙØ§Øª Excel Ù„ØªØ­Ù„ÙŠÙ„ Ø£Ø¹Ù…Ù‚.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <button id="toggle-instructions-btn" class="w-full text-right">
                        <div class="flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                ğŸ“– Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹
                            </h2>
                            <span id="instructions-arrow">â–¼</span>
                        </div>
                    </button>
                    <div id="instructions-content" class="collapsible-content mt-4 pt-4 border-t">
                        <ol class="list-decimal list-inside space-y-4 text-gray-700">
                            <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… <a href="#answer-key" class="quick-start-link text-blue-600 font-bold">"Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©"</a> ÙˆØ¬Ù‡Ù‘Ø² Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø§Ø¯Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®).</li>
                            <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… <a href="#students" class="quick-start-link text-blue-600 font-bold">"Ø§Ù„Ø·Ù„Ø§Ø¨"</a> ÙˆØ§Ø³ØªÙˆØ±Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø·Ù„Ø§Ø¨Ùƒ.</li>
                            <li>Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… <a href="#correction" class="quick-start-link text-blue-600 font-bold">"Ø§Ù„ØªØµØ­ÙŠØ­"</a> ÙˆØ§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯!</li>
                        </ol>
                    </div>
                </div>
            </section>
            
            <section id="answer-key" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h2>
                    
                    <div class="mb-4">
                        <label for="answerKeyModel" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¬Ø§Ø¨Ø©:</label>
                        <div class="flex gap-2">
                            <select id="answerKeyModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                            <button id="newModelBtn" title="Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-lg">â•</button>
                            <button id="renameModelBtn" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg">âœï¸</button>
                            <button id="deleteModelBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg">ğŸ—‘ï¸</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                            <input type="number" id="questionCount" min="1" max="100" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:</label>
                            <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="4">4 (A, B, C, D)</option>
                                <option value="5">5 (A, B, C, D, E)</option>
                            </select>
                        </div>
                        <div>
                            <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
                            <input type="text" id="subjectName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div id="examInfoSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                            <input type="text" id="examName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙØµÙ„ÙŠ Ø§Ù„Ø£ÙˆÙ„" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                            <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</h3>
                        <div class="flex flex-wrap gap-2">
                            <button id="manualEntryBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">âœï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹</button>
                            <button id="scanKeyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ“· ØªØµÙˆÙŠØ± Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ù„ÙˆÙ„</button>
                            <button id="printSheetBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ù†Ù…ÙˆØ°Ø¬ ÙØ§Ø±Øº</button>
                        </div>
                    </div>

                    <div id="answerSheet" class="hidden mt-6 pt-4 border-t">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹:</h3>
                        <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
                        <button id="saveAnswersBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
                    </div>
                </div>
            </section>
            
            <section id="students" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
                    </h2>
                    
                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ“Š Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                        <div class="flex-1">
                            <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv" 
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                        </div>
                    </div>

                    <div id="studentsListSection" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                            <div class="flex gap-2">
                                <button id="multiCorrectionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                    ğŸ”„ ØªØµØ­ÙŠØ­ Ù…ØªØ¹Ø¯Ø¯
                                </button>
                                <button id="clearStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
                                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
                                <div class="text-xs text-blue-800">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
                            </div>
                            <div class="bg-green-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
                                <div class="text-xs text-green-800">ØªÙ… ØªØµØ­ÙŠØ­Ù‡Ø§</div>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                                <div class="text-xs text-yellow-800">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
                                <div class="text-xs text-purple-800">Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„</div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…:</label>
                                    <input type="text" id="searchStudentName" placeholder="Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØµÙ„:</label>
                                    <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ØªØµØ­ÙŠØ­:</label>
                                    <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                        <option value="">Ø§Ù„ÙƒÙ„</option>
                                        <option value="corrected">ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­</option>
                                        <option value="pending">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                        <option value="absent">ØºØ§Ø¦Ø¨</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </section>

            <section id="correction" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“· ØªØµÙˆÙŠØ± Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h2>

                    <div id="correctionSelectedStudentDisplay" class="mb-4 bg-green-50 rounded-lg p-4 hidden">
                        <h3 class="text-lg font-semibold text-green-800 mb-2">ğŸ‘¤ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù„ØªØµØ­ÙŠØ­</h3>
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-semibold" id="correctionStudentNameDisplay">-</div>
                                <div class="text-sm text-gray-600">
                                    Ø§Ù„ÙØµÙ„: <span id="correctionStudentClassDisplay">-</span>
                                </div>
                            </div>
                            <button id="changeCorrectionStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-medium text-sm">ØªØºÙŠÙŠØ±</button>
                        </div>
                    </div>


                    <div class="mb-4">
                        <label for="correctionStudentSelect" class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨Ø§Ù‹ Ù„Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙØ±Ø¯ÙŠ (Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø§Ø¨):</label>
                        <select id="correctionStudentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
                        </select>
                    </div>

                    <div id="uploadOptions" class="flex flex-col sm:flex-row gap-4 my-6">
                        <button id="showCameraBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">ğŸ“¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                        <button id="showUploadBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">ğŸ“ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø©</button>
                    </div>
                    <div id="cameraSection" class="hidden">
                        <div class="camera-container mb-4">
                            <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
                            <canvas id="canvas" class="hidden"></canvas>
                            <div class="overlay"></div>
                            <div id="countdown" class="countdown-text"></div>
                        </div>
                        <div class="text-center">
                            <button id="stopCameraBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                        </div>
                    </div>
                    <div id="uploadSection" class="hidden">
                        <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                    </div>
                </div>

                <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">ğŸ”„ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</h2>
                    <div id="multiCorrectionSetup">
                        <div class="bg-purple-50 rounded-lg p-4 mb-6">
                            <p class="text-sm text-purple-700">Ø³ÙŠØªÙ… ØªØµØ­ÙŠØ­ Ø£ÙˆØ±Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹. ØµÙˆÙ‘Ø± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©.</p>
                        </div>
                        <div class="text-center">
                            <button id="startMultiBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg">
                                ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
                            </button>
                        </div>
                    </div>
                    <div id="multiCorrectionActive" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Ø§Ù„ØªÙ‚Ø¯Ù…</span>
                                <span id="progressText">0 Ù…Ù† 0</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                        </div>
                        <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
                                    <div class="text-sm text-blue-600">Ø§Ù„ÙØµÙ„: <span id="multiStudentClass">-</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-blue-600">ÙˆØ±Ù‚Ø© Ø±Ù‚Ù…</div>
                                    <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <button id="skipStudentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">â­ï¸ ØªØ®Ø·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
                            <button id="stopMultiBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">â¹ï¸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</button>
                        </div>
                    </div>
                    <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯</h3>
                        <div id="multiReportContent"></div>
                        <div class="mt-4 flex gap-4 justify-center">
                            <button id="exportMultiReportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                            <button id="resetMultiBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ”„ ØªØµØ­ÙŠØ­ Ø¬Ø¯ÙŠØ¯</button>
                        </div>
                    </div>
                </div>
                
                <div id="verificationContainer" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„ØªÙ‚Ø·Ø©</h3>
                            <img id="capturedImage" class="w-full rounded-lg shadow-md">
                        </div>
                        <div id="verificationSection">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ” ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
                            <div id="verificationGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto pr-2"></div>
                            <button id="confirmAnswersBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">âœ… ØªØ£ÙƒÙŠØ¯ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                        </div>
                    </div>
                </div>

                <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØµØ­ÙŠØ­</h3>
                    <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span id="resultStudentName">-</span></div>
                            <div><strong>Ø§Ù„ÙØµÙ„:</strong> <span id="resultStudentClass">-</span></div>
                            <div><strong>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> <span id="resultExamName">-</span></div>
                            <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="resultExamDate">-</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-green-600" id="correctCount">0</div>
                            <div class="text-sm">ØµØ­ÙŠØ­Ø©</div>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-red-600" id="wrongCount">0</div>
                            <div class="text-sm">Ø®Ø§Ø·Ø¦Ø©</div>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center">
                            <div class="text-3xl font-bold text-blue-600" id="scorePercentage">0%</div>
                            <div class="text-sm">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-purple-600" id="letterGrade">-</div>
                            <div class="text-sm">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</div>
                        </div>
                    </div>
                    <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="saveAndNewBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                        <button id="exportResultBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                    </div>
                </div>
            </section>
            
            <section id="history" class="app-section">
                <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ğŸ“š Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h3>
                        <div class="flex gap-2">
                            <button id="exportAllResultsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">ğŸ“Š ØªØµØ¯ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                            <button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                        </div>
                    </div>
                    <div id="historyFilters" class="bg-gray-50 rounded-lg p-4 mb-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="historyClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØµÙ„:</label>
                                <select id="historyClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="historyExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                                <select id="historyExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="filterHistoryBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">ğŸ” ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±</button>
                            </div>
                        </div>
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                </div>

                <div id="detailedHistorySection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">ğŸ“‹ Ø³Ø¬Ù„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…ÙØµÙ„)</h3>
                        <div class="flex gap-2">
                            <button id="exportDetailedLogBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-medium text-sm">ğŸ“„ ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (Excel)</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">ÙŠØ­ØªÙˆÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø© ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
                </div>
            </section>

            <section id="reports" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ–¨ï¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØµÙ„</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="reportClassFilter" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
                                    <select id="reportClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div>
                                    <label for="reportExamFilter" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø®ØªØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                                    <select id="reportExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                                </div>
                                <div class="self-end">
                                    <button id="generateReportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ“Š Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="report-container" class="mt-6"></div>
                </div>
            </section>
            
            <section id="stats" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="statsClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ÙØµÙ„:</label>
                                <select id="statsClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div>
                                <label for="statsExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
                                <select id="statsExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
                            </div>
                            <div class="self-end">
                                <button id="updateStatsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                            </div>
                        </div>
                    </div>
                    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h3>
                            <div id="summary-stats" class="grid grid-cols-2 gap-4"></div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</h3>
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg md:col-span-2 relative h-64">
                            <h3 class="font-semibold text-lg text-gray-800 mb-2">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</h3>
                            <canvas id="class-performance-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section id="settings" class="app-section">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                    <div class="space-y-6">

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="setting-admin" type="text" placeholder="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-school" type="text" placeholder="Ø§Ù„Ù…Ø¯Ø±Ø³Ø©" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-teacher" type="text" placeholder="Ø§Ù„Ù…Ø¹Ù„Ù…" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-director" type="text" placeholder="Ø§Ù„Ù…Ø¯ÙŠØ±" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-year" type="text" placeholder="Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input id="setting-semester" type="text" placeholder="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <button id="saveSettingsBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</button>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-800 mb-4">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                            <div class="flex flex-wrap gap-4">
                                <button id="backupBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ“¥ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                <div>
                                    <label for="restoreFile" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm cursor-pointer">ğŸ“¤ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</label>
                                    <input type="file" id="restoreFile" class="hidden" accept=".json">
                                </div>
                            </div>
                        </div>

                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <h3 class="font-semibold text-lg text-red-800 mb-2">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
                            <p class="text-sm text-red-700 mb-4">Ø³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ù„Ù‰ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŒ Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ø·Ù„Ø§Ø¨ØŒ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ØŒ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª.</p>
                            <button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
                        </div>
                    </div>
                </div>
            </section>
            <div id="printable-report-content" class="hidden print:block"></div>

        </main>
    </div>

    <script>
        // Global state variables
        let correctAnswers = [];
        let studentAnswers = [];
        let stream = null;
        let currentStudent = null;
        let autoCaptureTimer = null;
        let isScanningForKey = false;
        
        // Data loaded from Server/localStorage
        let settings = {};
        let studentsList = [];
        let resultsHistory = [];
        let detailedAnswersLog = [];
        let answerKeyModels = {};
        
        // Multi-correction state
        let isMultipleCorrectionMode = false;
        let multiCorrectionQueue = [];
        let currentMultiIndex = 0;
        let multiCorrectionResults = [];

        // Chart instances
        let gradeChart = null;
        let classChart = null;

        // === Safe localStorage Parsing ===
        function getFromStorage(key, defaultValue) {
            try {
                const storedValue = localStorage.getItem(key);
                if (storedValue === null || storedValue === undefined) return defaultValue;
                if (storedValue.startsWith('{') || storedValue.startsWith('[')) {
                    try { return JSON.parse(storedValue); } catch { return defaultValue; }
                }
                console.warn(`Value for ${key} in localStorage is not valid JSON.`);
                localStorage.removeItem(key); 
                return defaultValue;
            } catch (e) {
                console.error(`Error parsing ${key} from localStorage:`, e);
                localStorage.removeItem(key); 
                return defaultValue;
            }
        }

        // === Navigation & UI Initialization ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('translate-x-full');
                overlay.classList.toggle('hidden');
            }
        }

        function showSection(sectionId) {
            console.log("Showing section:", sectionId);
            try {
                document.querySelectorAll('.app-section').forEach(section => {
                    section.classList.remove('active');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.add('active');
                } else {
                    console.error("Section not found:", sectionId);
                    document.getElementById('dashboard')?.classList.add('active'); 
                }

                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
                if(targetLink) targetLink.classList.add('active');
                
                // --- Section specific actions ---
                if (sectionId === 'correction') populateCorrectionStudentSelect();
                if (sectionId === 'reports') populateReportFilters();
                if (sectionId === 'stats') {
                    populateStatsFilters(); 
                    updateGlobalStats(); 
                }
                if (sectionId === 'students') displayStudentsList(); 
                if (sectionId === 'history') populateHistoryFilters(); 


                if (sectionId !== 'correction') document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
                
                if (window.innerWidth < 768) { 
                    toggleSidebar();
                }
                window.location.hash = sectionId; // Update hash for deep linking/refresh
            } catch(e) {
                console.error("Error in showSection:", e);
                document.querySelectorAll('.app-section').forEach(section => section.classList.remove('active'));
                document.getElementById('dashboard')?.classList.add('active');
                document.querySelector(`.nav-link[href="#dashboard"]`)?.classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const addSafeListenerById = (id, event, handler) => {
                    const element = document.getElementById(id);
                    if (element) { element.addEventListener(event, handler); } 
                    else { console.warn(`Element not found for ID: ${id}`); }
                };

                document.querySelectorAll('.nav-link, .quick-start-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
                        if (sectionId) showSection(sectionId);
                    });
                });
                
                addSafeListenerById('studentsList', 'click', (e) => {
                    if (e.target.classList.contains('select-student-btn')) {
                        const studentId = parseInt(e.target.dataset.id);
                        if(studentId) selectStudent(studentId);
                    }
                    if (e.target.classList.contains('absent-btn')) {
                        const studentId = parseInt(e.target.dataset.id);
                        if(studentId) markAsAbsent(studentId);
                    }
                });

                addSafeListenerById('menu-button', 'click', toggleSidebar);
                addSafeListenerById('sidebar-overlay', 'click', toggleSidebar);
                addSafeListenerById('toggle-instructions-btn', 'click', toggleInstructions);
                addSafeListenerById('studentsFileInput', 'change', (e) => { const file = e.target.files[0]; if (file) parseStudentsFile(file); });
                addSafeListenerById('imageInput', 'change', (e) => { const file = e.target.files[0]; if (file) handleImageFile(file); });
                addSafeListenerById('answerKeyModel', 'change', switchModel);
                addSafeListenerById('correctionStudentSelect', 'change', (e) => { if(e.target.value) { selectStudent(parseInt(e.target.value)); } else { selectDifferentStudent(); } });
                addSafeListenerById('subjectName', 'input', updateModelData);
                addSafeListenerById('examName', 'input', updateModelData);
                addSafeListenerById('examDate', 'change', updateModelData);
                addSafeListenerById('questionCount', 'change', showManualEntry); 
                addSafeListenerById('optionsCount', 'change', showManualEntry); 
                addSafeListenerById('multiCorrectionBtn', 'click', toggleMultipleCorrection);
                addSafeListenerById('clearStudentsBtn', 'click', clearStudentsList);
                addSafeListenerById('newModelBtn', 'click', () => manageModels('new'));
                addSafeListenerById('renameModelBtn', 'click', () => manageModels('rename'));
                addSafeListenerById('deleteModelBtn', 'click', () => manageModels('delete'));
                addSafeListenerById('manualEntryBtn', 'click', showManualEntry);
                addSafeListenerById('scanKeyBtn', 'click', scanAnswerKey);
                addSafeListenerById('printSheetBtn', 'click', printBlankSheet);
                addSafeListenerById('saveAnswersBtn', 'click', saveCorrectAnswers);
                addSafeListenerById('showCameraBtn', 'click', showCameraSection);
                addSafeListenerById('showUploadBtn', 'click', showUploadSection);
                addSafeListenerById('stopCameraBtn', 'click', stopCamera);
                addSafeListenerById('startMultiBtn', 'click', startMultipleCorrection);
                addSafeListenerById('skipStudentBtn', 'click', skipCurrentStudent);
                addSafeListenerById('stopMultiBtn', 'click', stopMultipleCorrection);
                addSafeListenerById('exportMultiReportBtn', 'click', exportMultiReport);
                addSafeListenerById('resetMultiBtn', 'click', resetMultiCorrection);
                addSafeListenerById('confirmAnswersBtn', 'click', confirmAnswers);
                addSafeListenerById('saveAndNewBtn', 'click', saveToHistory);
                addSafeListenerById('exportResultBtn', 'click', exportResults);
                addSafeListenerById('exportAllResultsBtn', 'click', exportAllResults);
                addSafeListenerById('clearHistoryBtn', 'click', clearHistory);
                addSafeListenerById('exportDetailedLogBtn', 'click', exportDetailedAnswersLog);
                addSafeListenerById('generateReportBtn', 'click', generateClassReport);
                addSafeListenerById('saveSettingsBtn', 'click', saveSettings);
                addSafeListenerById('backupBtn', 'click', backupData);
                addSafeListenerById('clearAllDataBtn', 'click', clearAllData);
                addSafeListenerById('restoreFile', 'change', restoreData);
                addSafeListenerById('searchStudentName', 'keyup', filterStudentsList);
                addSafeListenerById('filterClass', 'change', filterStudentsList);
                addSafeListenerById('filterStatus', 'change', filterStudentsList);
                addSafeListenerById('changeCorrectionStudentBtn', 'click', selectDifferentStudent);
                addSafeListenerById('filterHistoryBtn', 'click', updateHistoryDisplay);
                addSafeListenerById('updateStatsBtn', 'click', updateGlobalStats);

                const examDateInput = document.getElementById('examDate');
                if(examDateInput) examDateInput.valueAsDate = new Date();

                loadInitialUI();

            } catch(e) {
                console.error("Error during DOMContentLoaded setup:", e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
            }
        });


        // ----------------------------------------------------
        // === Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… (APIs) ===
        // ----------------------------------------------------
        
        async function fetchData(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                
                if (method === 'DELETE' && response.status === 200) {
                    return { success: true };
                }
                
                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error || `HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ' + error.message, 'error');
                return null;
            }
        }
        
        async function loadAllData() {
            const studentsData = await fetchData('/api/students');
            if (studentsData) {
                studentsList = studentsData.map(s => ({ 
                    ...s, 
                    id: Number(s.id),
                    result: s.latest_result_json ? JSON.parse(s.latest_result_json) : null, 
                    status: s.status || 'pending'
                }));
            } else {
                studentsList = [];
            }
            
            const keysData = await fetchData('/api/answerkeys');
            if (keysData) {
                answerKeyModels = {};
                keysData.forEach(k => {
                    answerKeyModels[k.name] = {
                        name: k.name,
                        subject: k.subject,
                        examName: k.exam_name,
                        examDate: k.exam_date,
                        answers: k.answers 
                    };
                });
            }
            
            const logData = await fetchData('/api/resultslog');
            if (logData) {
                // ÙŠØ¬Ø¨ ÙÙƒ ØªØ´ÙÙŠØ± answers_log_json Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
                resultsHistory = logData.map(l => ({ ...l, answers: JSON.parse(l.answers_log_json) }));
                detailedAnswersLog = resultsHistory;
            } else {
                resultsHistory = [];
                detailedAnswersLog = [];
            }
            
            settings = getFromStorage('appSettings', {}); 
        }

        async function updateStudentStatusAndResult(studentId, status, resultObject) {
            const response = await fetchData(`/api/students/${studentId}`, 'PUT', {
                status: status,
                latest_result_json: JSON.stringify(resultObject) // Ù†Ø±Ø³Ù„Ù‡Ø§ ÙƒÙ€ String
            });

            if (response && response.success) {
                const studentIndex = studentsList.findIndex(s => s.id === studentId);
                if (studentIndex !== -1) {
                    studentsList[studentIndex].status = status;
                    studentsList[studentIndex].result = resultObject;
                }
                return true;
            }
            return false;
        }

        async function saveAnswerKeyAPI(modelData) {
            const response = await fetchData('/api/answerkeys', 'POST', {
                name: modelData.name,
                answers: modelData.answers,
                subject: modelData.subject,
                exam_name: modelData.examName,
                exam_date: modelData.examDate,
            });

            if (response && response.success) {
                answerKeyModels[modelData.name] = modelData;
                return true;
            }
            return false;
        }

        async function saveResultLogAPI(logEntry) {
            // logEntry.answers Ù‡Ù†Ø§ Ù‡ÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
            const response = await fetchData('/api/resultslog', 'POST', {
                student_id: logEntry.student_id,
                student_name: logEntry.student_name,
                student_class: logEntry.student_class,
                exam_name: logEntry.exam_name,
                exam_date: logEntry.exam_date,
                score_summary: logEntry.score_summary,
                percentage: logEntry.percentage,
                grade: logEntry.grade,
                answers_log: logEntry.answers // ØªØ±Ø³Ù„ ÙƒÙ€ Array ÙˆÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ ÙÙŠ Python
            });

            if (response && response.success) {
                logEntry.id = response.id;
                resultsHistory.unshift(logEntry);
                detailedAnswersLog.unshift(logEntry);
                return true;
            }
            return false;
        }


        // === Functions remaining as placeholders (Implemented Below) ===
        
        function toggleInstructions() {
            const content = document.getElementById('instructions-content');
            const arrow = document.getElementById('instructions-arrow');
            if(!content || !arrow) return;
            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                content.style.maxHeight = null;
                arrow.textContent = 'â–¼';
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
                arrow.textContent = 'â–²';
            }
        }

        function dataURItoBlob(dataURI) {
            try {
                const byteString = atob(dataURI.split(',')[1]);
                const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                return new Blob([ab], {type: mimeString});
            } catch (e) {
                console.error("Error converting data URI to Blob:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.", "error");
                return null;
            }
        }

        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const capturedImage = document.getElementById('capturedImage');
                const verificationContainer = document.getElementById('verificationContainer');
                if(!capturedImage || !verificationContainer) return;

                capturedImage.src = e.target.result;
                verificationContainer.classList.remove('hidden');
                
                processAnswers(e.target.result);
            };
            reader.onerror = (e) => {
                console.error("FileReader error:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„ØµÙˆØ±Ø©.", "error");
            };
            if (typeof file === 'string') {
                reader.readAsDataURL(dataURItoBlob(file));
            } else if (file instanceof Blob) {
                reader.readAsDataURL(file);
            } else {
                console.error("Invalid file type passed to handleImageFile:", file);
                showNotification("Ù†ÙˆØ¹ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­.", "error");
            }
        }

        // === Student Management ===
        
        function parseStudentsFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const ws = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    if (!Array.isArray(jsonData) || jsonData.length < 2) throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ§Ù„Ø­.");
                    
                    const headers = jsonData[0].map(h => String(h || '').trim());
                    const nameIndex = headers.findIndex(h => h.includes('Ø§Ø³Ù…'));
                    const classIndex = headers.findIndex(h => h.includes('ÙØµÙ„'));
                    if (nameIndex === -1 || classIndex === -1) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ÙŠ 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨' Ùˆ 'Ø§Ù„ÙØµÙ„'");
                    
                    const existingStudents = new Set(studentsList.map(s => `${s.name}-${s.class}`));
                    const newStudentsPromises = jsonData.slice(1).map((row, i) => {
                        if (!Array.isArray(row)) return null; 
                        const name = String(row[nameIndex] || '').trim();
                        const className = String(row[classIndex] || '').trim();
                        if (name && className && !existingStudents.has(`${name}-${className}`)) {
                            return addStudentFromExcel(name, className); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© API Ø¬Ø¯ÙŠØ¯Ø©
                        }
                        return Promise.resolve(false);
                    });

                    Promise.all(newStudentsPromises).then(() => {
                        displayStudentsList();
                        showNotification('ØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø¯Ø¯.', 'info');
                    });
                } catch (error) {
                    console.error("Error parsing student file:", error);
                    showNotification(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayStudentsList() {
            const section = document.getElementById('studentsListSection');
            if(!section) return;
            if (studentsList.length > 0) {
                section.classList.remove('hidden');
                updateStudentsStats();
                updateClassFilter();
                filterStudentsList();
                populateCorrectionStudentSelect();
            } else {
                section.classList.add('hidden');
            }
        }


        function updateStudentsStats() {
            const total = studentsList.length;
            const corrected = studentsList.filter(s => s.status === 'corrected').length;
            const pending = studentsList.filter(s => s.status === 'pending').length;
            const absent = studentsList.filter(s => s.status === 'absent').length;

            document.getElementById('totalStudentsCount').textContent = total;
            document.getElementById('correctedCount').textContent = corrected;
            document.getElementById('pendingCount').textContent = pending + absent; // Pending includes absent for stats
            document.getElementById('uniqueClassesCount').textContent = [...new Set(studentsList.map(s => s.class))].length;
        }

        function updateClassFilter() {
            const filterClass = document.getElementById('filterClass');
            if(!filterClass) return;
            const uniqueClasses = [...new Set(studentsList.map(s => s.class))].sort();
            filterClass.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function filterStudentsList() {
            const searchTermInput = document.getElementById('searchStudentName');
            const classFilterSelect = document.getElementById('filterClass');
            const statusFilterSelect = document.getElementById('filterStatus');
            const listDiv = document.getElementById('studentsList');
            if (!searchTermInput || !classFilterSelect || !statusFilterSelect || !listDiv) return;

            const searchTerm = searchTermInput.value.toLowerCase();
            const classFilter = classFilterSelect.value;
            const statusFilter = statusFilterSelect.value;

            const filtered = studentsList.filter(student => 
                (!searchTerm || student.name.toLowerCase().includes(searchTerm)) &&
                (!classFilter || student.class === classFilter) &&
                (!statusFilter || student.status === statusFilter)
            );
            
            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
                return;
            }
            listDiv.innerHTML = filtered.map(student => {
                let statusHTML = '';
                let buttonHTML = '';
                const latestResult = student.result;

                switch(student.status) {
                    case 'corrected':
                        statusHTML = `<div class="text-xs text-green-600">Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${latestResult?.percentage || '-'} (${latestResult?.score || '-'})</div>`;
                        break;
                    case 'absent':
                        statusHTML = `<div class="text-xs text-gray-500">ØºØ§Ø¦Ø¨</div>`;
                        break;
                    default: // pending
                        statusHTML = `<div class="text-xs text-yellow-600">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>`;
                        if(!isMultipleCorrectionMode) {
                            buttonHTML = `
                                <button data-id="${student.id}" class="select-student-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Ø§Ø®ØªÙŠØ§Ø±</button>
                                <button data-id="${student.id}" class="absent-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">ØºÙŠØ§Ø¨</button>
                            `;
                        }
                        break;
                }

                return `
                <div class="flex items-center justify-between p-3 rounded-lg border ${student.status === 'corrected' ? 'bg-green-50' : (student.status === 'absent' ? 'bg-gray-200' : 'bg-gray-50')}">
                    <div>
                        <div class="font-semibold">${student.name}</div>
                        <div class="text-sm text-gray-600">Ø§Ù„ÙØµÙ„: ${student.class}</div>
                        ${statusHTML}
                    </div>
                    <div class="flex gap-2">
                        ${buttonHTML}
                    </div>
                </div>
                `}).join('');
        }

        function selectStudent(studentId) {
            currentStudent = studentsList.find(s => s.id === parseInt(studentId));
            const selectElement = document.getElementById('correctionStudentSelect');
            const displayContainer = document.getElementById('correctionSelectedStudentDisplay');
            const nameDisplay = document.getElementById('correctionStudentNameDisplay');
            const classDisplay = document.getElementById('correctionStudentClassDisplay');

            if (currentStudent && selectElement && displayContainer && nameDisplay && classDisplay) {
                selectElement.value = currentStudent.id;
                nameDisplay.textContent = currentStudent.name;
                classDisplay.textContent = currentStudent.class;
                displayContainer.classList.remove('hidden'); 
                showNotification(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${currentStudent.name}. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­.`, 'success');
            } else if (!currentStudent) {
                console.error("Student not found with ID:", studentId);
                selectDifferentStudent(); 
            }
        }
        
        async function markAsAbsent(studentId) {
            const idToMark = parseInt(studentId);
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                const success = await updateStudentStatusAndResult(idToMark, 'absent', null);
                if (success) {
                    showNotification(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒØºØ§Ø¦Ø¨.`, 'info');
                } else {
                    showNotification(`ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨.`, 'error');
                }
            }
        }


        function selectDifferentStudent() {
            currentStudent = null;
            const selectElement = document.getElementById('correctionStudentSelect');
            const displayContainer = document.getElementById('correctionSelectedStudentDisplay');
            if(selectElement) selectElement.value = '';
            if(displayContainer) displayContainer.classList.add('hidden');
        }
        
        function populateCorrectionStudentSelect() {
            const select = document.getElementById('correctionStudentSelect');
            if(!select) return;
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>';
            const pendingStudents = studentsList.filter(s => s.status === 'pending');
            pendingStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} - ${student.class}`;
                select.appendChild(option);
            });
            if (currentStudent) select.value = currentStudent.id;
        }

        // === Answer Key Models Management ===
        
        function updateModelsDropdown() {
            const select = document.getElementById('answerKeyModel');
            if(!select) return;
            const currentModelName = select.value;
            select.innerHTML = '';
            Object.keys(answerKeyModels).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            select.value = currentModelName && answerKeyModels[currentModelName] ? currentModelName : Object.keys(answerKeyModels)[0];
            switchModel();
        }

        function switchModel() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName]) return;
            const modelData = answerKeyModels[modelName];
            correctAnswers = modelData.answers || [];
            const qCountInput = document.getElementById('questionCount');
            if(qCountInput) qCountInput.value = correctAnswers.length || 10;
            const subjectInput = document.getElementById('subjectName');
            if(subjectInput) subjectInput.value = modelData.subject || '';
            const examNameInput = document.getElementById('examName');
            if(examNameInput) examNameInput.value = modelData.examName || '';
            const examDateInput = document.getElementById('examDate');
            if(examDateInput) examDateInput.value = modelData.examDate || new Date().toISOString().split('T')[0];
            document.getElementById('answerSheet')?.classList.add('hidden');
            showNotification(`ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ "${modelName}"`, 'info');
        }


        function manageModels(action) {
            const select = document.getElementById('answerKeyModel');
            if(!select) return;
            const currentName = select.value;
            let newName;

            switch(action) {
                case 'new':
                    newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ù†Ù…ÙˆØ°Ø¬ Ø¨):");
                    if (newName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = { name: newName, subject: "", examName: "", examDate: new Date().toISOString().split('T')[0], answers: [] };
                    } else if (newName) {
                        alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
                    }
                    break;
                case 'rename':
                    if (!currentName) return;
                    newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬:", currentName);
                    if (newName && newName !== currentName && !answerKeyModels[newName]) {
                        answerKeyModels[newName] = answerKeyModels[currentName];
                        delete answerKeyModels[currentName];
                    } else if (newName) {
                        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¨Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
                    }
                    break;
                case 'delete':
                    if (!currentName || Object.keys(answerKeyModels).length <= 1) {
                        alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                        return;
                    }
                    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù†Ù…ÙˆØ°Ø¬ "${currentName}"ØŸ`)) {
                        delete answerKeyModels[currentName];
                        // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù€ localStorage Ù‡Ù†Ø§ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ù† DB
                        // Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± DELETE ÙÙŠ app.py
                    }
                    break;
            }
            updateModelsDropdown();
        }

        function showManualEntry() {
            generateAnswerSheet();
        }

        function scanAnswerKey() {
            isScanningForKey = true;
            showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØµÙˆÙŠØ± ÙˆØ±Ù‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©.', 'info');
            showSection('correction');
            showCameraSection();
        }

        function generateAnswerSheet() {
            const questionCountInput = document.getElementById('questionCount');
            const optionsCountSelect = document.getElementById('optionsCount');
            const answersGrid = document.getElementById('answersGrid');
            const answerSheetDiv = document.getElementById('answerSheet');
            if(!questionCountInput || !optionsCountSelect || !answersGrid || !answerSheetDiv) return;


            const questionCount = parseInt(questionCountInput.value);
            const optionsCount = parseInt(optionsCountSelect.value);
            answersGrid.innerHTML = '';
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = modelName ? answerKeyModels[modelName] : {};
            const currentAnswers = modelData?.answers || [];

            if (isNaN(questionCount) || questionCount < 1) {
                console.warn("Invalid question count:", questionCountInput.value);
                answersGrid.innerHTML = '<p class="text-red-500">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£Ø³Ø¦Ù„Ø© ØµØ­ÙŠØ­.</p>';
                answerSheetDiv.classList.remove('hidden');
                return;
            }

            for (let i = 1; i <= questionCount; i++) {
                answersGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø§Ù„Ø³Ø¤Ø§Ù„ ${i}:</label>
                        <select id="answer${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            ${options.map(opt => `<option value="${opt}" ${opt === (currentAnswers[i-1] || 'A') ? 'selected' : ''}>${opt}</option>`).join('')}
                        </select>
                    </div>
                `;
            }
            answerSheetDiv.classList.remove('hidden');
        }


        async function saveCorrectAnswers() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName) return;
            const questionCountInput = document.getElementById('questionCount');
            const subjectInput = document.getElementById('subjectName');
            const examNameInput = document.getElementById('examName');
            const examDateInput = document.getElementById('examDate');
            const answerSheetDiv = document.getElementById('answerSheet');

            if(!questionCountInput || !subjectInput || !examNameInput || !examDateInput || !answerSheetDiv) return;


            const questionCount = parseInt(questionCountInput.value);
            if (isNaN(questionCount) || questionCount < 1) {
                showNotification("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­.", "error");
                return;
            }
            let currentAnswersLocal = [];
            for(let i=1; i<=questionCount; i++){
                const select = document.getElementById(`answer${i}`);
                if(select && select.value){
                    currentAnswersLocal.push(select.value);
                } else {
                    console.warn(`Answer for question ${i} not found or empty.`);
                    currentAnswersLocal.push('A');
                }
            }
            
            const success = await saveAnswerKeyAPI({
                name: modelName,
                answers: currentAnswersLocal,
                subject: subjectInput.value,
                examName: examNameInput.value,
                examDate: examDateInput.value
            });

            if (success) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ø§Ø¬Ø­
                answerKeyModels[modelName] = {
                    name: modelName,
                    subject: subjectInput.value,
                    examName: examNameInput.value,
                    examDate: examDateInput.value,
                    answers: currentAnswersLocal
                };
                correctAnswers = currentAnswersLocal; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†Ø´Ø·
                answerSheetDiv.classList.add('hidden');
                showNotification(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ù€ "${modelName}".`, 'success');
            }
        }
        
        function updateModelData() {
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName]) return;
            
            const subject = document.getElementById('subjectName')?.value;
            const examName = document.getElementById('examName')?.value;
            const examDate = document.getElementById('examDate')?.value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·ØŒ ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØªÙ… ÙÙŠ saveCorrectAnswers
            answerKeyModels[modelName].subject = subject;
            answerKeyModels[modelName].examName = examName;
            answerKeyModels[modelName].examDate = examDate;
        }

        // === Camera and Image Processing ===
        
        async function showCameraSection() {
            stopCamera(); 

            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', 
                        width: { ideal: 4096 },  
                        height: { ideal: 2160 },
                        advanced: [{ focusMode: "continuous" }, { zoom: 1.0 }] 
                    } 
                });

                const videoElement = document.getElementById('camera');
                if(videoElement) videoElement.srcObject = stream;
                
                document.getElementById('cameraSection')?.classList.remove('hidden');
                document.getElementById('uploadSection')?.classList.add('hidden');
                
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙˆØ±Ù‚Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ø¶Ø­. Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.', 'info');
                setTimeout(startAutoCapture, 1000); 

            } catch (error) {
                console.error("Camera access error:", error);
                showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.', 'error');
            }
        }

        function startAutoCapture() {
            const countdownEl = document.getElementById('countdown');
            if(!countdownEl) return;
            let count = 3;
            countdownEl.textContent = count;
            countdownEl.style.display = 'block';

            if(autoCaptureTimer) clearInterval(autoCaptureTimer);

            autoCaptureTimer = setInterval(() => {
                count--;
                if(countdownEl) countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(autoCaptureTimer);
                    if(countdownEl) countdownEl.style.display = 'none';
                    captureAndProcess();
                }
            }, 1000);
        }

        function stopCamera() {
            if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
            if(autoCaptureTimer) clearInterval(autoCaptureTimer);
            const countdownEl = document.getElementById('countdown');
            if(countdownEl) countdownEl.style.display = 'none';
            document.getElementById('cameraSection')?.classList.add('hidden');
            document.getElementById('capturedSection')?.classList.add('hidden');
        }

        function captureAndProcess() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            if(!video || !canvas || video.readyState !== 4) {
                console.warn("Video not ready for capture. Retrying in 1s.");
                if(stream) setTimeout(startAutoCapture, 1000); 
                return;
            }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            clearInterval(autoCaptureTimer);
            
            if (isScanningForKey) {
                stopCamera();
            }

            handleImageFile(canvas.toDataURL('image/jpeg'));
        }

        function showUploadSection() {
            stopCamera();
            document.getElementById('uploadSection')?.classList.remove('hidden');
            document.getElementById('cameraSection')?.classList.add('hidden');
        }
        
        async function processAnswers(imageDataUrl) {
            const modelName = document.getElementById('answerKeyModel')?.value;
            correctAnswers = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName].answers : [];

            if (correctAnswers.length === 0 && !isScanningForKey) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ø£ÙˆÙ„Ø§Ù‹.', 'error'); return;
            }
            if (!currentStudent && !isMultipleCorrectionMode && !isScanningForKey) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹.', 'error'); return;
            }
            
            document.getElementById('verificationContainer')?.classList.remove('hidden');
            
            showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ... (ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±)', 'info');

            try {
                const base64Image = imageDataUrl.split(',')[1];
                
                const payload = {
                    image_base64: base64Image,
                    num_questions: document.getElementById('questionCount')?.value || correctAnswers.length,
                    options_per_q: document.getElementById('optionsCount')?.value || 4,
                    correct_answers: isScanningForKey ? [] : correctAnswers
                };


                const response = await fetch('/api/correct', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (!data.success) throw new Error(data.error || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                
                if (isScanningForKey) {
                    isScanningForKey = false;
                    const scannedAnswers = data.answers;
                    const questionCount = parseInt(document.getElementById('questionCount')?.value || 0);
                    for (let i = 0; i < questionCount; i++) {
                        const select = document.getElementById(`answer${i + 1}`);
                        if (select && scannedAnswers[i]) {
                            select.value = scannedAnswers[i] === 'Blank' ? 'A' : scannedAnswers[i];
                        }
                    }
                    showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ø«Ù… Ø§Ù„Ø­ÙØ¸.', 'success');
                    showManualEntry();
                    showSection('answer-key');

                } else {
                    studentAnswers = data.answers;
                    showAnswerVerification();
                }
            } catch (err) {
                console.error("Error processing answers:", err);
                showNotification(`ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${err.message}`, 'error');
                resetForNewSheet();
            } 
        }

        // === Verification and Results ===
        
        function showAnswerVerification() {
            const verificationGrid = document.getElementById('verificationGrid');
            const optionsCountSelect = document.getElementById('optionsCount');
            if(!verificationGrid || !optionsCountSelect || !Array.isArray(correctAnswers)) {
                console.error("Cannot show verification: grid, select, or correctAnswers missing/invalid.");
                return;
            }
            if (correctAnswers.length === 0) {
                showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹.", "error");
                resetForNewSheet();
                return;
            }

            const optionsCount = parseInt(optionsCountSelect.value);
            const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
            verificationGrid.innerHTML = '';
            
            while (studentAnswers.length < correctAnswers.length) {
                studentAnswers.push('Blank');
            }

            for (let i = 0; i < correctAnswers.length; i++) {
                const answer = studentAnswers[i] || 'Blank';
                verificationGrid.innerHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ø³ ${i + 1}</label>
                        <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <option value="Blank" ${answer === 'Blank' ? 'selected' : ''}>ÙØ±Ø§Øº</option>
                            ${options.map(opt => `<option value="${opt}" ${opt === answer ? 'selected' : ''}>${opt}</option>`).join('')}
                            ${!options.includes(answer) && answer !== 'Blank' ? `<option value="${answer}" selected>${answer} (ØºØ±ÙŠØ¨)</option>` : ''}
                        </select>
                    </div>`;
            }
            document.getElementById('verificationSection')?.classList.remove('hidden');
        }


        function confirmAnswers() {
            studentAnswers = Array.from({ length: correctAnswers.length }, (_, i) => {
                const select = document.getElementById(`verify${i}`);
                return select ? select.value : 'Blank';
            });
            document.getElementById('verificationContainer')?.classList.add('hidden');
            displayResults();
        }

        function displayResults() {
            if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
                console.error("Cannot display results without correct answers.");
                return;
            }
            let correctCount = 0;
            const detailedResults = document.getElementById('detailedResults');
            if(!detailedResults) return;

            detailedResults.innerHTML = '';
            for (let i = 0; i < correctAnswers.length; i++) {
                const sAnswer = studentAnswers[i] !== undefined ? studentAnswers[i] : 'Blank';
                const displayAnswer = sAnswer === 'Blank' ? 'ÙØ±Ø§Øº' : sAnswer;
                const isCorrect = sAnswer === correctAnswers[i];
                if (isCorrect) correctCount++;
                detailedResults.innerHTML += `
                    <div class="p-3 rounded-lg text-white text-center font-medium ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                        <div class="text-sm">Ø³ ${i + 1}</div>
                        <div class="text-lg">${displayAnswer || 'âˆ…'}</div>
                        <div class="text-xs">${isCorrect ? 'âœ“' : `âœ— (${correctAnswers[i]})`}</div>
                    </div>`;
            }
            const wrongCount = correctAnswers.length - correctCount;
            const percentage = correctAnswers.length > 0 ? Math.round((correctCount / correctAnswers.length) * 100) : 0;
            
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = wrongCount;
            document.getElementById('scorePercentage').textContent = `${percentage}%`;
            document.getElementById('letterGrade').textContent = getLetterGrade(percentage);
            
            const studentForDisplay = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
            if (!studentForDisplay) {
                console.error("No student selected for displaying results.");
                return;
            }
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};

            document.getElementById('resultStudentName').textContent = studentForDisplay.name;
            document.getElementById('resultStudentClass').textContent = studentForDisplay.class;
            document.getElementById('resultExamName').textContent = modelData.examName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            document.getElementById('resultExamDate').textContent = modelData.examDate || '';
            document.getElementById('resultsSection')?.classList.remove('hidden');
        }

        function getLetterGrade(percentage) {
            if (percentage >= 90) return 'Ù…Ù…ØªØ§Ø²';
            if (percentage >= 80) return 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹';
            if (percentage >= 70) return 'Ø¬ÙŠØ¯';
            if (percentage >= 60) return 'Ù…Ù‚Ø¨ÙˆÙ„';
            return 'Ø¶Ø¹ÙŠÙ'; 
        }

        async function saveToHistory() {
            const studentForHistory = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
            if (!studentForHistory) {
                showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø§Ù„Ø¨ Ù…Ø­Ø¯Ø¯ Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©.", "error");
                return;
            }
            if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
                showNotification("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø¨Ø¯ÙˆÙ† Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­.", "error");
                return;
            }
            const correctCount = parseInt(document.getElementById('correctCount')?.textContent || '0');
            const totalQuestions = correctAnswers.length;
            const modelName = document.getElementById('answerKeyModel')?.value;
            const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};
            
            const result = {
                score: `${correctCount}/${totalQuestions}`,
                percentage: document.getElementById('scorePercentage')?.textContent || '0%',
                grade: document.getElementById('letterGrade')?.textContent || '-',
            };
            const finalStudentAnswers = Array.from({ length: totalQuestions }, (_, i) => studentAnswers[i] || 'Blank');
            
            const logEntry = {
                student_id: studentForHistory.id,
                student_name: studentForHistory.name,
                student_class: studentForHistory.class,
                exam_name: modelData.examName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                exam_date: modelData.examDate || new Date().toISOString().split('T')[0],
                score_summary: result.score,
                percentage: result.percentage,
                grade: result.grade,
                answers: finalStudentAnswers
            };

            const logSuccess = await saveResultLogAPI(logEntry);

            if (logSuccess) {
                await updateStudentStatusAndResult(studentForHistory.id, 'corrected', result);
                
                if (isMultipleCorrectionMode) {
                    handleMultiCorrectionNext(result);
                } else {
                    resetForNewSheet();
                }
                showNotification('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨!', 'success');
            } else {
                 showNotification('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', 'error');
            }
        }

        function resetForNewSheet() {
            document.getElementById('resultsSection')?.classList.add('hidden');
            document.getElementById('verificationContainer')?.classList.add('hidden');
            selectDifferentStudent();
            showNotification('ØªÙ… Ø§Ù„Ø­ÙØ¸! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªØµØ­ÙŠØ­ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©.', 'success');
            
            if (stream) {
                stopCamera();
                showCameraSection();
            } else {
                document.getElementById('uploadOptions')?.classList.remove('hidden');
            }
        }

        // ----------------------------------------------------
        // === History Management ===
        // ----------------------------------------------------

        function populateHistoryFilters() {
            const classFilter = document.getElementById('historyClassFilter');
            const examFilter = document.getElementById('historyExamFilter');
            if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.student_class))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.exam_name))].sort();

            classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const historySection = document.getElementById('historySection');
            const classFilter = document.getElementById('historyClassFilter')?.value;
            const examFilter = document.getElementById('historyExamFilter')?.value;
            const historyFiltersDiv = document.getElementById('historyFilters');


            if(!historyList || !historySection || !historyFiltersDiv) return;
            
            historyFiltersDiv.classList.toggle('hidden', resultsHistory.length === 0);

            const filteredHistory = resultsHistory.filter(r => 
                (!classFilter || r.student_class === classFilter) &&
                (!examFilter || r.exam_name === examFilter)
            );


            historySection.classList.toggle('hidden', resultsHistory.length === 0); 
            if (filteredHistory.length === 0 && resultsHistory.length > 0) { 
                historyList.innerHTML = '<p class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø­Ø¯Ø¯.</p>';
            } else if (filteredHistory.length === 0 && resultsHistory.length === 0){
                historyList.innerHTML = ''; 
            } else {
                historyList.innerHTML = filteredHistory.map(r => `
                    <div class="bg-gray-50 rounded-lg p-3 border-r-4 border-blue-500">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold">${r.student_name}</h4>
                                <p class="text-sm text-gray-600">${r.exam_name || 'Ø§Ø®ØªØ¨Ø§Ø± ØºÙŠØ± Ù…Ø³Ù…Ù‰'} - ${r.exam_date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}</p>
                            </div>
                            <div class="text-left">
                                <div class="text-lg font-bold text-blue-600">${r.percentage || '0%'}</div>
                                <div class="text-sm font-semibold text-gray-700">(${r.score_summary || '0/0'})</div>
                                <div class="text-xs text-gray-600">${r.grade || '-'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function exportResults() {
            const studentName = document.getElementById('resultStudentName')?.textContent;
            const percentage = document.getElementById('scorePercentage')?.textContent;
            if (!studentName || !percentage) return;
            const report = `Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}\nØ§Ù„Ù†Ø³Ø¨Ø©: ${percentage}`;
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `Ù†ØªÙŠØ¬Ø©_${studentName}.txt`; a.click(); URL.revokeObjectURL(url);
        }

        function exportAllResults() {
            const classFilter = document.getElementById('historyClassFilter')?.value;
            const examFilter = document.getElementById('historyExamFilter')?.value;
            const filteredHistory = resultsHistory.filter(r => 
                (!classFilter || r.student_class === classFilter) &&
                (!examFilter || r.exam_name === examFilter)
            );
            if (filteredHistory.length === 0) {
                showNotification("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.", "info");
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(filteredHistory);
                XLSX.utils.book_append_sheet(wb, ws, 'Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬');
                XLSX.writeFile(wb, 'Ø³Ø¬Ù„_Ø§Ù„Ù†ØªØ§Ø¦Ø¬_Ø§Ù„Ù…ÙÙ„ØªØ±.xlsx');
            } catch(e) {
                console.error("Error exporting filtered results:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.", "error");
            }
        }

        function exportDetailedAnswersLog() {
            const classFilter = document.getElementById('historyClassFilter')?.value;
            const examFilter = document.getElementById('historyExamFilter')?.value;
            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.student_class === classFilter) &&
                (!examFilter || log.exam_name === examFilter)
            );

            if (filteredLogs.length === 0) { 
                showNotification("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù…ÙØµÙ„ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ÙÙ„ØªØ± Ù„ØªØµØ¯ÙŠØ±Ù‡.", "info"); 
                return; 
            }
            try {
                const maxQuestions = Math.max(0, ...filteredLogs.map(log => log.answers?.length || 0));
                const headers = ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„ÙØµÙ„', 'Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¯Ø±Ø¬Ø©'];
                for(let i=1; i<= maxQuestions; i++) { headers.push(`Ø³${i}`); }
                const data = filteredLogs.map(log => {
                    const row = {'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': log.student_name, 'Ø§Ù„ÙØµÙ„': log.student_class, 'Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±': log.exam_name, 'Ø§Ù„ØªØ§Ø±ÙŠØ®': log.exam_date, 'Ø§Ù„Ø¯Ø±Ø¬Ø©': log.score_summary };
                    (log.answers || []).forEach((ans, i) => { row[`Ø³${i+1}`] = ans; });
                    return row;
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data, {header: headers});
                XLSX.utils.book_append_sheet(wb, ws, 'Ø³Ø¬Ù„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨');
                XLSX.writeFile(wb, 'Ø³Ø¬Ù„_Ø¥Ø¬Ø§Ø¨Ø§Øª_Ø§Ù„Ø·Ù„Ø§Ø¨_Ø§Ù„Ù…ÙØµÙ„_Ø§Ù„Ù…ÙÙ„ØªØ±.xlsx');
            } catch(e) {
                console.error("Error exporting filtered detailed log:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.", "error");
            }
        }


        function clearHistory() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                resultsHistory = []; detailedAnswersLog = [];
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ API Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙƒÙ„ÙŠ
                updateHistoryDisplay();
                document.getElementById('detailedHistorySection')?.classList.add('hidden');
            }
        }

        // ----------------------------------------------------
        // === Multiple Correction Logic ===
        // ----------------------------------------------------

        function toggleMultipleCorrection() {
            const uncorrected = studentsList.filter(s => s.status === 'pending');
            if (uncorrected.length === 0) { showNotification('Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ØªÙ… ØªØµØ­ÙŠØ­ Ø£ÙˆØ±Ø§Ù‚Ù‡Ù…!', 'info'); return; }
            const multiSection = document.getElementById('multipleCorrectionSection');
            if(multiSection) multiSection.classList.toggle('hidden');
            selectDifferentStudent(); 
            showSection('correction');
        }

        function startMultipleCorrection() {
            multiCorrectionQueue = studentsList.filter(s => s.status === 'pending');
            if (multiCorrectionQueue.length === 0) { showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ±Ø§Ù‚ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØµØ­ÙŠØ­!', 'error'); return; }
            const modelName = document.getElementById('answerKeyModel')?.value;
            if (!modelName || !answerKeyModels[modelName] || answerKeyModels[modelName].answers.length === 0) { 
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹!', 'error'); 
                return; 
            }
            isMultipleCorrectionMode = true; currentMultiIndex = 0; multiCorrectionResults = [];
            document.getElementById('multiCorrectionSetup')?.classList.add('hidden');
            document.getElementById('multiCorrectionActive')?.classList.remove('hidden');
            showCurrentMultiStudent();
            showNotification(`Ø¨Ø¯Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ù„Ù€ ${multiCorrectionQueue.length} Ø·Ø§Ù„Ø¨.`, 'success');
        }

        function showCurrentMultiStudent() {
            if(currentMultiIndex >= multiCorrectionQueue.length) {
                completeMultipleCorrection();
                return;
            }
            const student = multiCorrectionQueue[currentMultiIndex];
            document.getElementById('multiStudentName').textContent = student.name;
            document.getElementById('multiStudentClass').textContent = student.class;
            document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
            updateMultiCorrectionProgress();
            
            if(!stream) {
                showCameraSection();
            } else {
                startAutoCapture(); 
            }
        }

        function updateMultiCorrectionProgress() {
            if(multiCorrectionQueue.length === 0) return;
            const progress = ((currentMultiIndex) / multiCorrectionQueue.length) * 100;
            document.getElementById('progressText').textContent = `${currentMultiIndex} Ù…Ù† ${multiCorrectionQueue.length}`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        function handleMultiCorrectionNext(result) {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'completed', result });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent(); 
                resetForNewSheet(); 
                showNotification(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©. Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„ØªØ§Ù„ÙŠ: ${multiCorrectionQueue[currentMultiIndex].name}`, 'info');
            } else {
                completeMultipleCorrection();
            }
        }


        function skipCurrentStudent() {
            multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'skipped', result: null });
            currentMultiIndex++;
            if (currentMultiIndex < multiCorrectionQueue.length) {
                showCurrentMultiStudent();
                if(!stream) showCameraSection(); else startAutoCapture();
            } else {
                completeMultipleCorrection();
            }
        }


        function stopMultipleCorrection() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ØŸ')) {
                completeMultipleCorrection();
            }
        }

        function completeMultipleCorrection() {
            isMultipleCorrectionMode = false;
            stopCamera(); 
            document.getElementById('multiCorrectionActive')?.classList.add('hidden');
            if (multiCorrectionResults.length > 0) {
                generateMultiCorrectionReport();
            } else {
                resetMultiCorrection();
            }
            showNotification('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯.', 'success');
        }

        function generateMultiCorrectionReport() {
            const corrected = multiCorrectionResults.filter(r => r.status === 'completed').length;
            const skipped = multiCorrectionResults.filter(r => r.status === 'skipped').length;
            const avgScore = corrected > 0 ? Math.round(multiCorrectionResults.filter(r=>r.result).reduce((sum, r) => sum + (parseInt(r.result.percentage) || 0), 0) / corrected) : 0;
            const reportContentDiv = document.getElementById('multiReportContent');
            const reportSectionDiv = document.getElementById('multiCorrectionReport');
            if(!reportContentDiv || !reportSectionDiv) return;

            reportContentDiv.innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div class="bg-green-100 p-2 rounded-lg"><div class="font-bold text-lg">${corrected}</div><div class="text-xs">ØªÙ… ØªØµØ­ÙŠØ­Ù‡Ø§</div></div>
                    <div class="bg-yellow-100 p-2 rounded-lg"><div class="font-bold text-lg">${skipped}</div><div class="text-xs">ØªÙ… ØªØ®Ø·ÙŠÙ‡Ø§</div></div>
                    <div class="bg-blue-100 p-2 rounded-lg"><div class="font-bold text-lg">${avgScore}%</div><div class="text-xs">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div></div>
                </div>
            `;
            reportSectionDiv.classList.remove('hidden');
        }

        function exportMultiReport() {
            if(multiCorrectionResults.length === 0) return;
            try {
                const reportData = multiCorrectionResults.map(r => ({
                    'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': r.student.name, 
                    'Ø§Ù„ÙØµÙ„': r.student.class, 
                    'Ø§Ù„Ø­Ø§Ù„Ø©': r.status === 'completed' ? 'ØªÙ… Ø§Ù„ØªØµØ­ÙŠØ­' : 'ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ', 
                    'Ø§Ù„Ø¯Ø±Ø¬Ø©': r.result ? r.result.score : '-',
                    'Ø§Ù„Ù†Ø³Ø¨Ø©': r.result ? r.result.percentage : '-',
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(reportData);
                XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØµØ­ÙŠØ­');
                XLSX.writeFile(wb, 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„ØªØµØ­ÙŠØ­_Ø§Ù„Ù…ØªØ¹Ø¯Ø¯.xlsx');
            } catch(e) {
                console.error("Error exporting multi-report:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±.", "error");
            }
        }


        function resetMultiCorrection() {
            document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
            document.getElementById('multiCorrectionSetup')?.classList.remove('hidden');
            document.getElementById('multiCorrectionReport')?.classList.add('hidden');
        }

        // ----------------------------------------------------
        // === Reports Section ===
        // ----------------------------------------------------

        function populateReportFilters() {
            const classFilter = document.getElementById('reportClassFilter');
            const examFilter = document.getElementById('reportExamFilter');
            if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.student_class))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.exam_name))].sort();

            classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function generateClassReport() {
            const classFilter = document.getElementById('reportClassFilter')?.value;
            const examFilter = document.getElementById('reportExamFilter')?.value;
            const container = document.getElementById('report-container');
            if (container === null || classFilter === undefined || examFilter === undefined) return;

            const filteredLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.student_class === classFilter) &&
                (!examFilter || log.exam_name === examFilter)
            );
            
            const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
            const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


            if (filteredLogs.length === 0 && absentStudents.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ÙÙ„Ø§ØªØ± Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±.</p>`;
                return;
            }
            
            const firstLog = filteredLogs[0]; 
            let reportCorrectAnswers = [];
            let questionAnalysisHTML = '<p class="text-sm text-gray-500">Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>';
            let hardestQuestionNum = '-';
            let easiestQuestionNum = '-';
            let totalQuestions = 0;
            
            if (firstLog) {
                const modelName = Object.keys(answerKeyModels).find(key => {
                    const model = answerKeyModels[key];
                    return model && (model.examName === firstLog.exam_name) && (model.answers && model.answers.length === (firstLog.answers?.length || 0));
                });
                reportCorrectAnswers = modelName ? (answerKeyModels[modelName].answers || []) : [];
                totalQuestions = reportCorrectAnswers.length; 

                if (reportCorrectAnswers.length > 0) {
                    const questionErrors = {};
                    for (let i = 0; i < reportCorrectAnswers.length; i++) {
                         questionErrors[i + 1] = { qNum: i + 1, errors: 0, corrects: 0, correct: reportCorrectAnswers[i] };
                    }
                    filteredLogs.forEach(log => {
                         (log.answers || []).forEach((studentAnswer, i) => {
                             if (i < reportCorrectAnswers.length) {
                                  if (studentAnswer === reportCorrectAnswers[i]) {
                                      questionErrors[i + 1].corrects++;
                                  } else {
                                      questionErrors[i + 1].errors++;
                                  }
                                  if(studentAnswer && studentAnswer !== 'Blank' && studentAnswer !== reportCorrectAnswers[i]){ 
                                      questionErrors[i + 1].choices = questionErrors[i + 1].choices || {};
                                      questionErrors[i + 1].choices[studentAnswer] = (questionErrors[i + 1].choices[studentAnswer] || 0) + 1;
                                  }
                              }
                         });
                    });
                    
                    const analysisArray = Object.values(questionErrors).sort((a, b) => a.qNum - b.qNum);
                    
                    if (analysisArray.length > 0) {
                        const sortedByError = [...analysisArray].sort((a, b) => b.errors - a.errors);
                        hardestQuestionNum = sortedByError.length > 0 ? sortedByError[0].qNum : '-';
                        easiestQuestionNum = sortedByError.length > 0 ? sortedByError[sortedByError.length - 1].qNum : '-';
                    }
                    
                    questionAnalysisHTML = `
                        <table class="w-full text-sm mt-4 border-collapse border border-gray-300 question-analysis-table">
                            <thead>
                                <tr class="bg-gray-100 border-b border-gray-300">
                                    <th class="p-1 border-l border-gray-300">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                                    <th class="p-1 border-l border-gray-300">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</th>
                                    <th class="p-1 border-l border-gray-300">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</th>
                                    <th class="p-1 border-l border-gray-300">Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©</th>
                                    <th class="p-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø§Ù„Ù†Ù…ÙˆØ°Ø¬)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${analysisArray.map(data => {
                                    let errorClass = 'q-errors-none';
                                    let difficultyText = 'Ø³Ù‡Ù„Ø© Ø¬Ø¯Ø§Ù‹';
                                    if(filteredLogs.length > 0) { 
                                        const errorRate = data.errors / filteredLogs.length;
                                        if (errorRate > 0.5) { errorClass = 'q-errors-high'; difficultyText = 'ØµØ¹Ø¨Ø©'; }
                                        else if (errorRate > 0.25) { errorClass = 'q-errors-medium'; difficultyText = 'Ù…ØªÙˆØ³Ø·Ø©'; }
                                        else if (errorRate > 0) { errorClass = 'q-errors-low'; difficultyText = 'Ø³Ù‡Ù„Ø©'; }
                                    }
                                    return `
                                    <tr class="border-b border-gray-200 ${errorClass}">
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${data.qNum}</td>
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${data.corrects}</td>
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${data.errors}</td>
                                        <td class="p-1 text-center font-bold border-l border-gray-300">${difficultyText}</td>
                                        <td class="p-1 text-center">${data.correct || '-'}</td>
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>`;
                }
            }


            const scores = filteredLogs.map(log => parseInt(log.percentage));
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0;
            const minScore = scores.length > 0 ? Math.min(...scores) : 0;
            const presentCount = filteredLogs.length;
            const absentCount = absentStudents.length;


            let reportHTML = `
                <div id="printable-report" class="bg-white p-6 rounded-lg shadow-md">
                    
                    <h4 class="text-lg font-bold mb-2">Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡</h4>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
                        <div class="bg-blue-100 p-3 rounded-lg"><div class="font-bold text-xl">${presentCount}</div><div class="text-xs">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
                        <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-xl">${absentCount}</div><div class="text-xs">Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨</div></div>
                        <div class="bg-orange-100 p-3 rounded-lg"><div class="font-bold text-xl">${totalQuestions}</div><div class="text-xs">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div></div>
                        <div class="bg-green-100 p-3 rounded-lg"><div class="font-bold text-xl">${avgScore}%</div><div class="text-xs">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ±</div></div>
                        <div class="bg-yellow-100 p-3 rounded-lg"><div class="font-bold text-xl">${maxScore}%</div><div class="text-xs">Ø£Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø©</div></div>
                        
                    </div>
                    
                    <h4 class="text-lg font-bold mt-6 mb-2">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <h5 class="font-semibold mb-1 text-red-700">Ø£ØµØ¹Ø¨ Ø³Ø¤Ø§Ù„</h5>
                            <p class="text-2xl font-bold text-red-600">Ø³ ${hardestQuestionNum}</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <h5 class="font-semibold mb-1 text-green-700">Ø£Ø³Ù‡Ù„ Ø³Ø¤Ø§Ù„</h5>
                            <p class="text-2xl font-bold text-green-600">Ø³ ${easiestQuestionNum}</p>
                        </div>
                    </div>
                    <div class="mb-6 border rounded p-2 bg-gray-50">
                        ${questionAnalysisHTML}
                    </div>

                    <div class="text-center">
                        <button id="printReportBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„</button>
                    </div>
                </div>
            `;
            container.innerHTML = reportHTML;
            
            const printBtn = document.getElementById('printReportBtn');
            if(printBtn) printBtn.addEventListener('click', printReport);
        }

        async function printReport() {
            const classFilter = document.getElementById('reportClassFilter')?.value;
            const examFilter = document.getElementById('reportExamFilter')?.value;
            if(classFilter === undefined || examFilter === undefined) return;
            const modelNameFromExam = Object.keys(answerKeyModels).find(key => answerKeyModels[key].examName === examFilter);
            const subjectName = modelNameFromExam ? answerKeyModels[modelNameFromExam].subject : (examFilter || 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            const date = new Date().toLocaleDateString('ar-SA');
            const title = `ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ ${subjectName} ${examFilter ? '- ' + examFilter : ''}`;
            const fileName = `ØªÙ‚Ø±ÙŠØ±-${subjectName.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}-${date}`; 

            
            const reportContainerClone = document.getElementById('report-container')?.cloneNode(true);
            if(!reportContainerClone) return;
            const printButtonInClone = reportContainerClone.querySelector('#printReportBtn');
            if(printButtonInClone) printButtonInClone.remove();
            
            const summaryHTML = reportContainerClone.querySelector('h4:nth-of-type(1)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-6')?.outerHTML;
            const analysisHTML = reportContainerClone.querySelector('h4:nth-of-type(2)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-4')?.outerHTML + reportContainerClone.querySelector('.mb-6.border.rounded.p-2.bg-gray-50')?.outerHTML;


            const studentLogs = detailedAnswersLog.filter(log => 
                (!classFilter || log.student_class === classFilter) &&
                (!examFilter || log.exam_name === examFilter)
            );
            const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
            const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


            allStudentsInFilter.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

            const studentListHTML = allStudentsInFilter.map((student, index) => {
                const log = studentLogs.find(l => l.student_id === student.id);
                return `
                    <tr class="border-b">
                        <td class="p-1 text-center">${index + 1}</td>
                        <td class="p-1 text-right">${student.name}</td>
                        <td class="p-1 text-center">${student.class}</td>
                        <td class="p-1 text-center">${log ? log.score_summary : (student.status === 'absent' ? 'ØºØ§Ø¦Ø¨' : '-')}</td>
                        <td class="p-1 text-center">${log ? log.percentage : '-'}</td>
                        <td class="p-1 text-center">${log ? log.grade : '-'}</td>
                    </tr>
                `}).join('');
            
            const absentListHTML = absentStudents.map((student, index) => `
                    <li class="text-sm">${index + 1}. ${student.name} (${student.class})</li>
            `).join('');


            const gradeChartImage = await getReportChartsAsImages(studentLogs, 'pie');
            const classChartImage = (!classFilter) ? await getReportChartsAsImages(studentLogs, 'bar', classFilter) : null;


            const chartsHTML = `
                    <div class="page-break" style="page-break-before: always;"></div> 
                    <h4 class="text-lg font-bold mt-6 mb-2 text-center">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</h4>
                    <div style="text-align: center; margin-bottom: 20px;">
                        ${gradeChartImage ? `<img src="${gradeChartImage}" class="mx-auto block" style="max-width: 350px; margin-top: 10px; border: 1px solid #ccc;"/>` : '<p class="text-center text-gray-500">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª (ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª).</p>'}
                    </div>
                    
                    ${classChartImage ? `
                            <h4 class="text-lg font-bold mt-6 mb-2 text-center">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„ÙØµÙ„</h4>
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="${classChartImage}" class="mx-auto block" style="max-width: 600px; margin-top: 10px; border: 1px solid #ccc;"/>
                            </div>
                    ` : ''}
            `;


            const studentTable = `
                    <div class="page-break" style="page-break-before: always;"></div> 
                    <h4 class="text-lg font-bold mt-6 mb-2">Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
                    <table class="w-full text-sm mt-4">
                        <thead><tr class="border-b-2 border-black"><th class="p-1">#</th><th class="p-1 text-right">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th class="p-1">Ø§Ù„ÙØµÙ„</th><th class="p-1">Ø§Ù„Ø¯Ø±Ø¬Ø©</th><th class="p-1">Ø§Ù„Ù†Ø³Ø¨Ø©</th><th class="p-1">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th></tr></thead>
                        <tbody>${studentListHTML}</tbody>
                    </table>
                    
                    ${absentStudents.length > 0 ? `
                            <h4 class="text-lg font-bold mt-6 mb-2">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ† (${absentStudents.length})</h4>
                            <ul class="list-decimal list-inside pr-4">${absentListHTML}</ul>
                    ` : ''}
            `;
            
            const finalPrintContent = summaryHTML + analysisHTML + chartsHTML + studentTable;

            const printDiv = document.getElementById('printable-report-content');
            if (printDiv) {
                printDiv.innerHTML = finalPrintContent; 
                printContent(printDiv.innerHTML, title, fileName); 
            } else {
                console.error("Printable report content div not found.");
            }
        }

        function printContent(content, title, fileName) {
            const settings = getFromStorage('appSettings', {});
            const classFilter = document.getElementById('reportClassFilter')?.value || '';
            const examFilter = document.getElementById('reportExamFilter')?.value || '';
            const date = new Date().toLocaleDateString('ar-SA');
            const safeFileName = fileName || `${title.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}_${date}`; 

            const headerInfo = `
                <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <p style="margin: 2px 0;">${settings.admin || ''}</p>
                    <p style="margin: 2px 0;">${settings.school || ''}</p>
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin: 5px 0;">${title}</h1>
                    <div style="font-size: 0.9rem; color: #555;">
                        <span>${classFilter ? `Ø§Ù„ÙØµÙ„: ${classFilter}`: ''}</span>
                        <span>${examFilter ? ` | Ø§Ø®ØªØ¨Ø§Ø±: ${examFilter}` : ''}</span>
                        <span> | ${date}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #555; margin-top: 5px;">
                        <span>Ø§Ù„Ù…Ø¹Ù„Ù…: ${settings.teacher || ''}</span>
                        ${settings.director ? `<span> | Ø§Ù„Ù…Ø¯ÙŠØ±: ${settings.director || ''}</span>` : ''}
                    </div>
                </div>
            `;

            const fullContent = headerInfo + content;
            const win = window.open('', '_blank');
            if(win){
                win.document.write(`
                    <html>
                        <head>
                            <title>${safeFileName}</title>
                            <script src="https://cdn.tailwindcss.com"></script> 
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                            <style>
                                @media print { button { display: none !important; } }
                            </style>
                        </head>
                        <body class="p-4">${fullContent}</body>
                    </html>`);
                win.document.close();
                setTimeout(() => { 
                    try { win.print(); } catch(e){ console.error("Print error:", e); }
                }, 500);
            } else {
                showNotification("ÙØ´Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.", "error");
            }
        }

        function printBlankSheet() {
            const qCountInput = document.getElementById('questionCount');
            const oCountSelect = document.getElementById('optionsCount');
            const subjectInput = document.getElementById('subjectName');
            const modelSelect = document.getElementById('answerKeyModel');
            const examNameInput = document.getElementById('examName');
            const examDateInput = document.getElementById('examDate');

            if(!qCountInput || !oCountSelect || !subjectInput || !modelSelect || !examNameInput || !examDateInput) {
                showNotification("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.", "error");
                return;
            }


            const qCount = parseInt(qCountInput.value);
            if (isNaN(qCount) || qCount < 1) {
                showNotification("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.", "error");
                return;
            }
            const oCount = parseInt(oCountSelect.value);
            const options = Array.from({ length: oCount }, (_, i) => String.fromCharCode(65 + i));
            const subjectName = subjectInput.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const modelName = modelSelect.value.replace('Ù†Ù…ÙˆØ°Ø¬ ', '');
            const examName = examNameInput.value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            const examDate = examDateInput.value || '';
            const splitPoint = Math.ceil(qCount / 2);
            const date = new Date().toLocaleDateString('ar-SA');
            const fileName = `Ù†Ù…ÙˆØ°Ø¬-Ø¥Ø¬Ø§Ø¨Ø©-${subjectName}-${date}`;


            let col1 = '';
            for (let i = 1; i <= splitPoint; i++) {
                col1 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col1 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col1 += `</div>`;
            }

            let col2 = '';
            for (let i = splitPoint + 1; i <= qCount; i++) {
                col2 += `<div class="q-item"><span class="q-num">${i}.</span>`;
                options.forEach(opt => { col2 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
                col2 += `</div>`;
            }
            
            const printContent = `
                <style>
                    body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 0; }
                    .page { max-width: 800px; margin: auto; padding: 20px; }
                    .header-container { display: flex; justify-content: space-between; align-items: flex-start;  border-bottom: none; }
                    .header-info { text-align: center; flex-grow: 1; }
                    .header-info h1 { font-size: 1.5rem; font-weight: bold; margin: 5px 0;}
                    .header-info p { margin: 2px 0; font-size: 0.9rem; }
                    .sub-header { font-size: 0.9rem; color: #555; }
                    #qrcode-container { width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0; }
                    .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; font-size: 14px; }
                    .info-item { border-bottom: 1.5px dotted #888; padding-bottom: 8px; }
                    .columns-container { display: flex; justify-content: space-between; gap: 20px; }
                    .column { flex: 1; }
                    .separator { border-left: 1.5px dashed #ccc; margin: 0 10px; flex-shrink: 0; }
                    .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
                    .q-num { font-weight: bold; width: 30px; flex-shrink: 0; }
                    .o-bubble { width: 22px; height: 22px; border: 1.5px solid black; border-radius: 50%; display: inline-block; flex-shrink: 0; }
                    .o-label { margin-left: -5px; margin-right: 8px; flex-shrink: 0;}
                    @media print { button { display: none; } }
                </style>
                <div class="page">
                    <div class="header-container">
                        <div id="qrcode-container-print" style="width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0;"></div>
                        <div class="header-info" style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                            <p>${settings.admin || ''}</p>
                            <p>${settings.school || ''}</p>
                            <h1>Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø§Ø¯Ø©: ${subjectName} - Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… (${modelName})</h1>
                            <div class="sub-header">
                                <span>Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${settings.year || ''}</span>
                                <span>Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ: ${settings.semester || ''}</span>
                            </div>
                        </div>
                    </div>
                    <div class="info">
                        <div class="info-item"><strong>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</strong></div>
                        <div class="info-item"><strong>Ø§Ù„ÙØµÙ„:</strong></div>
                        <div class="info-item"><strong>Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</strong> ${examName}</div>
                        <div class="info-item"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${examDate}</div>
                    </div>
                    <div class="columns-container">
                        <div class="column">${col1}</div>
                        ${qCount > 1 ? '<div class="separator"></div>' : ''}
                        <div class="column">${col2}</div>
                    </div>
                </div>
            `;
            
            const win = window.open('', '_blank');
            if(win){
                win.document.write(`
                    <html>
                        <head>
                            <title>${fileName}</title>
                            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
                            <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                            <style>
                                @media print { button { display: none; } }
                            </style>
                        </head>
                        <body>
                            ${printContent}
                            <div style="text-align:center; margin-top: 30px;"><button onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button></div>
                            <script>
                                const qrcode = new QRCode(document.getElementById("qrcode-container-print"), {
                                    text: "${modelSelect.value}|${subjectName}|${examName}|${examDate}",
                                    width: 80,
                                    height: 80,
                                    colorDark : "#000000",
                                    colorLight : "#ffffff",
                                    correctLevel : QRCode.CorrectLevel.H
                                });
                            </script>
                        </body>
                    </html>`);
                win.document.close();
                setTimeout(() => { 
                    try { win.print(); } catch(e){ console.error("Print error:", e); }
                }, 500);
            } else {
                showNotification("ÙØ´Ù„ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©.", "error");
            }
        }


        // ----------------------------------------------------
        // === Settings/Data Management Functions ===
        // ----------------------------------------------------

        function saveSettings() {
            settings = {
                admin: document.getElementById('setting-admin')?.value || '',
                school: document.getElementById('setting-school')?.value || '',
                teacher: document.getElementById('setting-teacher')?.value || '',
                director: document.getElementById('setting-director')?.value || '',
                year: document.getElementById('setting-year')?.value || '',
                semester: document.getElementById('setting-semester')?.value || '',
            };
            // Note: Keeping settings in localStorage for simplicity for now
            localStorage.setItem('appSettings', JSON.stringify(settings)); 
            showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }

        function loadSettings() {
            const adminInput = document.getElementById('setting-admin');
            if(adminInput) adminInput.value = settings.admin || '';
            const schoolInput = document.getElementById('setting-school');
            if(schoolInput) schoolInput.value = settings.school || '';
            const teacherInput = document.getElementById('setting-teacher');
            if(teacherInput) teacherInput.value = settings.teacher || '';
            const directorInput = document.getElementById('setting-director');
            if(directorInput) directorInput.value = settings.director || '';
            const yearInput = document.getElementById('setting-year');
            if(yearInput) yearInput.value = settings.year || '';
            const semesterInput = document.getElementById('setting-semester');
            if(semesterInput) semesterInput.value = settings.semester || '';
        }

        function backupData() {
            try {
                const data = {
                    appSettings: settings,
                    studentsList: studentsList,
                    examResults: resultsHistory,
                    detailedAnswersLog: detailedAnswersLog,
                    answerKeyModels: answerKeyModels,
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            } catch(e) {
                console.error("Error backing up data:", e);
                showNotification("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.", "error");
            }
        }

        function restoreData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ø³ÙŠØªÙ… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.")) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    // This function should be updated to use the DB APIs later
                    if (data.appSettings && data.studentsList && data.examResults && data.detailedAnswersLog && data.answerKeyModels) {
                        
                        settings = data.appSettings || {};
                        studentsList = (data.studentsList || []).map(s => ({ ...s, status: s.status || 'pending' })); 
                        resultsHistory = data.examResults || [];
                        detailedAnswersLog = data.detailedAnswersLog || [];
                        answerKeyModels = data.answerKeyModels || {};
                        
                        localStorage.setItem('appSettings', JSON.stringify(settings));
                        // In a real DB scenario, we would upload this data via API here

                        loadInitialUI(); 
                        showSection('dashboard'); 

                    } else {
                        throw new Error("Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù.");
                    }
                } catch (error) {
                    console.error("Error restoring data:", error);
                    showNotification(`Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'error');
                } finally {
                    event.target.value = ''; 
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            const confirmation = prompt("Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© 'Ø­Ø°Ù' ÙÙŠ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø£Ø¯Ù†Ø§Ù‡.");
            if (confirmation === 'Ø­Ø°Ù') {
                // In a real DB scenario, this would call a server endpoint to drop tables
                localStorage.clear();
                showNotification('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù. Ø§Ù„ÙƒØªØ§Ø¨Ø© ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©.', 'info');
            }
        }

        // ----------------------------------------------------
        // === Stats Section Functions ===
        // ----------------------------------------------------

        function populateStatsFilters() {
            const classFilter = document.getElementById('statsClassFilter');
            const examFilter = document.getElementById('statsExamFilter');
            if(!classFilter || !examFilter) return;

            const uniqueClasses = [...new Set(resultsHistory.map(r => r.student_class))].sort();
            const uniqueExams = [...new Set(resultsHistory.map(r => r.exam_name))].sort();

            classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            examFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function updateGlobalStats() {
            const container = document.getElementById('summary-stats');
            const gradeCtx = document.getElementById('grade-distribution-chart');
            const classCtx = document.getElementById('class-performance-chart');
            const classFilter = document.getElementById('statsClassFilter')?.value;
            const examFilter = document.getElementById('statsExamFilter')?.value;
            
            if(!container || !gradeCtx || !classCtx) {
                console.warn("Stats elements not found, skipping update.");
                return; 
            }
            
            const filteredResults = resultsHistory.filter(r => 
                (!classFilter || r.student_class === classFilter) &&
                (!examFilter || r.exam_name === examFilter)
            );


            const totalCorrected = filteredResults.length;
            const overallAverage = totalCorrected > 0 ? Math.round(filteredResults.reduce((sum, r) => sum + (parseInt(r.percentage) || 0), 0) / totalCorrected) : 0;
            const uniqueStudents = new Set(filteredResults.map(r => r.student_name)).size;
            const uniqueExams = new Set(filteredResults.map(r => r.exam_name)).size;

            container.innerHTML = `
                <div class="bg-blue-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${totalCorrected}</div><div class="text-xs">ÙˆØ±Ù‚Ø© Ù…ØµØ­Ø­Ø©</div></div>
                <div class="bg-green-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${overallAverage}%</div><div class="text-xs">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡</div></div>
                <div class="bg-purple-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${uniqueStudents}</div><div class="text-xs">Ø·Ø§Ù„Ø¨ ÙØ±ÙŠØ¯</div></div>
                <div class="bg-yellow-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-600">${uniqueExams}</div><div class="text-xs">Ø§Ø®ØªØ¨Ø§Ø± ÙØ±ÙŠØ¯</div></div>
            `;
            
            try {
                if(gradeChart) gradeChart.destroy();
                const gradeCtx2D = gradeCtx.getContext('2d');
                if(!gradeCtx2D) throw new Error("Could not get 2D context for grade chart");

                const gradeCounts = { 'Ù…Ù…ØªØ§Ø²': 0, 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': 0, 'Ø¬ÙŠØ¯': 0, 'Ù…Ù‚Ø¨ÙˆÙ„': 0, 'Ø¶Ø¹ÙŠÙ': 0 };
                filteredResults.forEach(r => { 
                    const grade = r.grade || 'Ø¶Ø¹ÙŠÙ'; 
                    if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
                });
                gradeChart = new Chart(gradeCtx2D, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeCounts),
                        datasets: [{
                            data: Object.values(gradeCounts),
                            backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } catch (e) { console.error("Error creating grade chart:", e); }

            try {
                if(classChart) classChart.destroy();
                const classCtx2D = classCtx.getContext('2d');
                if(!classCtx2D) throw new Error("Could not get 2D context for class chart");

                const classPerformances = {};
                filteredResults.forEach(r => {
                    const className = r.student_class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
                    classPerformances[className].total += (parseInt(r.percentage) || 0); 
                    classPerformances[className].count++;
                });
                const classLabels = Object.keys(classPerformances).sort();
                const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
                classChart = new Chart(classCtx2D, {
                    type: 'bar',
                    data: {
                        labels: classLabels,
                        datasets: [{
                            label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª',
                            data: classAverages,
                            backgroundColor: '#4f46e5',
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            } catch (e) { console.error("Error creating class chart:", e); }
        }

        async function getReportChartsAsImages(logs, chartType, classFilterValue) {
            if (typeof Chart === 'undefined') {
                console.error("Chart.js library is not loaded.");
                return null;
            }
            const offscreenCanvas = document.createElement('canvas');
            const ctx = offscreenCanvas.getContext('2d');
            if(!ctx){
                console.error("Could not get 2D context for offscreen canvas.");
                return null;
            }
            
            let chartConfig;
            
            if(chartType === 'pie'){
                offscreenCanvas.width = 400; offscreenCanvas.height = 250; 
                const gradeCounts = { 'Ù…Ù…ØªØ§Ø²': 0, 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹': 0, 'Ø¬ÙŠØ¯': 0, 'Ù…Ù‚Ø¨ÙˆÙ„': 0, 'Ø¶Ø¹ÙŠÙ': 0 };
                logs.forEach(r => { 
                    const grade = r.grade || 'Ø¶Ø¹ÙŠÙ';
                    if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
                });
                chartConfig = {
                    type: 'pie',
                    data: {
                        labels: Object.keys(gradeCounts),
                        datasets: [{ data: Object.values(gradeCounts), backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'], }]
                    },
                    options: { responsive: false, animation: false, plugins: { legend: { display: true, position: 'bottom' } } }
                };
            } else if (chartType === 'bar'){
                offscreenCanvas.width = 600; offscreenCanvas.height = 300; 
                const classPerformances = {};
                const relevantHistory = resultsHistory.filter(r => !classFilterValue || r.student_class === classFilterValue); 

                relevantHistory.forEach(r => {
                    const className = r.student_class || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
                    classPerformances[className].total += (parseInt(r.percentage) || 0); 
                    classPerformances[className].count++;
                });
                const classLabels = Object.keys(classPerformances).sort();
                const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
                
                chartConfig = {
                    type: 'bar',
                    data: {
                        labels: classLabels,
                        datasets: [{ label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', data: classAverages, backgroundColor: '#4f46e5', }]
                    },
                    options: { responsive: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
                };
            } else {
                return null; 
            }

            return new Promise((resolve) => {
                let chartInstance = null;
                chartConfig.options = chartConfig.options || {};
                chartConfig.options.animation = {
                    duration: 0, 
                    onComplete: () => {
                        try {
                            const dataUrl = chartInstance.toBase64Image();
                            resolve(dataUrl);
                        } catch (imgError) {
                            console.error("Error converting chart to image:", imgError);
                            resolve(null);
                        } finally {
                            if (chartInstance) chartInstance.destroy();
                        }
                    }
                };
                try {
                    chartInstance = new Chart(ctx, chartConfig);
                    if (!chartInstance) throw new Error("Chart instance creation failed.");
                } catch (chartError) {
                    console.error("Error creating chart instance:", chartError);
                    resolve(null);
                }
            });

        }
    
        document.addEventListener('DOMContentLoaded', () => {
            // Re-attach listeners outside of the initial load for dynamic content if needed
            // ... (Your existing listener setup) ...
        });

    </script>
</body>
</html>
