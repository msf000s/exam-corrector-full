<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ย <title>ุชุทุจูู ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</title>
ย ย <script src="https://cdn.tailwindcss.com"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
ย ย <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
ย ย <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
ย ย <style>
ย ย ย ย body { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
ย ย ย ย .camera-container {
ย ย ย ย ย ย position: relative;
ย ย ย ย ย ย max-width: 100%;
ย ย ย ย ย ย background: #1f2937;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย overflow: hidden;
ย ย ย ย ย ย /* ูุถูุงู ุฃู ุงูููุฏูู ูููุฃ ุงูุญุงููุฉ ููุญุงูุธ ุนูู ุงูุงุฑุชูุงุน */
ย ย ย ย ย ย height: 60vh; /* ุงุฑุชูุงุน ุซุงุจุช ูุณุจููุง */
ย ย ย ย }
ย ย ย ย .overlay {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 50%;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translate(-50%, -50%);
ย ย ย ย ย ย /* ุงูุชุนุฏูู: ุญุฏูุฏ ุฃูุถุญ ูุชุนุชูู ููุฎูููุฉ */
ย ย ย ย ย ย border: 4px solid #f97316; /* ููู ุจุฑุชูุงูู ูุงุถุญ */
ย ย ย ย ย ย box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); /* ุชุนุชูู ูุง ุญูู ุงูุฅุทุงุฑ */
ย ย ย ย ย ย width: 90%; /* ุชูุณูุน ุงูุฅุทุงุฑ ููุบุทู ูุณุงุญุฉ ุฃูุจุฑ */
ย ย ย ย ย ย height: 90%; /* ุชูุณูุน ุงูุฅุทุงุฑ ููุบุทู ูุณุงุญุฉ ุฃูุจุฑ */
ย ย ย ย ย ย pointer-events: none;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย z-index: 10;
ย ย ย ย }
ย ย ย ย .countdown-text {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 50%;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translate(-50%, -50%);
ย ย ย ย ย ย font-size: 5rem;
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย text-shadow: 0 0 15px rgba(0,0,0,0.7);
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย animation: fadeInOut 1s infinite;
ย ย ย ย ย ย z-index: 15; /* ุชุฃูุฏ ูู ุฃูู ุฃุนูู ูู ูู ุดูุก */
ย ย ย ย }
ย ย ย ย @keyframes fadeInOut {
ย ย ย ย ย ย 0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
ย ย ย ย ย ย 50% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
ย ย ย ย }
ย ย ย ย .result-animation { animation: slideIn 0.5s ease-out; }
ย ย ย ย @keyframes slideIn {
ย ย ย ย ย ย from { opacity: 0; transform: translateY(20px); }
ย ย ย ย ย ย to { opacity: 1; transform: translateY(0); }
ย ย ย ย }
ย ย ย ย .correct-answer { background: linear-gradient(135deg, #10b981, #059669); }
ย ย ย ย .wrong-answer { background: linear-gradient(135deg, #ef4444, #dc2626); }
ย ย ย ย .collapsible-content {
ย ย ย ย ย ย max-height: 0;
ย ย ย ย ย ย overflow: hidden;
ย ย ย ย ย ย transition: max-height 0.3s ease-out;
ย ย ย ย }
ย ย ย ย .app-section {
ย ย ย ย ย ย display: none;
ย ย ย ย }
ย ย ย ย .app-section.active {
ย ย ย ย ย ย display: block;
ย ย ย ย }
ย ย ย ย .nav-link.active {
ย ย ย ย ย ย background-color: #4f46e5;
ย ย ย ย ย ย color: white;
ย ย ย ย }
ย ย ย ย /* Styles for report question analysis colors */
ย ย ย ย .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } /* Light red (High Difficulty) */
ย ย ย ย .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } /* Light orange (Medium Difficulty) */
ย ย ย ย .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } /* Light green (Low Difficulty) */
ย ย ย ย .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } /* Lighter green (No Errors) */

ย ย ย ย /* Print-specific styles */
ย ย ย ย @media print {
ย ย ย ย ย ย body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; }
ย ย ย ย ย ย button, input, select, aside, #menu-button, #printReportBtn { display: none !important; } /* Hide print button in print view */
ย ย ย ย ย ย main { margin: 0 !important; padding: 0 !important; }
ย ย ย ย ย ย .app-section { display: none !important; } /* Hide all sections */
ย ย ย ย ย ย #printable-report-content { display: block !important; } /* Show only print content */
ย ย ย ย ย ย .bg-white { box-shadow: none !important; border: 1px solid #ccc; }
ย ย ย ย ย ย .text-xs { font-size: 0.7rem !important; }
ย ย ย ย ย ย .text-sm { font-size: 0.8rem !important; }
ย ย ย ย ย ย .text-lg { font-size: 1rem !important; }
ย ย ย ย ย ย .text-xl { font-size: 1.1rem !important; }
ย ย ย ย ย ย .text-2xl { font-size: 1.2rem !important; }
ย ย ย ย ย ย .font-bold { font-weight: bold !important; }
ย ย ย ย ย ย .p-1 { padding: 0.25rem !important; }
ย ย ย ย ย ย .p-2 { padding: 0.5rem !important; }
ย ย ย ย ย ย .p-3 { padding: 0.75rem !important; }
ย ย ย ย ย ย .mb-1 { margin-bottom: 0.25rem !important; }
ย ย ย ย ย ย .mb-2 { margin-bottom: 0.5rem !important; }
ย ย ย ย ย ย .mb-4 { margin-bottom: 1rem !important; }
ย ย ย ย ย ย .mt-4 { margin-top: 1rem !important; }
ย ย ย ย ย ย .mt-6 { margin-top: 1.5rem !important; }
ย ย ย ย ย ย .gap-4 { gap: 1rem !important; }
ย ย ย ย ย ย .grid { display: grid !important; }
ย ย ย ย ย ย .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
ย ย ย ย ย ย .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
ย ย ย ย ย ย .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
ย ย ย ย ย ย .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)) !important; }
ย ย ย ย ย ย .text-center { text-align: center !important; }
ย ย ย ย ย ย .text-right { text-align: right !important; }
ย ย ย ย ย ย .border { border-width: 1px !important; }
ย ย ย ย ย ย .border-b { border-bottom-width: 1px !important; }
ย ย ย ย ย ย .border-b-2 { border-bottom-width: 2px !important; }
ย ย ย ย ย ย .border-black { border-color: black !important; }
ย ย ย ย ย ย .border-gray-300 { border-color: #d1d5db !important; }
ย ย ย ย ย ย .rounded-lg { border-radius: 0.5rem !important; }
ย ย ย ย ย ย .w-full { width: 100% !important; }
ย ย ย ย ย ย .mx-auto { margin-left: auto !important; margin-right: auto !important; }
ย ย ย ย ย ย table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto !important;}
ย ย ย ย ย ย tr { page-break-inside: avoid !important; page-break-after: auto !important; }
ย ย ย ย ย ย thead { display: table-header-group !important; } /* Repeat header on each page */
ย ย ย ย ย ย td, th { border: 1px solid #ddd !important; padding: 4px !important; text-align: center !important; font-size: 0.75rem !important; } /* Reduced padding/font */
ย ย ย ย ย ย th { background-color: #f2f2f2 !important; font-weight: bold !important;}
ย ย ย ย ย ย tr:nth-child(even){background-color: #f9f9f9 !important;}
ย ย ย ย ย ย img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important;}
ย ย ย ย ย ย .page-break { page-break-before: always !important; }
ย ย ย ย ย ย ย/* Ensure colored backgrounds print */
ย ย ย ย ย ย .bg-blue-100 { background-color: #DBEAFE !important; }
ย ย ย ย ย ย .bg-green-100 { background-color: #DCFCE7 !important; }
ย ย ย ย ย ย .bg-red-100 { background-color: #FEE2E2 !important; }
ย ย ย ย ย ย .bg-gray-50 { background-color: #F9FAFB !important; }
ย ย ย ย ย ย .bg-gray-100 { background-color: #F3F4F6 !important; }
ย ย ย ย ย ย .bg-yellow-100 { background-color: #FEF3C7 !important; }
ย ย ย ย ย ย .bg-orange-100 { background-color: #FFEDD5 !important; }

ย ย ย ย ย ย /* Specific report styles */
ย ย ย ย ย ย #printable-report-content .text-red-700 { color: #b91c1c !important; }
ย ย ย ย ย ย #printable-report-content .text-green-700 { color: #15803d !important; }
ย ย ย ย ย ย #printable-report-content .text-red-600 { color: #dc2626 !important; }
ย ย ย ย ย ย #printable-report-content .text-green-600 { color: #16a34a !important; }
ย ย ย ย ย ย #printable-report-content .text-blue-600 { color: #2563eb !important; }
ย ย ย ย ย ย #printable-report-content .font-semibold { font-weight: 600 !important; }
ย ย ย ย ย ย #printable-report-content .font-bold { font-weight: 700 !important; }
ย ย ย ย ย ย #printable-report-content .pr-2 { padding-right: 0 !important; }
ย ย ย ย ย ย #printable-report-content .question-analysis-table td,
ย ย ย ย ย ย #printable-report-content .question-analysis-table th { font-size: 0.7rem !important; padding: 3px !important; } /* Smaller font for analysis table */
ย ย ย ย }
ย ย </style>
ย ย <link rel="preconnect" href="https://fonts.googleapis.com">
ย ย <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
ย ย <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
ย ย <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
ย ย <div class="flex flex-col md:flex-row">
ย ย ย ย ย ย ย ย <aside id="sidebar" class="w-64 bg-gray-800 text-white p-4 min-h-screen fixed md:relative inset-y-0 right-0 transform translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
ย ย ย ย ย ย <h1 class="text-2xl font-bold text-center mb-8">ุงููุตุญุญ ุงูุฐูู</h1>
ย ย ย ย ย ย <nav class="flex flex-col gap-2">
ย ย ย ย ย ย ย ย <a href="#dashboard" class="nav-link active p-3 rounded-lg hover:bg-gray-700">๐ ููุญุฉ ุงูุชุญูู</a>
ย ย ย ย ย ย ย ย <a href="#answer-key" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ููุงุฐุฌ ุงูุฅุฌุงุจุฉ</a>
ย ย ย ย ย ย ย ย <a href="#students" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ฅ ุงูุทูุงุจ</a>
ย ย ย ย ย ย ย ย <a href="#correction" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ท ุงูุชุตุญูุญ</a>
ย ย ย ย ย ย ย ย <a href="#history" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ุงูุณุฌูุงุช</a>
ย ย ย ย ย ย ย ย <a href="#reports" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐จ๏ธ ุงูุชูุงุฑูุฑ</a>
ย ย ย ย ย ย ย ย <a href="#stats" class="nav-link p-3 rounded-lg hover:bg-gray-700">๐ ุงูุฅุญุตุงุฆูุงุช</a>
ย ย ย ย ย ย ย ย <a href="#settings" class="nav-link p-3 rounded-lg hover:bg-gray-700">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</a>
ย ย ย ย ย ย </nav>
ย ย ย ย </aside>

ย ย ย ย ย ย ย ย <main class="flex-1 p-4 md:p-8">
ย ย ย ย ย ย <button id="menu-button" class="md:hidden fixed top-4 right-4 z-20 p-2 bg-gray-800 text-white rounded-md">
ย ย ย ย ย ย ย ย <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
ย ย ย ย ย ย ย ย ย ย <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
ย ย ย ย ย ย ย ย </svg>
ย ย ย ย ย ย </button>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <section id="dashboard" class="app-section active">
ย ย ย ย ย ย ย ย <header class="mb-10">
ย ย ย ย ย ย ย ย ย ย <h1 class="text-4xl md:text-5xl font-bold text-gray-800 mb-3 text-center">ุฃุทูู ุงูุนูุงู ูููุฉ ุงูุชุตุญูุญ ุงูููุฑู</h1>
ย ย ย ย ย ย ย ย ย ย <p class="text-lg md:text-xl text-center max-w-3xl mx-auto text-gray-600">"ุงููุตุญุญ ุงูุฐูู" ูู ูุณุงุนุฏู ุงูุฑููู ุงูุฐู ูุญูู ูููุฉ ุชุตุญูุญ ุงูุงุฎุชุจุงุฑุงุช ุงููุฑููุฉ ุฅูู ุนูููุฉ ุณุฑูุนุฉ ูุฏูููุฉ ูููุชุนุฉ ุจุงุณุชุฎุฏุงู ุฃุญุฏุซ ุชูููุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู.</p>
ย ย ย ย ย ย ย ย </header>

ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b pb-4">ุฃุจุฑุฒ ุงูููุฒุงุช</h2>
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-start gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-indigo-100 text-indigo-600 p-3 rounded-full text-2xl">โก๏ธ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold mb-1">ุชุตุญูุญ ุฐูู ูุณุฑูุน</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600">ุญููู ูุงููุฑุง ูุงุชูู ุฅูู ูุงุณุญ ุถูุฆู ูุงุฆู ุงูุณุฑุนุฉ. ููุชูุท ุงูุชุทุจูู ุงูุฅุฌุงุจุงุช ุชููุงุฆูุงู ููุญูููุง ูู ุซูุงูู ูุนุฏูุฏุฉ ุจุฏูุฉ ุนุงููุฉ.</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-start gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-green-100 text-green-600 p-3 rounded-full text-2xl">๐ฅ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold mb-1">ุฅุฏุงุฑุฉ ุงูุทูุงุจ ูุงููุตูู</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600">ุงุณุชูุฑุฏ ููุงุฆู ุทูุงุจู ูู ูููุงุช Excel ุจุณูููุฉุ ูุชุชุจุน ุฃุฏุงุกููุ ููู ุจุชุตุญูุญ ุฃูุฑุงููู ุจุดูู ูุฑุฏู ุฃู ุฌูุงุนู.</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-start gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full text-2xl">๐</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold mb-1">ููุงุฐุฌ ุฅุฌุงุจุฉ ูุฑูุฉ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600">ุฃูุดุฆ ููุงุฐุฌ ุฅุฌุงุจุงุช ูุชุนุฏุฏุฉ ูุงุญูุธูุง. ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูุฏููุงู ุฃู ูู ุจุชุตููุฑ ูููุฐุฌ ูุญููู ููููุฑ ุนููู ุนูุงุก ุงูุฅุฏุฎุงู.</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-start gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-red-100 text-red-600 p-3 rounded-full text-2xl">๐</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold mb-1">ุณุฌูุงุช ูุชูุงุฑูุฑ ููุตูุฉ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-gray-600">ุงุญูุธ ุฌููุน ุงููุชุงุฆุฌ ุชููุงุฆูุงู ูู ุณุฌูุงุช ููุธูุฉ. ูู ุจุชุตุฏูุฑ ููุฎุตุงุช ุงููุชุงุฆุฌ ุฃู ุชูุงุฑูุฑ ุงูุฅุฌุงุจุงุช ุงูุชูุตูููุฉ ุฅูู ูููุงุช Excel ูุชุญููู ุฃุนูู.</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <button id="toggle-instructions-btn" class="w-full text-right">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ ุฏููู ุงูุจุฏุก ุงูุณุฑูุน
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span id="instructions-arrow">โผ</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย <div id="instructions-content" class="collapsible-content mt-4 pt-4 border-t">
ย ย ย ย ย ย ย ย ย ย ย ย <ol class="list-decimal list-inside space-y-4 text-gray-700">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<li>ุงุฐูุจ ุฅูู ูุณู <a href="#answer-key" class="quick-start-link text-blue-600 font-bold">"ููุงุฐุฌ ุงูุฅุฌุงุจุฉ"</a> ูุฌููุฒ ูููุฐุฌ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (ุฃุฏุฎู ุงููุงุฏุฉ ูุงุณู ุงูุงุฎุชุจุงุฑ ูุงูุชุงุฑูุฎ).</li>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <li>ุงุฐูุจ ุฅูู ูุณู <a href="#students" class="quick-start-link text-blue-600 font-bold">"ุงูุทูุงุจ"</a> ูุงุณุชูุฑุฏ ูุงุฆูุฉ ุทูุงุจู.</li>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <li>ุงูุชูู ุฅูู ูุณู <a href="#correction" class="quick-start-link text-blue-600 font-bold">"ุงูุชุตุญูุญ"</a> ูุงุฎุชุฑ ุทุงูุจุงู ุฃู ุงุจุฏุฃ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ!</li>
ย ย ย ย ย ย ย ย ย ย ย ย </ol>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <section id="answer-key" class="app-section">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ ุฅุนุฏุงุฏ ููุงุฐุฌ ุงูุฅุฌุงุจุฉ</h2>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <label for="answerKeyModel" class="block text-sm font-medium text-gray-700 mb-2">ุงุฎุชุฑ ุฃู ุฃูุดุฆ ูููุฐุฌ ุฅุฌุงุจุฉ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="answerKeyModel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="newModelBtn" title="ูููุฐุฌ ุฌุฏูุฏ" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-lg">โ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="renameModelBtn" title="ุฅุนุงุฏุฉ ุชุณููุฉ" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg">โ๏ธ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="deleteModelBtn" title="ุญุฐู ุงููููุฐุฌ" class="bg-red-500 hover:bg-red-600 text-white px-3 rounded-lg">๐๏ธ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฃุณุฆูุฉ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="number" id="questionCount" min="1" max="100" value="10" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="optionsCount" class="block text-sm font-medium text-gray-700 mb-2">ุนุฏุฏ ุงูุฎูุงุฑุงุช:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="optionsCount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="4">4 (A, B, C, D)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="5">5 (A, B, C, D, E)</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="subjectName" class="block text-sm font-medium text-gray-700 mb-2">ุงููุงุฏุฉ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="subjectName" placeholder="ูุซุงู: ุฑูุงุถูุงุช" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="examInfoSection" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย<div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="examName" class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุงุฎุชุจุงุฑ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="examName" placeholder="ูุซุงู: ุงูุงุฎุชุจุงุฑ ุงููุตูู ุงูุฃูู" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="examDate" class="block text-sm font-medium text-gray-700 mb-2">ุชุงุฑูุฎ ุงูุงุฎุชุจุงุฑ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="date" id="examDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="mt-4 pt-4 border-t">
ย ย ย ย ย ย ย ย ย ย ย ย ย<h3 class="text-lg font-bold text-gray-800 mb-3">ุฅุฌุฑุงุกุงุช ุงููููุฐุฌ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="flex flex-wrap gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="manualEntryBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">โ๏ธ ุฅุนุฏุงุฏ ุงูุฅุฌุงุจุงุช ูุฏููุงู</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="scanKeyBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ท ุชุตููุฑ ูููุฐุฌ ูุญููู</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="printSheetBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐จ๏ธ ุทุจุงุนุฉ ูููุฐุฌ ูุงุฑุบ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="answerSheet" class="hidden mt-6 pt-4 border-t">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุฃุฏุฎู ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูุฏููุงู:</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <button id="saveAnswersBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">ุญูุธ ุงูุฅุฌุงุจุงุช</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <section id="students" class="app-section">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
ย ย ย ย ย ย ย ย ย ย ย ย ๐ฅ ุฅุฏุงุฑุฉ ุงูุทูุงุจ
ย ย ย ย ย ย ย ย ย ย </h2>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-50 rounded-lg p-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-blue-800 mb-3">๐ ุงุณุชูุฑุงุฏ ูุงุฆูุฉ ุงูุทูุงุจ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex-1">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="studentsFileInput" accept=".xlsx,.xls,.csv"ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="studentsListSection" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-gray-800">๐ ูุงุฆูุฉ ุงูุทูุงุจ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="multiCorrectionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ ุชุตุญูุญ ูุชุนุฏุฏ
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="clearStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐๏ธ ูุณุญ ุงููุงุฆูุฉ
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-100 p-3 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-blue-600" id="totalStudentsCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-blue-800">ุฅุฌูุงูู ุงูุทูุงุจ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-green-100 p-3 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-green-600" id="correctedCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-green-800">ุชู ุชุตุญูุญูุง</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-yellow-100 p-3 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-yellow-800">ูู ุงูุงูุชุธุงุฑ</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-purple-100 p-3 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-purple-600" id="uniqueClassesCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-xs text-purple-800">ุนุฏุฏ ุงููุตูู</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 rounded-lg p-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="searchStudentName" class="block text-sm font-medium text-gray-700 mb-1">ุงูุจุญุซ ุจุงูุงุณู:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="text" id="searchStudentName" placeholder="ุฌุฒุก ูู ุงุณู ุงูุทุงูุจ..."ย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="filterClass" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="filterClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">ุฌููุน ุงููุตูู</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">ุญุงูุฉ ุงูุชุตุญูุญ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">ุงููู</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="corrected">ุชู ุงูุชุตุญูุญ</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="pending">ูู ุงูุงูุชุธุงุฑ</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="absent">ุบุงุฆุจ</option>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย <div id="studentsList" class="space-y-2 max-h-64 overflow-y-auto"></div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>

ย ย ย ย ย ย ย ย ย ย ย ย <section id="correction" class="app-section">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-4">๐ท ุชุตููุฑ ุฃู ุชุญููู ูุฑูุฉ ุงูุฅุฌุงุจุฉ</h2>

ย ย ย ย ย ย ย ย ย ย <div id="correctionSelectedStudentDisplay" class="mb-4 bg-green-50 rounded-lg p-4 hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ย<h3 class="text-lg font-semibold text-green-800 mb-2">๐ค ุงูุทุงูุจ ุงููุญุฏุฏ ููุชุตุญูุญ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="flex items-center justify-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="font-semibold" id="correctionStudentNameDisplay">-</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm text-gray-600">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ุงููุตู: <span id="correctionStudentClassDisplay">-</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button id="changeCorrectionStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg font-medium text-sm">ุชุบููุฑ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย</div>
ย ย ย ย ย ย ย ย ย ย </div>


ย ย ย ย ย ย ย ย ย ย <div class="mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <label for="correctionStudentSelect" class="block text-sm font-medium text-gray-700 mb-2">๐ค ุงุฎุชุฑ ุทุงูุจุงู ููุชุตุญูุญ ุงููุฑุฏู (ุฃู ุงุฎุชุฑ ูู ูุณู ุงูุทูุงุจ):</label>
ย ย ย ย ย ย ย ย ย ย ย ย <select id="correctionStudentSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <option value="">-- ุงุฎุชุฑ ูู ุงููุงุฆูุฉ --</option>
ย ย ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div id="uploadOptions" class="flex flex-col sm:flex-row gap-4 my-6">
ย ย ย ย ย ย ย ย ย ย ย ย <button id="showCameraBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">๐น ุงุณุชุฎุฏุงู ุงููุงููุฑุง</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button id="showUploadBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-colors">๐ ุชุญููู ุตูุฑุฉ</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="cameraSection" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="camera-container mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <video id="camera" autoplay playsinline class="w-full h-80 object-cover"></video>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <canvas id="canvas" class="hidden"></canvas>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="overlay"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="countdown" class="countdown-text"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="stopCameraBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โน๏ธ ุฅููุงู ุงููุงููุฑุง</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="uploadSection" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ยย ย ย ย ย ย ย ย <div id="multipleCorrectionSection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">๐ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</h2>
ย ย ย ย ย ย ย ย ย ย <div id="multiCorrectionSetup">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-purple-50 rounded-lg p-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-purple-700">ุณูุชู ุชุตุญูุญ ุฃูุฑุงู ุฌููุน ุงูุทูุงุจ ูู ูุงุฆูุฉ "ูู ุงูุงูุชุธุงุฑ" ุจุงูุชุชุงุจุน. ุตููุฑ ุงูุฃูุฑุงู ุจุงูุชุฑุชูุจ ูุณูุชู ุงูุงูุชูุงู ููุทุงูุจ ุงูุชุงูู ุชููุงุฆูุงู ุจุนุฏ ุญูุธ ุงููุชูุฌุฉ.</p>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="startMultiBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2 text-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ๐ ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="multiCorrectionActive" class="hidden">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex justify-between text-sm text-gray-600 mb-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span>ุงูุชูุฏู</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span id="progressText">0 ูู 0</span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="w-full bg-gray-200 rounded-full h-3"><div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="currentMultiStudent" class="bg-blue-50 rounded-lg p-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex items-center justify-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-lg font-semibold text-blue-800" id="multiStudentName">-</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm text-blue-600">ุงููุตู: <span id="multiStudentClass">-</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-right">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm text-blue-600">ูุฑูุฉ ุฑูู</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-blue-800" id="currentStudentNumber">1</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row gap-4 justify-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="skipStudentBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โญ๏ธ ุชุฎุทู ูุฐุง ุงูุทุงูุจ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="stopMultiBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โน๏ธ ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="multiCorrectionReport" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-lg font-semibold text-gray-800 mb-3">๐ ุชูุฑูุฑ ุงูุชุตุญูุญ ุงููุชุนุฏุฏ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="multiReportContent"></div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="mt-4 flex gap-4 justify-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="exportMultiReportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ุงูุชูุฑูุฑ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="resetMultiBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ ุชุตุญูุญ ุฌุฏูุฏ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="verificationContainer" class="hidden bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย ย<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">๐ผ๏ธ ุงูุตูุฑุฉ ุงูููุชูุทุฉ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<img id="capturedImage" class="w-full rounded-lg shadow-md">
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div id="verificationSection">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800 mb-4">๐ ุชุฃููุฏ ุงูุฅุฌุงุจุงุช</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="verificationGrid" class="grid grid-cols-2 lg:grid-cols-3 gap-3 max-h-96 overflow-y-auto pr-2"></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button id="confirmAnswersBtn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">โ ุชุฃููุฏ ูุญุณุงุจ ุงููุชูุฌุฉ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="resultsSection" class="bg-white rounded-xl shadow-lg p-6 hidden result-animation">
ย ย ย ย ย ย ย ย ย ย <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">๐ ูุชุงุฆุฌ ุงูุชุตุญูุญ</h3>
ย ย ย ย ย ย ย ย ย ย <div id="studentResultInfo" class="bg-gray-50 rounded-lg p-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><strong>ุงูุทุงูุจ:</strong> <span id="resultStudentName">-</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><strong>ุงููุตู:</strong> <span id="resultStudentClass">-</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><strong>ุงูุงุฎุชุจุงุฑ:</strong> <span id="resultExamName">-</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div><strong>ุงูุชุงุฑูุฎ:</strong> <span id="resultExamDate">-</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-green-100 p-4 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-green-600" id="correctCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm">ุตุญูุญุฉ</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-red-100 p-4 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-red-600" id="wrongCount">0</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm">ุฎุงุทุฆุฉ</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-blue-100 p-4 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-3xl font-bold text-blue-600" id="scorePercentage">0%</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm">ุงููุณุจุฉ</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-purple-100 p-4 rounded-lg text-center">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-2xl font-bold text-purple-600" id="letterGrade">-</div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="text-sm">ุงูุชูุฏูุฑ</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="detailedResults" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6"></div>
ย ย ย ย ย ย ย ย ย ย <div class="flex flex-col sm:flex-row gap-4 justify-center">
ย ย ย ย ย ย ย ย ย ย ย ย <button id="saveAndNewBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">๐พ ุญูุธ ูุจุฏุก ูุฑูุฉ ุฌุฏูุฏุฉ</button>
ย ย ย ย ย ย ย ย ย ย ย ย <button id="exportResultBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">๐ ุชุตุฏูุฑ ุงููุชูุฌุฉ</button>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <section id="history" class="app-section">
ย ย ย ย ย ย ย ย ยย ย ย ย ย ย ย ย <div id="historySection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย ย<div class="flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800">๐ ุณุฌู ุงููุชุงุฆุฌ ุงููุญููุธุฉ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="exportAllResultsBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ููุฎุต ุงููุชุงุฆุฌ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button id="clearHistoryBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐๏ธ ูุณุญ ุงูุณุฌู</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="historyFilters" class="bg-gray-50 rounded-lg p-4 mb-4 hidden">
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="historyClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="historyClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="historyExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงูุงุฎุชุจุงุฑ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="historyExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="self-end">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="filterHistoryBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุชุทุจูู ุงูููุชุฑ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="historyList" class="space-y-3"></div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="detailedHistorySection" class="bg-white rounded-xl shadow-lg p-6 mb-8 hidden">
ย ย ย ย ย ย ย ย ย ย ย<div class="flex justify-between items-center mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="text-xl font-bold text-gray-800">๐ ุณุฌู ุฅุฌุงุจุงุช ุงูุทูุงุจ (ููุตู)</h3>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="flex gap-2">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="exportDetailedLogBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded-lg font-medium text-sm">๐ ุชุตุฏูุฑ ุณุฌู ุงูุฅุฌุงุจุงุช (Excel)</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <p class="text-sm text-gray-600">ูุญุชูู ูุฐุง ุงูุณุฌู ุนูู ุฅุฌุงุจุฉ ูู ุทุงูุจ ููู ุณุคุงู. ุงุณุชุฎุฏู ุฒุฑ ุงูุชุตุฏูุฑ ูุชุญููู ุงูุจูุงูุงุช.</p>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>

ย ย ย ย ย ย ย ย ย ย ย ย <section id="reports" class="app-section">
ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-4">๐จ๏ธ ุงูุชูุงุฑูุฑ ูุงูุทุจุงุนุฉ</h2>
ย ย ย ย ย ย ย ย ย ย <div class="space-y-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-semibold text-lg text-gray-800 mb-2">ุชูุฑูุฑ ุฃุฏุงุก ุงููุตู</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="reportClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ุงุฎุชุฑ ุงููุตู:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="reportClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="reportExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ุงุฎุชุฑ ุงูุงุฎุชุจุงุฑ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="reportExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="self-end">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="generateReportBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุฅูุดุงุก ุชูุฑูุฑ</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div id="report-container" class="mt-6"></div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>
ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย <section id="stats" class="app-section">
ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย ย<h2 class="text-2xl font-bold text-gray-800 mb-4">๐ ุงูุฅุญุตุงุฆูุงุช</h2>
ย ย ย ย ย ย ย ย ย ย ย<div class="bg-gray-50 rounded-lg p-4 mb-6">
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="statsClassFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงููุตู:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="statsClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="statsExamFilter" class="block text-sm font-medium text-gray-700 mb-1">ููุชุฑุฉ ุจุงูุงุฎุชุจุงุฑ:</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <select id="statsExamFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"></select>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="self-end">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="updateStatsBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm">๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย<div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-semibold text-lg text-gray-800 mb-2">ููุฎุต ุงูุฃุฏุงุก</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div id="summary-stats" class="grid grid-cols-2 gap-4"></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="bg-gray-50 p-4 rounded-lg relative h-64">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-semibold text-lg text-gray-800 mb-2">ุชูุฒูุน ุงูุชูุฏูุฑุงุช</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <canvas id="grade-distribution-chart"></canvas>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg md:col-span-2 relative h-64">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-semibold text-lg text-gray-800 mb-2">ูุชูุณุท ุงูุฃุฏุงุก ุญุณุจ ุงููุตู</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <canvas id="class-performance-chart"></canvas>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>

ย ย ย ย ย ย ย ย ย ย ย ย <section id="settings" class="app-section">
ย ย ย ย ย ย ย ย <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
ย ย ย ย ย ย ย ย ย ย <h2 class="text-2xl font-bold text-gray-800 mb-6">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h2>
ย ย ย ย ย ย ย ย ย ย <div class="space-y-6">

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <h3 class="font-semibold text-lg text-gray-800 mb-4">ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ ููุชูุงุฑูุฑ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-admin" type="text" placeholder="ุฅุฏุงุฑุฉ ุงูุชุนููู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-school" type="text" placeholder="ุงููุฏุฑุณุฉ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-teacher" type="text" placeholder="ุงููุนูู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-director" type="text" placeholder="ุงููุฏูุฑ" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-year" type="text" placeholder="ุงูุนุงู ุงูุฏุฑุงุณู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input id="setting-semester" type="text" placeholder="ุงููุตู ุงูุฏุฑุงุณู" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="saveSettingsBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">ุญูุธ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-gray-50 p-4 rounded-lg">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<h3 class="font-semibold text-lg text-gray-800 mb-4">ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="flex flex-wrap gap-4">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <button id="backupBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐ฅ ูุณุฎ ุงุญุชูุงุทู ููุจูุงูุงุช</button>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <label for="restoreFile" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg font-medium text-sm cursor-pointer">๐ค ุงุณุชุนุงุฏุฉ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</label>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <input type="file" id="restoreFile" class="hidden" accept=".json">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย</div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="bg-red-50 p-4 rounded-lg border border-red-200">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<h3 class="font-semibold text-lg text-red-800 mb-2">ููุทูุฉ ุงูุฎุทุฑ</h3>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<p class="text-sm text-red-700 mb-4">ุณูุคุฏู ูุฐุง ุงูุฅุฌุฑุงุก ุฅูู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ุงูุชุทุจูู ุจุดูู ููุงุฆูุ ุจูุง ูู ุฐูู ุงูุทูุงุจุ ุงูููุงุฐุฌุ ูุงูุณุฌูุงุช.</p>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย<button id="clearAllDataBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">๐๏ธ ูุณุญ ุฌููุน ุจูุงูุงุช ุงูุชุทุจูู</button>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </section>
ย ย ย ย ย ย ยย ย ย ย ย ย <div id="printable-report-content" class="hidden print:block"></div>

ย ย ย ย </main>
ย ย </div>

ย ย <script>
ย ย ย ย // Global state variables
ย ย ย ย let correctAnswers = [];
ย ย ย ย let studentAnswers = [];
ย ย ย ย let stream = null;
ย ย ย ย let currentStudent = null;
ย ย ย ย let autoCaptureTimer = null;
ย ย ย ย let isScanningForKey = false;
ย ย ย ยย
ย ย ย ย // Data loaded from localStorage
ย ย ย ย let settings = {};
ย ย ย ย let studentsList = [];
ย ย ย ย let resultsHistory = [];
ย ย ย ย let detailedAnswersLog = [];
ย ย ย ย let answerKeyModels = {};
ย ย ย ยย
ย ย ย ย // Multi-correction state
ย ย ย ย let isMultipleCorrectionMode = false;
ย ย ย ย let multiCorrectionQueue = [];
ย ย ย ย let currentMultiIndex = 0;
ย ย ย ย let multiCorrectionResults = [];

ย ย ย ย // Chart instances
ย ย ย ย let gradeChart = null;
ย ย ย ย let classChart = null;

ย ย ย ย // === Safe localStorage Parsing ===
ย ย ย ย function getFromStorage(key, defaultValue) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const storedValue = localStorage.getItem(key);
ย ย ย ย ย ย ย ย if (storedValue === null || storedValue === undefined) return defaultValue;
ย ย ย ย ย ย ย ย // Attempt to parse only if it looks like JSON
ย ย ย ย ย ย ย ย if (storedValue.startsWith('{') || storedValue.startsWith('[')) {
ย ย ย ย ย ย ย ย ย ย ยtry { return JSON.parse(storedValue); } catch { return defaultValue; }
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย // Handle cases where non-JSON might be stored accidentally (shouldn't happen with current code)
ย ย ย ย ย ย ย ย console.warn(`Value for ${key} in localStorage is not valid JSON.`);
ย ย ย ย ย ย ย ย localStorage.removeItem(key); // Remove invalid data
ย ย ย ย ย ย ย ย return defaultValue;
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย console.error(`Error parsing ${key} from localStorage:`, e);
ย ย ย ย ย ย ย ย localStorage.removeItem(key);ย
ย ย ย ย ย ย ย ย return defaultValue;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // === Navigation & UI Initialization ===
ย ย ย ย function toggleSidebar() {
ย ย ย ย ย ย const sidebar = document.getElementById('sidebar');
ย ย ย ย ย ย const overlay = document.getElementById('sidebar-overlay');
ย ย ย ย ย ย if (sidebar && overlay) {
ย ย ย ย ย ย ย ย sidebar.classList.toggle('translate-x-full');
ย ย ย ย ย ย ย ย overlay.classList.toggle('hidden');
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function showSection(sectionId) {
ย ย ย ย ย ย ยconsole.log("Showing section:", sectionId);
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย document.querySelectorAll('.app-section').forEach(section => {
ย ย ย ย ย ย ย ย ย ย section.classList.remove('active');
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย const targetSection = document.getElementById(sectionId);
ย ย ย ย ย ย ย ย if (targetSection) {
ย ย ย ย ย ย ย ย ย ย targetSection.classList.add('active');
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ยconsole.error("Section not found:", sectionId);
ย ย ย ย ย ย ย ย ย ย ยdocument.getElementById('dashboard')?.classList.add('active');ย
ย ย ย ย ย ย ย ย }


ย ย ย ย ย ย ย ย document.querySelectorAll('.nav-link').forEach(link => {
ย ย ย ย ย ย ย ย ย ย link.classList.remove('active');
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย const targetLink = document.querySelector(`.nav-link[href="#${sectionId}"]`);
ย ย ย ย ย ย ย ย ยif(targetLink) targetLink.classList.add('active');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // --- Section specific actions ---
ย ย ย ย ย ย ย ย if (sectionId === 'correction') populateCorrectionStudentSelect();
ย ย ย ย ย ย ย ย if (sectionId === 'reports') populateReportFilters();
ย ย ย ย ย ย ย ย if (sectionId === 'stats') {
ย ย ย ย ย ย ย ย ย ย populateStatsFilters();ย
ย ย ย ย ย ย ย ย ย ย updateGlobalStats();ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย if (sectionId === 'students') displayStudentsList();ย
ย ย ย ย ย ย ย ย ยif (sectionId === 'history') populateHistoryFilters();ย


ย ย ย ย ย ย ย ย if (sectionId !== 'correction') document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (window.innerWidth < 768) {ย
ย ย ย ย ย ย ย ย ย ย toggleSidebar();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ยwindow.location.hash = sectionId; // Update hash for deep linking/refresh
ย ย ย ย ย ย } catch(e) {
ย ย ย ย ย ย ย ย ยconsole.error("Error in showSection:", e);
ย ย ย ย ย ย ย ย ยdocument.querySelectorAll('.app-section').forEach(section => section.classList.remove('active'));
ย ย ย ย ย ย ย ย ยdocument.getElementById('dashboard')?.classList.add('active');
ย ย ย ย ย ย ย ย ยdocument.querySelector(`.nav-link[href="#dashboard"]`)?.classList.add('active');
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย document.addEventListener('DOMContentLoaded', () => {
ย ย ย ย ย ย ยtry {
ย ย ย ย ย ย ย ย // Event Listeners Setup - More Robust
ย ย ย ย ย ย ย ย ยconst addSafeListener = (selector, event, handler) => {
ย ย ย ย ย ย ย ย ย ย ยconst element = document.querySelector(selector);
ย ย ย ย ย ย ย ย ย ย ยif (element) {
ย ย ย ย ย ย ย ย ย ย ย ย ยelement.addEventListener(event, handler);
ย ย ย ย ย ย ย ย ย ย ย} else {
ย ย ย ย ย ย ย ย ย ย ย ย ยconsole.warn(`Element not found for selector: ${selector}`);
ย ย ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย ย ย ย};

ย ย ย ย ย ย ย ย ยconst addSafeListenerById = (id, event, handler) => {
ย ย ย ย ย ย ย ย ย ย ยconst element = document.getElementById(id);
ย ย ย ย ย ย ย ย ย ย ยif (element) {
ย ย ย ย ย ย ย ย ย ย ย ย ยelement.addEventListener(event, handler);
ย ย ย ย ย ย ย ย ย ย ย} else {
ย ย ย ย ย ย ย ย ย ย ย ย ย console.warn(`Element not found for ID: ${id}`);
ย ย ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย ย ย ย};


ย ย ย ย ย ย ย ย document.querySelectorAll('.nav-link').forEach(link => {
ย ย ย ย ย ย ย ย ย ย link.addEventListener('click', (e) => {
ย ย ย ย ย ย ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย ย ย ย ย ย ย const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
ย ย ย ย ย ย ย ย ย ย ย ย if (sectionId) showSection(sectionId);
ย ย ย ย ย ย ย ย ย ย ย ย ยelse console.error("Invalid href for nav link:", e.currentTarget);
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย document.querySelectorAll('.quick-start-link').forEach(link => {
ย ย ย ย ย ย ย ย ย ย ยlink.addEventListener('click', (e) => {
ย ย ย ย ย ย ย ย ย ย ย ย e.preventDefault();
ย ย ย ย ย ย ย ย ย ย ย ย const sectionId = e.currentTarget.getAttribute('href')?.substring(1);
ย ย ย ย ย ย ย ย ย ย ย ย if (sectionId) showSection(sectionId);
ย ย ย ย ย ย ย ย ย ย ย ย ยelse console.error("Invalid href for quick start link:", e.currentTarget);
ย ย ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย addSafeListenerById('studentsList', 'click', (e) => {
ย ย ย ย ย ย ย ย ย ย if (e.target.classList.contains('select-student-btn')) {
ย ย ย ย ย ย ย ย ย ย ย ย const studentId = e.target.dataset.id;
ย ย ย ย ย ย ย ย ย ย ย ย ยif(studentId) selectStudent(studentId);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ยif (e.target.classList.contains('absent-btn')) {
ย ย ย ย ย ย ย ย ย ย ย ย ยconst studentId = e.target.dataset.id;
ย ย ย ย ย ย ย ย ย ย ย ย ยif(studentId) markAsAbsent(studentId);
ย ย ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย addSafeListenerById('menu-button', 'click', toggleSidebar);
ย ย ย ย ย ย ย ย addSafeListenerById('sidebar-overlay', 'click', toggleSidebar);
ย ย ย ย ย ย ย ย addSafeListenerById('toggle-instructions-btn', 'click', toggleInstructions);

ย ย ย ย ย ย ย ย addSafeListenerById('studentsFileInput', 'change', (e) => {
ย ย ย ย ย ย ย ย ย ย const file = e.target.files[0];
ย ย ย ย ย ย ย ย ย ย if (file) parseStudentsFile(file);
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย addSafeListenerById('imageInput', 'change', (e) => {
ย ย ย ย ย ย ย ย ย ย const file = e.target.files[0];
ย ย ย ย ย ย ย ย ย ย if (file) handleImageFile(file);
ย ย ย ย ย ย ย ย });

ย ย ย ย ย ย ย ย addSafeListenerById('answerKeyModel', 'change', switchModel);
ย ย ย ย ย ย ย ย addSafeListenerById('correctionStudentSelect', 'change', (e) => {
ย ย ย ย ย ย ย ย ย ย if(e.target.value) {
ย ย ย ย ย ย ย ย ย ย ย ย selectStudent(parseInt(e.target.value));
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย selectDifferentStudent();
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย addSafeListenerById('subjectName', 'input', updateModelData);
ย ย ย ย ย ย ย ย addSafeListenerById('examName', 'input', updateModelData);
ย ย ย ย ย ย ย ย addSafeListenerById('examDate', 'change', updateModelData);
ย ย ย ย ย ย ย ย addSafeListenerById('questionCount', 'change', showManualEntry);ย
ย ย ย ย ย ย ย ย addSafeListenerById('optionsCount', 'change', showManualEntry);ย

ย ย ย ย ย ย ย ย addSafeListenerById('multiCorrectionBtn', 'click', toggleMultipleCorrection);
ย ย ย ย ย ย ย ย addSafeListenerById('clearStudentsBtn', 'click', clearStudentsList);
ย ย ย ย ย ย ย ย addSafeListenerById('newModelBtn', 'click', () => manageModels('new'));
ย ย ย ย ย ย ย ย addSafeListenerById('renameModelBtn', 'click', () => manageModels('rename'));
ย ย ย ย ย ย ย ย addSafeListenerById('deleteModelBtn', 'click', () => manageModels('delete'));
ย ย ย ย ย ย ย ย addSafeListenerById('manualEntryBtn', 'click', showManualEntry);
ย ย ย ย ย ย ย ย addSafeListenerById('scanKeyBtn', 'click', scanAnswerKey);
ย ย ย ย ย ย ย ย addSafeListenerById('printSheetBtn', 'click', printBlankSheet);
ย ย ย ย ย ย ย ย addSafeListenerById('saveAnswersBtn', 'click', saveCorrectAnswers);
ย ย ย ย ย ย ย ย addSafeListenerById('showCameraBtn', 'click', showCameraSection);
ย ย ย ย ย ย ย ย addSafeListenerById('showUploadBtn', 'click', showUploadSection);
ย ย ย ย ย ย ย ย addSafeListenerById('stopCameraBtn', 'click', stopCamera);
ย ย ย ย ย ย ย ย addSafeListenerById('startMultiBtn', 'click', startMultipleCorrection);
ย ย ย ย ย ย ย ย addSafeListenerById('skipStudentBtn', 'click', skipCurrentStudent);
ย ย ย ย ย ย ย ย addSafeListenerById('stopMultiBtn', 'click', stopMultipleCorrection);
ย ย ย ย ย ย ย ย addSafeListenerById('exportMultiReportBtn', 'click', exportMultiReport);
ย ย ย ย ย ย ย ย addSafeListenerById('resetMultiBtn', 'click', resetMultiCorrection);
ย ย ย ย ย ย ย ย addSafeListenerById('confirmAnswersBtn', 'click', confirmAnswers);
ย ย ย ย ย ย ย ย addSafeListenerById('saveAndNewBtn', 'click', saveToHistory);
ย ย ย ย ย ย ย ย addSafeListenerById('exportResultBtn', 'click', exportResults);
ย ย ย ย ย ย ย ย addSafeListenerById('exportAllResultsBtn', 'click', exportAllResults);
ย ย ย ย ย ย ย ย addSafeListenerById('clearHistoryBtn', 'click', clearHistory);
ย ย ย ย ย ย ย ย addSafeListenerById('exportDetailedLogBtn', 'click', exportDetailedAnswersLog);
ย ย ย ย ย ย ย ย addSafeListenerById('generateReportBtn', 'click', generateClassReport);
ย ย ย ย ย ย ย ย addSafeListenerById('saveSettingsBtn', 'click', saveSettings);
ย ย ย ย ย ย ย ย addSafeListenerById('backupBtn', 'click', backupData);
ย ย ย ย ย ย ย ย addSafeListenerById('clearAllDataBtn', 'click', clearAllData);
ย ย ย ย ย ย ย ย addSafeListenerById('restoreFile', 'change', restoreData);
ย ย ย ย ย ย ย ย addSafeListenerById('searchStudentName', 'keyup', filterStudentsList);
ย ย ย ย ย ย ย ย addSafeListenerById('filterClass', 'change', filterStudentsList);
ย ย ย ย ย ย ย ย addSafeListenerById('filterStatus', 'change', filterStudentsList);
ย ย ย ย ย ย ย ย addSafeListenerById('changeCorrectionStudentBtn', 'click', selectDifferentStudent);
ย ย ย ย ย ย ย ย addSafeListenerById('filterHistoryBtn', 'click', updateHistoryDisplay);
ย ย ย ย ย ย ย ย addSafeListenerById('updateStatsBtn', 'click', updateGlobalStats);

ย ย ย ย ย ย ย ย ยconst examDateInput = document.getElementById('examDate');
ย ย ย ย ย ย ย ย ยif(examDateInput) examDateInput.valueAsDate = new Date();

ย ย ย ย ย ย ย ย loadInitialUI();

ย ย ย ย ย ย ย} catch(e) {
ย ย ย ย ย ย ย ย ย console.error("Error during DOMContentLoaded setup:", e);
ย ย ย ย ย ย ย ย ย alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุชุทุจูู. ูุฏ ุชุญุชุงุฌ ุฅูู ุชุญุฏูุซ ุงูุตูุญุฉ.");
ย ย ย ย ย ย ย}
ย ย ย ย });


ย ย ย ย function loadInitialUI() {
ย ย ย ย ย ย ยconsole.log("Loading initial UI...");
ย ย ย ย ย ย settings = getFromStorage('appSettings', {});
ย ย ย ย ย ย studentsList = getFromStorage('studentsList', []);
ย ย ย ย ย ย // Ensure status property exists, default to 'pending' if missing
ย ย ย ย ย ย studentsList = studentsList.map(s => ({ ...s, status: s.status || 'pending' }));ย
ย ย ย ย ย ย resultsHistory = getFromStorage('examResults', []);
ย ย ย ย ย ย detailedAnswersLog = getFromStorage('detailedAnswersLog', []);
ย ย ย ย ย ย answerKeyModels = getFromStorage('answerKeyModels', {});
ย ย ย ย ย ยย
ย ย ย ย ย ย loadSettings();

ย ย ย ย ย ย if (Object.keys(answerKeyModels).length === 0) {
ย ย ย ย ย ย ย ย answerKeyModels['ูููุฐุฌ ุฃ'] = { name: "ูููุฐุฌ ุฃ", subject: "", examName: "", examDate: new Date().toISOString().split('T')[0], answers: [] };
ย ย ย ย ย ย ย ย ยlocalStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels)); // Save default if empty
ย ย ย ย ย ย }
ย ย ย ย ย ย updateModelsDropdown();ย
ย ย ย ย ย ยย
ย ย ย ย ย ย if (studentsList.length > 0) {
ย ย ย ย ย ย ย ย ยdisplayStudentsList();
ย ย ย ย ย ย ย} else {
ย ย ย ย ย ย ย ย ยdocument.getElementById('studentsListSection')?.classList.add('hidden');
ย ย ย ย ย ย ย}
ย ย ย ย ย ยย
ย ย ย ย ย ย if (resultsHistory.length > 0) {
ย ย ย ย ย ย ย ย updateHistoryDisplay();
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ยdocument.getElementById('historySection')?.classList.add('hidden');
ย ย ย ย ย ย ย ย ยdocument.getElementById('historyFilters')?.classList.add('hidden');
ย ย ย ย ย ย }
ย ย ย ย ย ย if (detailedAnswersLog.length > 0) document.getElementById('detailedHistorySection')?.classList.remove('hidden');
ย ย ย ย ย ย ยelse {
ย ย ย ย ย ย ย ย ยdocument.getElementById('detailedHistorySection')?.classList.add('hidden');
ย ย ย ย ย ย ย}
ย ย ย ย ย ย ยconst initialSection = window.location.hash ? window.location.hash.substring(1) : 'dashboard';
ย ย ย ย ย ย ย// Validate initialSection before showing
ย ย ย ย ย ย ยconst validSections = ['dashboard', 'students', 'answer-key', 'correction', 'history', 'reports', 'stats', 'settings'];
ย ย ย ย ย ย ยshowSection(validSections.includes(initialSection) ? initialSection : 'dashboard');
ย ย ย ย ย ย ยconsole.log("Initial UI Load Complete.");
ย ย ย ย }
ย ย ย ยย
ย ย ย ย function toggleInstructions() {
ย ย ย ย ย ย const content = document.getElementById('instructions-content');
ย ย ย ย ย ย const arrow = document.getElementById('instructions-arrow');
ย ย ย ย ย ย if(!content || !arrow) return;
ย ย ย ย ย ย if (content.style.maxHeight && content.style.maxHeight !== '0px') {
ย ย ย ย ย ย ย ย content.style.maxHeight = null;
ย ย ย ย ย ย ย ย arrow.textContent = 'โผ';
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย content.style.maxHeight = content.scrollHeight + "px";
ย ย ย ย ย ย ย ย arrow.textContent = 'โฒ';
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย function showNotification(message, type = 'info') {
ย ย ย ย ย ย const notification = document.createElement('div');
ย ย ย ย ย ย notification.className = `fixed top-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg text-white shadow-lg z-50 text-center ${
ย ย ย ย ย ย ย ย type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
ย ย ย ย ย ย }`;
ย ย ย ย ย ย notification.textContent = message;
ย ย ย ย ย ย document.body.appendChild(notification);
ย ย ย ย ย ย setTimeout(() => {ย
ย ย ย ย ย ย ย ย ยif(notification && document.body.contains(notification)) {
ย ย ย ย ย ย ย ย ย ย ยdocument.body.removeChild(notification);ย
ย ย ย ย ย ย ย ย ย}
ย ย ย ย ย ย }, 3000);
ย ย ย ย }

ย ย ย ย function handleImageFile(file) {
ย ย ย ย ย ย const reader = new FileReader();
ย ย ย ย ย ย reader.onload = (e) => {
ย ย ย ย ย ย ย ย const capturedImage = document.getElementById('capturedImage');
ย ย ย ย ย ย ย ย const verificationContainer = document.getElementById('verificationContainer');
ย ย ย ย ย ย ย ย if(!capturedImage || !verificationContainer) return;

ย ย ย ย ย ย ย ย capturedImage.src = e.target.result;
ย ย ย ย ย ย ย ย verificationContainer.classList.remove('hidden');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ยprocessAnswers(e.target.result);
ย ย ย ย ย ย };
ย ย ย ย ย ย reader.onerror = (e) => {
ย ย ย ย ย ย ย ย ยconsole.error("FileReader error:", e);
ย ย ย ย ย ย ย ย ยshowNotification("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงูุตูุฑุฉ.", "error");
ย ย ย ย ย ย };
ย ย ย ย ย ย if (typeof file === 'string') {
ย ย ย ย ย ย ย ย ยreader.readAsDataURL(dataURItoBlob(file));
ย ย ย ย ย ย } else if (file instanceof Blob) {
ย ย ย ย ย ย ย ย reader.readAsDataURL(file);
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ยconsole.error("Invalid file type passed to handleImageFile:", file);
ย ย ย ย ย ย ย ย ยshowNotification("ููุน ููู ุบูุฑ ุตุงูุญ.", "error");
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ยย
ย ย ย ย function dataURItoBlob(dataURI) {
ย ย ย ย ย ย try {
ย ย ย ย ย ย ย ย const byteString = atob(dataURI.split(',')[1]);
ย ย ย ย ย ย ย ย const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
ย ย ย ย ย ย ย ย const ab = new ArrayBuffer(byteString.length);
ย ย ย ย ย ย ย ย const ia = new Uint8Array(ab);
ย ย ย ย ย ย ย ย for (let i = 0; i < byteString.length; i++) {
ย ย ย ย ย ย ย ย ย ย ia[i] = byteString.charCodeAt(i);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย return new Blob([ab], {type: mimeString});
ย ย ย ย ย ย } catch (e) {
ย ย ย ย ย ย ย ย ยconsole.error("Error converting data URI to Blob:", e);
ย ย ย ย ย ย ย ย ยshowNotification("ุฎุทุฃ ูู ุชุญููู ุงูุตูุฑุฉ.", "error");
ย ย ย ย ย ย ย ย ยreturn null;
ย ย ย ย ย ย }
ย ย ย ย }


ย ย ย ย // === Student Management ===
ย ย ย ย function downloadStudentsTemplate() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function parseStudentsFile(file) { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function displayStudentsList() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function updateStudentsStats() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function updateClassFilter() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function filterStudentsList() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function selectStudent(studentId) { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function markAsAbsent(studentId) { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function selectDifferentStudent() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function populateCorrectionStudentSelect() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function clearStudentsList() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }

ย ย ย ย // === Answer Key Models Management ===
ย ย ย ย function updateModelsDropdown() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function switchModel() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function manageModels(action) { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function showManualEntry() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function scanAnswerKey() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function generateAnswerSheet() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function saveCorrectAnswers() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }
ย ย ย ย function updateModelData() { /* ... (ุงูููุฏ ุงูุฃุตูู) ... */ }


ย ย ย ย // === Camera and Image Processing (ุงูููุฏ ุงูุฃุตูู ูุน ุงูุชุนุฏููุงุช) ===
ย ย ย ย 
        // ุงูุชุนุฏูู: ุชุทุจูู ูููุฏ ุงููุงููุฑุง ูุงูุชุฑููุฒ ุงูุชููุงุฆู
        async function showCameraSection() {
            stopCamera(); // ุฅููุงู ุฃู ุชูุงุฑ ุณุงุจู

            try {
                // ุทูุจ ุฃุนูู ุฏูุฉ ููููุฉ ูุงูุชุฑููุฒ ุงูุชููุงุฆู ุงููุณุชูุฑ
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // ุงููุงููุฑุง ุงูุฎูููุฉ
                        width: { ideal: 4096 },   // ูุญุงููุฉ ุงูุญุตูู ุนูู ุฏูุฉ ุนุงููุฉ
                        height: { ideal: 2160 },
                        advanced: [{ focusMode: "continuous" }, { zoom: 1.0 }] // ุทูุจ ุงูุชุฑููุฒ ุงูุชููุงุฆู
                    } 
                });

                const videoElement = document.getElementById('camera');
                if(videoElement) videoElement.srcObject = stream;
                
                document.getElementById('cameraSection')?.classList.remove('hidden');
                document.getElementById('uploadSection')?.classList.add('hidden');
                
                // ุงูุชุนุฏูู: ุฅุดุนุงุฑ ุชูุฌููู ูููุณุชุฎุฏู
                showNotification('ูุฑุฌู ุงูุชุฃูุฏ ูู ุฃู ุงููุฑูุฉ ุฏุงุฎู ุงูุฅุทุงุฑ ุงูุจุฑุชูุงูู ูุงูุชุฑููุฒ ูุงุถุญ. ุณูุจุฏุฃ ุงูุนุฏ ุงูุชูุงุฒูู.', 'info');

                // ุงูุชุนุฏูู: ุชุฃุฎูุฑ ููุณูุงุญ ูููุงููุฑุง ุจุงูุชุฑููุฒ ูุจู ุจุฏุก ุงูุนุฏ ุงูุชูุงุฒูู
                setTimeout(startAutoCapture, 1000); 

            } catch (error) {
                console.error("Camera access error:", error);
                showNotification('ูุง ูููู ุงููุตูู ูููุงููุฑุง. ุชุฃูุฏ ูู ููุญ ุงูุฅุฐู.', 'error');
            }
        }

ย ย ย ย function startAutoCapture() {
ย ย ย ย ย ย const countdownEl = document.getElementById('countdown');
ย ย ย ย ย ย if(!countdownEl) return;
ย ย ย ย ย ย let count = 3;
ย ย ย ย ย ย countdownEl.textContent = count;
ย ย ย ย ย ย countdownEl.style.display = 'block';

ย ย ย ย ย ย if(autoCaptureTimer) clearInterval(autoCaptureTimer);

ย ย ย ย ย ย autoCaptureTimer = setInterval(() => {
ย ย ย ย ย ย ย ย count--;
ย ย ย ย ย ย ย ย ยif(countdownEl) countdownEl.textContent = count;
ย ย ย ย ย ย ย ย if (count <= 0) {
ย ย ย ย ย ย ย ย ย ย clearInterval(autoCaptureTimer);
ย ย ย ย ย ย ย ย ย ย ยif(countdownEl) countdownEl.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย captureAndProcess();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, 1000);
ย ย ย ย }

ย ย ย ย function stopCamera() {
ย ย ย ย ย ย if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
ย ย ย ย ย ย if(autoCaptureTimer) clearInterval(autoCaptureTimer);
ย ย ย ย ย ย const countdownEl = document.getElementById('countdown');
ย ย ย ย ย ย if(countdownEl) countdownEl.style.display = 'none';
ย ย ย ย ย ย document.getElementById('cameraSection')?.classList.add('hidden');
ย ย ย ย ย ย document.getElementById('capturedSection')?.classList.add('hidden');
ย ย ย ย }

ย ย ย ย function captureAndProcess() {
ย ย ย ย ย ย const video = document.getElementById('camera');
ย ย ย ย ย ย const canvas = document.getElementById('canvas');
ย ย ย ย ย ย if(!video || !canvas || video.readyState !== 4) {
ย ย ย ย ย ย ย ย ยconsole.warn("Video not ready for capture. Retrying in 1s.");
ย ย ย ย ย ย ย ย ยif(stream) setTimeout(startAutoCapture, 1000);ย
ย ย ย ย ย ย ย ย ยreturn;
ย ย ย ย ย ย ย}
ย ย ย ย ย ย canvas.width = video.videoWidth; canvas.height = video.videoHeight;
ย ย ย ย ย ย canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
ย ย ย ย ย ยย
ย ย ย ย ย ย clearInterval(autoCaptureTimer);
ย ย ย ย ย ยย
ย ย ย ย ย ย if (isScanningForKey) {
ย ย ย ย ย ย ย ย ยstopCamera();
ย ย ย ย ย ย }

ย ย ย ย ย ย handleImageFile(canvas.toDataURL('image/jpeg'));
ย ย ย ย }

ย ย ย ย function showUploadSection() {
ย ย ย ย ย ย stopCamera();
ย ย ย ย ย ย document.getElementById('uploadSection')?.classList.remove('hidden');
ย ย ย ย ย ย document.getElementById('cameraSection')?.classList.add('hidden');
ย ย ย ย }
ย ย ย ยย
ย ย ย ย ย/**
ย ย ย ย ย * ุงููุธููุฉ ุงูุฑุฆูุณูุฉ ูุชุญููู ุงูุตูุฑุฉ ุฅูุง ูุฅุฌุงุจุงุช ุงูุทุงูุจ ุฃู ููููุฐุฌ ุงูุฅุฌุงุจุฉ.
ย ย ย ย ย */
ย ย ย ย async function processAnswers(imageDataUrl) {
ย ย ย ย ย ย const modelName = document.getElementById('answerKeyModel')?.value;
ย ย ย ย ย ย correctAnswers = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName].answers : [];

ย ย ย ย ย ย if (correctAnswers.length === 0 && !isScanningForKey) {
ย ย ย ย ย ย ย ย showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ูุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ุฃููุงู.', 'error'); return;
ย ย ย ย ย ย }
ย ย ย ย ย ย if (!currentStudent && !isMultipleCorrectionMode && !isScanningForKey) {
ย ย ย ย ย ย ย ย showNotification('ูุฑุฌู ุงุฎุชูุงุฑ ุทุงูุจ ุฃููุงู.', 'error'); return;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย document.getElementById('verificationContainer')?.classList.remove('hidden');
ย ย ย ย ย ยย
ย ย ย ย ย ย showNotification('ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ ุจูุงุณุทุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู... (ูุฑุฌู ุงูุงูุชุธุงุฑ)', 'info');

ย ย ย ย ย ย try {
// Extract base64 part
            const base64Image = imageDataUrl.split(',')[1];
            
            const payload = {
                image_base64: base64Image,
                num_questions: document.getElementById('questionCount')?.value || correctAnswers.length,
                options_per_q: document.getElementById('optionsCount')?.value || 4,
                correct_answers: isScanningForKey ? [] : correctAnswers
            };


            // --- ุงุณุชุฏุนุงุก ุฎุงุฏู ุงูุชุญููู ุงูุฎุงุฑุฌู (Python Backend) ---
            const response = await fetch('/api/correct', { 
                method: 'POST', 
                // *** ุงูุชุนุฏูู ุงูุฑุฆูุณู: ุฅุถุงูุฉ ุฑุฃุณ Content-Type ***
                headers: { 
                    'Content-Type': 'application/json' 
                },
                // *** ุชุญููู ุญูููุฉ ุงูุจูุงูุงุช ุฅูู JSON String ***
                body: JSON.stringify(payload)
            });
            const data = await response.json();
			
ย ย ย ย ย ย ย ย // --- ููุงูุฉ ุงูุงุณุชุฏุนุงุก ---

ย ย ย ย ย ย ย ย if (!data.success) throw new Error(data.error || 'ูุดู ูู ุงูุชุญููู ูู ุงูุฎุงุฏู');
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย if (isScanningForKey) {
ย ย ย ย ย ย ย ย ย ย isScanningForKey = false;
ย ย ย ย ย ย ย ย ย ย const scannedAnswers = data.answers;
ย ย ย ย ย ย ย ย ย ย const questionCount = parseInt(document.getElementById('questionCount')?.value || 0);
ย ย ย ย ย ย ย ย ย ย for (let i = 0; i < questionCount; i++) {
ย ย ย ย ย ย ย ย ย ย ย ย const select = document.getElementById(`answer${i + 1}`);
ย ย ย ย ย ย ย ย ย ย ย ย if (select && scannedAnswers[i]) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย select.value = scannedAnswers[i] === 'Blank' ? 'A' : scannedAnswers[i];
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย showNotification('ุชู ูุณุญ ุงูุฅุฌุงุจุงุช ุจูุฌุงุญ. ูุฑุฌู ูุฑุงุฌุนุชูุง ุซู ุงูุญูุธ.', 'success');
ย ย ย ย ย ย ย ย ย ย showManualEntry();
ย ย ย ย ย ย ย ย ย ย showSection('answer-key');

ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย studentAnswers = data.answers;
ย ย ย ย ย ย ย ย ย ย showAnswerVerification();
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } catch (err) {
ย ย ย ย ย ย ย ย console.error("Error processing answers:", err);
ย ย ย ย ย ย ย ย showNotification(`ูุดู ุชุญููู ุงูุตูุฑุฉ: ${err.message}`, 'error');
ย ย ย ย ย ย ย ย resetForNewSheet();
ย ย ย ย ย ย }
ย ย ย ย 

// === Verification and Results ===
function showAnswerVerification() {
    const verificationGrid = document.getElementById('verificationGrid');
    const optionsCountSelect = document.getElementById('optionsCount');
    if(!verificationGrid || !optionsCountSelect || !Array.isArray(correctAnswers)) {
        console.error("Cannot show verification: grid, select, or correctAnswers missing/invalid.");
        return;
    }
    if (correctAnswers.length === 0) {
        showNotification("ูุง ููุฌุฏ ูููุฐุฌ ุฅุฌุงุจุฉ ููุฐุง ุงูุนุฏุฏ ูู ุงูุฃุณุฆูุฉ. ูุฑุฌู ุงูุฅุนุฏุงุฏ ุฃููุงู.", "error");
        resetForNewSheet();
        return;
    }

    const optionsCount = parseInt(optionsCountSelect.value);
    const options = Array.from({ length: optionsCount }, (_, i) => String.fromCharCode(65 + i));
    verificationGrid.innerHTML = '';
    
    // ุชุฃูุฏ ูู ุฃู studentAnswers ูุฏูู ุทูู ููุงุณุจ
    while (studentAnswers.length < correctAnswers.length) {
        studentAnswers.push('Blank');
    }

    for (let i = 0; i < correctAnswers.length; i++) {
        const answer = studentAnswers[i] || 'Blank';
        verificationGrid.innerHTML += `
            <div class="bg-gray-50 p-3 rounded-lg text-center">
                <label class="block text-sm font-medium text-gray-700 mb-2">ุณ ${i + 1}</label>
                <select id="verify${i}" class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    <option value="Blank" ${answer === 'Blank' ? 'selected' : ''}>ูุฑุงุบ</option>
                    ${options.map(opt => `<option value="${opt}" ${opt === answer ? 'selected' : ''}>${opt}</option>`).join('')}
                    ${!options.includes(answer) && answer !== 'Blank' ? `<option value="${answer}" selected>${answer} (ุบุฑูุจ)</option>` : ''}
                </select>
            </div>`;
    }
    document.getElementById('verificationSection')?.classList.remove('hidden');
}


function confirmAnswers() {
    // ูุฑุงุกุฉ ุงูุฅุฌุงุจุงุช ูู ูุงุฆูุฉ ุงูุชุญูู ูุฏููุงู (ูุชุถููู ุฃู ุชุนุฏููุงุช ูุงู ุจูุง ุงููุณุชุฎุฏู)
    studentAnswers = Array.from({ length: correctAnswers.length }, (_, i) => {
        const select = document.getElementById(`verify${i}`);
        return select ? select.value : 'Blank';
    });
    document.getElementById('verificationContainer')?.classList.add('hidden');
    displayResults();
}

function displayResults() {
    if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
        console.error("Cannot display results without correct answers.");
        return;
    }
    let correctCount = 0;
    const detailedResults = document.getElementById('detailedResults');
    if(!detailedResults) return;

    detailedResults.innerHTML = '';
    for (let i = 0; i < correctAnswers.length; i++) {
        const sAnswer = studentAnswers[i] !== undefined ? studentAnswers[i] : 'Blank';
        const displayAnswer = sAnswer === 'Blank' ? 'ูุฑุงุบ' : sAnswer;
        const isCorrect = sAnswer === correctAnswers[i];
        if (isCorrect) correctCount++;
        detailedResults.innerHTML += `
            <div class="p-3 rounded-lg text-white text-center font-medium ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                <div class="text-sm">ุณ ${i + 1}</div>
                <div class="text-lg">${displayAnswer || 'โ'}</div>
                <div class="text-xs">${isCorrect ? 'โ' : `โ (${correctAnswers[i]})`}</div>
            </div>`;
    }
    const wrongCount = correctAnswers.length - correctCount;
    const percentage = correctAnswers.length > 0 ? Math.round((correctCount / correctAnswers.length) * 100) : 0;
    
    document.getElementById('correctCount').textContent = correctCount;
    document.getElementById('wrongCount').textContent = wrongCount;
    document.getElementById('scorePercentage').textContent = `${percentage}%`;
    document.getElementById('letterGrade').textContent = getLetterGrade(percentage);
    
    const studentForDisplay = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
    if (!studentForDisplay) {
        console.error("No student selected for displaying results.");
        return;
    }
    const modelName = document.getElementById('answerKeyModel')?.value;
    const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};

    document.getElementById('resultStudentName').textContent = studentForDisplay.name;
    document.getElementById('resultStudentClass').textContent = studentForDisplay.class;
    document.getElementById('resultExamName').textContent = modelData.examName || 'ุบูุฑ ูุญุฏุฏ';
    document.getElementById('resultExamDate').textContent = modelData.examDate || '';
    document.getElementById('resultsSection')?.classList.remove('hidden');
}

function getLetterGrade(percentage) {
    if (percentage >= 90) return 'ููุชุงุฒ';
    if (percentage >= 80) return 'ุฌูุฏ ุฌุฏุงู';
    if (percentage >= 70) return 'ุฌูุฏ';
    if (percentage >= 60) return 'ููุจูู';
    return 'ุถุนูู'; 
}

function saveToHistory() {
    const studentForHistory = isMultipleCorrectionMode ? multiCorrectionQueue[currentMultiIndex] : currentStudent;
    if (!studentForHistory) {
        showNotification("ูุง ููุฌุฏ ุทุงูุจ ูุญุฏุฏ ูุญูุธ ุงููุชูุฌุฉ.", "error");
        return;
    }
    if (!Array.isArray(correctAnswers) || correctAnswers.length === 0) {
        showNotification("ูุง ูููู ุญูุธ ูุชูุฌุฉ ุจุฏูู ูููุฐุฌ ุฅุฌุงุจุฉ ุตุญูุญ.", "error");
        return;
    }
    const correctCount = parseInt(document.getElementById('correctCount')?.textContent || '0');
    const totalQuestions = correctAnswers.length;
    const modelName = document.getElementById('answerKeyModel')?.value;
    const modelData = (modelName && answerKeyModels[modelName]) ? answerKeyModels[modelName] : {};
    const result = {
        id: Date.now(), studentName: studentForHistory.name, studentClass: studentForHistory.class,
        examName: modelData.examName || 'ุบูุฑ ูุญุฏุฏ', examDate: modelData.examDate || '',
        score: `${correctCount}/${totalQuestions}`,
        percentage: document.getElementById('scorePercentage')?.textContent || '0%',
        grade: document.getElementById('letterGrade')?.textContent || '-',
    };
    const finalStudentAnswers = Array.from({ length: totalQuestions }, (_, i) => studentAnswers[i] || 'Blank');
    const detailedResult = { ...result, answers: finalStudentAnswers };

    resultsHistory.unshift(result); detailedAnswersLog.unshift(detailedResult);
    localStorage.setItem('examResults', JSON.stringify(resultsHistory));
    localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
    updateHistoryDisplay();
    document.getElementById('detailedHistorySection')?.classList.remove('hidden');
    
    const studentIndex = studentsList.findIndex(s => s.id === studentForHistory.id);
    if (studentIndex !== -1) {
        studentsList[studentIndex].status = 'corrected';
        studentsList[studentIndex].result = { percentage: result.percentage, score: result.score };
        localStorage.setItem('studentsList', JSON.stringify(studentsList));
        displayStudentsList();
    }
    if (isMultipleCorrectionMode) {
        handleMultiCorrectionNext(result);
    } else {
        resetForNewSheet();
    }
}

function resetForNewSheet() {
    document.getElementById('resultsSection')?.classList.add('hidden');
    document.getElementById('verificationContainer')?.classList.add('hidden');
    selectDifferentStudent();
    showNotification('ุชู ุงูุญูุธ! ููููู ุงูุขู ุชุตุญูุญ ูุฑูุฉ ุฌุฏูุฏุฉ.', 'success');
    
    if (stream) {
        // ุฅุนุงุฏุฉ ุชุดุบูู ุงููุงููุฑุง ูุงูุนุฏ ุงูุชูุงุฒูู ุจุนุฏ ุงูุญูุธ ุงูุชููุงุฆู
        stopCamera();
        showCameraSection();
    } else {
        document.getElementById('uploadOptions')?.classList.remove('hidden');
    }
}

// ----------------------------------------------------
// === History Management ===
// ----------------------------------------------------

function populateHistoryFilters() {
    const classFilter = document.getElementById('historyClassFilter');
    const examFilter = document.getElementById('historyExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    const historySection = document.getElementById('historySection');
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const historyFiltersDiv = document.getElementById('historyFilters');


    if(!historyList || !historySection || !historyFiltersDiv) return;
    
    historyFiltersDiv.classList.toggle('hidden', resultsHistory.length === 0);

    const filteredHistory = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );


    historySection.classList.toggle('hidden', resultsHistory.length === 0); 
    if (filteredHistory.length === 0 && resultsHistory.length > 0) { 
        historyList.innerHTML = '<p class="text-center text-gray-500 py-4">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุชุทุงุจู ุงูููุชุฑ ุงููุญุฏุฏ.</p>';
    } else if (filteredHistory.length === 0 && resultsHistory.length === 0){
        historyList.innerHTML = ''; 
    } else {
        historyList.innerHTML = filteredHistory.map(r => `
            <div class="bg-gray-50 rounded-lg p-3 border-r-4 border-blue-500">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold">${r.studentName}</h4>
                        <p class="text-sm text-gray-600">${r.examName || 'ุงุฎุชุจุงุฑ ุบูุฑ ูุณูู'} - ${r.examDate || 'ุจุฏูู ุชุงุฑูุฎ'}</p>
                    </div>
                    <div class="text-left">
                        <div class="text-lg font-bold text-blue-600">${r.percentage || '0%'}</div>
                        <div class="text-sm font-semibold text-gray-700">(${r.score || '0/0'})</div>
                        <div class="text-xs text-gray-600">${r.grade || '-'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

function exportResults() {
    const studentName = document.getElementById('resultStudentName')?.textContent;
    const percentage = document.getElementById('scorePercentage')?.textContent;
    if (!studentName || !percentage) return;
    const report = `ูุชูุฌุฉ ุงูุทุงูุจ: ${studentName}\nุงููุณุจุฉ: ${percentage}`;
    const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `ูุชูุฌุฉ_${studentName}.txt`; a.click(); URL.revokeObjectURL(url);
}

function exportAllResults() {
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const filteredHistory = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );
    if (filteredHistory.length === 0) {
        showNotification("ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ ููููุชุฑ ูุชุตุฏูุฑูุง.", "info");
        return;
    }
    try {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(filteredHistory);
        XLSX.utils.book_append_sheet(wb, ws, 'ุณุฌู ุงููุชุงุฆุฌ');
        XLSX.writeFile(wb, 'ุณุฌู_ุงููุชุงุฆุฌ_ุงููููุชุฑ.xlsx');
    } catch(e) {
        console.error("Error exporting filtered results:", e);
        showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ููุฎุต ุงููุชุงุฆุฌ.", "error");
    }
}

function exportDetailedAnswersLog() {
    const classFilter = document.getElementById('historyClassFilter')?.value;
    const examFilter = document.getElementById('historyExamFilter')?.value;
    const filteredLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );

    if (filteredLogs.length === 0) { 
        showNotification("ูุง ููุฌุฏ ุณุฌู ููุตู ูุทุงุจู ููููุชุฑ ูุชุตุฏูุฑู.", "info"); 
        return; 
    }
    try {
        const maxQuestions = Math.max(0, ...filteredLogs.map(log => log.answers?.length || 0));
        const headers = ['ุงุณู ุงูุทุงูุจ', 'ุงููุตู', 'ุงุณู ุงูุงุฎุชุจุงุฑ', 'ุงูุชุงุฑูุฎ', 'ุงูุฏุฑุฌุฉ'];
        for(let i=1; i<= maxQuestions; i++) { headers.push(`ุณ${i}`); }
        const data = filteredLogs.map(log => {
            const row = {'ุงุณู ุงูุทุงูุจ': log.studentName, 'ุงููุตู': log.studentClass, 'ุงุณู ุงูุงุฎุชุจุงุฑ': log.examName, 'ุงูุชุงุฑูุฎ': log.examDate, 'ุงูุฏุฑุฌุฉ': log.score };
            (log.answers || []).forEach((ans, i) => { row[`ุณ${i+1}`] = ans; });
            return row;
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data, {header: headers});
        XLSX.utils.book_append_sheet(wb, ws, 'ุณุฌู ุฅุฌุงุจุงุช ุงูุทูุงุจ');
        XLSX.writeFile(wb, 'ุณุฌู_ุฅุฌุงุจุงุช_ุงูุทูุงุจ_ุงูููุตู_ุงููููุชุฑ.xlsx');
    } catch(e) {
        console.error("Error exporting filtered detailed log:", e);
        showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ุณุฌู ุงูุฅุฌุงุจุงุช.", "error");
    }
}


function clearHistory() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุงูุณุฌูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) {
        resultsHistory = []; detailedAnswersLog = [];
        localStorage.removeItem('examResults');
        localStorage.removeItem('detailedAnswersLog');
        updateHistoryDisplay();
        document.getElementById('detailedHistorySection')?.classList.add('hidden');
    }
}

// ----------------------------------------------------
// === Multiple Correction Logic ===
// ----------------------------------------------------

function toggleMultipleCorrection() {
    const uncorrected = studentsList.filter(s => s.status === 'pending');
    if (uncorrected.length === 0) { showNotification('ุฌููุน ุงูุทูุงุจ ุชู ุชุตุญูุญ ุฃูุฑุงููู!', 'info'); return; }
    const multiSection = document.getElementById('multipleCorrectionSection');
    if(multiSection) multiSection.classList.toggle('hidden');
    selectDifferentStudent(); // Clear single selection
    showSection('correction');
}

function startMultipleCorrection() {
    multiCorrectionQueue = studentsList.filter(s => s.status === 'pending');
    if (multiCorrectionQueue.length === 0) { showNotification('ูุง ุชูุฌุฏ ุฃูุฑุงู ูู ุงูุชุธุงุฑ ุงูุชุตุญูุญ!', 'error'); return; }
    const modelName = document.getElementById('answerKeyModel')?.value;
    if (!modelName || !answerKeyModels[modelName] || answerKeyModels[modelName].answers.length === 0) { 
        showNotification('ูุฑุฌู ุฅุนุฏุงุฏ ูุญูุธ ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ ูููููุฐุฌ ุงูุญุงูู ุฃููุงู!', 'error'); 
        return; 
    }
    isMultipleCorrectionMode = true; currentMultiIndex = 0; multiCorrectionResults = [];
    document.getElementById('multiCorrectionSetup')?.classList.add('hidden');
    document.getElementById('multiCorrectionActive')?.classList.remove('hidden');
    showCurrentMultiStudent();
    showNotification(`ุจุฏุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ ูู ${multiCorrectionQueue.length} ุทุงูุจ.`, 'success');
}

function showCurrentMultiStudent() {
    if(currentMultiIndex >= multiCorrectionQueue.length) {
        completeMultipleCorrection();
        return;
    }
    const student = multiCorrectionQueue[currentMultiIndex];
    document.getElementById('multiStudentName').textContent = student.name;
    document.getElementById('multiStudentClass').textContent = student.class;
    document.getElementById('currentStudentNumber').textContent = currentMultiIndex + 1;
    updateMultiCorrectionProgress();
    
    if(!stream) {
        showCameraSection();
    } else {
        startAutoCapture(); // ุฅุนุงุฏุฉ ุชุดุบูู ุงูุงูุชูุงุท ุงูุชููุงุฆู
    }
}

function updateMultiCorrectionProgress() {
    if(multiCorrectionQueue.length === 0) return;
    const progress = ((currentMultiIndex) / multiCorrectionQueue.length) * 100;
    document.getElementById('progressText').textContent = `${currentMultiIndex} ูู ${multiCorrectionQueue.length}`;
    document.getElementById('progressBar').style.width = `${progress}%`;
}

function handleMultiCorrectionNext(result) {
    multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'completed', result });
    currentMultiIndex++;
    if (currentMultiIndex < multiCorrectionQueue.length) {
        showCurrentMultiStudent(); // Display next student info
        resetForNewSheet(); 
        showNotification(`ุชู ุญูุธ ุงููุชูุฌุฉ. ุงูุชูู ููุทุงูุจ ุงูุชุงูู: ${multiCorrectionQueue[currentMultiIndex].name}`, 'info');
    } else {
        completeMultipleCorrection();
    }
}


function skipCurrentStudent() {
    multiCorrectionResults.push({ student: multiCorrectionQueue[currentMultiIndex], status: 'skipped', result: null });
    currentMultiIndex++;
    if (currentMultiIndex < multiCorrectionQueue.length) {
        showCurrentMultiStudent();
        if(!stream) showCameraSection(); else startAutoCapture();
    } else {
        completeMultipleCorrection();
    }
}


function stopMultipleCorrection() {
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏุ')) {
        completeMultipleCorrection();
    }
}

function completeMultipleCorrection() {
    isMultipleCorrectionMode = false;
    stopCamera(); // Stop camera when multi-mode ends
    document.getElementById('multiCorrectionActive')?.classList.add('hidden');
    if (multiCorrectionResults.length > 0) {
        generateMultiCorrectionReport();
    } else {
        resetMultiCorrection();
    }
    showNotification('ุชู ุฅููุงุก ุงูุชุตุญูุญ ุงููุชุนุฏุฏ.', 'success');
}

function generateMultiCorrectionReport() {
    const corrected = multiCorrectionResults.filter(r => r.status === 'completed').length;
    const skipped = multiCorrectionResults.filter(r => r.status === 'skipped').length;
    const avgScore = corrected > 0 ? Math.round(multiCorrectionResults.filter(r=>r.result).reduce((sum, r) => sum + (parseInt(r.result.percentage) || 0), 0) / corrected) : 0;
    const reportContentDiv = document.getElementById('multiReportContent');
    const reportSectionDiv = document.getElementById('multiCorrectionReport');
    if(!reportContentDiv || !reportSectionDiv) return;

    reportContentDiv.innerHTML = `
        <div class="grid grid-cols-3 gap-4 mb-4 text-center">
            <div class="bg-green-100 p-2 rounded-lg"><div class="font-bold text-lg">${corrected}</div><div class="text-xs">ุชู ุชุตุญูุญูุง</div></div>
            <div class="bg-yellow-100 p-2 rounded-lg"><div class="font-bold text-lg">${skipped}</div><div class="text-xs">ุชู ุชุฎุทููุง</div></div>
            <div class="bg-blue-100 p-2 rounded-lg"><div class="font-bold text-lg">${avgScore}%</div><div class="text-xs">ูุชูุณุท ุงูุฏุฑุฌุงุช</div></div>
        </div>
    `;
    reportSectionDiv.classList.remove('hidden');
}

function exportMultiReport() {
    if(multiCorrectionResults.length === 0) return;
    try {
        const reportData = multiCorrectionResults.map(r => ({
            'ุงุณู ุงูุทุงูุจ': r.student.name, 
            'ุงููุตู': r.student.class, 
            'ุงูุญุงูุฉ': r.status === 'completed' ? 'ุชู ุงูุชุตุญูุญ' : 'ุชู ุงูุชุฎุทู', 
            'ุงูุฏุฑุฌุฉ': r.result ? r.result.score : '-',
            'ุงููุณุจุฉ': r.result ? r.result.percentage : '-',
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(reportData);
        XLSX.utils.book_append_sheet(wb, ws, 'ุชูุฑูุฑ ุงูุชุตุญูุญ');
        XLSX.writeFile(wb, 'ุชูุฑูุฑ_ุงูุชุตุญูุญ_ุงููุชุนุฏุฏ.xlsx');
    } catch(e) {
        console.error("Error exporting multi-report:", e);
        showNotification("ุฎุทุฃ ูู ุชุตุฏูุฑ ุงูุชูุฑูุฑ.", "error");
    }
}


function resetMultiCorrection() {
    document.getElementById('multipleCorrectionSection')?.classList.add('hidden');
    document.getElementById('multiCorrectionSetup')?.classList.remove('hidden');
    document.getElementById('multiCorrectionReport')?.classList.add('hidden');
}

// ----------------------------------------------------
// === Reports Section ===
// ----------------------------------------------------

function populateReportFilters() {
    const classFilter = document.getElementById('reportClassFilter');
    const examFilter = document.getElementById('reportExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function generateClassReport() {
    const classFilter = document.getElementById('reportClassFilter')?.value;
    const examFilter = document.getElementById('reportExamFilter')?.value;
    const container = document.getElementById('report-container');
    if (container === null || classFilter === undefined || examFilter === undefined) return;

    const filteredLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );
    
    const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
    const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


    if (filteredLogs.length === 0 && absentStudents.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500">ูุง ุชูุฌุฏ ุจูุงูุงุช ุชุทุงุจู ูุฐู ุงูููุงุชุฑ ูุฅูุดุงุก ุชูุฑูุฑ.</p>`;
        return;
    }
    
    const firstLog = filteredLogs[0]; // Use first log to find answer key
    let reportCorrectAnswers = [];
    let questionAnalysisHTML = '<p class="text-sm text-gray-500">ูุง ูููู ุชุญููู ุงูุฃุณุฆูุฉ ุจุฏูู ูููุฐุฌ ุฅุฌุงุจุฉ ูุทุงุจู ููุฐุง ุงูุงุฎุชุจุงุฑ.</p>';
    let hardestQuestionNum = '-';
    let easiestQuestionNum = '-';
    let totalQuestions = 0;
    
    if (firstLog) {
        const modelName = Object.keys(answerKeyModels).find(key => {
            const model = answerKeyModels[key];
            // Match by examName AND number of answers
            return model && (model.examName === firstLog.examName) && (model.answers && model.answers.length === (firstLog.answers?.length || 0));
        });
        reportCorrectAnswers = modelName ? (answerKeyModels[modelName].answers || []) : [];
        totalQuestions = reportCorrectAnswers.length; // Get total questions count

        if (reportCorrectAnswers.length > 0) {
            const questionErrors = {};
            for (let i = 0; i < reportCorrectAnswers.length; i++) {
                 // Initialize with errors, corrects count, and correct answer
                 questionErrors[i + 1] = { qNum: i + 1, errors: 0, corrects: 0, correct: reportCorrectAnswers[i] };
            }
            filteredLogs.forEach(log => {
                 (log.answers || []).forEach((studentAnswer, i) => {
                     if (i < reportCorrectAnswers.length) {
                          if (studentAnswer === reportCorrectAnswers[i]) {
                              questionErrors[i + 1].corrects++;
                          } else {
                              questionErrors[i + 1].errors++;
                          }
                          // Track incorrect choices (excluding Blank) - No longer strictly needed for this column but kept for analysis logic
                          if(studentAnswer && studentAnswer !== 'Blank' && studentAnswer !== reportCorrectAnswers[i]){ 
                              questionErrors[i + 1].choices = questionErrors[i + 1].choices || {};
                              questionErrors[i + 1].choices[studentAnswer] = (questionErrors[i + 1].choices[studentAnswer] || 0) + 1;
                          }
                      }
                 });
            });
            
            // Get all questions numerically (Goal 4)
            const analysisArray = Object.values(questionErrors).sort((a, b) => a.qNum - b.qNum);
            
            // Find easiest/hardest from the analysis array
            if (analysisArray.length > 0) {
                const sortedByError = [...analysisArray].sort((a, b) => b.errors - a.errors);
                hardestQuestionNum = sortedByError.length > 0 ? sortedByError[0].qNum : '-';
                easiestQuestionNum = sortedByError.length > 0 ? sortedByError[sortedByError.length - 1].qNum : '-';
            }
            
            
            // Build the analysis table HTML (Goal 5)
            questionAnalysisHTML = `
                <table class="w-full text-sm mt-4 border-collapse border border-gray-300 question-analysis-table">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-300">
                            <th class="p-1 border-l border-gray-300">ุฑูู ุงูุณุคุงู</th>
                            <th class="p-1 border-l border-gray-300">ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ</th>
                            <th class="p-1 border-l border-gray-300">ุนุฏุฏ ุงูุฃุฎุทุงุก</th>
                            <th class="p-1 border-l border-gray-300">ุฏุฑุฌุฉ ุงูุตุนูุจุฉ</th>
                            <th class="p-1">ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ (ุงููููุฐุฌ)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysisArray.map(data => {
                             // Determine row color based on error rate
                            let errorClass = 'q-errors-none';
                            let difficultyText = 'ุณููุฉ ุฌุฏุงู';
                            if(filteredLogs.length > 0) { // Avoid division by zero
                                const errorRate = data.errors / filteredLogs.length;
                                if (errorRate > 0.5) { errorClass = 'q-errors-high'; difficultyText = 'ุตุนุจุฉ'; }
                                else if (errorRate > 0.25) { errorClass = 'q-errors-medium'; difficultyText = 'ูุชูุณุทุฉ'; }
                                else if (errorRate > 0) { errorClass = 'q-errors-low'; difficultyText = 'ุณููุฉ'; }
                            }
                            return `
                            <tr class="border-b border-gray-200 ${errorClass}">
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.qNum}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.corrects}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${data.errors}</td>
                                <td class="p-1 text-center font-bold border-l border-gray-300">${difficultyText}</td>
                                <td class="p-1 text-center">${data.correct || '-'}</td>
                            </tr>`
                        }).join('')}
                    </tbody>
                </table>`;
        }
    }


    const scores = filteredLogs.map(log => parseInt(log.percentage));
    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
    const maxScore = scores.length > 0 ? Math.max(...scores) : 0;
    const minScore = scores.length > 0 ? Math.min(...scores) : 0;
    const presentCount = filteredLogs.length;
    const absentCount = absentStudents.length;


    let reportHTML = `
        <div id="printable-report" class="bg-white p-6 rounded-lg shadow-md">
            
            <h4 class="text-lg font-bold mb-2">ููุฎุต ุงูุฃุฏุงุก</h4>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
                <div class="bg-blue-100 p-3 rounded-lg"><div class="font-bold text-xl">${presentCount}</div><div class="text-xs">ุนุฏุฏ ุงูุญุถูุฑ</div></div>
                <div class="bg-gray-100 p-3 rounded-lg"><div class="font-bold text-xl">${absentCount}</div><div class="text-xs">ุนุฏุฏ ุงูุบูุงุจ</div></div>
                <div class="bg-orange-100 p-3 rounded-lg"><div class="font-bold text-xl">${totalQuestions}</div><div class="text-xs">ุฅุฌูุงูู ุงูุฃุณุฆูุฉ</div></div>
                <div class="bg-green-100 p-3 rounded-lg"><div class="font-bold text-xl">${avgScore}%</div><div class="text-xs">ูุชูุณุท ุงูุญุถูุฑ</div></div>
                <div class="bg-yellow-100 p-3 rounded-lg"><div class="font-bold text-xl">${maxScore}%</div><div class="text-xs">ุฃุนูู ุฏุฑุฌุฉ</div></div>
                
            </div>
            
            <h4 class="text-lg font-bold mt-6 mb-2">ุชุญููู ุงูุฃุณุฆูุฉ</h4>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-red-50 p-3 rounded-lg text-center">
                    <h5 class="font-semibold mb-1 text-red-700">ุฃุตุนุจ ุณุคุงู</h5>
                    <p class="text-2xl font-bold text-red-600">ุณ ${hardestQuestionNum}</p>
                </div>
                <div class="bg-green-50 p-3 rounded-lg text-center">
                    <h5 class="font-semibold mb-1 text-green-700">ุฃุณูู ุณุคุงู</h5>
                    <p class="text-2xl font-bold text-green-600">ุณ ${easiestQuestionNum}</p>
                </div>
            </div>
            <div class="mb-6 border rounded p-2 bg-gray-50">
                ${questionAnalysisHTML}
            </div>

            <div class="text-center">
                <button id="printReportBtn" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-lg font-medium text-sm">ุทุจุงุนุฉ ุงูุชูุฑูุฑ ุงููุงูู</button>
            </div>
        </div>
    `;
    container.innerHTML = reportHTML;
    
    // Re-attach listener for the newly created button
    const printBtn = document.getElementById('printReportBtn');
    if(printBtn) printBtn.addEventListener('click', printReport);
}

async function printReport() {
    const classFilter = document.getElementById('reportClassFilter')?.value;
    const examFilter = document.getElementById('reportExamFilter')?.value;
    if(classFilter === undefined || examFilter === undefined) return;
    const modelNameFromExam = Object.keys(answerKeyModels).find(key => answerKeyModels[key].examName === examFilter);
    const subjectName = modelNameFromExam ? answerKeyModels[modelNameFromExam].subject : (examFilter || 'ุงูุงุฎุชุจุงุฑ');
    const date = new Date().toLocaleDateString('ar-SA');
    const title = `ุชูุฑูุฑ ุฃุฏุงุก ${subjectName} ${examFilter ? '- ' + examFilter : ''}`;
    const fileName = `ุชูุฑูุฑ-${subjectName.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}-${date}`; // Sanitize file name better

    
    // Get the generated content *excluding* the print button itself for printing
    const reportContainerClone = document.getElementById('report-container')?.cloneNode(true);
    if(!reportContainerClone) return;
    const printButtonInClone = reportContainerClone.querySelector('#printReportBtn');
    if(printButtonInClone) printButtonInClone.remove();
    
    // Extract core analysis content to be printed early (Goal 2, 3, 4, 5)
    const summaryHTML = reportContainerClone.querySelector('h4:nth-of-type(1)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-6')?.outerHTML;
    const analysisHTML = reportContainerClone.querySelector('h4:nth-of-type(2)')?.outerHTML + reportContainerClone.querySelector('.grid.gap-4.mb-4')?.outerHTML + reportContainerClone.querySelector('.mb-6.border.rounded.p-2.bg-gray-50')?.outerHTML;


    // Filter logs again to get student list for printing
    const studentLogs = detailedAnswersLog.filter(log => 
        (!classFilter || log.studentClass === classFilter) &&
        (!examFilter || log.examName === examFilter)
    );
    const allStudentsInFilter = studentsList.filter(s => !classFilter || s.class === classFilter);
    const absentStudents = allStudentsInFilter.filter(s => s.status === 'absent');


    // Sort students alphabetically for the table
    allStudentsInFilter.sort((a,b) => a.name.localeCompare(b.name, 'ar'));

    const studentListHTML = allStudentsInFilter.map((student, index) => {
        const log = studentLogs.find(l => l.studentName === student.name && l.studentClass === student.class);
        return `
            <tr class="border-b">
                <td class="p-1 text-center">${index + 1}</td>
                <td class="p-1 text-right">${student.name}</td>
                <td class="p-1 text-center">${student.class}</td>
                <td class="p-1 text-center">${log ? log.score : (student.status === 'absent' ? 'ุบุงุฆุจ' : '-')}</td>
                <td class="p-1 text-center">${log ? log.percentage : '-'}</td>
                <td class="p-1 text-center">${log ? log.grade : '-'}</td>
            </tr>
        `}).join('');
    
    const absentListHTML = absentStudents.map((student, index) => `
            <li class="text-sm">${index + 1}. ${student.name} (${student.class})</li>
    `).join('');


    // Generate chart images for printing (Goal 2)
    const gradeChartImage = await getReportChartsAsImages(studentLogs, 'pie');
    // For class chart in report, only show if no specific class is selected
    const classChartImage = (!classFilter) ? await getReportChartsAsImages(studentLogs, 'bar', classFilter) : null;


    const chartsHTML = `
            <div class="page-break" style="page-break-before: always;"></div> 
            <h4 class="text-lg font-bold mt-6 mb-2 text-center">ุชูุฒูุน ุงูุชูุฏูุฑุงุช</h4>
            <div style="text-align: center; margin-bottom: 20px;">
                ${gradeChartImage ? `<img src="${gradeChartImage}" class="mx-auto block" style="max-width: 350px; margin-top: 10px; border: 1px solid #ccc;"/>` : '<p class="text-center text-gray-500">ูุง ูููู ุนุฑุถ ุฑุณู ุงูุชูุฏูุฑุงุช (ุชุฃูุฏ ูู ูุฌูุฏ ุจูุงูุงุช).</p>'}
            </div>
            
            ${classChartImage ? `
                    <h4 class="text-lg font-bold mt-6 mb-2 text-center">ูุชูุณุท ุงูุฃุฏุงุก ุญุณุจ ุงููุตู</h4>
                    <div style="text-align: center; margin-bottom: 20px;">
                       <img src="${classChartImage}" class="mx-auto block" style="max-width: 600px; margin-top: 10px; border: 1px solid #ccc;"/>
                    </div>
            ` : ''}
    `;


    const studentTable = `
            <div class="page-break" style="page-break-before: always;"></div> 
            <h4 class="text-lg font-bold mt-6 mb-2">ุฏุฑุฌุงุช ุงูุทูุงุจ</h4>
            <table class="w-full text-sm mt-4">
                <thead><tr class="border-b-2 border-black"><th class="p-1">#</th><th class="p-1 text-right">ุงุณู ุงูุทุงูุจ</th><th class="p-1">ุงููุตู</th><th class="p-1">ุงูุฏุฑุฌุฉ</th><th class="p-1">ุงููุณุจุฉ</th><th class="p-1">ุงูุชูุฏูุฑ</th></tr></thead>
                <tbody>${studentListHTML}</tbody>
            </table>
            
            ${absentStudents.length > 0 ? `
                    <h4 class="text-lg font-bold mt-6 mb-2">ุงูุทูุงุจ ุงูุบุงุฆุจูู (${absentStudents.length})</h4>
                    <ul class="list-decimal list-inside pr-4">${absentListHTML}</ul>
            ` : ''}
    `;
    
    // Final content assembly (Goal 2)
    const finalPrintContent = summaryHTML + analysisHTML + chartsHTML + studentTable;

    // Use the separate div for print content
    const printDiv = document.getElementById('printable-report-content');
    if (printDiv) {
        printDiv.innerHTML = finalPrintContent; 
        printContent(printDiv.innerHTML, title, fileName); // Pass the combined HTML
    } else {
        console.error("Printable report content div not found.");
    }
}

function printContent(content, title, fileName) {
    const settings = getFromStorage('appSettings', {});
    const classFilter = document.getElementById('reportClassFilter')?.value || '';
    const examFilter = document.getElementById('reportExamFilter')?.value || '';
    const date = new Date().toLocaleDateString('ar-SA');
    const safeFileName = fileName || `${title.replace(/[^a-zA-Z0-9\u0600-\u06FF]/g, '_')}_${date}`; // Use provided or generate

    const headerInfo = `
        <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
            <p style="margin: 2px 0;">${settings.admin || ''}</p>
            <p style="margin: 2px 0;">${settings.school || ''}</p>
            <h1 style="font-size: 1.5rem; font-weight: bold; margin: 5px 0;">${title}</h1>
            <div style="font-size: 0.9rem; color: #555;">
                <span>${classFilter ? `ุงููุตู: ${classFilter}`: ''}</span>
                <span>${examFilter ? ` | ุงุฎุชุจุงุฑ: ${examFilter}` : ''}</span>
                <span> | ${date}</span>
            </div>
            <div style="font-size: 0.8rem; color: #555; margin-top: 5px;">
                <span>ุงููุนูู: ${settings.teacher || ''}</span>
                ${settings.director ? `<span> | ุงููุฏูุฑ: ${settings.director || ''}</span>` : ''}
            </div>
        </div>
    `;

    const fullContent = headerInfo + content;
    const win = window.open('', '_blank');
    if(win){
        win.document.write(`
            <html>
                <head>
                    <title>${safeFileName}</title>
                    <script src="https://cdn.tailwindcss.com"></script> 
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                     <style>
                        body { font-family:'Cairo', sans-serif; direction: rtl; margin: 20px; -webkit-print-color-adjust: exact !important; color-adjust: exact !important; } 
                        table { border-collapse: collapse !important; width: 100% !important; margin-top: 15px !important; page-break-inside: auto !important; } 
                        tr { page-break-inside: avoid !important; page-break-after: auto !important; }
                        thead { display: table-header-group !important; } 
                        td, th { border: 1px solid #ddd !important; padding: 4px !important; text-align: center !important; font-size: 0.75rem !important; } 
                        th { background-color: #f2f2f2 !important; font-weight: bold !important;} 
                        tr:nth-child(even){background-color: #f9f9f9 !important;} 
                        img { max-width: 100% !important; height: auto !important; page-break-inside: avoid !important;}
                        .page-break { page-break-before: always !important; }
                        .q-errors-high { background-color: #fee2e2 !important; color: #b91c1c !important; } 
                        .q-errors-medium { background-color: #ffedd5 !important; color: #c2410c !important; } 
                        .q-errors-low { background-color: #dcfce7 !important; color: #166534 !important; } 
                        .q-errors-none { background-color: #f0fdf4 !important; color: #16a34a !important; } 
                        .bg-blue-100 { background-color: #DBEAFE !important; }
                        .bg-green-100 { background-color: #DCFCE7 !important; }
                        .bg-red-100 { background-color: #FEE2E2 !important; }
                        .bg-gray-100 { background-color: #F3F4F6 !important; }
                        .bg-yellow-100 { background-color: #FEF3C7 !important; }
                        .bg-orange-100 { background-color: #FFEDD5 !important; }
                        .bg-red-50 { background-color: #FEF2F2 !important; }
                        .bg-green-50 { background-color: #F0FDF4 !important; }
                        .bg-gray-50 { background-color: #F9FAFB !important; }
                        .text-red-700 { color: #b91c1c !important; }
                        .text-green-700 { color: #15803d !important; }
                        .text-red-600 { color: #dc2626 !important; }
                        .text-green-600 { color: #16a34a !important; }
                        .text-blue-600 { color: #2563eb !important; }
                        .font-semibold { font-weight: 600 !important; }
                        .font-bold { font-weight: 700 !important; }
                        .text-xs { font-size: 0.7rem !important; }
                        .text-sm { font-size: 0.8rem !important; }
                        .text-lg { font-size: 1rem !important; }
                        .text-xl { font-size: 1.1rem !important; }
                        .text-2xl { font-size: 1.2rem !important; }
                        .p-1 { padding: 0.25rem !important; }
                        .p-2 { padding: 0.5rem !important; }
                        .p-3 { padding: 0.75rem !important; }
                        .mb-1 { margin-bottom: 0.25rem !important; }
                        .mb-2 { margin-bottom: 0.5rem !important; }
                        .mb-4 { margin-bottom: 1rem !important; }
                        .mt-4 { margin-top: 1rem !important; }
                        .mt-6 { margin-top: 1.5rem !important; }
                        .gap-4 { gap: 1rem !important; }
                        .grid { display: grid !important; }
                        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
                        .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
                        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
                        .grid-cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)) !important; }
                        .text-center { text-align: center !important; }
                        .text-right { text-align: right !important; }
                        .rounded-lg { border-radius: 0.5rem !important; }
                        @media print { button { display: none !important; } }
                    </style>
                </head>
                <body class="p-4">${fullContent}</body>
            </html>`);
        win.document.close();
        setTimeout(() => { 
            try { win.print(); } catch(e){ console.error("Print error:", e); }
        }, 500);
    } else {
        showNotification("ูุดู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.", "error");
    }
}

function printBlankSheet() {
    const qCountInput = document.getElementById('questionCount');
    const oCountSelect = document.getElementById('optionsCount');
    const subjectInput = document.getElementById('subjectName');
    const modelSelect = document.getElementById('answerKeyModel');
    const examNameInput = document.getElementById('examName');
    const examDateInput = document.getElementById('examDate');

    if(!qCountInput || !oCountSelect || !subjectInput || !modelSelect || !examNameInput || !examDateInput) {
        showNotification("ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ุนูุงุตุฑ ุงููููุฐุฌ.", "error");
        return;
    }


    const qCount = parseInt(qCountInput.value);
    if (isNaN(qCount) || qCount < 1) {
        showNotification("ุนุฏุฏ ุงูุฃุณุฆูุฉ ุบูุฑ ุตุงูุญ ูุทุจุงุนุฉ ุงููููุฐุฌ.", "error");
        return;
    }
    const oCount = parseInt(oCountSelect.value);
    const options = Array.from({ length: oCount }, (_, i) => String.fromCharCode(65 + i));
    const subjectName = subjectInput.value || 'ุบูุฑ ูุญุฏุฏ';
    const modelName = modelSelect.value.replace('ูููุฐุฌ ', '');
    const examName = examNameInput.value || 'ุบูุฑ ูุญุฏุฏ';
    const examDate = examDateInput.value || '';
    const splitPoint = Math.ceil(qCount / 2);
    const date = new Date().toLocaleDateString('ar-SA');
    const fileName = `ูููุฐุฌ-ุฅุฌุงุจุฉ-${subjectName}-${date}`;


    let col1 = '';
    for (let i = 1; i <= splitPoint; i++) {
        col1 += `<div class="q-item"><span class="q-num">${i}.</span>`;
        options.forEach(opt => { col1 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
        col1 += `</div>`;
    }

    let col2 = '';
    for (let i = splitPoint + 1; i <= qCount; i++) {
        col2 += `<div class="q-item"><span class="q-num">${i}.</span>`;
        options.forEach(opt => { col2 += `<span class="o-bubble"></span><span class="o-label">${opt}</span>`; });
        col2 += `</div>`;
    }
    
    // *** ุชู ุชุบููุฑ ุงูุชุฑููุณุฉ ููุชู ุฏูุฌูุง ูู printContent
    const printContent = `
        <style>
            body { font-family: 'Cairo', sans-serif; direction: rtl; margin: 0; }
            .page { max-width: 800px; margin: auto; padding: 20px; }
            .header-container { display: flex; justify-content: space-between; align-items: flex-start;ย border-bottom: none; /* ูุชู ุฅุถุงูุฉ ุงูุญุฏูุฏ ูู ุฏุงูุฉ ุงูุทุจุงุนุฉ */ }
            .header-info { text-align: center; flex-grow: 1; }
            .header-info h1 { font-size: 1.5rem; font-weight: bold; margin: 5px 0;}
            .header-info p { margin: 2px 0; font-size: 0.9rem; }
            .sub-header { font-size: 0.9rem; color: #555; }
            #qrcode-container { width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0; }
            .info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; font-size: 14px; }
            .info-item { border-bottom: 1.5px dotted #888; padding-bottom: 8px; }
            .columns-container { display: flex; justify-content: space-between; gap: 20px; }
            .column { flex: 1; }
            .separator { border-left: 1.5px dashed #ccc; margin: 0 10px; flex-shrink: 0; }
            .q-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
            .q-num { font-weight: bold; width: 30px; flex-shrink: 0; }
            .o-bubble { width: 22px; height: 22px; border: 1.5px solid black; border-radius: 50%; display: inline-block; flex-shrink: 0; }
            .o-label { margin-left: -5px; margin-right: 8px; flex-shrink: 0;}
            @media print { button { display: none; } }
        </style>
        <div class="page">
            <div class="header-container">
                <div id="qrcode-container-print" style="width: 80px; height: 80px; margin-left: 10px; flex-shrink: 0;"></div>
                <div class="header-info" style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;">
                    <p>${settings.admin || ''}</p>
                    <p>${settings.school || ''}</p>
                    <h1>ุงุฎุชุจุงุฑ ูุงุฏุฉ: ${subjectName} - ูููุฐุฌ ุฑูู (${modelName})</h1>
                    <div class="sub-header">
                        <span>ุงูุนุงู ุงูุฏุฑุงุณู: ${settings.year || ''}</span>
                        <span>ุงููุตู ุงูุฏุฑุงุณู: ${settings.semester || ''}</span>
                    </div>
                </div>
            </div>
            <div class="info">
                <div class="info-item"><strong>ุงุณู ุงูุทุงูุจ:</strong></div>
                <div class="info-item"><strong>ุงููุตู:</strong></div>
                <div class="info-item"><strong>ุงุณู ุงูุงุฎุชุจุงุฑ:</strong> ${examName}</div>
                <div class="info-item"><strong>ุงูุชุงุฑูุฎ:</strong> ${examDate}</div>
            </div>
            <div class="columns-container">
                <div class="column">${col1}</div>
                ${qCount > 1 ? '<div class="separator"></div>' : ''}
                <div class="column">${col2}</div>
            </div>
        </div>
    `;
    
    // ูุณุชุฎุฏู ุฏุงูุฉ ุงูุทุจุงุนุฉ ุงูุฎุงุตุฉ ููุชุญ ุงููุงูุฐุฉ ูุชุทุจูู ุงูุชูุณููุงุช
    const win = window.open('', '_blank');
    if(win){
        win.document.write(`
            <html>
                <head>
                    <title>${fileName}</title>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        /* Styles defined within the printContent template */
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <div style="text-align:center; margin-top: 30px;"><button onclick="window.print()">ุทุจุงุนุฉ ุงููููุฐุฌ</button></div>
                    <script>
                        const qrcode = new QRCode(document.getElementById("qrcode-container-print"), {
                            text: "${modelSelect.value}|${subjectName}|${examName}|${examDate}",
                            width: 80,
                            height: 80,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    </script>
                </body>
            </html>`);
        win.document.close();
        setTimeout(() => { 
            try { 
                // Check if print dialog opened, if not, show button
                if(win.document.readyState === 'complete'){
                    win.print();
                } 
            } catch(e){ 
                console.error("Print error:", e); 
            }
        }, 500);
    } else {
        showNotification("ูุดู ูุชุญ ูุงูุฐุฉ ุงูุทุจุงุนุฉ. ูุฑุฌู ุงูุณูุงุญ ุจุงูููุงูุฐ ุงูููุจุซูุฉ.", "error");
    }
}


// ----------------------------------------------------
// === Settings Section ===
// ----------------------------------------------------

function saveSettings() {
    settings = {
        admin: document.getElementById('setting-admin')?.value || '',
        school: document.getElementById('setting-school')?.value || '',
        teacher: document.getElementById('setting-teacher')?.value || '',
        director: document.getElementById('setting-director')?.value || '',
        year: document.getElementById('setting-year')?.value || '',
        semester: document.getElementById('setting-semester')?.value || '',
    };
    localStorage.setItem('appSettings', JSON.stringify(settings));
    showNotification('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!', 'success');
}

function loadSettings() {
    const adminInput = document.getElementById('setting-admin');
    if(adminInput) adminInput.value = settings.admin || '';
    const schoolInput = document.getElementById('setting-school');
    if(schoolInput) schoolInput.value = settings.school || '';
    const teacherInput = document.getElementById('setting-teacher');
    if(teacherInput) teacherInput.value = settings.teacher || '';
    const directorInput = document.getElementById('setting-director');
    if(directorInput) directorInput.value = settings.director || '';
    const yearInput = document.getElementById('setting-year');
    if(yearInput) yearInput.value = settings.year || '';
    const semesterInput = document.getElementById('setting-semester');
    if(semesterInput) semesterInput.value = settings.semester || '';
}

function backupData() {
    try {
        const data = {
            appSettings: settings,
            studentsList: studentsList,
            examResults: resultsHistory,
            detailedAnswersLog: detailedAnswersLog,
            answerKeyModels: answerKeyModels,
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showNotification('ุชู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ ุจูุฌุงุญ!', 'success');
    } catch(e) {
        console.error("Error backing up data:", e);
        showNotification("ุฎุทุฃ ูู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.", "error");
    }
}

function restoreData(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุชุ ุณูุชู ุงููุชุงุจุฉ ููู ุฌููุน ุงูุจูุงูุงุช ุงูุญุงููุฉ.")) {
        event.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            // Add more validation if necessary
            if (data.appSettings && data.studentsList && data.examResults && data.detailedAnswersLog && data.answerKeyModels) {
                // Restore data
                settings = data.appSettings || {};
                studentsList = (data.studentsList || []).map(s => ({ ...s, status: s.status || 'pending' })); // Ensure status on restore
                resultsHistory = data.examResults || [];
                detailedAnswersLog = data.detailedAnswersLog || [];
                answerKeyModels = data.answerKeyModels || {};
                
                // Save restored data to localStorage
                localStorage.setItem('appSettings', JSON.stringify(settings));
                localStorage.setItem('studentsList', JSON.stringify(studentsList));
                localStorage.setItem('examResults', JSON.stringify(resultsHistory));
                localStorage.setItem('detailedAnswersLog', JSON.stringify(detailedAnswersLog));
                localStorage.setItem('answerKeyModels', JSON.stringify(answerKeyModels));

                showNotification('ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุชุญุฏูุซ ุงููุงุฌูุฉ.', 'success');
                
                // Instead of reload, call loadInitialUI to refresh display
                loadInitialUI(); 
                showSection('dashboard'); // Go to dashboard after restore


            } else {
                throw new Error("ููู ุงููุณุฎ ุงูุงุญุชูุงุทู ุบูุฑ ุตุงูุญ ุฃู ุชุงูู.");
            }
        } catch (error) {
            console.error("Error restoring data:", error);
            showNotification(`ุฎุทุฃ ูู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช: ${error.message}`, 'error');
        } finally {
            event.target.value = ''; // Reset file input
        }
    };
    reader.onerror = (e) => {
        console.error("FileReader error (restore):", e);
        showNotification("ุฎุทุฃ ูู ูุฑุงุกุฉ ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ.", "error");
        event.target.value = ''; // Reset file input
    };
    reader.readAsText(file);
}

function clearAllData() {
    const confirmation = prompt("ููุชุฃููุฏุ ูุฑุฌู ูุชุงุจุฉ 'ุญุฐู' ูู ุงููุฑุจุน ุฃุฏูุงู.");
    if (confirmation === 'ุญุฐู') {
        localStorage.clear();
        showNotification('ุชู ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุจูุฌุงุญ! ุณูุชู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.', 'success');
        setTimeout(() => location.reload(), 1500);
    } else {
        showNotification('ูู ูุชู ุงูุญุฐู. ุงููุชุงุจุฉ ุบูุฑ ูุทุงุจูุฉ.', 'info');
    }
}

// ----------------------------------------------------
// === Stats Section ===
// ----------------------------------------------------

function populateStatsFilters() {
    const classFilter = document.getElementById('statsClassFilter');
    const examFilter = document.getElementById('statsExamFilter');
    if(!classFilter || !examFilter) return;

    const uniqueClasses = [...new Set(resultsHistory.map(r => r.studentClass))].sort();
    const uniqueExams = [...new Set(resultsHistory.map(r => r.examName))].sort();

    classFilter.innerHTML = '<option value="">ุฌููุน ุงููุตูู</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
    examFilter.innerHTML = '<option value="">ุฌููุน ุงูุงุฎุชุจุงุฑุงุช</option>' + uniqueExams.map(e => `<option value="${e}">${e}</option>`).join('');
}

function updateGlobalStats() {
    const container = document.getElementById('summary-stats');
    const gradeCtx = document.getElementById('grade-distribution-chart');
    const classCtx = document.getElementById('class-performance-chart');
    const classFilter = document.getElementById('statsClassFilter')?.value;
    const examFilter = document.getElementById('statsExamFilter')?.value;
    
    if(!container || !gradeCtx || !classCtx) {
        console.warn("Stats elements not found, skipping update.");
        return; 
    }
    
    const filteredResults = resultsHistory.filter(r => 
        (!classFilter || r.studentClass === classFilter) &&
        (!examFilter || r.examName === examFilter)
    );


    const totalCorrected = filteredResults.length;
    const overallAverage = totalCorrected > 0 ? Math.round(filteredResults.reduce((sum, r) => sum + (parseInt(r.percentage) || 0), 0) / totalCorrected) : 0;
    const uniqueStudents = new Set(filteredResults.map(r => r.studentName)).size;
    const uniqueExams = new Set(filteredResults.map(r => r.examName)).size;

    container.innerHTML = `
        <div class="bg-blue-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${totalCorrected}</div><div class="text-xs">ูุฑูุฉ ูุตุญุญุฉ</div></div>
        <div class="bg-green-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-green-600">${overallAverage}%</div><div class="text-xs">ูุชูุณุท ุงูุฃุฏุงุก</div></div>
        <div class="bg-purple-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-purple-600">${uniqueStudents}</div><div class="text-xs">ุทุงูุจ ูุฑูุฏ</div></div>
        <div class="bg-yellow-100 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-yellow-600">${uniqueExams}</div><div class="text-xs">ุงุฎุชุจุงุฑ ูุฑูุฏ</div></div>
    `;
    
    // Grade Distribution Chart
    try {
        if(gradeChart) gradeChart.destroy();
        const gradeCtx2D = gradeCtx.getContext('2d');
        if(!gradeCtx2D) throw new Error("Could not get 2D context for grade chart");

        const gradeCounts = { 'ููุชุงุฒ': 0, 'ุฌูุฏ ุฌุฏุงู': 0, 'ุฌูุฏ': 0, 'ููุจูู': 0, 'ุถุนูู': 0 };
        filteredResults.forEach(r => { 
            const grade = r.grade || 'ุถุนูู'; 
            if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
        });
        gradeChart = new Chart(gradeCtx2D, {
            type: 'pie',
            data: {
                labels: Object.keys(gradeCounts),
                datasets: [{
                    data: Object.values(gradeCounts),
                    backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    } catch (e) { console.error("Error creating grade chart:", e); }

    // Class Performance Chart
    try {
        if(classChart) classChart.destroy();
        const classCtx2D = classCtx.getContext('2d');
        if(!classCtx2D) throw new Error("Could not get 2D context for class chart");

        const classPerformances = {};
        filteredResults.forEach(r => {
            const className = r.studentClass || 'ุบูุฑ ูุญุฏุฏ';
            if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
            classPerformances[className].total += (parseInt(r.percentage) || 0); 
            classPerformances[className].count++;
        });
        const classLabels = Object.keys(classPerformances).sort();
        const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
        classChart = new Chart(classCtx2D, {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{
                    label: 'ูุชูุณุท ุงูุฏุฑุฌุงุช',
                    data: classAverages,
                    backgroundColor: '#4f46e5',
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
        });
    } catch (e) { console.error("Error creating class chart:", e); }
}

async function getReportChartsAsImages(logs, chartType, classFilterValue) {
    if (typeof Chart === 'undefined') {
        console.error("Chart.js library is not loaded.");
        return null;
    }
    const offscreenCanvas = document.createElement('canvas');
    const ctx = offscreenCanvas.getContext('2d');
    if(!ctx){
        console.error("Could not get 2D context for offscreen canvas.");
        return null;
    }
    
    let chartConfig;
    
    if(chartType === 'pie'){
        offscreenCanvas.width = 400; offscreenCanvas.height = 250; 
        const gradeCounts = { 'ููุชุงุฒ': 0, 'ุฌูุฏ ุฌุฏุงู': 0, 'ุฌูุฏ': 0, 'ููุจูู': 0, 'ุถุนูู': 0 };
        logs.forEach(r => { 
            const grade = r.grade || 'ุถุนูู';
            if(gradeCounts[grade] !== undefined) gradeCounts[grade]++; 
        });
        chartConfig = {
            type: 'pie',
            data: {
                labels: Object.keys(gradeCounts),
                datasets: [{ data: Object.values(gradeCounts), backgroundColor: ['#22c55e', '#84cc16', '#facc15', '#fb923c', '#ef4444'], }]
            },
            options: { responsive: false, animation: false, plugins: { legend: { display: true, position: 'bottom' } } }
        };
    } else if (chartType === 'bar'){
        offscreenCanvas.width = 600; offscreenCanvas.height = 300; 
        const classPerformances = {};
        // If no class filter is active in the report, show all classes' averages across all selected exams
        const relevantHistory = resultsHistory.filter(r => !classFilterValue || r.studentClass === classFilterValue); 

        relevantHistory.forEach(r => {
            const className = r.studentClass || 'ุบูุฑ ูุญุฏุฏ';
            if(!classPerformances[className]) classPerformances[className] = { total: 0, count: 0 };
            classPerformances[className].total += (parseInt(r.percentage) || 0); 
            classPerformances[className].count++;
        });
        const classLabels = Object.keys(classPerformances).sort();
        const classAverages = classLabels.map(c => classPerformances[c].count > 0 ? Math.round(classPerformances[c].total / classPerformances[c].count) : 0);
        
        chartConfig = {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{ label: 'ูุชูุณุท ุงูุฏุฑุฌุงุช', data: classAverages, backgroundColor: '#4f46e5', }]
            },
            options: { responsive: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
        };
    } else {
        return null; // Invalid chart type
    }

    // Await chart rendering
    return new Promise((resolve) => {
        let chartInstance = null;
        chartConfig.options = chartConfig.options || {};
        chartConfig.options.animation = {
            duration: 0, // No animation
            onComplete: () => {
                try {
                    const dataUrl = chartInstance.toBase64Image();
                    resolve(dataUrl);
                } catch (imgError) {
                    console.error("Error converting chart to image:", imgError);
                    resolve(null);
                } finally {
                    if (chartInstance) chartInstance.destroy();
                }
            }
        };
        try {
            chartInstance = new Chart(ctx, chartConfig);
            if (!chartInstance) throw new Error("Chart instance creation failed.");
        } catch (chartError) {
            console.error("Error creating chart instance:", chartError);
            resolve(null);
        }
    });

}
ย ย </script>
</body>
</html>
